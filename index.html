<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="theme-color" content="#0a0d14">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AuthenticaDetector">
    <meta name="description" content="AuthenticaDetector - Capture beasts, battle waves, and compete in the Veilbreakers arena!">
    <meta property="og:title" content="AuthenticaDetector - Beast Collection & Tank Battle">
    <meta property="og:description" content="Collect beasts, battle in your tank, and climb the leaderboards!">
    <meta property="og:image" content="icon-512.png">
    <title>AuthenticaDetector - Beast Collection & Tank Battle</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-180.png">

    <!-- Professional Icon Libraries - Using jsDelivr CDN for reliability -->
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.294.0/dist/umd/lucide.min.js"></script>
    <!-- Lottie for animations -->
    <script src="https://cdn.jsdelivr.net/npm/@lottiefiles/lottie-player@2.0.2/dist/lottie-player.js"></script>
    <!-- GSAP for smooth professional animations -->
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        
        /* RESET & VARIABLES */
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        :root{
            /* VERA-themed dark backgrounds */
            --bg:#0a0d14;--surface:#0f172a;--surface2:#1a1f2e;--surface3:#242b3d;
            /* VERA Teal/Cyan - primary accent */
            --primary:#14b8a6;--primary-bright:#5eead4;--primary-dim:#0d9488;
            --primary-glow:rgba(94,234,212,0.35);--cyan:#22d3ee;--cyan-glow:rgba(34,211,238,0.4);
            /* VERA Purple - demon/monster accent */
            --secondary:#7c3aed;--secondary-bright:#8b5cf6;--secondary-dim:#6366f1;
            --purple:#c4b5fd;--purple-dark:#581c87;--secondary-glow:rgba(124,58,237,0.35);
            /* Status colors - VERA themed */
            --danger:#dc2626;--danger-glow:rgba(220,38,38,0.35);
            --warning:#f59e0b;--success:#22c55e;
            /* VERA Gold - warm anime gold */
            --gold:#fcd34d;--gold-bright:#fef3c7;--gold-dim:#f59e0b;--gold-glow:rgba(252,211,77,0.45);
            --silver:#e8e8e8;--bronze:#cd7f32;
            /* Text hierarchy */
            --text:#f8fafc;--text2:#cbd5e1;--text3:#64748b;
            /* Borders with teal tint */
            --border:rgba(94,234,212,0.1);--border-bright:rgba(94,234,212,0.25);
            --safe-top:env(safe-area-inset-top,0px);
            --safe-bottom:env(safe-area-inset-bottom,0px);
            --safe-left:env(safe-area-inset-left,0px);--safe-right:env(safe-area-inset-right,0px);
        }
        
        /* BASE - CRITICAL RESPONSIVE FIX + CHROME PWA FIXES */
        html{
            height:100%;height:100dvh;  /* dvh = dynamic viewport, fixes Chrome address bar */
            overflow:hidden;
            overscroll-behavior:none;   /* Prevent pull-to-refresh on Chrome */
        }
        body{
            min-height:100%;min-height:100dvh;
            height:100%;height:100dvh;
            font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;
            background:var(--bg);color:var(--text);
            overflow:hidden;
            display:flex;flex-direction:column;
            overscroll-behavior:none;
            /* Prevent rubber-band scrolling on iOS/Chrome */
            position:fixed;
            width:100%;
            touch-action:pan-x pan-y;
        }

        /* ============================================
           PROFESSIONAL ANIMATION SYSTEM
           ============================================ */

        /* Global entrance animations */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideInFromLeft {
            from { opacity: 0; transform: translateX(-30px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes slideInFromRight {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Shimmer & glow effects */
        @keyframes shimmerSlide {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        @keyframes shimmerSweep {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        @keyframes borderGlow {
            0%, 100% { border-color: rgba(94,234,212,0.3); }
            50% { border-color: rgba(94,234,212,0.6); }
        }
        @keyframes softGlow {
            0%, 100% { box-shadow: 0 0 10px rgba(94,234,212,0.2); }
            50% { box-shadow: 0 0 20px rgba(94,234,212,0.4); }
        }

        /* Loading animations */
        @keyframes skeletonPulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        @keyframes spinLoader {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes dotBounce {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* Skeleton loader components */
        .skeleton {
            background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
            background-size: 200% 100%;
            animation: skeletonShimmer 1.5s ease-in-out infinite;
            border-radius: 8px;
        }
        @keyframes skeletonShimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .skeleton-text {
            height: 16px;
            margin-bottom: 8px;
        }
        .skeleton-title {
            height: 24px;
            width: 60%;
            margin-bottom: 12px;
        }
        .skeleton-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
        }
        .skeleton-card {
            height: 120px;
            margin-bottom: 12px;
        }

        /* Count-up number animation */
        @keyframes numberPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* Value change highlight animation */
        @keyframes valueChange {
            0% {
                transform: scale(1);
                color: inherit;
            }
            50% {
                transform: scale(1.15);
                color: var(--primary-bright);
                text-shadow: 0 0 8px var(--primary-glow);
            }
            100% {
                transform: scale(1);
                color: inherit;
            }
        }
        .value-changed {
            animation: valueChange 0.4s ease-out;
        }

        /* Notification pulse animation */
        @keyframes notificationPulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.8;
            }
        }
        .notification-dot {
            animation: notificationPulse 1.5s ease-in-out infinite;
        }

        /* Page transition animations */
        @keyframes pageSlideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes pageSlideOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(-20px); }
        }
        @keyframes pageFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Apply smooth transitions to common elements */
        button, .card, .panel {
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        button:active {
            transform: scale(0.97);
            transition-duration: 0.1s;
        }

        /* Accessibility: Respect reduced motion preference */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* ============================================
           ANIMATION FEATURE SUMMARY
           ============================================

           ✓ Button Hover Effects:
             - Icon buttons: Lift + glow + shimmer sweep
             - CTA buttons: Scale + gradient shift + top glow
             - Quick nav: Lift + scale + shimmer
             - Menu items: Slide + shimmer + icon rotate

           ✓ Card Hover Effects:
             - Stat cards: Lift + scale + shimmer sweep
             - Badge cards: Lift + scale + continuous shine (unlocked)
             - Profile stat cards: Lift + scale + shimmer
             - Shop items: Already have good animations

           ✓ Page Transitions:
             - Views: Slide in/out with fade
             - Closing: Fade out animation class

           ✓ Loading States:
             - Skeleton loaders: Shimmer animation
             - Helper function: showSkeletonLoader()

           ✓ Stat Counters:
             - Number count-up: animateNumber() function
             - Value change highlight: updateValueWithAnimation()
             - Pop effect when complete

           ✓ Badge/Achievement Effects:
             - Unlocked badges: Diagonal shine sweep
             - Epic/Legendary: Already have glow animations

           ✓ Navigation:
             - Quick nav icons: Float + rotate on hover
             - Menu arrows: Slide right on hover
             - Beast toggle: Rotate 180° + shimmer

           ✓ Currency Bar:
             - Hover effects: Lift + scale
             - Value change animation available

           ✓ Notifications:
             - Notification dot pulse animation
             - Toast notifications: Already animated
           ============================================ */

        /* Animated underline for links */
        a { position: relative; text-decoration: none; color: var(--primary); }
        a::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--primary);
            transition: width 0.3s ease;
        }
        a:hover::after { width: 100%; }

        /* VIEWS - SCROLLABLE WITH SMOOTH TRANSITIONS */
        .view{
            position:fixed;inset:0;
            background:var(--bg);
            display:none;flex-direction:column;
            z-index:10;
            overflow:hidden;
            /* Chrome PWA: Use dynamic viewport height */
            height:100dvh;
            /* Smooth page transitions */
            opacity: 0;
            transform: translateX(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .view.active{
            display:flex;
            opacity: 1 !important;
            transform: translateX(0) !important;
            animation: pageSlideIn 0.3s ease forwards;
        }
        .view.closing{
            animation: pageSlideOut 0.25s ease forwards;
        }
        
        .view-header{
            flex-shrink:0;
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:12px 16px;
            padding-top:calc(12px + var(--safe-top));
            background:var(--surface);
            border-bottom:1px solid var(--border);
            min-height:56px;
            /* Extend background into safe area to prevent Chrome bleed-through */
            position:relative;
            gap:12px;
        }
        .view-header > *:first-child{
            flex:0 0 auto;
        }
        .view-header > *:nth-child(2){
            flex:1 1 auto;
            text-align:center;
        }
        .view-header > *:last-child{
            flex:0 0 auto;
        }
        .view-header::before{
            content:'';position:absolute;top:calc(-1 * var(--safe-top));left:0;right:0;
            height:var(--safe-top);background:var(--surface);
        }
        .view-title{
            font-size:18px;
            font-weight:700;
            display:flex;
            align-items:center;
            justify-content:center;
            gap:8px;
        }
        .view-close{
            width:44px;height:44px;border-radius:50%;
            background:var(--surface2);border:none;
            color:var(--text);font-size:22px;
            cursor:pointer;display:flex;align-items:center;justify-content:center;
            transition:all 0.2s ease;
        }
        .view-close:hover{
            background:var(--surface3);
            transform:scale(1.05);
        }
        /* Premium Home Button */
        .home-btn{
            width:40px;
            height:40px;
            border-radius:12px;
            background:linear-gradient(135deg, rgba(94,234,212,0.15) 0%, rgba(34,211,238,0.1) 100%);
            border:1px solid rgba(94,234,212,0.3);
            color:var(--primary);
            font-size:18px;
            cursor:pointer;
            display:flex;
            align-items:center;
            justify-content:center;
            transition:all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow:0 2px 8px rgba(0,0,0,0.2);
            flex-shrink:0;
        }
        .home-btn:hover{
            background:linear-gradient(135deg, rgba(94,234,212,0.25) 0%, rgba(34,211,238,0.2) 100%);
            border-color:rgba(94,234,212,0.5);
            transform:translateY(-2px);
            box-shadow:0 4px 12px rgba(94,234,212,0.3);
        }
        .home-btn:active{transform:scale(0.95)}
        /* Back Button - matches home-btn style */
        .back-btn{
            width:40px;
            height:40px;
            border-radius:12px;
            background:linear-gradient(135deg, rgba(124,58,237,0.15) 0%, rgba(139,92,246,0.1) 100%);
            border:1px solid rgba(124,58,237,0.3);
            color:#a78bfa;
            font-size:18px;
            cursor:pointer;
            display:flex;
            align-items:center;
            justify-content:center;
            transition:all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow:0 2px 8px rgba(0,0,0,0.2);
            flex-shrink:0;
        }
        .back-btn:hover{
            background:linear-gradient(135deg, rgba(124,58,237,0.25) 0%, rgba(139,92,246,0.2) 100%);
            border-color:rgba(124,58,237,0.5);
            transform:translateY(-2px);
            box-shadow:0 4px 12px rgba(124,58,237,0.3);
        }
        .back-btn:active{transform:scale(0.95)}
        
        /* SCROLLABLE VIEW BODY - KEY FIX */
        .view-body{
            flex:1 1 auto;
            overflow-y:auto;
            overflow-x:hidden;
            -webkit-overflow-scrolling:touch;
            overscroll-behavior:contain;
        }
        .view-body-padded{
            padding:16px;
            padding-bottom:calc(100px + var(--safe-bottom));
        }
        
        /* HOME VIEW - SCROLLABLE */
        #homeView{display:flex;flex-direction:column}
        #homeView .home-content{
            flex:1 1 auto;
            overflow-y:auto;
            overflow-x:hidden;
            -webkit-overflow-scrolling:touch;
            padding-bottom:calc(20px + var(--safe-bottom));
        }
        
        /* HOME HEADER - PREMIUM DESIGN */
        .home-header{
            flex-shrink:0;
            display:flex;align-items:center;justify-content:space-between;
            padding:12px 16px;
            padding-top:calc(12px + var(--safe-top));
            background:var(--surface);
            min-height:56px;
            border-bottom:1px solid rgba(139,92,246,0.3);
            position:relative;
            z-index:100;
        }
        .home-header::before{
            content:'';position:absolute;top:calc(-1 * var(--safe-top));left:0;right:0;
            height:var(--safe-top);background:var(--surface);z-index:-1;
        }
        .logo{display:flex;align-items:center;gap:12px;cursor:pointer;transition:transform 0.2s}
        .logo:hover{transform:scale(1.02)}
        .logo-icon{
            width:42px;height:42px;
            filter:drop-shadow(0 0 12px rgba(94,234,212,0.6));
            animation:logo-pulse 3s ease-in-out infinite;
            flex-shrink: 0;
            overflow: visible;
        }
        .logo-icon svg{
            width:100%;
            height:100%;
            display:block;
            overflow: visible;
        }
        @keyframes logo-pulse{
            0%,100%{filter:drop-shadow(0 0 12px rgba(94,234,212,0.5))}
            50%{filter:drop-shadow(0 0 24px rgba(94,234,212,0.9))}
        }
        .logo-text{
            font-size:22px;font-weight:900;letter-spacing:-0.5px;
            /* Deep professional gradient - teal, purple, blue */
            background:linear-gradient(135deg, #00d4aa 0%, #0984e3 25%, #6c5ce7 50%, #00b894 75%, #00d4aa 100%);
            background-size:300% auto;
            animation:text-shimmer 4s linear infinite;
            -webkit-background-clip:text;-webkit-text-fill-color:transparent;
            background-clip:text;
            white-space:nowrap;
            text-shadow:0 2px 20px rgba(94,234,212,0.3);
        }
        /* Mobile: responsive header - bigger text on mobile too */
        @media(max-width:480px){
            .logo-text{font-size:18px}
            .logo-icon{width:36px;height:36px}
            .header-btns{gap:3px}
            .icon-btn{width:34px;height:34px;font-size:15px;border-radius:10px}
            .user-btn{width:34px;height:34px;font-size:12px}
        }
        @media(max-width:400px){
            .logo-text{font-size:16px}
            .logo-icon{width:32px;height:32px}
            .header-btns{gap:2px}
            .icon-btn{width:30px;height:30px;font-size:14px;border-radius:8px}
            .user-btn{width:30px;height:30px;font-size:11px}
        }
        @media(max-width:360px){
            .logo-text{font-size:14px;letter-spacing:-0.3px}
            .logo-icon{width:26px;height:26px}
            .icon-btn{width:28px;height:28px;font-size:13px;border-radius:6px}
            .user-btn{width:28px;height:28px;font-size:10px}
        }
        /* Hide tooltips on mobile - touch devices don't need hover */
        @media(max-width:768px){
            .icon-btn::after{display:none !important}
        }
        @keyframes text-shimmer{
            0%{background-position:0% center}
            100%{background-position:200% center}
        }
        .header-btns{display:flex;gap:6px;flex-shrink:1;min-width:0;overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch}
        .icon-btn{
            width:40px;height:40px;border-radius:12px;
            background:var(--surface2);border:1px solid var(--border);
            color:var(--text2);font-size:18px;
            cursor:pointer;display:flex;align-items:center;justify-content:center;
            transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position:relative;
            box-shadow:0 2px 4px rgba(0,0,0,0.2);
        }
        /* Enhanced shimmer effect on hover */
        .icon-btn::before{
            content:'';
            position:absolute;
            top:0;left:-100%;
            width:100%;height:100%;
            background:linear-gradient(90deg, transparent, rgba(94,234,212,0.3), transparent);
            transition:left 0.5s ease;
            border-radius:12px;
            pointer-events:none;
        }
        .icon-btn:hover::before{
            left:100%;
        }
        .icon-btn::after{
            content:attr(data-tooltip);
            position:absolute;bottom:-32px;left:50%;transform:translateX(-50%) scale(0.8);
            background:var(--surface3);color:var(--text);
            padding:4px 8px;border-radius:6px;font-size:10px;font-weight:600;
            white-space:nowrap;opacity:0;pointer-events:none;
            transition:all 0.25s cubic-bezier(0.4, 0, 0.2, 1);z-index:100;
            box-shadow:0 4px 12px rgba(0,0,0,0.3);
        }
        .icon-btn:hover::after{
            opacity:1;
            transform:translateX(-50%) scale(1) translateY(-2px);
        }
        .icon-btn:hover{
            background:linear-gradient(135deg, var(--surface3), var(--surface2));
            border-color:var(--primary);
            color:var(--primary);
            transform:translateY(-4px) scale(1.05);
            box-shadow:0 8px 24px rgba(94,234,212,0.35), 0 0 16px rgba(94,234,212,0.15);
        }
        .icon-btn:active{
            transform:scale(0.95) translateY(0);
            transition-duration:0.1s;
        }
        .icon-btn.highlight{
            animation:btn-glow 2s ease-in-out infinite;
            border-color:rgba(236,72,153,0.5);
        }
        @keyframes btn-glow{
            0%,100%{box-shadow:0 0 5px rgba(236,72,153,0.3)}
            50%{box-shadow:0 0 15px rgba(236,72,153,0.5), 0 0 25px rgba(124,58,237,0.3)}
        }
        .user-btn{
            width:40px;height:40px;border-radius:50%;
            background:linear-gradient(135deg, var(--primary), #6366f1);
            border:2px solid rgba(255,255,255,0.2);color:#fff;
            font-size:14px;font-weight:800;cursor:pointer;
            overflow:hidden;display:flex;align-items:center;justify-content:center;
            transition:all 0.2s;
            box-shadow:0 4px 15px rgba(94,234,212,0.3);
        }
        .user-btn:hover{transform:scale(1.1);box-shadow:0 6px 20px rgba(94,234,212,0.4)}
        .user-btn img{width:100%;height:100%;object-fit:cover}

        /* QUICK NAV - Premium horizontal navigation */
        .quick-nav{
            display:flex;
            justify-content:center;
            padding:12px 12px;
            background:linear-gradient(180deg, var(--surface) 0%, rgba(18,22,31,0.95) 100%);
            border-bottom:1px solid rgba(94,234,212,0.15);
            gap:10px;
        }
        .quick-nav-btn{
            flex:0 1 72px;
            display:flex;
            flex-direction:column;
            align-items:center;
            gap:6px;
            padding:12px 8px 10px;
            background:linear-gradient(145deg, rgba(26,31,46,0.9) 0%, rgba(18,22,31,0.95) 100%);
            border:1px solid rgba(255,255,255,0.06);
            border-radius:14px;
            cursor:pointer;
            transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family:inherit;
            position:relative;
            overflow:hidden;
            box-shadow:0 2px 8px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.03);
        }
        /* Top highlight line */
        .quick-nav-btn::before{
            content:'';position:absolute;top:0;left:0;right:0;height:2px;
            background:linear-gradient(90deg, transparent, rgba(94,234,212,0.5), transparent);
            opacity:0;transition:opacity 0.3s;
        }
        /* Shimmer sweep on hover */
        .quick-nav-btn::after{
            content:'';
            position:absolute;
            top:0;left:-100%;
            width:100%;height:100%;
            background:linear-gradient(90deg, transparent, rgba(94,234,212,0.1), transparent);
            transition:left 0.6s ease;
            pointer-events:none;
        }
        .quick-nav-btn:hover::before{opacity:1}
        .quick-nav-btn:hover::after{left:100%}
        .quick-nav-btn:hover{
            background:linear-gradient(145deg, rgba(36,43,61,0.95) 0%, rgba(26,31,46,0.98) 100%);
            border-color:rgba(94,234,212,0.35);
            transform:translateY(-4px) scale(1.02);
            box-shadow:0 10px 24px rgba(0,0,0,0.4), 0 0 24px rgba(94,234,212,0.15), inset 0 1px 0 rgba(255,255,255,0.05);
        }
        .quick-nav-btn:active{
            transform:translateY(-2px) scale(0.98);
            transition-duration:0.1s;
        }
        .quick-nav-icon{
            width:38px;height:38px;
            display:flex;align-items:center;justify-content:center;
            font-size:22px;line-height:1;
            background:linear-gradient(135deg, rgba(94,234,212,0.15) 0%, rgba(34,211,238,0.1) 100%);
            border:1px solid rgba(94,234,212,0.2);
            border-radius:12px;
            box-shadow:inset 0 1px 0 rgba(255,255,255,0.1), 0 2px 10px rgba(0,0,0,0.2);
            animation: floatUp 3s ease-in-out infinite;
            transition: transform 0.25s ease, box-shadow 0.25s ease;
        }
        .quick-nav-btn:hover .quick-nav-icon {
            transform: scale(1.15) rotate(10deg);
            box-shadow: 0 4px 15px rgba(94,234,212,0.3);
        }
        .quick-nav-btn:nth-child(1) .quick-nav-icon { animation-delay: 0s; }
        .quick-nav-btn:nth-child(2) .quick-nav-icon { animation-delay: 0.2s; }
        .quick-nav-btn:nth-child(3) .quick-nav-icon { animation-delay: 0.4s; }
        .quick-nav-btn:nth-child(4) .quick-nav-icon { animation-delay: 0.6s; }
        .quick-nav-label{
            font-size:9px;font-weight:700;
            color:var(--text3);
            text-transform:uppercase;letter-spacing:0.3px;
            transition:color 0.2s;
        }
        .quick-nav-btn:hover .quick-nav-label{color:var(--primary)}
        @media(max-width:400px){
            .quick-nav{padding:10px 8px;gap:6px}
            .quick-nav-btn{flex:0 1 60px;padding:10px 6px 8px;border-radius:12px}
            .quick-nav-icon{width:28px;height:28px;font-size:16px;border-radius:8px}
            .quick-nav-label{font-size:8px}
        }

        /* LUCIDE ICONS - Professional SVG styling */
        .lucide-icon {
            width: 22px;
            height: 22px;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
            transition: all 0.3s ease;
        }
        .lucide-icon-sm {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            stroke-width: 2.5;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
            vertical-align: middle;
            margin-right: 4px;
        }
        .lucide-icon-lg {
            width: 32px;
            height: 32px;
            stroke: currentColor;
            stroke-width: 1.5;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }
        .quick-nav-icon .lucide-icon {
            color: var(--primary);
            filter: drop-shadow(0 0 4px var(--primary-glow));
        }
        .quick-nav-btn:hover .lucide-icon {
            transform: scale(1.15);
            filter: drop-shadow(0 0 8px var(--primary));
        }

        /* LOTTIE ANIMATIONS - Smooth micro-interactions */
        lottie-player {
            display: inline-block;
            pointer-events: none;
        }
        .lottie-loading {
            width: 80px;
            height: 80px;
        }
        .lottie-success {
            width: 60px;
            height: 60px;
        }
        .lottie-coin {
            width: 32px;
            height: 32px;
        }
        .lottie-confetti {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }
        .lottie-sparkle {
            width: 24px;
            height: 24px;
            position: absolute;
        }

        /* STATUS BAR - PREMIUM BUTTONS */
        .status-bar{
            flex-shrink:0;
            padding:10px 16px;background:var(--surface2);
            display:flex;gap:8px;flex-wrap:wrap;
        }
        .status-chip{
            display:flex;align-items:center;gap:6px;
            padding:8px 14px;border-radius:20px;
            font-size:12px;font-weight:700;
            cursor:pointer;border:none;font-family:inherit;
            transition:all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow:0 2px 8px rgba(0,0,0,0.2);
        }
        .status-chip:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.3)}
        .status-chip:active{transform:scale(0.95)}
        .status-chip.pending{
            background:linear-gradient(135deg, rgba(255,165,2,.2), rgba(255,200,2,.15));
            color:var(--warning);border:1px solid rgba(255,165,2,.3);
        }
        .status-chip.pending:hover{background:linear-gradient(135deg, rgba(255,165,2,.3), rgba(255,200,2,.25))}
        .status-chip.complete{
            background:linear-gradient(135deg, rgba(46,213,115,.2), rgba(0,255,136,.15));
            color:var(--success);border:1px solid rgba(46,213,115,.3);
        }
        .status-chip.signup{
            background:linear-gradient(135deg, rgba(124,58,237,.25), rgba(139,92,246,.2));
            color:#a78bfa;border:1px solid rgba(124,58,237,.4);
        }
        .status-chip.signup:hover{
            background:linear-gradient(135deg, rgba(124,58,237,.4), rgba(139,92,246,.35));
            box-shadow:0 4px 15px rgba(124,58,237,0.3);
        }
        
        /* INSTALL BANNER */
        .install-banner{
            display:none;padding:12px 16px;
            background:linear-gradient(135deg,var(--secondary),#8b5cf6);
            align-items:center;gap:10px;
        }
        .install-banner.show{display:flex}
        .install-banner-icon{font-size:24px}
        .install-banner-text{flex:1}
        .install-banner-text strong{display:block;font-size:13px;margin-bottom:1px}
        .install-banner-text span{font-size:11px;opacity:.9}
        .install-banner-btn{
            padding:8px 14px;background:#fff;color:var(--secondary);
            border:none;border-radius:8px;font-weight:700;font-size:12px;cursor:pointer;
        }
        
        /* iOS HELPER */
        .ios-helper{
            display:none;margin:10px 16px;padding:14px;
            background:var(--surface);border:2px solid var(--primary);border-radius:14px;
        }
        .ios-helper.show{display:block}
        .ios-helper-title{font-size:14px;font-weight:700;margin-bottom:10px}
        .ios-steps{display:flex;flex-direction:column;gap:8px}
        .ios-step{display:flex;align-items:center;gap:10px;font-size:12px;color:var(--text2)}
        .ios-step-num{
            width:22px;height:22px;background:var(--primary);border-radius:50%;
            display:flex;align-items:center;justify-content:center;
            font-size:11px;font-weight:700;color:#000;flex-shrink:0;
        }
        .ios-dismiss{
            background:var(--surface2);border:none;color:var(--text2);
            font-size:12px;cursor:pointer;margin-top:10px;padding:8px;border-radius:8px;width:100%;
        }
        
        /* FACTS PANEL - ANIMATED GRADIENT BANNER */
        .facts-panel{
            margin:10px 16px;padding:14px 16px;
            background:linear-gradient(135deg, rgba(108,92,231,0.12) 0%, rgba(34,211,238,0.1) 50%, rgba(94,234,212,0.08) 100%);
            border-radius:14px;
            border:1px solid rgba(94,234,212,0.3);
            position:relative;
            overflow:hidden;
        }
        .facts-panel::before{
            content:'';position:absolute;inset:0;
            background:linear-gradient(90deg, transparent, rgba(94,234,212,0.15), rgba(34,211,238,0.15), transparent);
            background-size:200% 100%;
            animation:facts-shimmer 3s linear infinite;
        }
        @keyframes facts-shimmer{
            0%{background-position:-200% 0}
            100%{background-position:200% 0}
        }
        .facts-header{
            display:flex;align-items:center;gap:6px;
            margin-bottom:8px;font-size:11px;
            color:#00d4aa;font-weight:700;
            text-transform:uppercase;letter-spacing:1px;
            position:relative;z-index:1;
        }
        .facts-content{
            font-size:13px;color:var(--text);line-height:1.5;
            display:flex;align-items:flex-start;gap:10px;
            position:relative;z-index:1;
        }
        .facts-icon{
            font-size:20px;
            flex-shrink:0;
            width:24px;
            height:24px;
            display:flex;
            align-items:center;
            justify-content:center;
            filter:drop-shadow(0 0 8px rgba(94,234,212,0.5));
        }

        /* TRUTH HUNTERS GAME CTA - EPIC PREMIUM DESIGN */
        .game-cta-card {
            margin: 16px;
            padding: 0;
            background: linear-gradient(145deg, #1a1f35 0%, #0d1117 100%);
            border: 2px solid transparent;
            border-image: linear-gradient(135deg, #00d4aa, #6366f1, #ff6b35) 1;
            border-radius: 20px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4),
                        0 0 0 1px rgba(255,255,255,0.05) inset,
                        0 0 60px rgba(94,234,212,0.1);
        }
        .game-cta-glow {
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(94,234,212,0.1), transparent, rgba(124,58,237,0.1), transparent, rgba(255,107,53,0.1), transparent);
            animation: epicRotate 8s linear infinite;
            pointer-events: none;
        }
        @keyframes epicRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .game-cta-content {
            position: relative;
            z-index: 1;
            padding: 24px;
            background: linear-gradient(180deg, rgba(26,31,53,0.9) 0%, rgba(13,17,23,0.95) 100%);
        }
        .game-cta-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .game-cta-icon {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, rgba(94,234,212,0.2), rgba(124,58,237,0.2));
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(94,234,212,0.3);
            box-shadow: 0 4px 20px rgba(94,234,212,0.2);
        }
        .game-cta-stats {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        .game-cta-stat {
            flex: 1;
            background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
            padding: 14px 10px;
            border-radius: 14px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.08);
            backdrop-filter: blur(10px);
        }
        .game-cta-stat-value {
            font-size: 20px;
            font-weight: 800;
            background: linear-gradient(135deg, #00d4aa, #00ffcc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 4px;
        }
        .game-cta-stat-label {
            font-size: 10px;
            color: var(--text3);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        @keyframes epicPulse {
            0%, 100% {
                box-shadow: 0 6px 24px rgba(255,107,53,0.4),
                            0 0 40px rgba(255,107,53,0.2),
                            inset 0 1px 0 rgba(255,255,255,0.2);
            }
            50% {
                box-shadow: 0 8px 32px rgba(255,184,0,0.5),
                            0 0 60px rgba(255,184,0,0.3),
                            inset 0 1px 0 rgba(255,255,255,0.3);
            }
        }
        @keyframes epicShimmer {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }
        .game-cta-btn {
            width: 100%;
            padding: 18px 28px;
            background: linear-gradient(90deg,
                #ff4757 0%, #ff6b35 20%, #ffb800 40%,
                #ff6b35 60%, #ff4757 80%, #ff6b35 100%);
            background-size: 300% auto;
            animation: epicPulse 2.5s ease-in-out infinite, epicShimmer 4s linear infinite;
            border: none;
            border-radius: 14px;
            color: #fff;
            font-size: 17px;
            font-weight: 900;
            letter-spacing: 2px;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-shadow: 0 2px 8px rgba(0,0,0,0.5);
            position: relative;
            overflow: hidden;
        }
        .game-cta-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 60%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transform: skewX(-20deg);
            transition: left 0.8s ease;
        }
        .game-cta-btn:hover {
            transform: translateY(-3px) scale(1.02);
            filter: brightness(1.15) saturate(1.1);
        }
        .game-cta-btn:hover::before {
            left: 150%;
        }
        .game-cta-btn:active {
            transform: scale(0.98);
        }
        .game-cta-btn .lucide-icon {
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4));
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(26, 188, 156, 0.3); }
            50% { box-shadow: 0 0 40px rgba(26, 188, 156, 0.5); }
        }
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* ===== TRUTH CANNON GAME ===== */
        .truth-cannon-game {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #0a0e1a 0%, #1a1f35 100%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
        }

        .game-header {
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .game-close-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .game-stats-row {
            display: flex;
            gap: 20px;
        }

        .game-stat {
            text-align: center;
        }

        .game-stat-label {
            font-size: 10px;
            color: var(--text3);
            font-weight: 700;
            letter-spacing: 1px;
        }

        .game-stat-value {
            font-size: 20px;
            font-weight: 800;
            color: var(--primary);
            margin-top: 2px;
        }

        .credibility-bar-container {
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.3);
        }

        .credibility-label {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            font-weight: 700;
            color: var(--text2);
            margin-bottom: 6px;
        }

        .credibility-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .credibility-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success) 0%, var(--primary) 100%);
            transition: width 0.3s;
        }

        .credibility-fill[style*="width:100%"] {
            background: linear-gradient(90deg, #00ff88 0%, var(--success) 100%);
        }

        .credibility-fill[style*="width:0%"],
        .credibility-fill[style*="width:1"],
        .credibility-fill[style*="width:2"],
        .credibility-fill[style*="width:3"] {
            background: linear-gradient(90deg, #ff0044 0%, var(--danger) 100%);
        }

        #gameCanvas {
            flex: 1;
            width: 100%;
            display: block;
            background: transparent;
        }

        .aim-overlay {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
        }

        .aim-power-bar {
            height: 12px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 6px;
            overflow: hidden;
            border: 2px solid var(--primary);
        }

        .aim-power-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success) 0%, var(--warning) 50%, var(--danger) 100%);
            transition: width 0.05s linear;
        }

        /* Game Over Screen */
        .game-over-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .game-over-content {
            text-align: center;
            padding: 32px;
            max-width: 400px;
        }

        .game-over-content h1 {
            font-size: 32px;
            font-weight: 900;
            margin-bottom: 24px;
            color: var(--primary);
            text-shadow: 0 0 20px rgba(26, 188, 156, 0.5);
        }

        .game-over-stats {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
        }

        .game-over-stat {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            padding: 16px;
            border-radius: 12px;
        }

        .game-over-stat-label {
            font-size: 11px;
            color: var(--text3);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .game-over-stat-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--primary);
        }

        .game-over-rewards {
            background: linear-gradient(135deg, rgba(26, 188, 156, 0.1) 0%, rgba(142, 68, 173, 0.1) 100%);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 24px;
            border: 2px solid var(--primary);
        }

        .reward-earned {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .game-over-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .game-retry-btn {
            padding: 16px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            border: none;
            border-radius: 12px;
            color: #000;
            font-size: 18px;
            font-weight: 800;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(26, 188, 156, 0.4);
        }

        .game-quit-btn {
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--border);
            border-radius: 12px;
            color: var(--text2);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        /* POWER-UPS */
        .powerup-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(26, 188, 156, 0.5);
            border-radius: 12px;
            padding: 8px 12px;
            min-width: 70px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .powerup-btn:hover:not(:disabled) {
            background: rgba(26, 188, 156, 0.2);
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .powerup-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            border-color: rgba(255, 255, 255, 0.2);
        }

        .powerup-btn.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            border-color: var(--primary);
            animation: powerup-pulse 0.5s ease-in-out;
        }

        @keyframes powerup-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .powerup-icon {
            font-size: 24px;
            text-align: center;
            margin-bottom: 4px;
        }

        .powerup-name {
            font-size: 10px;
            font-weight: 700;
            text-align: center;
            color: var(--text);
            text-transform: uppercase;
        }

        .powerup-cooldown {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(0, 0, 0, 0.8);
            color: var(--warning);
            font-size: 10px;
            font-weight: 700;
            padding: 2px 4px;
            border-radius: 4px;
        }

        @media (max-width: 480px) {
            .powerup-btn {
                min-width: 60px;
                padding: 6px 8px;
            }
            .powerup-icon {
                font-size: 20px;
            }
            .powerup-name {
                font-size: 8px;
            }
        }

        /* TOAST */
        .toast-container{
            position:fixed;bottom:calc(80px + var(--safe-bottom));left:50%;transform:translateX(-50%);
            z-index:9999;display:flex;flex-direction:column;gap:6px;pointer-events:none;
        }
        .toast{
            background:var(--surface2);color:var(--text);padding:10px 16px;
            border-radius:8px;font-size:12px;box-shadow:0 4px 20px rgba(0,0,0,.3);
            animation:toast-in .3s;pointer-events:auto;
        }
        @keyframes toast-in{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        @keyframes slideInRight{from{opacity:0;transform:translateX(100%)}to{opacity:1;transform:translateX(0)}}
        @keyframes slideOutRight{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(100%)}}
        .toast-success,.toast-error,.toast-warning,.toast-info{
            color:#fff;padding:12px 18px;border-radius:10px;font-weight:600;
            display:flex;align-items:center;box-shadow:0 6px 25px rgba(0,0,0,.35);
        }

        /* PROFILE - Premium Design */
        @keyframes avatarGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(94,234,212,0.4), 0 0 40px rgba(94,234,212,0.2); }
            50% { box-shadow: 0 0 30px rgba(94,234,212,0.6), 0 0 60px rgba(94,234,212,0.3); }
        }
        @keyframes statPop {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .profile-header{
            background:linear-gradient(145deg, rgba(26,31,46,0.95) 0%, rgba(18,22,31,0.98) 100%);
            border:1px solid rgba(94,234,212,0.15);
            border-radius:20px;padding:24px;
            margin-bottom:16px;text-align:center;
            position:relative;
            overflow:hidden;
        }
        .profile-header::before {
            content:'';
            position:absolute;
            top:-50%;left:-50%;width:200%;height:200%;
            background:radial-gradient(circle at 30% 20%, rgba(94,234,212,0.08) 0%, transparent 40%);
            pointer-events:none;
        }
        .profile-avatar{
            width:80px;height:80px;border-radius:50%;
            background:linear-gradient(135deg, #00d4aa 0%, #0984e3 50%, #6c5ce7 100%);
            margin:0 auto 16px;display:flex;align-items:center;justify-content:center;
            font-size:28px;font-weight:900;color:#fff;cursor:pointer;overflow:hidden;
            position:relative;
            animation: avatarGlow 3s ease-in-out infinite;
            border:3px solid rgba(255,255,255,0.2);
        }
        .profile-avatar::after {
            content:'';
            position:absolute;
            inset:0;
            background:linear-gradient(135deg, transparent 40%, rgba(255,255,255,0.2) 50%, transparent 60%);
            pointer-events:none;
        }
        .profile-avatar img{width:100%;height:100%;object-fit:cover;border-radius:50%}
        .profile-name{
            font-size:20px;font-weight:900;margin-bottom:4px;
            background:linear-gradient(135deg, #fff 0%, #00d4aa 100%);
            -webkit-background-clip:text;-webkit-text-fill-color:transparent;
        }
        .profile-email{font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:8px}

        .stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px}
        .stat-card{
            background:linear-gradient(145deg, rgba(26,31,46,0.9) 0%, rgba(18,22,31,0.95) 100%);
            border:1px solid rgba(94,234,212,0.12);
            border-radius:16px;padding:16px;text-align:center;
            animation: statPop 0.5s ease-out backwards;
            transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position:relative;
            overflow:hidden;
            box-shadow:0 2px 8px rgba(0,0,0,0.2);
        }
        /* Shimmer effect on stat cards */
        .stat-card::before{
            content:'';
            position:absolute;
            top:0;left:-100%;
            width:100%;height:100%;
            background:linear-gradient(90deg, transparent, rgba(94,234,212,0.2), transparent);
            transition:left 0.6s ease;
            pointer-events:none;
        }
        .stat-card:hover::before{
            left:100%;
        }
        .stat-card:nth-child(1) { animation-delay: 0s; }
        .stat-card:nth-child(2) { animation-delay: 0.1s; }
        .stat-card:nth-child(3) { animation-delay: 0.2s; }
        .stat-card:nth-child(4) { animation-delay: 0.3s; }
        .stat-card:hover {
            transform: translateY(-6px) scale(1.02);
            border-color: rgba(94,234,212,0.4);
            box-shadow: 0 12px 32px rgba(0,0,0,0.4), 0 0 24px rgba(94,234,212,0.2);
        }
        .stat-card:active {
            transform: translateY(-2px) scale(0.98);
            transition-duration: 0.1s;
        }
        .stat-value{
            font-size:24px;font-weight:900;
            background:linear-gradient(135deg, #00d4aa 0%, #00ffcc 50%, #0984e3 100%);
            -webkit-background-clip:text;-webkit-text-fill-color:transparent;
            margin-bottom:4px;
        }
        .stat-label{
            font-size:10px;color:rgba(255,255,255,0.5);
            text-transform:uppercase;letter-spacing:0.5px;font-weight:600;
        }
        
        /* BADGES - Styles moved to PROFESSIONAL_UI_OVERHAUL.css */

        /* ENHANCED BADGE DISPLAY - PROFILE & DETAILED VIEWS */
        .enhanced-badges-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:16px;padding:12px}
        .badge-card{
            position:relative;padding:16px;border-radius:16px;
            background:rgba(255,255,255,.08);backdrop-filter:blur(10px);
            border:1px solid rgba(255,255,255,.2);text-align:center;
            transition:all 0.35s cubic-bezier(0.4, 0, 0.2, 1);cursor:pointer;
            display:flex;flex-direction:column;align-items:center;justify-content:center;
            min-height:140px;
            overflow:hidden;
            box-shadow:0 4px 16px rgba(0,0,0,.2);
        }
        /* Shine sweep for unlocked badges */
        .badge-card.unlocked::after{
            content:'';
            position:absolute;
            top:-50%;left:-50%;
            width:200%;height:200%;
            background:linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.15) 50%, transparent 70%);
            transform:rotate(45deg);
            animation:badgeShine 4s ease-in-out infinite;
            pointer-events:none;
        }
        @keyframes badgeShine {
            0%, 100% { transform:rotate(45deg) translateX(-100%); }
            50% { transform:rotate(45deg) translateX(100%); }
        }
        .badge-card:hover{
            transform:translateY(-10px) scale(1.04);
            background:rgba(255,255,255,.15);
            border-color:rgba(94,234,212,.5);
            box-shadow:0 12px 36px rgba(0,0,0,.4), 0 0 30px rgba(94,234,212,.25);
        }
        .badge-card:active{
            transform:translateY(-6px) scale(1.01);
            transition-duration:0.1s;
        }
        .badge-card.locked{
            opacity:0.5;
            pointer-events:none;
            filter:grayscale(0.7);
        }
        .badge-card-icon{
            width:64px;height:64px;border-radius:14px;
            display:flex;align-items:center;justify-content:center;
            font-size:40px;margin-bottom:12px;position:relative;
            transition:transform 0.3s ease
        }
        .badge-card:hover .badge-card-icon{transform:scale(1.15)}
        .badge-card-icon.common{background:linear-gradient(135deg,#4a5568,#718096);box-shadow:0 4px 12px rgba(74,85,104,.4)}
        .badge-card-icon.rare{background:linear-gradient(135deg,#3182ce,#63b3ed);box-shadow:0 4px 12px rgba(49,130,206,.4)}
        .badge-card-icon.epic{background:linear-gradient(135deg,#805ad5,#b794f4);box-shadow:0 4px 12px rgba(128,90,213,.4)}
        .badge-card-icon.legendary{
            background:linear-gradient(135deg,#d69e2e,#f6e05e);
            box-shadow:0 4px 16px rgba(214,158,46,.5);
            animation:badge-glow 2s ease-in-out infinite;
        }
        .badge-card-icon.locked{background:var(--surface2);opacity:0.4}
        .badge-card-title{font-size:13px;font-weight:700;margin-bottom:6px;color:var(--text)}
        .badge-card-desc{font-size:11px;color:var(--text2);margin-bottom:8px;line-height:1.4}
        .badge-card-points{font-size:12px;color:var(--gold);font-weight:600;margin-top:auto}
        .badge-tooltip{
            position:absolute;bottom:calc(100% + 10px);left:50%;transform:translateX(-50%);
            background:rgba(0,0,0,.9);color:white;padding:10px 14px;border-radius:8px;
            font-size:12px;white-space:nowrap;pointer-events:none;opacity:0;
            transition:opacity 0.2s ease;z-index:1000;font-weight:600;
            box-shadow:0 4px 12px rgba(0,0,0,.3)
        }
        .badge-card:hover .badge-tooltip{opacity:1}
        .badge-progress{width:100%;height:4px;background:var(--surface2);border-radius:2px;margin-top:8px;overflow:hidden}
        .badge-progress-bar{height:100%;background:linear-gradient(90deg,var(--primary),var(--accent));
            width:var(--progress,0%);transition:width 0.3s ease;border-radius:2px}
        .badge-status-indicator{
            position:absolute;top:8px;right:8px;width:20px;height:20px;
            border-radius:50%;display:flex;align-items:center;justify-content:center;
            font-size:10px;font-weight:700;background:var(--primary);color:white
        }
        .badge-status-indicator.locked{background:var(--surface2);color:var(--text3)}

        /* SHOP - GLASSMORPHIC DESIGN */
        /* PREMIUM SHOP - Complete Overhaul */
        .shop-category{margin-bottom:32px}
        .shop-category-title{
            font-size:16px;font-weight:800;
            margin-bottom:16px;padding:12px 16px;
            background:linear-gradient(135deg, rgba(94,234,212,0.1) 0%, rgba(34,211,238,0.05) 100%);
            border-left:4px solid var(--primary);
            border-radius:0 12px 12px 0;
            display:flex;align-items:center;gap:10px;
            box-shadow:0 2px 12px rgba(0,0,0,0.2);
        }
        .shop-grid{
            display:grid;grid-template-columns:repeat(auto-fill,minmax(155px,1fr));
            gap:16px;margin-bottom:20px
        }
        .shop-item{
            position:relative;padding:16px 12px;border-radius:20px;
            background:linear-gradient(145deg, rgba(26,31,46,0.95) 0%, rgba(18,22,31,0.98) 100%);
            backdrop-filter:blur(12px);
            border:1px solid rgba(255,255,255,.08);text-align:center;
            transition:all 0.35s cubic-bezier(0.4, 0, 0.2, 1);cursor:pointer;
            display:flex;flex-direction:column;align-items:center;
            min-height:200px;
            box-shadow:0 4px 20px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.03);
            overflow:hidden;
        }
        .shop-item::before{
            content:'';position:absolute;top:0;left:0;right:0;height:2px;
            background:linear-gradient(90deg, transparent, rgba(94,234,212,0.5), transparent);
            opacity:0;transition:opacity 0.3s;
        }
        .shop-item:hover::before{opacity:1}
        .shop-item:hover{
            transform:translateY(-8px) scale(1.02);
            border-color:rgba(94,234,212,.3);
            box-shadow:0 12px 40px rgba(0,0,0,0.4), 0 0 30px rgba(94,234,212,0.15), inset 0 1px 0 rgba(255,255,255,0.05);
        }
        .shop-item.locked{opacity:0.5;pointer-events:none;filter:grayscale(0.5)}
        .shop-item.purchased{
            background:linear-gradient(145deg, rgba(94,234,212,0.12) 0%, rgba(0,184,148,0.08) 100%);
            border-color:rgba(94,234,212,0.4);
        }
        .shop-item.purchased::after{
            content:'OK';position:absolute;top:10px;right:10px;
            width:26px;height:26px;border-radius:50%;
            background:linear-gradient(135deg, var(--primary), #00b894);color:#fff;
            display:flex;align-items:center;justify-content:center;
            font-weight:800;font-size:14px;
            box-shadow:0 2px 8px rgba(94,234,212,0.4);
        }
        .shop-item-icon{
            width:72px;height:72px;border-radius:18px;
            display:flex;align-items:center;justify-content:center;
            font-size:36px;margin-bottom:14px;position:relative;
            transition:all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            background:linear-gradient(145deg, rgba(94,234,212,0.15) 0%, rgba(34,211,238,0.1) 100%);
            border:1px solid rgba(94,234,212,.25);
            box-shadow:0 4px 16px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.05);
        }
        .shop-item:hover .shop-item-icon{
            transform:scale(1.15) rotate(3deg);
            box-shadow:0 8px 24px rgba(94,234,212,0.3);
        }
        .shop-item-name{
            font-size:13px;font-weight:700;color:var(--text);
            margin-bottom:6px;line-height:1.3
        }
        .shop-item-desc{
            font-size:10px;color:var(--text3);margin-bottom:12px;
            line-height:1.4;flex:1;padding:0 4px;
        }
        .shop-item-cost{
            display:flex;align-items:center;justify-content:center;gap:6px;
            font-size:14px;font-weight:800;color:var(--gold);
            padding:10px 14px;
            background:linear-gradient(135deg, rgba(255,215,0,0.12) 0%, rgba(255,180,0,0.08) 100%);
            border-radius:10px;width:100%;margin-bottom:10px;
            border:1px solid rgba(255,215,0,.25);
            box-shadow:inset 0 1px 0 rgba(255,255,255,0.05);
        }
        .shop-item-cost-icon{font-size:16px}
        .shop-item-btn{
            width:100%;padding:10px 14px;border:none;
            border-radius:10px;font-size:12px;font-weight:700;
            cursor:pointer;transition:all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            font-family:inherit;text-transform:uppercase;letter-spacing:0.5px;
        }
        .shop-item-btn.purchase{
            background:linear-gradient(135deg, var(--primary) 0%, #00b894 100%);
            color:#fff;text-shadow:0 1px 2px rgba(0,0,0,0.2);
            box-shadow:0 4px 16px rgba(94,234,212,.35);
        }
        .shop-item-btn.purchase:hover{
            background:linear-gradient(135deg, #00e8bc 0%, #00d4aa 100%);
            box-shadow:0 6px 20px rgba(94,234,212,.5);
            transform:translateY(-2px);
        }
        .shop-item-btn.purchase:active{transform:scale(0.96) translateY(0)}
        .shop-item-btn.purchase.insufficient{
            background:linear-gradient(135deg, var(--surface2) 0%, var(--surface3) 100%);
            color:var(--text3);box-shadow:none;cursor:not-allowed;opacity:0.5;
        }
        .shop-item-btn.owned{
            background:linear-gradient(135deg, rgba(94,234,212,0.2) 0%, rgba(0,184,148,0.15) 100%);
            color:var(--primary);cursor:default;border:1px solid rgba(94,234,212,0.3);
        }
        /* Rarity-based styling */
        .shop-item-rarity{
            position:absolute;top:10px;left:10px;
            font-size:9px;font-weight:800;padding:4px 8px;
            border-radius:6px;text-transform:uppercase;letter-spacing:0.5px;
        }
        .shop-item-rarity[data-rarity="common"]{
            background:linear-gradient(135deg, rgba(107,114,128,0.3) 0%, rgba(75,85,99,0.2) 100%);
            color:#9ca3af;border:1px solid rgba(107,114,128,0.3);
        }
        .shop-item-rarity[data-rarity="rare"]{
            background:linear-gradient(135deg, rgba(59,130,246,0.3) 0%, rgba(37,99,235,0.2) 100%);
            color:#60a5fa;border:1px solid rgba(59,130,246,0.4);
        }
        .shop-item-rarity[data-rarity="epic"]{
            background:linear-gradient(135deg, rgba(168,85,247,0.3) 0%, rgba(139,92,246,0.2) 100%);
            color:#c084fc;border:1px solid rgba(168,85,247,0.4);
            animation:epic-glow 2s ease-in-out infinite;
        }
        @keyframes epic-glow{
            0%,100%{box-shadow:0 0 8px rgba(168,85,247,0.3)}
            50%{box-shadow:0 0 16px rgba(168,85,247,0.5)}
        }
        .shop-item-rarity[data-rarity="legendary"]{
            background:linear-gradient(135deg, rgba(251,191,36,0.4) 0%, rgba(245,158,11,0.3) 100%);
            color:#fcd34d;border:1px solid rgba(251,191,36,0.5);
            animation:legendary-glow 1.5s ease-in-out infinite;
        }
        @keyframes legendary-glow{
            0%,100%{box-shadow:0 0 10px rgba(251,191,36,0.4), 0 0 20px rgba(251,191,36,0.2)}
            50%{box-shadow:0 0 20px rgba(251,191,36,0.6), 0 0 40px rgba(251,191,36,0.3)}
        }

        .menu{
            background:linear-gradient(145deg, rgba(26,31,46,0.9) 0%, rgba(18,22,31,0.95) 100%);
            border:1px solid rgba(255,255,255,0.06);
            border-radius:16px;overflow:hidden;
        }
        .menu-item{
            display:flex;align-items:center;gap:14px;padding:16px;
            border-bottom:1px solid rgba(255,255,255,0.05);cursor:pointer;
            background:none;border-left:none;border-right:none;border-top:none;
            width:100%;text-align:left;color:var(--text);font-family:inherit;font-size:14px;
            font-weight:500;
            transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position:relative;
            overflow:hidden;
        }
        /* Left accent bar */
        .menu-item::before {
            content:'';
            position:absolute;
            left:0;top:0;bottom:0;width:3px;
            background:linear-gradient(180deg, #00d4aa, #0984e3);
            opacity:0;
            transition:opacity 0.3s ease;
        }
        /* Shimmer effect on hover */
        .menu-item::after {
            content:'';
            position:absolute;
            top:0;left:-100%;
            width:100%;height:100%;
            background:linear-gradient(90deg, transparent, rgba(94,234,212,0.08), transparent);
            transition:left 0.5s ease;
            pointer-events:none;
        }
        .menu-item:hover {
            background:rgba(94,234,212,0.1);
            padding-left:24px;
        }
        .menu-item:hover::before { opacity:1; }
        .menu-item:hover::after { left:100%; }
        .menu-item:active {
            background:rgba(94,234,212,0.15);
            transition-duration:0.1s;
        }
        .menu-item:last-child{border-bottom:none}
        .menu-icon{
            font-size:18px;width:32px;height:32px;
            display:flex;align-items:center;justify-content:center;
            background:linear-gradient(135deg, rgba(94,234,212,0.12), rgba(34,211,238,0.08));
            border-radius:10px;
            transition:all 0.3s ease;
        }
        .menu-item:hover .menu-icon {
            transform:scale(1.1) rotate(5deg);
            background:linear-gradient(135deg, rgba(94,234,212,0.2), rgba(34,211,238,0.15));
        }
        .menu-text{flex:1;color:#fff}
        .menu-arrow{
            color:rgba(94,234,212,0.6);
            font-size:14px;
            transition:transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .menu-item:hover .menu-arrow {
            transform:translateX(6px);
            color:rgba(94,234,212,0.9);
        }
        
        /* HISTORY - Premium Cards */
        @keyframes historySlideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .history-item{
            display:flex;align-items:center;gap:14px;padding:14px 16px;
            background:linear-gradient(145deg, rgba(26,31,46,0.95) 0%, rgba(18,22,31,0.98) 100%);
            border:1px solid rgba(255,255,255,0.06);
            border-radius:14px;margin-bottom:10px;
            animation: historySlideIn 0.4s ease-out backwards;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position:relative;
            overflow:hidden;
        }
        .history-item::before {
            content:'';
            position:absolute;
            top:0;left:-100%;width:100%;height:100%;
            background:linear-gradient(90deg, transparent, rgba(255,255,255,0.03), transparent);
            transition:left 0.5s ease;
        }
        .history-item:hover {
            transform: translateX(6px);
            border-color: rgba(94,234,212,0.2);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .history-item:hover::before { left:100%; }
        .history-item:nth-child(1) { animation-delay: 0s; }
        .history-item:nth-child(2) { animation-delay: 0.05s; }
        .history-item:nth-child(3) { animation-delay: 0.1s; }
        .history-item:nth-child(4) { animation-delay: 0.15s; }
        .history-item:nth-child(5) { animation-delay: 0.2s; }

        .history-thumb{
            width:50px;height:50px;border-radius:10px;
            background:linear-gradient(135deg, rgba(94,234,212,0.1) 0%, rgba(34,211,238,0.08) 100%);
            border:1px solid rgba(94,234,212,0.15);
            display:flex;align-items:center;justify-content:center;font-size:20px;
            flex-shrink:0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .history-thumb img {
            width:100%;height:100%;object-fit:cover;border-radius:9px;
        }

        .history-info{flex:1;min-width:0}

        .history-result{
            font-size:14px;font-weight:700;
            margin-bottom:4px;
            color:#fff;
        }

        .history-meta{
            font-size:11px;color:rgba(255,255,255,0.5);
            display:flex;align-items:center;gap:8px;
        }
        .history-meta::before {
            content:'';
            display:inline-block;
            width:4px;height:4px;
            background:rgba(94,234,212,0.5);
            border-radius:50%;
        }

        .history-score{
            font-size:13px;font-weight:800;padding:6px 12px;border-radius:8px;
            min-width:52px;text-align:center;
            position:relative;
        }
        .history-score.fake{
            background:linear-gradient(135deg, rgba(220,38,38,0.2) 0%, rgba(255,107,107,0.15) 100%);
            color:#ff6b6b;
            border:1px solid rgba(220,38,38,0.3);
            box-shadow: 0 2px 10px rgba(220,38,38,0.2);
        }
        .history-score.real{
            background:linear-gradient(135deg, rgba(46,213,115,0.2) 0%, rgba(94,234,212,0.15) 100%);
            color:#2ed573;
            border:1px solid rgba(46,213,115,0.3);
            box-shadow: 0 2px 10px rgba(46,213,115,0.2);
        }

        .history-empty{
            text-align:center;padding:60px 24px;color:rgba(255,255,255,0.4);
            background:linear-gradient(145deg, rgba(26,31,46,0.5) 0%, rgba(18,22,31,0.3) 100%);
            border:1px dashed rgba(255,255,255,0.1);
            border-radius:16px;
        }
        .history-empty div { font-size:48px;margin-bottom:12px;opacity:0.6; }
        .history-empty p { font-size:15px;font-weight:500; }
        
        /* LEADERBOARD - EPIC TIERS */
        .podium{display:flex;justify-content:center;gap:8px;margin-bottom:14px;padding:12px}
        .podium-item{text-align:center;flex:1;max-width:90px;position:relative}
        .podium-item.first{order:2;margin-top:-8px;animation:goldPulse 2s ease-in-out infinite}
        .podium-item.second{order:1;animation:silverGlow 3s ease-in-out infinite}
        .podium-item.third{order:3;animation:bronzeShimmer 2.5s ease-in-out infinite}

        /* TOP 3 ANIMATIONS */
        @keyframes goldPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        @keyframes silverGlow {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.15); }
        }
        @keyframes bronzeShimmer {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.1); }
        }

        .podium-avatar{
            width:50px;height:50px;border-radius:50%;margin:0 auto 6px;
            display:flex;align-items:center;justify-content:center;
            font-size:18px;font-weight:800;overflow:hidden;position:relative;
        }
        .podium-item.first .podium-avatar{
            width:60px;height:60px;font-size:22px;
            background:linear-gradient(135deg,#ffd700,#ffed4a);
            border:4px solid #ffd700;
            box-shadow:0 0 30px rgba(255,215,0,.7), 0 0 60px rgba(255,215,0,.4), inset 0 0 20px rgba(255,255,255,.3);
        }
        .podium-item.second .podium-avatar{
            background:linear-gradient(135deg,#c0c0c0,#e8e8e8);
            border:4px solid #c0c0c0;
            box-shadow:0 0 20px rgba(192,192,192,.6), inset 0 0 15px rgba(255,255,255,.2);
        }
        .podium-item.third .podium-avatar{
            background:linear-gradient(135deg,#cd7f32,#daa520);
            border:4px solid #cd7f32;
            box-shadow:0 0 18px rgba(205,127,50,.5), inset 0 0 12px rgba(255,255,255,.15);
        }
        .podium-avatar img{width:100%;height:100%;object-fit:cover}
        .podium-crown{position:absolute;top:-10px;left:50%;transform:translateX(-50%);font-size:24px;z-index:10}
        .podium-item.first .podium-crown{font-size:32px;top:-14px;z-index:10}
        .podium-name{font-size:10px;font-weight:700}
        .podium-item.first .podium-name{color:var(--gold)}
        .podium-points{font-size:9px;color:var(--text3)}
        .podium-tier{
            font-size:8px;text-transform:uppercase;margin-top:3px;font-weight:800;
            padding:2px 6px;border-radius:4px;display:inline-block;
        }
        .tier-king{background:linear-gradient(135deg,#ffd700,#ff8c00);color:#000}
        .tier-viceroy{background:linear-gradient(135deg,#c0c0c0,#808080);color:#000}
        .tier-archduke{background:linear-gradient(135deg,#cd7f32,#8b4513);color:#fff}
        .tier-legend{background:linear-gradient(135deg,#9b59b6,#8e44ad);color:#fff}
        .tier-elite{background:linear-gradient(135deg,#3498db,#2980b9);color:#fff}
        .tier-veteran{background:linear-gradient(135deg,#27ae60,#1e8449);color:#fff}
        .tier-rising{background:linear-gradient(135deg,#7f8c8d,#95a5a6);color:#fff}
        
        .lb-item{
            display:flex;align-items:center;gap:10px;padding:10px;
            background:var(--surface);border-radius:10px;margin-bottom:6px;cursor:pointer;
            transition:all .3s ease;position:relative;
        }
        /* TOP 10 SPECIAL BORDERS */
        .lb-item:has(.lb-rank.top10){
            border:2px solid transparent;
            background:linear-gradient(var(--surface),var(--surface)) padding-box,
                       linear-gradient(135deg,var(--primary),#00ff88,#1abc9c) border-box;
            box-shadow:0 0 15px rgba(26,188,156,.3);
        }
        .lb-item:has(.lb-rank.top10):hover{
            box-shadow:0 0 25px rgba(26,188,156,.5);
            transform:translateX(4px);
        }
        /* TIERED BORDERS FOR ALL PLAYERS */
        .lb-item:has(.lb-tier.tier-king){
            border-left:4px solid #ffd700;
        }
        .lb-item:has(.lb-tier.tier-viceroy){
            border-left:4px solid #c0c0c0;
        }
        .lb-item:has(.lb-tier.tier-archduke){
            border-left:4px solid #cd7f32;
        }
        .lb-item:has(.lb-tier.tier-legend){
            border-left:4px solid #9b59b6;
        }
        .lb-item:has(.lb-tier.tier-elite){
            border-left:4px solid #3498db;
        }
        .lb-item:has(.lb-tier.tier-veteran){
            border-left:4px solid #27ae60;
        }
        .lb-item:has(.lb-tier.tier-rising){
            border-left:4px solid #7f8c8d;
        }

        /* TIER GROUP SECTIONS WITH BRACKETED HEADERS */
        .tier-group-section{
            margin-bottom:18px;border-radius:10px;overflow:hidden;
            background:linear-gradient(135deg,rgba(255,255,255,.02),rgba(255,255,255,.01));
            border:1px solid rgba(255,255,255,.1);
        }

        .tier-group-header{
            padding:12px 14px;font-weight:800;font-size:13px;
            display:flex;align-items:center;justify-content:center;gap:8px;
            text-transform:uppercase;letter-spacing:1px;
            background:linear-gradient(135deg,rgba(255,255,255,.08),rgba(255,255,255,.04));
            border-bottom:2px solid;
        }

        .tier-group-header.tier-legend{
            border-bottom-color:#9b59b6;color:#9b59b6;
        }
        .tier-group-header.tier-elite{
            border-bottom-color:#3498db;color:#3498db;
        }
        .tier-group-header.tier-veteran{
            border-bottom-color:#27ae60;color:#27ae60;
        }
        .tier-group-header.tier-rising{
            border-bottom-color:#7f8c8d;color:#7f8c8d;
        }

        .tier-group-bracket{
            font-size:16px;opacity:.7;
        }

        .tier-group-label{
            flex:1;text-align:center;
        }

        .tier-group-content{
            padding:8px 10px;
            display:flex;flex-direction:column;gap:6px;
        }

        .tier-group-content .lb-item{
            margin-bottom:0;
        }

        .lb-rank{
            width:28px;height:28px;border-radius:6px;
            display:flex;align-items:center;justify-content:center;
            font-size:11px;font-weight:800;
        }
        .lb-rank.top10{
            background:linear-gradient(135deg,var(--primary),#00ff88);
            color:#000;
            box-shadow:0 0 10px rgba(26,188,156,.4);
            font-weight:900;
        }
        .lb-rank.normal{background:var(--surface2);color:var(--text2)}
        .lb-avatar{
            width:36px;height:36px;border-radius:50%;
            background:linear-gradient(135deg,var(--primary),#00ff88);
            display:flex;align-items:center;justify-content:center;
            font-size:12px;font-weight:800;color:#000;overflow:hidden;
        }
        .lb-avatar img{width:100%;height:100%;object-fit:cover}
        .lb-info{flex:1}
        .lb-name{font-size:12px;font-weight:700}
        .lb-stats{font-size:10px;color:var(--text3)}
        .lb-points{font-size:14px;font-weight:800;color:var(--primary)}
        .lb-tier{margin-left:6px}
        
        /* REWARDS SECTION */
        .rewards-card{
            background:linear-gradient(135deg,var(--surface2),var(--surface3));
            border:2px solid var(--gold);border-radius:14px;padding:14px;margin-bottom:12px;
        }
        .rewards-title{font-size:14px;font-weight:800;color:var(--gold);margin-bottom:8px;display:flex;align-items:center;gap:6px}
        .rewards-list{display:flex;flex-direction:column;gap:6px}
        .reward-item{
            display:flex;align-items:center;gap:8px;padding:8px;
            background:var(--surface);border-radius:8px;font-size:11px;
        }
        .reward-icon{font-size:18px}
        .reward-text{flex:1}
        .reward-tier{font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px}
        
        /* LOGIN */
        .login-content{padding:16px;max-width:360px;margin:0 auto}
        .login-hero{text-align:center;margin-bottom:24px}
        .login-hero .logo-icon{width:56px;height:56px;margin:0 auto 14px}
        .login-hero h2{font-size:20px;font-weight:800;margin-bottom:4px}
        .login-hero p{color:var(--text2);font-size:12px}
        .login-form{display:flex;flex-direction:column;gap:12px}
        .input-group{display:flex;flex-direction:column;gap:4px}
        .input-group label{font-size:11px;font-weight:600;color:var(--text2)}
        .input-group input{
            padding:11px 12px;background:var(--surface);border:2px solid var(--border);
            border-radius:8px;color:var(--text);font-size:13px;font-family:inherit;
        }
        .input-group input:focus{outline:none;border-color:var(--primary)}
        .login-submit{
            padding:12px;background:linear-gradient(135deg,var(--primary),#00ff88);
            border:none;border-radius:10px;color:#000;font-size:14px;font-weight:800;
            cursor:pointer;font-family:inherit;
        }
        .login-submit:disabled{opacity:.5}
        .login-toggle{text-align:center;font-size:11px;color:var(--text3);margin-top:12px}
        .login-toggle a{color:var(--primary);cursor:pointer}
        .login-guest{
            width:100%;padding:10px;background:var(--surface2);border:none;border-radius:8px;
            color:var(--text2);font-size:12px;font-weight:600;cursor:pointer;margin-top:8px;
        }
        .login-error{
            background:rgba(220,38,38,.15);border:2px solid var(--danger);color:#ff6b7a;
            padding:12px;border-radius:8px;font-size:13px;font-weight:500;text-align:center;display:none;margin-bottom:12px;
            animation:shake 0.4s ease-in-out;
        }
        .login-error.show{display:block}
        @keyframes shake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-5px)}40%,80%{transform:translateX(5px)}}
        .forgot-password{text-align:right;margin:-4px 0 12px;font-size:12px}
        .forgot-password a{color:var(--primary);cursor:pointer;text-decoration:none}
        .forgot-password a:hover{text-decoration:underline}
        
        /* MODALS - PREMIUM DESIGN */
        .modal-overlay{
            position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:100;
            display:none;align-items:center;justify-content:center;padding:16px;
            backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
        }
        .modal-overlay.show{display:flex}
        .modal{
            background:linear-gradient(180deg, var(--surface), var(--bg));
            border-radius:20px;padding:24px;
            max-width:360px;width:100%;max-height:85vh;overflow-y:auto;position:relative;
            border:1px solid rgba(94,234,212,0.2);
            box-shadow:0 25px 50px rgba(0,0,0,0.5), 0 0 30px rgba(94,234,212,0.1);
        }
        .modal-close{
            position:absolute;top:calc(12px + var(--safe-top));right:calc(12px + var(--safe-right));
            background:linear-gradient(135deg, var(--surface2), var(--surface3));
            border:1px solid var(--border);
            color:var(--text);width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:16px;
            transition:all 0.2s;display:flex;align-items:center;justify-content:center;
        }
        .modal-close:hover{
            background:var(--danger);border-color:var(--danger);
            transform:rotate(90deg);
        }
        
        /* Old VERA CSS removed - now using vera-controller.css */

        .help-section{
            background:linear-gradient(145deg, rgba(26,31,46,0.9) 0%, rgba(18,22,31,0.95) 100%);
            border:1px solid rgba(94,234,212,0.1);
            border-radius:16px;margin-bottom:12px;overflow:hidden;
            transition:all 0.3s ease;
        }
        .help-section:hover {
            border-color: rgba(94,234,212,0.25);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .help-header{
            display:flex;align-items:center;justify-content:space-between;
            padding:16px;cursor:pointer;
            transition:background 0.25s ease;
        }
        .help-header:hover {
            background:rgba(94,234,212,0.08);
        }
        .help-title{
            font-size:15px;font-weight:700;
            color:#fff;
            display:flex;align-items:center;gap:10px;
        }
        .help-toggle{
            color:rgba(94,234,212,0.7);font-size:12px;
            transition:transform 0.3s ease;
        }
        .help-section.open .help-toggle { transform:rotate(180deg); }
        .help-content{
            padding:0 16px 16px;display:none;
            animation:accordionOpen 0.3s ease-out;
        }
        .help-content.show{display:block}
        .help-text{font-size:13px;color:rgba(255,255,255,0.7);line-height:1.7}
        .help-text p{margin-bottom:12px}
        .help-text ul{margin-left:20px;margin-bottom:12px}
        .help-text li{margin-bottom:6px;position:relative}
        .help-text li::before {
            content:'';
            position:absolute;
            left:-16px;top:8px;
            width:6px;height:6px;
            background:linear-gradient(135deg, #00d4aa, #0984e3);
            border-radius:50%;
        }
        .help-text strong { color:#00d4aa; }

        /* ========================================
           TOGGLE SWITCH STYLES (Settings Page)
           ======================================== */

        /* Toggle switch - the slider knob that moves */
        label input[type="checkbox"] + span::before {
            content: '';
            position: absolute;
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.4s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* When checkbox is checked, move the slider knob to the right */
        label input[type="checkbox"]:checked + span::before {
            transform: translateX(20px);
        }

        /* Change background color when checked */
        label input[type="checkbox"]:checked + span {
            background: var(--primary) !important;
        }

        /* Add pointer cursor to the label */
        label[style*="position:relative"] {
            cursor: pointer;
        }

        /* Hover effect for better UX */
        label[style*="position:relative"]:hover span {
            opacity: 0.9;
        }

        /* Active/pressed effect */
        label[style*="position:relative"]:active span::before {
            width: 22px;
        }

        .hidden{display:none!important}

        /* ========================================
           TRUTH HUNTERS GAME STYLES
           Modern, Glassmorphic, Addictive Design
           ======================================== */

        /* ===== NAVIGATION ===== */
        .game-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(18, 22, 31, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            padding-bottom: calc(8px + var(--safe-bottom));
            z-index: 100;
        }

        .game-nav-btn {
            flex: 1;
            background: none;
            border: none;
            color: var(--text3);
            padding: 6px 8px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
            position: relative;
        }

        .game-nav-btn.active {
            color: var(--primary);
        }

        .game-nav-icon {
            font-size: 24px;
            transition: transform 0.2s;
        }

        .game-nav-btn:active .game-nav-icon {
            transform: scale(0.9);
        }

        .game-nav-label {
            font-size: 11px;
            font-weight: 600;
        }

        .game-nav-badge {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(6px);
            background: var(--danger);
            color: #fff;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .game-nav-pulse {
            position: absolute;
            top: 4px;
            left: 50%;
            transform: translateX(8px);
            width: 12px;
            height: 12px;
            background: var(--danger);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        /* ===== COMMON ELEMENTS ===== */
        .coins-display, .streak-display {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 215, 0, 0.1);
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 700;
            color: var(--gold);
            border: 1px solid rgba(255, 215, 0, 0.3);
            flex-shrink: 0;
            white-space: nowrap;
        }

        .streak-display {
            background: rgba(255, 69, 0, 0.1);
            color: #ff4500;
            border-color: rgba(255, 69, 0, 0.3);
        }

        /* PREMIUM VERIFY PAGE - Complete Overhaul */
        .verify-stats {
            display: flex;
            background: linear-gradient(145deg, rgba(26,31,46,0.95) 0%, rgba(18,22,31,0.98) 100%);
            border-bottom: 1px solid rgba(94,234,212,0.15);
            padding: 14px 16px;
            box-shadow:0 4px 16px rgba(0,0,0,0.2);
        }

        .verify-stat {
            flex: 1;
            text-align: center;
            position:relative;
        }
        .verify-stat:not(:last-child)::after{
            content:'';position:absolute;right:0;top:20%;height:60%;
            width:1px;background:rgba(255,255,255,0.08);
        }

        .verify-stat-value {
            font-weight: 900;
            font-size: 20px;
            background:linear-gradient(135deg, var(--primary), #00ff88);
            -webkit-background-clip:text;-webkit-text-fill-color:transparent;
            margin-bottom: 4px;
        }

        .verify-stat-label {
            font-size: 10px;
            color: var(--text3);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight:600;
        }

        .verify-container {
            height: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .verify-loading, .verify-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 48px 24px;
            text-align: center;
        }

        .loading-spinner {
            width: 56px;
            height: 56px;
            border: 4px solid rgba(94,234,212,0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s cubic-bezier(0.4, 0, 0.2, 1) infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Card Stack (Tinder-style) - Premium */
        .card-stack {
            flex: 1;
            position: relative;
            padding: 20px;
            overflow: hidden;
        }

        .verify-card {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            bottom: calc(150px + var(--safe-bottom)); /* Space for vote buttons + footer */
            background: linear-gradient(145deg, rgba(26,31,46,0.98) 0%, rgba(18,22,31,1) 100%);
            border-radius: 24px;
            border: 2px solid rgba(255,255,255,0.08);
            overflow: hidden;
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255,255,255,0.02);
            cursor: grab;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .verify-card::before{
            content:'';position:absolute;top:0;left:0;right:0;height:3px;
            background:linear-gradient(90deg, var(--primary), #00ff88, var(--primary));
            background-size:200% 100%;
            animation:shimmer-line 3s linear infinite;
        }
        @keyframes shimmer-line{
            0%{background-position:100% 0}
            100%{background-position:-100% 0}
        }

        .verify-card:active {
            cursor: grabbing;
        }

        .verify-card.swiping-right {
            transform: rotate(8deg) scale(1.02);
            border-color: var(--success);
            box-shadow: 0 0 40px rgba(46,213,115,0.3), 0 16px 48px rgba(0,0,0,0.4);
        }

        .verify-card.swiping-left {
            transform: rotate(-8deg) scale(1.02);
            border-color: var(--danger);
            box-shadow: 0 0 40px rgba(220,38,38,0.3), 0 16px 48px rgba(0,0,0,0.4);
        }

        .verify-card-image {
            width: 100%;
            height: 55%;
            object-fit: contain;
            background: linear-gradient(180deg, #0a0d14 0%, #12161f 100%);
        }

        .verify-card-content {
            padding: 18px;
            height: 45%;
            overflow-y: auto;
            background:linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.2) 100%);
        }

        .verify-card-platform {
            display: inline-flex;align-items:center;gap:6px;
            background: linear-gradient(135deg, rgba(94,234,212,0.15) 0%, rgba(34,211,238,0.1) 100%);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 14px;
            border:1px solid rgba(94,234,212,0.2);
        }

        .verify-card-context {
            font-size: 14px;
            color: var(--text2);
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .verify-card-claim {
            background: linear-gradient(135deg, rgba(255,165,2,0.12) 0%, rgba(255,200,2,0.08) 100%);
            border: 1px solid rgba(255, 165, 2, 0.25);
            border-radius: 12px;
            padding: 12px 14px;
            font-size: 13px;
            margin-top: 12px;
            color:var(--warning);
        }

        /* Vote Controls - Premium - Fixed to stay above footer */
        .vote-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            padding-bottom: calc(80px + var(--safe-bottom)); /* Account for game-nav footer */
            display: flex;
            justify-content: center;
            gap: 16px;
            background: linear-gradient(transparent 0%, var(--bg) 30%, var(--bg) 100%);
            z-index: 50;
        }

        .vote-btn {
            flex: 1;
            max-width: 90px;
            aspect-ratio: 1;
            border: none;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
            font-weight: 700;
        }

        .vote-btn-icon {
            font-size: 28px;
        }

        .vote-btn-label {
            font-size: 10px;
        }

        .vote-real {
            background: linear-gradient(135deg, #2ed573, #26de81);
            color: #000;
            box-shadow: 0 4px 16px rgba(46, 213, 115, 0.3);
        }

        .vote-ai {
            background: linear-gradient(135deg, #ff4757, #ff6348);
            color: #fff;
            box-shadow: 0 4px 16px rgba(255, 71, 87, 0.3);
        }

        .vote-unsure {
            background: var(--surface2);
            color: var(--text2);
            border: 2px solid var(--border);
        }

        .vote-btn:active {
            transform: scale(0.9);
        }

        /* Vote Feedback Overlay */
        .vote-feedback {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.2s;
        }

        .feedback-content {
            text-align: center;
            animation: bounceIn 0.4s;
        }

        .feedback-icon {
            font-size: 80px;
            margin-bottom: 16px;
        }

        .feedback-text {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .feedback-points {
            font-size: 32px;
            font-weight: 800;
            color: var(--gold);
            animation: slideInUp 0.4s 0.2s backwards;
        }

        @keyframes bounceIn {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes slideInUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ===== SQUADS - Premium Glassmorphic Design ===== */
        @keyframes squadPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(99, 102, 241, 0.3), 0 0 40px rgba(99, 102, 241, 0.1); }
            50% { box-shadow: 0 0 30px rgba(99, 102, 241, 0.5), 0 0 60px rgba(99, 102, 241, 0.2); }
        }
        @keyframes memberGlow {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        @keyframes challengeShimmer {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }

        .my-squad-card {
            background: linear-gradient(145deg, rgba(99, 102, 241, 0.12) 0%, rgba(139, 92, 246, 0.08) 50%, rgba(168, 85, 247, 0.05) 100%);
            border-radius: 20px;
            border: 1px solid rgba(99, 102, 241, 0.25);
            padding: 24px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
            animation: squadPulse 4s ease-in-out infinite;
        }
        .my-squad-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.1), transparent);
            animation: shimmerSlide 4s ease-in-out infinite;
        }

        .squad-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            position: relative;
            z-index: 1;
        }

        .squad-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: 3px solid transparent;
            background: linear-gradient(135deg, #6366f1, #8b5cf6, #a855f7) border-box;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
            animation: memberGlow 3s ease-in-out infinite;
        }

        .squad-info {
            flex: 1;
        }

        .squad-name {
            font-size: 22px;
            font-weight: 800;
            margin-bottom: 4px;
            background: linear-gradient(135deg, #fff 0%, #c7d2fe 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 20px rgba(99, 102, 241, 0.3);
        }

        .squad-members {
            font-size: 14px;
            color: rgba(199, 210, 254, 0.8);
            font-weight: 500;
        }

        .squad-settings-btn {
            width: 42px;
            height: 42px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.15));
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 12px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .squad-settings-btn:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.35), rgba(139, 92, 246, 0.25));
            transform: rotate(45deg);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .weekly-challenge {
            background: linear-gradient(145deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.08));
            border: 1px solid rgba(99, 102, 241, 0.35);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        .weekly-challenge::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.1) 0%, transparent 60%);
            animation: rotate 20s linear infinite;
        }

        .challenge-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 16px;
            font-size: 15px;
            font-weight: 700;
            color: #c7d2fe;
            position: relative;
            z-index: 1;
        }

        .challenge-bar {
            background: rgba(30, 27, 75, 0.6);
            height: 28px;
            border-radius: 14px;
            overflow: hidden;
            margin-bottom: 10px;
            border: 1px solid rgba(99, 102, 241, 0.2);
            position: relative;
            z-index: 1;
        }

        .challenge-fill {
            height: 100%;
            background: linear-gradient(90deg, #6366f1, #8b5cf6, #a855f7, #8b5cf6);
            background-size: 200% 100%;
            animation: challengeShimmer 3s linear infinite;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.5);
            position: relative;
        }
        .challenge-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.2), transparent);
        }

        .challenge-label {
            text-align: center;
            font-size: 13px;
            color: rgba(199, 210, 254, 0.7);
            font-weight: 500;
            position: relative;
            z-index: 1;
        }

        .challenge-progress {
            width: 100%;
        }

        .squad-members-list {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .squad-members-list > div {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.05));
            border: 1px solid rgba(99, 102, 241, 0.15);
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
        }
        .squad-members-list > div:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.18), rgba(139, 92, 246, 0.1));
            transform: translateX(6px);
            border-color: rgba(99, 102, 241, 0.3);
        }

        .squad-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 14px;
            margin-top: 20px;
            position: relative;
            z-index: 1;
        }

        .squad-stat {
            text-align: center;
            background: linear-gradient(145deg, rgba(99, 102, 241, 0.12), rgba(139, 92, 246, 0.06));
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 14px;
            padding: 16px 10px;
            transition: all 0.3s ease;
        }
        .squad-stat:hover {
            background: linear-gradient(145deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.12));
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.25);
        }

        .squad-stat-value {
            font-size: 24px;
            font-weight: 900;
            background: linear-gradient(135deg, #818cf8, #c4b5fd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 4px;
        }

        .squad-stat-label {
            font-size: 11px;
            color: rgba(199, 210, 254, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .no-squad {
            text-align: center;
            padding: 50px 24px;
            background: linear-gradient(145deg, rgba(99, 102, 241, 0.08), rgba(139, 92, 246, 0.04));
            border: 1px dashed rgba(99, 102, 241, 0.3);
            border-radius: 20px;
            margin-bottom: 24px;
        }
        .no-squad h3 {
            font-size: 22px;
            font-weight: 800;
            background: linear-gradient(135deg, #c7d2fe, #818cf8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 12px;
        }
        .no-squad p {
            color: rgba(199, 210, 254, 0.7);
            font-size: 14px;
            line-height: 1.6;
            max-width: 280px;
            margin: 0 auto;
        }

        .cta-btn {
            width: 100%;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
            background-size: 200% auto;
            border: none;
            border-radius: 14px;
            padding: 18px;
            color: #fff;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 12px;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.35);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }
        /* Shimmer sweep effect */
        .cta-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.6s ease;
        }
        /* Glow effect on top */
        .cta-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .cta-btn:hover {
            background-position: right center;
            transform: translateY(-4px) scale(1.01);
            box-shadow: 0 10px 35px rgba(99, 102, 241, 0.6), 0 0 20px rgba(139, 92, 246, 0.3);
        }
        .cta-btn:hover::before {
            left: 100%;
        }
        .cta-btn:hover::after {
            opacity: 1;
        }
        .cta-btn:active {
            transform: translateY(-2px) scale(0.99);
            transition-duration: 0.1s;
        }

        .cta-btn-secondary {
            width: 100%;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.1));
            border: 2px solid rgba(99, 102, 241, 0.35);
            border-radius: 14px;
            padding: 16px;
            color: #c7d2fe;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .cta-btn-secondary:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.25), rgba(139, 92, 246, 0.18));
            border-color: rgba(99, 102, 241, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.2);
        }

        .section-header {
            margin-bottom: 16px;
        }

        .section-header h3 {
            font-size: 16px;
            margin: 0;
        }

        /* ===== OUTBREAKS / TANK BATTLE ===== */

        /* Battle Hero Scene */
        .battle-hero {
            text-align: center;
            padding: 24px 16px;
            margin-bottom: 20px;
        }
        .battle-scene {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }
        .battle-tank {
            display: flex;
            flex-direction: column;
            align-items: center;
            animation: tankBounce 1.5s ease-in-out infinite;
        }
        .battle-tank-hero {
            width: 140px;
        }
        .battle-tank-visual {
            width: 120px;
            height: auto;
            filter: drop-shadow(0 10px 22px rgba(0,0,0,0.45));
        }
        .tank-body {
            font-size: 48px;
            filter: drop-shadow(0 4px 12px rgba(94,234,212,0.5));
        }
        .tank-cannon {
            font-size: 20px;
            color: var(--primary);
            margin-top: -10px;
            animation: cannonPulse 0.5s ease-in-out infinite;
        }
        .tank-label {
            font-size: 10px;
            font-weight: 900;
            color: var(--primary);
            margin-top: 4px;
            letter-spacing: 2px;
        }
        @keyframes tankBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        @keyframes cannonPulse {
            0%, 100% { opacity: 0.5; transform: translateX(0); }
            50% { opacity: 1; transform: translateX(5px); }
        }
        .battle-vs {
            font-size: 32px;
            animation: vsPulse 1s ease-in-out infinite;
        }
        @keyframes vsPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        .battle-enemies {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 200px;
        }
        .enemy-monster {
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 6px;
            border-radius: 14px;
            background: rgba(24, 28, 38, 0.8);
            border: 1px solid rgba(255, 107, 53, 0.4);
            box-shadow: 0 8px 18px rgba(0,0,0,0.35);
            animation: enemyFloat 2s ease-in-out infinite;
        }
        .enemy-monster img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .enemy-monster.boss {
            width: 68px;
            height: 68px;
            border-color: rgba(255, 198, 0, 0.55);
            box-shadow: 0 10px 24px rgba(255, 198, 0, 0.25);
        }
        .enemy-1 { animation-delay: 0s; }
        .enemy-2 { animation-delay: 0.3s; }
        .enemy-3 { animation-delay: 0.6s; }
        @keyframes enemyFloat {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            25% { transform: translateX(3px) rotate(5deg); }
            75% { transform: translateX(-3px) rotate(-5deg); }
        }
        @keyframes treadSpin {
            0% { background: #555; }
            50% { background: #333; }
            100% { background: #555; }
        }
        @keyframes bossThrob {
            0%, 100% { transform: scale(1); filter: drop-shadow(0 0 15px #f39c12); }
            50% { transform: scale(1.15); filter: drop-shadow(0 0 25px #e74c3c) drop-shadow(0 0 40px #ff0000); }
        }
        .enemy-label {
            font-size: 10px;
            font-weight: 900;
            color: #ff4757;
            margin-top: 4px;
            letter-spacing: 2px;
        }
        .battle-title {
            font-size: 28px;
            font-weight: 900;
            background: linear-gradient(135deg, #ff4757 0%, #ff6348 50%, #ffb800 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
            text-shadow: 0 2px 20px rgba(220,38,38,0.3);
        }
        .battle-subtitle {
            color: var(--text2);
            font-size: 14px;
            margin-top: 8px;
        }

        /* Battle Stats */
        .battle-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 20px 0;
        }
        .battle-stat-card {
            background: rgba(0,0,0,0.3);
            border-radius: 16px;
            padding: 16px 8px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .battle-stat-card .stat-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        .battle-stat-card .stat-value {
            font-size: 18px;
            font-weight: 900;
            color: #fff;
        }
        .battle-stat-card .stat-label {
            font-size: 10px;
            color: var(--text3);
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Big Tank Play Button - DANGER THEMED for Outbreak */
        .tank-play-btn {
            width: 100%;
            padding: 24px;
            margin-top: 20px;
            background: linear-gradient(135deg, #ff4757 0%, #ff6348 50%, #ff4757 100%);
            background-size: 200% 100%;
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px rgba(220,38,38,0.5), inset 0 1px 0 rgba(255,255,255,0.2);
            animation: dangerPulse 3s ease-in-out infinite;
        }
        @keyframes dangerPulse {
            0%, 100% { background-position: 0% 0; box-shadow: 0 8px 32px rgba(220,38,38,0.4); }
            50% { background-position: 100% 0; box-shadow: 0 12px 48px rgba(255,99,72,0.6); }
        }
        .tank-play-btn:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 16px 48px rgba(220,38,38,0.6);
            animation: none;
            background-position: 100% 0;
        }
        .tank-play-btn:active {
            transform: scale(0.98);
        }
        .tank-btn-glow {
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transform: translateX(-100%);
            animation: btnShimmer 2s ease-in-out infinite;
        }
        @keyframes btnShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .tank-btn-content {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }
        .tank-btn-icon {
            font-size: 36px;
            filter: drop-shadow(0 4px 12px rgba(0,0,0,0.4));
            animation: tankIconBounce 2s ease-in-out infinite;
        }
        @keyframes tankIconBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }
        .tank-btn-text {
            font-size: 26px;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 3px 12px rgba(0,0,0,0.4);
            letter-spacing: 3px;
        }
        .tank-btn-sub {
            font-size: 13px;
            color: rgba(255,255,255,0.9);
            font-weight: 700;
            text-shadow: 0 1px 4px rgba(0,0,0,0.3);
        }

        /* Battle History */
        .battle-history {
            background: rgba(0,0,0,0.2);
            border-radius: 16px;
            padding: 20px;
        }
        .history-placeholder {
            text-align: center;
            color: var(--text3);
            font-size: 14px;
            padding: 20px;
        }

        /* PREMIUM OUTBREAKS PAGE - Complete Overhaul */
        .outbreak-card {
            background: linear-gradient(145deg, rgba(26,31,46,0.95) 0%, rgba(18,22,31,0.98) 100%);
            border-radius: 24px;
            border: 2px solid rgba(220,38,38,0.2);
            padding: 28px 24px;
            padding-top: 36px; /* Extra space for the badge */
            margin-top: 20px; /* Space for the overflowing badge */
            position: relative;
            margin-bottom: 28px;
            box-shadow:0 8px 32px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.03);
            overflow: visible; /* Allow badge to overflow */
        }
        .outbreak-card::before{
            content:'';position:absolute;top:0;left:0;right:0;height:4px;
            background:linear-gradient(90deg, #ff4757, #ff6348, #ff4757);
            background-size:200% 100%;
            animation:danger-pulse 2s ease-in-out infinite;
        }
        @keyframes danger-pulse{
            0%,100%{background-position:0% 0}
            50%{background-position:100% 0}
        }

        .active-outbreak {
            border-color: rgba(220,38,38,0.4);
            box-shadow: 0 0 48px rgba(255, 71, 87, 0.25), 0 8px 32px rgba(0,0,0,0.3);
            animation:outbreak-glow 3s ease-in-out infinite;
        }
        @keyframes outbreak-glow{
            0%,100%{box-shadow:0 0 40px rgba(220,38,38,0.2), 0 8px 32px rgba(0,0,0,0.3)}
            50%{box-shadow:0 0 60px rgba(220,38,38,0.35), 0 8px 32px rgba(0,0,0,0.3)}
        }

        .outbreak-badge {
            position: absolute;
            top: -14px;
            right: 24px;
            background: linear-gradient(135deg, #ff4757 0%, #ff6348 50%, #ff4757 100%);
            background-size:200% auto;
            animation:badge-shimmer 2s linear infinite;
            padding: 8px 20px;
            border-radius: 24px;
            font-size: 12px;
            font-weight: 900;
            text-transform:uppercase;letter-spacing:1px;
            box-shadow: 0 6px 20px rgba(255, 71, 87, 0.5);
        }
        @keyframes badge-shimmer{0%{background-position:100% 0}100%{background-position:-100% 0}}

        .outbreak-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .outbreak-card-header h2 {
            font-size: 22px;
            font-weight:900;
            margin: 0;
            background:linear-gradient(135deg, #fff 0%, #ff4757 100%);
            -webkit-background-clip:text;-webkit-text-fill-color:transparent;
        }

        .outbreak-difficulty {
            display: flex;
            gap: 3px;
            filter:drop-shadow(0 2px 4px rgba(220,38,38,0.3));
        }

        .outbreak-description {
            color: var(--text2);
            line-height: 1.7;
            margin: 0 0 24px;
            font-size:14px;
        }

        .outbreak-timer-big {
            background: linear-gradient(145deg, rgba(220,38,38,0.15) 0%, rgba(255,99,72,0.1) 100%);
            border: 1px solid rgba(255, 71, 87, 0.25);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            margin-bottom: 24px;
            box-shadow:inset 0 2px 8px rgba(0,0,0,0.1);
        }

        .timer-label {
            font-size: 12px;
            color: var(--text3);
            margin-bottom: 10px;
            text-transform:uppercase;letter-spacing:1px;font-weight:600;
        }

        .timer-display {
            font-size: 40px;
            font-weight: 900;
            color: #ff4757;
            font-variant-numeric: tabular-nums;
            text-shadow:0 0 30px rgba(220,38,38,0.4);
        }

        .outbreak-goals {
            display: grid;
            gap: 16px;
            margin-bottom: 24px;
        }

        .outbreak-goal {
            width: 100%;
        }

        .goal-progress {
            width: 100%;
        }

        .goal-bar {
            background: linear-gradient(145deg, rgba(26,31,46,0.9) 0%, rgba(18,22,31,0.95) 100%);
            height: 24px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 8px;
            box-shadow:inset 0 2px 4px rgba(0,0,0,0.2);
            border:1px solid rgba(255,255,255,0.05);
        }

        .goal-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #00ff88, var(--primary));
            background-size:200% 100%;
            animation:goal-shimmer 2s linear infinite;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow:0 0 20px rgba(94,234,212,0.4);
        }
        @keyframes goal-shimmer{0%{background-position:100% 0}100%{background-position:-100% 0}}

        .goal-label {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            font-weight:600;
        }

        .outbreak-rewards {
            background: linear-gradient(145deg, rgba(255,215,0,0.12) 0%, rgba(255,180,0,0.08) 100%);
            border: 1px solid rgba(255, 215, 0, 0.25);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .rewards-label {
            font-weight: 800;
            margin-bottom: 14px;
            color:var(--gold);
        }

        .reward-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .reward-pill {
            background: linear-gradient(145deg, rgba(255,215,0,0.15) 0%, rgba(255,180,0,0.1) 100%);
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight:600;
            border:1px solid rgba(255,215,0,0.2);
        }

        .outbreak-leaderboard {
            margin-bottom: 24px;
        }

        .leaderboard-header {
            font-weight: 800;
            margin-bottom: 14px;
            font-size:14px;
        }

        .outbreak-ctas {
            display: grid;
            gap: 14px;
        }

        /* ===== ANIMATIONS ===== */
        @keyframes slideInDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* ========== MOBILE RESPONSIVE MEDIA QUERIES ========== */
        
        /* Small phones: 320px - 480px */
        @media (max-width: 480px) {
            .game-cta-card {
                margin: 8px;
                padding: 12px;
            }
            .game-cta-stat-value {
                font-size: clamp(14px, 4vw, 18px);
            }
            .game-cta-stat-label {
                font-size: clamp(8px, 2.5vw, 10px);
            }
            .game-cta-btn {
                padding: clamp(12px, 3vw, 16px);
                font-size: clamp(14px, 3.5vw, 16px);
            }
            .vote-btn {
                max-width: 80px;
            }
            .modal {
                max-width: 90vw;
            }
        }
        
        /* Tablets: 768px+ */
        @media (min-width: 768px) {
            .vote-btn {
                max-width: 120px;
            }
            .modal {
                max-width: 480px;
            }
        }
        
        /* Landscape orientation */
        @media (orientation: landscape) {
            .toast-container {
                bottom: calc(20px + var(--safe-bottom));
            }
            .game-nav {
                padding: 4px 0;
            }
        }

        /* ====================================
           QUEST SYSTEM STYLES
           ==================================== */

        /* Quests Popup - Floating on Home Screen */
        .quests-popup {
            position: fixed;
            top: 120px;
            right: 16px;
            width: 320px;
            max-width: calc(100vw - 32px);
            max-height: 70vh;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.98) 0%, rgba(30, 41, 59, 0.95) 100%);
            border: 2px solid rgba(94, 234, 212, 0.3);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 40px rgba(94, 234, 212, 0.15);
            z-index: 1000;
            overflow: hidden;
            animation: popupSlideIn 0.3s ease-out;
        }
        @keyframes popupSlideIn {
            from { opacity: 0; transform: translateY(-20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .quests-popup-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: linear-gradient(135deg, rgba(94, 234, 212, 0.15) 0%, rgba(20, 184, 166, 0.1) 100%);
            border-bottom: 1px solid rgba(94, 234, 212, 0.2);
        }
        .quests-popup-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 700;
            color: var(--primary, #5eead4);
        }
        .popup-close {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: var(--text2, #94a3b8);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .popup-close:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.5);
            color: #ef4444;
        }
        .quests-popup-body {
            padding: 16px;
            max-height: 350px;
            overflow-y: auto;
        }
        .quests-popup-footer {
            padding: 12px 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            background: rgba(0, 0, 0, 0.2);
        }
        .quests-popup-footer button { width: 100%; }
        .popup-quest-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-bottom: 10px;
            transition: all 0.2s ease;
        }
        .popup-quest-item:hover {
            background: rgba(94, 234, 212, 0.1);
            border-color: rgba(94, 234, 212, 0.2);
        }
        .popup-quest-item.claimable {
            border-color: var(--primary, #5eead4);
            background: rgba(94, 234, 212, 0.15);
        }
        .popup-quest-icon { font-size: 24px; width: 40px; text-align: center; }
        .popup-quest-info { flex: 1; min-width: 0; }
        .popup-quest-title { font-size: 13px; font-weight: 600; color: var(--text, #f1f5f9); margin-bottom: 4px; }
        .popup-quest-progress { font-size: 11px; color: var(--text2, #94a3b8); }
        .popup-quest-reward { display: flex; align-items: center; gap: 4px; font-size: 12px; font-weight: 700; color: #fcd34d; }
        @media (max-width: 480px) {
            .quests-popup { right: 8px; left: 8px; width: auto; }
        }

        /* ═══════════════════════════════════════════════════════════════════ */
        /* QUESTS VIEW - POLISHED                                               */
        /* ═══════════════════════════════════════════════════════════════════ */

        /* Quest Summary Card - Top of page */
        .quest-summary-card {
            background: linear-gradient(135deg, rgba(94,234,212,0.15) 0%, rgba(34,211,238,0.1) 100%);
            border: 1px solid rgba(94,234,212,0.3);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-around;
            text-align: center;
        }
        .quest-summary-stat {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .quest-summary-value {
            font-size: 28px;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary) 0%, var(--cyan) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .quest-summary-label {
            font-size: 11px;
            color: var(--text3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .quest-section {
            margin-bottom: 24px;
        }
        .quest-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }
        .quest-section-header h3 {
            font-size: 16px;
            font-weight: 800;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .quest-timer {
            font-size: 12px;
            color: var(--text3);
            font-weight: 600;
            padding: 4px 10px;
            background: rgba(99,102,241,0.15);
            border-radius: 20px;
            transition: all 0.3s;
        }
        .quest-timer.urgent {
            background: rgba(239,68,68,0.2);
            color: #ef4444;
            animation: pulse-urgent 1s ease-in-out infinite;
        }
        @keyframes pulse-urgent {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .quest-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .quest-card {
            background: linear-gradient(135deg, rgba(15,23,42,0.9) 0%, rgba(30,41,59,0.8) 100%);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .quest-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(94,234,212,0.1), transparent);
            transition: left 0.5s;
        }
        .quest-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 20px rgba(94,234,212,0.15);
            transform: translateY(-2px);
        }
        .quest-card:hover::before {
            left: 100%;
        }
        .quest-card.claimable {
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(94,234,212,0.2);
            animation: glow-pulse 2s ease-in-out infinite;
        }
        @keyframes glow-pulse {
            0%, 100% { box-shadow: 0 0 15px rgba(94,234,212,0.15); }
            50% { box-shadow: 0 0 25px rgba(94,234,212,0.3); }
        }
        .quest-card.completed {
            opacity: 0.5;
            background: var(--surface2);
            border-style: dashed;
        }
        .quest-card.completed::after {
            content: '✓';
            position: absolute;
            top: 8px;
            right: 12px;
            font-size: 16px;
            color: var(--success);
        }
        .quest-icon {
            font-size: 36px;
            min-width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(94,234,212,0.1);
            border-radius: 12px;
        }
        .quest-info {
            flex: 1;
            min-width: 0;
        }
        .quest-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 4px;
        }
        .quest-desc {
            font-size: 11px;
            color: var(--text3);
            margin-bottom: 8px;
            line-height: 1.4;
        }
        .quest-progress {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .quest-progress-bar {
            flex: 1;
            height: 8px;
            background: rgba(30,41,59,0.8);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        .quest-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--cyan), var(--primary));
            background-size: 200% 100%;
            border-radius: 10px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            animation: progress-shimmer 2s linear infinite;
            position: relative;
        }
        @keyframes progress-shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .quest-progress-fill.complete {
            background: linear-gradient(90deg, var(--success), #4ade80);
            animation: none;
        }
        .quest-progress-text {
            font-size: 12px;
            font-weight: 700;
            color: var(--text2);
            min-width: 55px;
            text-align: right;
            white-space: nowrap;
        }
        .quest-reward {
            text-align: center;
            min-width: 65px;
            padding: 8px;
            background: rgba(252,211,77,0.1);
            border-radius: 10px;
            border: 1px solid rgba(252,211,77,0.2);
        }
        .quest-reward-value {
            font-size: 18px;
            font-weight: 900;
            color: var(--gold);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        .quest-reward-label {
            font-size: 9px;
            color: var(--text3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
        }
        .quest-claim-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--cyan) 100%);
            color: #0a0d14;
            border: none;
            padding: 10px 18px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }
        .quest-claim-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.4s;
        }
        .quest-claim-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 4px 15px rgba(94,234,212,0.4);
        }
        .quest-claim-btn:hover::after {
            left: 100%;
        }
        .quest-claim-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }
        .quest-claim-btn:disabled:hover {
            box-shadow: none;
        }
        .quest-claim-btn:disabled::after {
            display: none;
        }

        /* Mobile adjustments */
        @media (max-width: 480px) {
            .quest-summary-card {
                padding: 16px 10px;
            }
            .quest-summary-value {
                font-size: 22px;
            }
            .quest-card {
                padding: 12px;
                flex-wrap: wrap;
            }
            .quest-icon {
                font-size: 28px;
                min-width: 40px;
                height: 40px;
            }
            .quest-reward {
                min-width: auto;
                padding: 6px 10px;
            }
            .quest-claim-btn {
                padding: 8px 14px;
                font-size: 11px;
            }
        }

        /* ====================================
           CHARACTER DESIGNER SYSTEM
           Full piece-by-piece avatar builder
           ==================================== */

        /* Character Stage - The main preview area */
        .character-stage {
            position: relative;
            width: 100%;
            max-width: 360px;
            height: 320px;
            margin: 0 auto 24px;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            border-radius: 20px;
            border: 3px solid #1abc9c;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(26, 188, 156, 0.3), inset 0 0 60px rgba(26, 188, 156, 0.1);
        }

        /* Animated background grid */
        .character-stage::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image:
                linear-gradient(rgba(26, 188, 156, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(26, 188, 156, 0.1) 1px, transparent 1px);
            background-size: 30px 30px;
            animation: gridScroll 20s linear infinite;
        }
        @keyframes gridScroll {
            0% { transform: translate(0, 0); }
            100% { transform: translate(30px, 30px); }
        }

        /* Spotlight effect */
        .character-stage::after {
            content: '';
            position: absolute;
            top: -50%;
            left: 50%;
            transform: translateX(-50%);
            width: 200%;
            height: 100%;
            background: radial-gradient(ellipse at center, rgba(26, 188, 156, 0.15) 0%, transparent 60%);
            pointer-events: none;
        }

        /* Character Container */
        .character-container {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 140px;
            height: 220px;
            z-index: 10;
        }

        /* Character Body Parts - Layered system */
        .character-part {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            cursor: pointer;
            z-index: 5;
        }
        .character-part:hover {
            transform: scale(1.1);
            filter: brightness(1.2);
        }
        .character-part.selected {
            animation: partGlow 1s ease-in-out infinite;
        }
        @keyframes partGlow {
            0%, 100% { filter: drop-shadow(0 0 8px #1abc9c); }
            50% { filter: drop-shadow(0 0 20px #1abc9c); }
        }

        /* Head slot */
        .char-head {
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 70px;
            height: 70px;
            font-size: 50px;
            z-index: 10;
        }

        /* Hat slot (above head) */
        .char-hat {
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 50px;
            font-size: 36px;
            z-index: 11;
        }

        /* Glasses slot (on face) */
        .char-glasses {
            top: 25px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 20px;
            font-size: 28px;
            z-index: 12;
        }

        /* Torso slot */
        .char-torso {
            top: 65px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 70px;
            font-size: 52px;
            z-index: 8;
        }

        /* Left Arm */
        .char-left-arm {
            top: 70px;
            left: 5px;
            width: 35px;
            height: 60px;
            font-size: 32px;
            z-index: 7;
        }

        /* Right Arm */
        .char-right-arm {
            top: 70px;
            right: 5px;
            width: 35px;
            height: 60px;
            font-size: 32px;
            z-index: 7;
        }

        /* Weapon (in right hand) */
        .char-weapon {
            top: 85px;
            right: -15px;
            width: 45px;
            height: 45px;
            font-size: 36px;
            z-index: 9;
            transform: rotate(-20deg);
        }

        /* Legs slot */
        .char-legs {
            top: 130px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 70px;
            font-size: 42px;
            z-index: 6;
        }

        .character-part {
            color: var(--text);
        }

        .char-head {
            background: url('assets/avatar/avatar-head.svg') center/contain no-repeat;
            border: none;
            border-radius: 0;
            font-size: 0;
        }
        .char-torso {
            background: url('assets/avatar/avatar-torso.svg') center/contain no-repeat;
            border: none;
            border-radius: 0;
            font-size: 0;
        }
        .char-left-arm {
            background: url('assets/avatar/avatar-arm.svg') center/contain no-repeat;
            border: none;
            border-radius: 0;
            font-size: 0;
        }
        .char-right-arm {
            background: url('assets/avatar/avatar-arm.svg') center/contain no-repeat;
            transform: scaleX(-1);
            transform-origin: center center;
            border: none;
            border-radius: 0;
            font-size: 0;
        }
        .char-legs {
            background: url('assets/avatar/avatar-legs.svg') center/contain no-repeat;
            border: none;
            border-radius: 0;
            font-size: 0;
        }
        .char-weapon,
        .char-hat,
        .char-glasses,
        .char-back,
        .char-pet {
            font-size: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* Placeholder icons for empty accessory slots */
        .char-weapon:empty::before { content: '⚔️'; font-size: 24px; opacity: 0.3; }
        .char-hat:empty::before { content: '🎩'; font-size: 24px; opacity: 0.3; }
        .char-glasses:empty::before { content: '👓'; font-size: 20px; opacity: 0.3; }
        .char-back:empty::before { content: '🦋'; font-size: 24px; opacity: 0.3; }
        .char-pet:empty::before { content: '🐾'; font-size: 20px; opacity: 0.3; }
        .avatar-item-icon {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(124,77,255,0.15);
            border: 1px solid rgba(124,77,255,0.4);
            box-shadow: 0 0 12px rgba(124,77,255,0.25);
        }

        .character-extra-layer {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 6;
        }
        .char-extra-arm,
        .char-extra-leg {
            position: absolute;
            border: 3px solid #0b0f18;
            border-radius: 18px;
            background: linear-gradient(180deg, #23314a 0%, #0b111d 100%);
        }

        .tank-body img.tank-visual {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 8px 20px rgba(0,0,0,0.45));
        }

        .mutation-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        .mutation-control {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 12px 14px;
            border-radius: 14px;
            background: rgba(18,22,31,0.85);
            border: 1px solid rgba(124,77,255,0.3);
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
        }
        .mutation-btn {
            width: 30px;
            height: 30px;
            border-radius: 10px;
            border: 1px solid rgba(124,77,255,0.4);
            background: rgba(124,77,255,0.15);
            color: var(--text);
            font-weight: 700;
            cursor: pointer;
        }

        /* Back item (cape, wings, etc) */
        .char-back {
            top: 55px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 90px;
            font-size: 60px;
            z-index: 4;
            opacity: 0.9;
        }

        /* Pet companion */
        .char-pet {
            bottom: 10px;
            right: -30px;
            width: 50px;
            height: 50px;
            font-size: 36px;
            z-index: 15;
            animation: petBounce 1.5s ease-in-out infinite;
        }
        @keyframes petBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        /* Effect/Aura layer */
        .char-effect {
            position: absolute;
            inset: -20px;
            pointer-events: none;
            z-index: 3;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .effect-particles {
            position: absolute;
            inset: 0;
        }

        /* Tank Riding Mode */
        .tank-ride-container {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 160px;
            height: 100px;
            z-index: 2;
            display: none;
        }
        .tank-ride-container.active {
            display: block;
            animation: tankIdle 2s ease-in-out infinite;
        }
        @keyframes tankIdle {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-3px); }
        }

        .tank-body {
            position: relative;
            width: 100%;
            height: 100%;
        }

        /* ASCII Tank Art */
        .tank-hull {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            font-family: monospace;
            font-size: 14px;
            line-height: 1;
            color: #2ecc71;
            text-shadow: 0 0 10px #2ecc71;
            white-space: pre;
            letter-spacing: 0;
        }

        .tank-turret {
            position: absolute;
            bottom: 45px;
            left: 50%;
            transform: translateX(-50%);
            font-family: monospace;
            font-size: 12px;
            line-height: 1;
            color: #27ae60;
            text-shadow: 0 0 8px #27ae60;
            white-space: pre;
        }

        .tank-treads {
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            font-family: monospace;
            font-size: 10px;
            line-height: 1;
            color: #16a085;
            white-space: pre;
            animation: treadMove 0.3s linear infinite;
        }
        @keyframes treadMove {
            0% { letter-spacing: 0; }
            50% { letter-spacing: 1px; }
            100% { letter-spacing: 0; }
        }

        /* Rider position on tank */
        .character-container.riding {
            bottom: 85px;
            transform: translateX(-50%) scale(0.75);
        }

        /* Ground shadow */
        .character-shadow {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 15px;
            background: radial-gradient(ellipse, rgba(0,0,0,0.4) 0%, transparent 70%);
            z-index: 1;
        }

        /* Mode Toggle Buttons */
        .character-mode-toggle {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 8px;
            z-index: 20;
        }
        .mode-btn {
            padding: 8px 12px;
            background: rgba(26, 188, 156, 0.2);
            border: 2px solid #1abc9c;
            border-radius: 8px;
            color: white;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }
        .mode-btn:hover, .mode-btn.active {
            background: #1abc9c;
            transform: scale(1.05);
        }

        /* Character Name Display */
        .character-name-display {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 6px 16px;
            border-radius: 20px;
            border: 1px solid #1abc9c;
            z-index: 20;
        }
        .character-name-display span {
            color: #1abc9c;
            font-size: 14px;
            font-weight: 700;
        }

        /* Equipment Slots Panel */
        .equipment-slots {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
            padding: 16px;
            background: linear-gradient(135deg, rgba(26, 188, 156, 0.1), rgba(22, 160, 133, 0.05));
            border-radius: 16px;
            border: 2px solid rgba(26, 188, 156, 0.3);
        }

        .equip-slot {
            aspect-ratio: 1;
            background: rgba(0, 0, 0, 0.3);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            min-height: 70px;
        }
        .equip-slot:hover {
            border-color: #1abc9c;
            background: rgba(26, 188, 156, 0.2);
            transform: translateY(-2px);
        }
        .equip-slot.filled {
            border-style: solid;
            border-color: #1abc9c;
            background: linear-gradient(135deg, rgba(26, 188, 156, 0.2), rgba(22, 160, 133, 0.1));
        }

        .equip-slot-icon {
            font-size: 28px;
            margin-bottom: 4px;
        }
        .equip-slot-label {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .equip-slot .unequip-btn {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 20px;
            height: 20px;
            background: #e74c3c;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 12px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .equip-slot.filled:hover .unequip-btn {
            display: flex;
        }

        /* Rarity borders for equipped items */
        .equip-slot.rarity-common { border-color: #95a5a6; }
        .equip-slot.rarity-uncommon { border-color: #3498db; }
        .equip-slot.rarity-rare { border-color: #9b59b6; }
        .equip-slot.rarity-epic { border-color: #f39c12; box-shadow: 0 0 15px rgba(243, 156, 18, 0.3); }
        .equip-slot.rarity-legendary {
            border-color: #e74c3c;
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.4);
            animation: legendarySlotGlow 2s ease-in-out infinite;
        }
        @keyframes legendarySlotGlow {
            0%, 100% { box-shadow: 0 0 15px rgba(231, 76, 60, 0.4); }
            50% { box-shadow: 0 0 30px rgba(231, 76, 60, 0.7); }
        }

        /* Body Part Tabs */
        .body-part-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .body-part-tab {
            padding: 8px 14px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: #bbb;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .body-part-tab:hover {
            background: rgba(26, 188, 156, 0.2);
            border-color: #1abc9c;
            color: white;
        }
        .body-part-tab.active {
            background: linear-gradient(135deg, #1abc9c, #16a085);
            border-color: #0d7a5f;
            color: white;
        }

        /* Items Grid for selection */
        .items-selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
            padding: 4px;
        }

        .item-card {
            aspect-ratio: 1;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            padding: 8px;
        }
        .item-card:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        .item-card.equipped {
            border-color: #f39c12;
            background: rgba(243, 156, 18, 0.15);
        }
        .item-card.equipped::after {
            content: '✓';
            position: absolute;
            top: 4px;
            right: 4px;
            width: 18px;
            height: 18px;
            background: #f39c12;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
        }
        .item-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .item-card.locked::before {
            content: '🔒';
            position: absolute;
            font-size: 20px;
        }

        .item-card-icon {
            font-size: 36px;
            margin-bottom: 4px;
        }
        .item-card-name {
            font-size: 10px;
            color: white;
            text-align: center;
            line-height: 1.2;
        }
        .item-card-price {
            font-size: 10px;
            color: #f39c12;
            margin-top: 2px;
        }

        /* Rarity colors for item cards */
        .item-card.rarity-common { border-color: #95a5a6; }
        .item-card.rarity-uncommon { border-color: #3498db; }
        .item-card.rarity-rare { border-color: #9b59b6; }
        .item-card.rarity-epic {
            border-color: #f39c12;
            box-shadow: 0 0 10px rgba(243, 156, 18, 0.2);
        }
        .item-card.rarity-legendary {
            border-color: #e74c3c;
            box-shadow: 0 0 15px rgba(231, 76, 60, 0.3);
            animation: cardGlow 2s ease-in-out infinite;
        }
        @keyframes cardGlow {
            0%, 100% { box-shadow: 0 0 10px rgba(231, 76, 60, 0.3); }
            50% { box-shadow: 0 0 25px rgba(231, 76, 60, 0.6); }
        }

        /* Section headers */
        .designer-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .designer-section-header h3 {
            font-size: 16px;
            font-weight: 700;
            color: #1abc9c;
            margin: 0;
        }
        .designer-section-header .item-count {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
        }

        /* Legacy support for old preview */
        .avatar-preview-section {
            margin-bottom: 24px;
        }
        .avatar-preview-section h3 {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--text1);
        }
        .avatar-preview-large {
            width: 120px;
            height: 120px;
            margin: 0 auto;
            position: relative;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--surface), var(--surface2));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: 900;
            color: var(--text1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .avatar-preview-frame {
            position: absolute;
            inset: -8px;
            border-radius: 50%;
            pointer-events: none;
        }
        .avatar-preview-effects {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            pointer-events: none;
        }

        .cosmetic-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .cosmetic-tab {
            flex: 1;
            min-width: 80px;
            padding: 10px 12px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            color: var(--text2);
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .cosmetic-tab:hover {
            border-color: var(--primary);
        }
        .cosmetic-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .cosmetic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }
        .cosmetic-item {
            aspect-ratio: 1;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .cosmetic-item:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(94,234,212,0.2);
        }
        .cosmetic-item.equipped {
            border-color: var(--primary);
            background: rgba(94,234,212,0.1);
        }
        .cosmetic-item.locked {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .cosmetic-item-icon {
            font-size: 32px;
            margin-bottom: 4px;
        }
        .cosmetic-item-name {
            font-size: 10px;
            font-weight: 700;
            color: var(--text2);
            text-align: center;
        }
        .cosmetic-item-rarity {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .rarity-common { background: #95a5a6; }
        .rarity-rare { background: #3498db; }
        .rarity-epic { background: #9b59b6; }
        .rarity-legendary { background: #f1c40f; }

        .cosmetic-item-badge {
            position: absolute;
            top: 4px;
            left: 4px;
            background: var(--primary);
            color: white;
            font-size: 8px;
            font-weight: 700;
            padding: 2px 4px;
            border-radius: 4px;
            text-transform: uppercase;
        }

        /* ====================================
           GACHA SYSTEM STYLES
           ==================================== */
        .gacha-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 2px solid var(--border);
        }
        .gacha-banner {
            background: linear-gradient(135deg, rgba(94,234,212,0.1), rgba(0,229,184,0.05));
            border: 2px solid var(--primary);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
        }
        .gacha-banner h3 {
            font-size: 18px;
            font-weight: 900;
            color: var(--text1);
            margin-bottom: 4px;
        }
        .gacha-banner p {
            font-size: 12px;
            color: var(--text3);
            margin-bottom: 16px;
        }
        .gacha-costs {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        .gacha-btn {
            flex: 1;
            max-width: 150px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .gacha-btn:hover {
            background: #00B88C;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(94,234,212,0.3);
        }
        .gacha-btn-multi {
            background: linear-gradient(135deg, var(--primary), #00E5B8);
        }
        .gacha-discount {
            font-size: 10px;
            background: #FFD700;
            color: #000;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 900;
        }

        .gacha-result-content {
            max-width: 500px;
        }
        .gacha-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .gacha-result-header h2 {
            font-size: 24px;
            font-weight: 900;
            color: var(--text1);
        }
        .gacha-results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        .gacha-result-item {
            background: var(--surface2);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            position: relative;
            animation: gacha-reveal 0.5s ease-out;
        }
        .gacha-result-item-icon {
            font-size: 48px;
            margin-bottom: 8px;
        }
        .gacha-result-item-name {
            font-size: 12px;
            font-weight: 700;
            color: var(--text1);
            margin-bottom: 4px;
        }
        .gacha-result-item-rarity {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }
        .gacha-result-item.new::before {
            content: "NEW!";
            position: absolute;
            top: 8px;
            right: 8px;
            background: #FFD700;
            color: #000;
            font-size: 8px;
            font-weight: 900;
            padding: 2px 6px;
            border-radius: 4px;
        }
        @keyframes gacha-reveal {
            0% {
                opacity: 0;
                transform: scale(0) rotate(-180deg);
            }
            60% {
                transform: scale(1.1) rotate(10deg);
            }
            100% {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
        }
        .gacha-result-actions {
            display: flex;
            gap: 12px;
        }
        .gacha-result-actions button {
            flex: 1;
        }

        /* ========================================= */
        /* CURRENCY BAR (Sticky below header)        */
        /* ========================================= */
        .currency-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 14px;
            background: linear-gradient(135deg, rgba(0,0,0,0.5), rgba(20,20,40,0.7));
            border-bottom: 1px solid rgba(99, 102, 241, 0.15);
            position: sticky;
            top: 65px;
            z-index: 99;
            backdrop-filter: blur(8px);
        }
        .currency-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: rgba(255, 255, 255, 0.04);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        .currency-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px) scale(1.05);
            border-color: rgba(255, 255, 255, 0.15);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .currency-item:active {
            transform: translateY(0) scale(1);
            transition-duration: 0.1s;
        }
        .currency-item.coins {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(245, 158, 11, 0.08));
            border-color: rgba(251, 191, 36, 0.25);
        }
        .currency-item.keys {
            background: linear-gradient(135deg, rgba(34, 211, 238, 0.15), rgba(6, 182, 212, 0.08));
            border-color: rgba(34, 211, 238, 0.25);
        }
        .currency-item.gems {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(139, 92, 246, 0.08));
            border-color: rgba(168, 85, 247, 0.25);
        }
        .currency-item .currency-icon { font-size: 22px; }
        .currency-value { font-weight: 700; font-size: 15px; }
        .currency-item.coins .currency-value { color: #fcd34d; }
        .currency-item.keys .currency-value { color: #22d3ee; }
        .currency-item.gems .currency-value { color: #c084fc; }

        /* ========================================= */
        /* NEW PROFILE CARD LAYOUT                   */
        /* ========================================= */
        .profile-section { padding: 16px; }

        .profile-top-area {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            margin-bottom: 14px;
        }
        .profile-avatar-lg {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1e1b4b, #312e81);
            border: 6px solid #6366f1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
            box-shadow: 0 8px 32px rgba(99, 102, 241, 0.5);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            flex-shrink: 0;
        }
        .profile-avatar-lg:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 40px rgba(99, 102, 241, 0.7);
        }
        .profile-middle-col {
            flex: 1;
            min-width: 0;
        }
        .profile-name-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 3px;
        }
        .profile-username {
            font-size: 18px;
            font-weight: 900;
            color: #fff;
        }
        .profile-level-badge {
            background: linear-gradient(135deg, #fcd34d, #f59e0b);
            color: #000;
            font-size: 10px;
            font-weight: 800;
            padding: 2px 8px;
            border-radius: 10px;
        }
        .profile-title {
            font-size: 11px;
            color: #a78bfa;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .profile-xp-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .profile-xp-bar-container {
            flex: 1;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 6px;
            height: 8px;
            overflow: hidden;
        }
        .profile-xp-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #22d3ee, #8b5cf6);
            border-radius: 6px;
            transition: width 0.5s ease;
        }
        .profile-xp-text {
            font-size: 10px;
            color: #a3a3a3;
            white-space: nowrap;
        }

        /* Right action buttons */
        .profile-right-actions {
            display: flex;
            flex-direction: column;
            gap: 6px;
            align-items: flex-end;
        }
        .profile-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.15);
            background: rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .profile-action-btn:hover {
            background: rgba(255,255,255,0.1);
            transform: translateY(-2px);
        }
        .profile-action-btn.customize {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.25), rgba(99, 102, 241, 0.15));
            border-color: rgba(139, 92, 246, 0.4);
        }
        .profile-action-btn.shop {
            background: linear-gradient(135deg, rgba(34, 211, 238, 0.2), rgba(6, 182, 212, 0.1));
            border-color: rgba(34, 211, 238, 0.4);
        }
        .profile-action-btn.vera {
            background: linear-gradient(135deg, rgba(45, 212, 191, 0.2), rgba(20, 184, 166, 0.1));
            border-color: rgba(45, 212, 191, 0.4);
        }

        /* Stats Grid */
        .profile-stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 14px;
        }
        .profile-stat-card {
            background: rgba(255, 255, 255, 0.04);
            padding: 10px 6px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        /* Shimmer on hover */
        .profile-stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(94,234,212,0.15), transparent);
            transition: left 0.5s ease;
            pointer-events: none;
        }
        .profile-stat-card:hover::before {
            left: 100%;
        }
        .profile-stat-card:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-4px) scale(1.03);
            border-color: rgba(94, 234, 212, 0.3);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3), 0 0 16px rgba(94,234,212,0.15);
        }
        .profile-stat-card:active {
            transform: translateY(-2px) scale(0.99);
            transition-duration: 0.1s;
        }
        .profile-stat-card .stat-icon { font-size: 18px; margin-bottom: 4px; }
        .profile-stat-card .stat-value { font-size: 14px; font-weight: 800; }
        .profile-stat-card .stat-label { font-size: 8px; color: #a3a3a3; text-transform: uppercase; margin-top: 2px; }
        .profile-stat-card .tap-hint { font-size: 7px; color: #555; margin-top: 2px; }

        /* ========================================= */
        /* COLLAPSIBLE BEAST SECTION                 */
        /* ========================================= */
        .profile-section-label {
            font-size: 9px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .profile-section-label::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgba(255,255,255,0.1);
        }
        .beast-section {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.12), rgba(168, 85, 247, 0.08));
            border: 1px solid rgba(139, 92, 246, 0.25);
            border-radius: 14px;
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
        }
        .beast-section::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.1) 0%, transparent 60%);
            animation: beastGlow 4s ease-in-out infinite;
            pointer-events: none;
        }
        @keyframes beastGlow {
            0%, 100% { transform: translate(0, 0); opacity: 0.5; }
            50% { transform: translate(10%, 10%); opacity: 1; }
        }
        .beast-collapsed {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            cursor: pointer;
            position: relative;
            z-index: 1;
        }
        .beast-avatar {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            background: linear-gradient(135deg, #2d1b4e 0%, #1a0f2e 100%);
            border: 2px solid rgba(168, 85, 247, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.4);
            flex-shrink: 0;
        }
        .beast-info { flex: 1; min-width: 0; }
        .beast-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 2px;
            flex-wrap: wrap;
        }
        .beast-name { font-size: 14px; font-weight: 800; color: #e9d5ff; }
        .beast-level {
            background: linear-gradient(135deg, #a855f7, #7c3aed);
            color: #fff;
            font-size: 9px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 6px;
        }
        .beast-rarity {
            font-size: 8px;
            font-weight: 700;
            padding: 2px 5px;
            border-radius: 5px;
        }
        .beast-rarity.common { background: rgba(148, 163, 184, 0.3); color: #94a3b8; }
        .beast-rarity.uncommon { background: rgba(34, 197, 94, 0.3); color: #4ade80; }
        .beast-rarity.rare { background: rgba(59, 130, 246, 0.3); color: #60a5fa; }
        .beast-rarity.epic { background: rgba(168, 85, 247, 0.3); color: #c084fc; }
        .beast-rarity.legendary {
            background: linear-gradient(135deg, #fcd34d, #f59e0b);
            color: #000;
        }
        .beast-type { font-size: 10px; color: #a78bfa; }
        .beast-stats-mini {
            display: flex;
            gap: 8px;
            margin-top: 4px;
        }
        .beast-stat { font-size: 9px; color: #888; }
        .beast-stat span { color: #c4b5fd; font-weight: 700; }
        .beast-toggle {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid rgba(139, 92, 246, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }
        /* Shimmer effect on beast toggle */
        .beast-toggle::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }
        .beast-toggle:hover::before {
            left: 100%;
        }
        .beast-toggle:hover {
            background: rgba(139, 92, 246, 0.35);
            transform: scale(1.15) rotate(5deg);
            border-color: rgba(139, 92, 246, 0.6);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }
        .beast-toggle:active {
            transform: scale(1.05) rotate(0deg);
            transition-duration: 0.1s;
        }
        .beast-toggle.expanded {
            background: rgba(139, 92, 246, 0.5);
            transform: rotate(180deg);
        }
        .beast-toggle.expanded:hover {
            transform: rotate(180deg) scale(1.15);
        }

        /* Expanded state */
        .beast-expanded {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            padding: 0 12px;
            position: relative;
            z-index: 1;
        }
        .beast-section.open .beast-expanded {
            max-height: 300px;
            padding: 0 12px 12px;
        }
        .beast-divider {
            height: 1px;
            background: rgba(139, 92, 246, 0.2);
            margin-bottom: 12px;
        }
        .beast-full-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        .beast-stat-box {
            background: rgba(0,0,0,0.2);
            padding: 8px;
            border-radius: 8px;
            text-align: center;
        }
        .beast-stat-box .val { font-size: 16px; font-weight: 800; color: #c4b5fd; }
        .beast-stat-box .lbl { font-size: 8px; color: #888; text-transform: uppercase; }
        .beast-xp-section {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        .beast-xp-label { font-size: 10px; color: #a78bfa; font-weight: 600; }
        .beast-xp-bar {
            flex: 1;
            height: 8px;
            background: rgba(0,0,0,0.4);
            border-radius: 4px;
            overflow: hidden;
        }
        .beast-xp-fill {
            height: 100%;
            background: linear-gradient(90deg, #a855f7, #f472b6);
            width: 0%;
            transition: width 0.5s ease;
        }
        .beast-xp-text { font-size: 10px; color: #888; }
        .beast-actions { display: flex; gap: 8px; }
        .beast-btn {
            flex: 1;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid rgba(168, 85, 247, 0.3);
            background: rgba(168, 85, 247, 0.1);
            color: #c4b5fd;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.2s;
        }
        .beast-btn:hover {
            background: rgba(168, 85, 247, 0.2);
            transform: translateY(-2px);
        }
        .beast-btn.primary {
            background: linear-gradient(135deg, #a855f7, #7c3aed);
            border: none;
            color: #fff;
        }
        .beast-btn.primary:hover { box-shadow: 0 4px 16px rgba(168, 85, 247, 0.4); }

        /* Header title - responsive */
        .header-title {
            margin: 0;
            font-size: 24px;
            font-weight: 900;
            cursor: pointer;
            background: linear-gradient(90deg, #22d3ee, #8b5cf6, #f472b6, #22d3ee);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientFlow 3s ease infinite;
            white-space: nowrap;
            letter-spacing: -0.5px;
        }
        @media (max-width: 480px) {
            .header-title { font-size: 16px; }
            .title-hub { display: none; }
        }
        @media (max-width: 360px) {
            .header-title { font-size: 14px; }
        }

        /* Mobile responsiveness for profile */
        @media (max-width: 480px) {
            .profile-top-area {
                gap: 10px;
            }
            .profile-avatar-lg {
                width: 80px;
                height: 80px;
                font-size: 40px;
                border-width: 3px;
            }
            .profile-username {
                font-size: 16px;
            }
            .profile-level-badge {
                font-size: 9px;
                padding: 2px 6px;
            }
            .profile-title {
                font-size: 10px;
            }
            .profile-actions-col {
                gap: 4px;
            }
            .action-icon-btn {
                width: 28px;
                height: 28px;
                font-size: 14px;
            }
            .profile-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .beast-full-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            .beast-actions {
                flex-wrap: wrap;
            }
            .beast-btn {
                flex: 1 1 45%;
            }
        }

        /* Feature Badge System - Inline with game titles */
        .feature-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 9px;
            font-weight: 800;
            padding: 3px 8px;
            border-radius: 6px;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .feature-badge.featured { background: linear-gradient(135deg, #f59e0b, #d97706); box-shadow: 0 2px 8px rgba(245,158,11,0.4); }
        .feature-badge.live { background: linear-gradient(135deg, #22c55e, #16a34a); box-shadow: 0 2px 8px rgba(34,197,94,0.4); }
        .feature-badge.soon { background: linear-gradient(135deg, #6366f1, #4f46e5); box-shadow: 0 2px 8px rgba(99,102,241,0.4); }
        .feature-badge.new { background: linear-gradient(135deg, #3b82f6, #2563eb); box-shadow: 0 2px 8px rgba(59,130,246,0.4); }

        /* Mobile: Slightly smaller inline badges */
        @media (max-width: 480px) {
            .feature-badge {
                font-size: 8px;
                padding: 2px 6px;
            }
        }

        /* ═══════════════════════════════════════════════════════════════════ */
        /* PROFILE VIEW - Modern Redesign                                       */
        /* ═══════════════════════════════════════════════════════════════════ */
        .profile-hero-card {
            background: linear-gradient(135deg, rgba(99,102,241,0.15) 0%, rgba(139,92,246,0.1) 100%);
            border: 1px solid rgba(99,102,241,0.25);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .profile-email-small {
            font-size: 11px;
            color: var(--text3);
            margin-bottom: 8px;
        }
        .profile-edit-btn {
            width: 100%;
            margin-top: 16px;
            padding: 12px;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }
        .profile-edit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139,92,246,0.4);
        }

        .profile-section-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text1);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .profile-section-title .see-all-btn {
            margin-left: auto;
            background: none;
            border: none;
            color: var(--primary);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .profile-stats-extended {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 24px;
        }
        .profile-stat-box {
            background: rgba(30,35,50,0.8);
            border: 1px solid rgba(99,102,241,0.15);
            border-radius: 14px;
            padding: 14px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .profile-stat-box:hover {
            transform: translateY(-2px);
            border-color: rgba(99,102,241,0.4);
            background: rgba(99,102,241,0.1);
        }
        .stat-icon-lg { font-size: 24px; margin-bottom: 6px; }
        .stat-value-lg { font-size: 18px; font-weight: 800; color: var(--text1); }
        .stat-label-lg { font-size: 10px; color: var(--text3); margin-top: 4px; }

        .badges-grid-modern {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 24px;
        }

        .profile-actions-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 24px;
        }
        .profile-action-card {
            background: rgba(30,35,50,0.8);
            border: 1px solid rgba(99,102,241,0.15);
            border-radius: 14px;
            padding: 16px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .profile-action-card:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
            background: rgba(99,102,241,0.1);
        }
        .action-icon { font-size: 24px; margin-bottom: 6px; }
        .action-label { font-size: 11px; color: var(--text2); font-weight: 600; }
        .action-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #ef4444;
            color: #fff;
            font-size: 10px;
            font-weight: 700;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-menu {
            background: rgba(30,35,50,0.6);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 24px;
        }
        .settings-item {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: none;
            border: none;
            border-bottom: 1px solid rgba(99,102,241,0.1);
            color: var(--text1);
            cursor: pointer;
            transition: background 0.2s;
        }
        .settings-item:last-child { border-bottom: none; }
        .settings-item:hover { background: rgba(99,102,241,0.1); }
        .settings-icon { font-size: 18px; }
        .settings-text { flex: 1; text-align: left; font-size: 14px; }
        .settings-arrow { color: var(--text3); font-size: 14px; }

        .app-info {
            text-align: center;
            padding: 20px;
            color: var(--text3);
        }
        .app-version { font-size: 12px; font-weight: 600; margin-bottom: 4px; }
        .app-copyright { font-size: 10px; }

        @media (max-width: 480px) {
            .profile-stats-extended { grid-template-columns: repeat(2, 1fr); }
            .profile-actions-grid { grid-template-columns: repeat(2, 1fr); }
            .profile-hero-card { padding: 16px; }
        }

        /* ═══════════════════════════════════════════════════════════════════ */
        /* BEAST COLLECTION VIEW                                                */
        /* ═══════════════════════════════════════════════════════════════════ */
        .beast-summary-card {
            display: flex;
            justify-content: space-around;
            background: linear-gradient(135deg, rgba(16,185,129,0.15) 0%, rgba(5,150,105,0.1) 100%);
            border: 1px solid rgba(16,185,129,0.25);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .beast-summary-stat { text-align: center; }
        .summary-value { font-size: 28px; font-weight: 800; color: #10b981; }
        .summary-label { font-size: 11px; color: var(--text3); margin-top: 4px; }

        .beast-filter-tabs {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 12px;
            margin-bottom: 16px;
        }
        .beast-filter-tab {
            flex-shrink: 0;
            padding: 8px 16px;
            background: rgba(30,35,50,0.8);
            border: 1px solid rgba(99,102,241,0.15);
            border-radius: 20px;
            color: var(--text2);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .beast-filter-tab.active, .beast-filter-tab:hover {
            background: rgba(16,185,129,0.2);
            border-color: rgba(16,185,129,0.4);
            color: #10b981;
        }

        .beast-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        .beast-empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px 20px;
            color: var(--text2);
        }
        .beast-empty-state h3 { color: var(--text1); margin-bottom: 8px; }
        .beast-empty-state p { font-size: 13px; line-height: 1.5; }

        /* ═══════════════════════════════════════════════════════════════════ */
        /* FRIENDS VIEW - POLISHED                                              */
        /* ═══════════════════════════════════════════════════════════════════ */
        .friend-stats-bar {
            display: flex;
            justify-content: space-around;
            background: linear-gradient(135deg, rgba(99,102,241,0.15) 0%, rgba(139,92,246,0.1) 100%);
            border: 1px solid rgba(99,102,241,0.25);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 20px;
        }
        .friend-stat { text-align: center; }
        .friend-stat-value {
            font-size: 26px;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: block;
        }
        .friend-stat-label { font-size: 11px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.5px; }

        .friends-section { margin-bottom: 24px; }
        .friends-section .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .friends-section .section-header h3 {
            font-size: 14px;
            font-weight: 700;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .friends-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* Friend Card - Individual friend row */
        .friend-card {
            display: flex;
            align-items: center;
            gap: 12px;
            background: linear-gradient(135deg, rgba(15,23,42,0.8) 0%, rgba(30,41,59,0.7) 100%);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 14px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .friend-card:hover {
            border-color: var(--primary);
            transform: translateX(4px);
            box-shadow: 0 4px 15px rgba(94,234,212,0.1);
        }
        .friend-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
            position: relative;
        }
        .friend-avatar.online::after {
            content: '';
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            background: var(--success);
            border-radius: 50%;
            border: 2px solid var(--bg);
        }
        .friend-info {
            flex: 1;
            min-width: 0;
        }
        .friend-name {
            font-size: 14px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 2px;
        }
        .friend-status {
            font-size: 11px;
            color: var(--text3);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .friend-status.online { color: var(--success); }
        .friend-level {
            font-size: 10px;
            color: var(--text3);
            background: rgba(99,102,241,0.15);
            padding: 2px 8px;
            border-radius: 10px;
        }
        .friend-actions {
            display: flex;
            gap: 8px;
        }
        .friend-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: rgba(94,234,212,0.1);
            border: 1px solid rgba(94,234,212,0.2);
            color: var(--primary);
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .friend-action-btn:hover {
            background: rgba(94,234,212,0.2);
            transform: scale(1.1);
        }
        .friend-action-btn.danger {
            background: rgba(239,68,68,0.1);
            border-color: rgba(239,68,68,0.2);
            color: #ef4444;
        }
        .friend-action-btn.danger:hover {
            background: rgba(239,68,68,0.2);
        }

        /* Friend Request Card */
        .friend-request-card {
            display: flex;
            align-items: center;
            gap: 12px;
            background: linear-gradient(135deg, rgba(251,191,36,0.1) 0%, rgba(245,158,11,0.05) 100%);
            border: 1px solid rgba(251,191,36,0.3);
            border-radius: 14px;
            padding: 14px;
            margin-bottom: 8px;
        }
        .friend-request-actions {
            display: flex;
            gap: 8px;
        }
        .friend-accept-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, var(--success), #16a34a);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        .friend-accept-btn:hover { transform: scale(1.05); }
        .friend-decline-btn {
            padding: 8px 12px;
            background: transparent;
            border: 1px solid rgba(239,68,68,0.3);
            border-radius: 8px;
            color: #ef4444;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .friend-decline-btn:hover {
            background: rgba(239,68,68,0.1);
        }

        .friends-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text3);
        }
        .friends-empty h4 { color: var(--text); margin-bottom: 8px; font-size: 16px; }
        .friends-empty p { font-size: 13px; line-height: 1.6; max-width: 280px; margin: 0 auto; }

        /* ═══════════════════════════════════════════════════════════════════ */
        /* TRADING VIEW                                                         */
        /* ═══════════════════════════════════════════════════════════════════ */
        .trading-stats-card {
            display: flex;
            justify-content: space-around;
            background: linear-gradient(135deg, rgba(251,191,36,0.15) 0%, rgba(245,158,11,0.1) 100%);
            border: 1px solid rgba(251,191,36,0.25);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .trading-stat { text-align: center; }
        .trading-stat-icon { font-size: 24px; margin-bottom: 4px; }
        .trading-stat-value { font-size: 20px; font-weight: 800; color: #fbbf24; }
        .trading-stat-label { font-size: 11px; color: var(--text3); margin-top: 2px; }

        .trades-list {
            background: rgba(30,35,50,0.6);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 16px;
        }
        .trades-empty {
            text-align: center;
            padding: 30px 20px;
            color: var(--text3);
        }
        .trades-empty h4 { color: var(--text1); margin-bottom: 8px; }
        .trades-empty p { font-size: 13px; line-height: 1.5; }

        .create-trade-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border: none;
            border-radius: 12px;
            color: #000;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }
        .create-trade-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(251,191,36,0.4);
        }

        .section-header h3 {
            font-size: 14px;
            font-weight: 700;
            color: var(--text1);
            margin-bottom: 12px;
        }
    </style>
<link rel="stylesheet" href="assets/style/design-tokens.css">
<link rel="stylesheet" href="assets/style/theme.css">
<link rel="stylesheet" href="phaser-character-creator.css">
<script src="assets/icons/index.js" defer></script>
<!-- Phaser.js for character animation AND tank game -->
<script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
<!-- Phaser Spine Plugin (optional - for bone-rigged animations) -->
<script src="https://cdn.jsdelivr.net/npm/phaser-spine@4.2.0/dist/phaser-spine.umd.min.js" defer></script>
<script src="phaser-character-creator.js" defer></script>

<!-- Howler.js for professional game audio -->
<script src="https://cdn.jsdelivr.net/npm/howler@2.2.3/dist/howler.min.js"></script>
</head>
<body>
<script>
// Profile card functions (defined early for onclick handlers)
window.toggleBeastCard = function(sectionId) {
    const section = document.getElementById(sectionId);
    if (section) {
        section.classList.toggle('open');
        const toggleBtn = section.querySelector('.beast-toggle');
        if (toggleBtn) toggleBtn.classList.toggle('expanded');
    }
};
window.openBeastCollection = function() { openView('beastCollectionView'); };
window.openTankLeaderboard = function() { openView('leaderboardView'); };
window.openPvPArena = function() { if (!user) { if(window.showToast) showToast('Please log in to play!', 'warning'); return; } if(window.showToast) showToast('PvP Arena coming in Veilbreakers update!', 'info'); };
window.viewBeastDetails = function() { if (!user) { if(window.showToast) showToast('Please log in to play!', 'warning'); return; } if(window.showToast) showToast('Beast details coming soon!', 'info'); };
window.openBeastLineup = function() { if (!user) { if(window.showToast) showToast('Please log in to play!', 'warning'); return; } if(window.showToast) showToast('Beast Lineup coming soon!', 'info'); };
window.startBeastBattle = function() { if (!user) { if(window.showToast) showToast('Please log in to play!', 'warning'); return; } if(window.showToast) showToast('Beast battles coming soon!', 'info'); };
window.openFriendsList = function() { openView('friendsView'); };
window.openTradingHub = function() { openView('tradingView'); };
window.openNotificationSettings = function() { if(window.showToast) showToast('Notification settings coming soon!', 'info'); };
window.openPrivacySettings = function() { if(window.showToast) showToast('Privacy settings coming soon!', 'info'); };

// Beast Collection functions
window.filterBeasts = function(type, btn) {
    document.querySelectorAll('.beast-filter-tab').forEach(t => t.classList.remove('active'));
    if (btn) btn.classList.add('active');
    // TODO: Filter beast grid by type
    if(window.showToast) showToast(`Filtering by ${type}`, 'info');
};

// Friends functions
window.showAddFriend = function() {
    const code = prompt('Enter friend code or username:');
    if (code && code.trim()) {
        if(window.showToast) showToast(`Friend request sent to ${code}!`, 'success');
    }
};

// Trading functions
window.showCreateTrade = function() {
    if(window.showToast) showToast('Select a friend to trade with first!', 'info');
};

// ============================================
// ANIMATION UTILITIES
// ============================================

/**
 * Animate number counting up from start to end
 * @param {HTMLElement} element - The element to animate
 * @param {number} start - Starting number
 * @param {number} end - Ending number
 * @param {number} duration - Duration in milliseconds (default: 800ms)
 * @param {string} suffix - Optional suffix (e.g., '%', 'K', etc.)
 */
window.animateNumber = function(element, start, end, duration = 800, suffix = '') {
    if (!element) return;

    const range = end - start;
    const startTime = performance.now();
    const isInteger = Number.isInteger(end);

    function updateNumber(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);

        // Easing function (ease-out-cubic)
        const easeOut = 1 - Math.pow(1 - progress, 3);
        const current = start + (range * easeOut);

        // Format number
        const displayValue = isInteger ? Math.round(current) : current.toFixed(1);
        element.textContent = displayValue + suffix;

        // Add pop animation when complete
        if (progress === 1) {
            element.style.animation = 'numberPop 0.3s ease-out';
            setTimeout(() => {
                element.style.animation = '';
            }, 300);
        } else {
            requestAnimationFrame(updateNumber);
        }
    }

    requestAnimationFrame(updateNumber);
};

/**
 * Animate multiple stat counters
 * @param {Object} stats - Object with { elementId: targetValue }
 */
window.animateStats = function(stats) {
    Object.entries(stats).forEach(([elementId, targetValue], index) => {
        const element = document.getElementById(elementId);
        if (element) {
            // Stagger animations slightly
            setTimeout(() => {
                const currentValue = parseFloat(element.textContent) || 0;
                animateNumber(element, currentValue, targetValue, 800);
            }, index * 50);
        }
    });
};

/**
 * Add entrance animation to element
 * @param {HTMLElement} element - Element to animate
 * @param {string} animationType - Animation type: 'fadeInUp', 'fadeInScale', 'slideInFromLeft', 'slideInFromRight'
 * @param {number} delay - Delay in milliseconds
 */
window.addEntranceAnimation = function(element, animationType = 'fadeInUp', delay = 0) {
    if (!element) return;

    element.style.opacity = '0';
    element.style.animation = `${animationType} 0.5s ease-out forwards`;
    element.style.animationDelay = `${delay}ms`;
};

/**
 * Trigger value change animation when updating a stat/currency
 * @param {string} elementId - ID of the element to animate
 * @param {number|string} newValue - New value to set
 */
window.updateValueWithAnimation = function(elementId, newValue) {
    const element = document.getElementById(elementId);
    if (!element) return;

    // Add animation class
    element.classList.add('value-changed');

    // Update value
    element.textContent = newValue;

    // Remove class after animation completes
    setTimeout(() => {
        element.classList.remove('value-changed');
    }, 400);
};

/**
 * Show skeleton loaders while content is loading
 * @param {HTMLElement} container - Container to add skeletons to
 * @param {number} count - Number of skeleton items
 * @param {string} type - Type: 'card', 'text', 'avatar'
 */
window.showSkeletonLoader = function(container, count = 3, type = 'card') {
    if (!container) return;

    const skeletonHTML = type === 'card'
        ? '<div class="skeleton skeleton-card"></div>'
        : type === 'text'
        ? '<div class="skeleton skeleton-text"></div>'
        : '<div class="skeleton skeleton-avatar"></div>';

    container.innerHTML = skeletonHTML.repeat(count);
};
</script>

<!-- HOME VIEW -->
<div class="view active" id="homeView">
    <!-- ═══════════════════════════════════════════════════════════════════════ -->
    <!-- STICKY HEADER - Title + Coins + Settings/Profile (Scrolls with content) -->
    <!-- ═══════════════════════════════════════════════════════════════════════ -->
    <div class="home-header" style="position:sticky;top:0;z-index:100;display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:linear-gradient(180deg,rgba(10,15,30,0.98) 0%,rgba(15,20,35,0.95) 100%);border-bottom:1px solid rgba(99,102,241,0.3);backdrop-filter:blur(12px)">
        <!-- LEFT: Title (MUCH BIGGER) -->
        <h1 class="header-title" onclick="goHome()" title="Go to Home">
            <span class="title-full">AuthenticaDetector</span><span class="title-hub"> Hub</span>
        </h1>
        <!-- RIGHT: Quests + Gift + Settings + Profile -->
        <div style="display:flex;align-items:center;gap:8px">
            <!-- Quests Button with Badge -->
            <button onclick="toggleQuestsPopup()" title="Quests" id="headerQuestsBtn" style="position:relative;width:40px;height:40px;border-radius:50%;border:2px solid rgba(94,234,212,0.5);background:linear-gradient(135deg,rgba(94,234,212,0.2),rgba(20,184,166,0.1));cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;transition:all 0.2s ease">
                <img src="assets/icons/quest.svg" alt="Quests" style="width:20px;height:20px">
                <span id="questsBadge" style="position:absolute;top:-4px;right:-4px;min-width:18px;height:18px;background:linear-gradient(135deg,#ef4444,#dc2626);color:white;font-size:10px;font-weight:700;border-radius:9px;display:flex;align-items:center;justify-content:center;padding:0 4px;border:2px solid var(--bg)">3</span>
            </button>
            <button onclick="claimDailyBonus()" title="Daily Bonus" style="width:40px;height:40px;border-radius:50%;border:2px solid rgba(251,191,36,0.5);background:linear-gradient(135deg,rgba(251,191,36,0.2),rgba(245,158,11,0.1));cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center">
                <img src="assets/icons/rewards.svg" alt="Daily Bonus" style="width:20px;height:20px">
            </button>
            <button onclick="openSettings()" title="Settings" style="width:40px;height:40px;border-radius:50%;border:2px solid rgba(100,116,139,0.4);background:rgba(100,116,139,0.15);cursor:pointer;display:flex;align-items:center;justify-content:center">
                <img src="assets/icons/ui-settings.svg" alt="Settings" style="width:22px;height:22px">
            </button>
            <button class="user-btn" id="userBtn" onclick="openProfile()" title="Profile" style="width:40px;height:40px;border-radius:50%;border:2px solid #6366f1;background:linear-gradient(135deg,#1e1b4b,#312e81);cursor:pointer;font-size:18px;box-shadow:0 3px 10px rgba(99,102,241,0.4)">
                <span id="userInitial"><img src="assets/icons/profile.svg" alt="Profile" style="width:20px;height:20px"></span>
            </button>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════════════ -->
    <!-- CURRENCY BAR - Coins, Keys, Gems (Sticky below header)                  -->
    <!-- ═══════════════════════════════════════════════════════════════════════ -->
    <div class="currency-bar">
        <div class="currency-item coins">
            <span class="currency-icon"><img src="assets/icons/currency-coin.svg" alt="Coins" style="width:18px;height:18px"></span>
            <span class="currency-value" id="headerCoinCount">0</span>
        </div>
        <div class="currency-item keys">
            <span class="currency-icon"><img src="assets/icons/currency-key.svg" alt="Keys" style="width:18px;height:18px"></span>
            <span class="currency-value" id="headerKeyCount">0</span>
        </div>
        <div class="currency-item gems">
            <span class="currency-icon"><img src="assets/icons/currency-crystal.svg" alt="Gems" style="width:18px;height:18px"></span>
            <span class="currency-value" id="headerGemCount">0</span>
        </div>
    </div>

    <!-- SCROLLABLE CONTENT -->
    <div class="home-content" style="padding:16px 16px 100px;overflow-y:auto">

        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- PROFILE CARD - New compact design with collapsible beast        -->
        <!-- ═══════════════════════════════════════════════════════════════ -->
        <div class="profile-section" style="margin-bottom:16px;background:linear-gradient(135deg,rgba(99,102,241,0.12) 0%,rgba(139,92,246,0.08) 100%);border-radius:20px;border:1px solid rgba(99,102,241,0.2)">

            <!-- Top Area: Avatar + Info + Actions -->
            <div class="profile-top-area">
                <div class="profile-avatar-lg" id="homeAvatarDisplay" onclick="openAvatarBuilder()">
                    <span id="homeAvatarEmoji">🧑‍🚀</span>
                </div>
                <div class="profile-middle-col">
                    <div class="profile-name-row">
                        <span class="profile-username" id="homeUserName">Explorer</span>
                        <span class="profile-level-badge">LV <span id="homeAvatarLevel">1</span></span>
                    </div>
                    <div class="profile-title" id="homeUserTitle">Newcomer</div>
                    <div class="profile-xp-row">
                        <div class="profile-xp-bar-container">
                            <div class="profile-xp-bar-fill" id="homeXpBarFill" style="width: 0%"></div>
                        </div>
                        <span class="profile-xp-text"><span id="homeAvatarXP">0</span>/<span id="homeXpRequired">100</span></span>
                    </div>
                </div>
                <div class="profile-right-actions">
                    <button class="profile-action-btn customize" onclick="openAvatarBuilder()" title="Customize Avatar">
                        <img src="assets/icons/camera.svg" alt="Customize" style="width:20px;height:20px">
                    </button>
                    <button class="profile-action-btn shop" onclick="openShop()" title="Shop">
                        <img src="assets/icons/shop.svg" alt="Shop" style="width:20px;height:20px">
                    </button>
                    <button class="profile-action-btn vera" onclick="openHelp()" title="VERA Assistant">
                        <img src="assets/icons/nav-vera.svg" alt="VERA" style="width:20px;height:20px">
                    </button>
                </div>
            </div>

            <!-- Stats Grid (4 columns, clickable) -->
            <div class="profile-stats-grid">
                <div class="profile-stat-card" onclick="openLeaderboard()">
                    <div class="stat-icon"><img src="assets/icons/trophy.svg" alt="Rank" style="width:28px;height:28px"></div>
                    <div class="stat-value" style="color:#a78bfa" id="homeRankNum">#--</div>
                    <div class="stat-label">Rank</div>
                    <div class="tap-hint">tap</div>
                </div>
                <div class="profile-stat-card" onclick="openBeastCollection()">
                    <div class="stat-icon"><img src="assets/icons/beasts.svg" alt="Beasts" style="width:28px;height:28px"></div>
                    <div class="stat-value" style="color:#10b981" id="homeBeastCount">0</div>
                    <div class="stat-label">Beasts</div>
                    <div class="tap-hint">tap</div>
                </div>
                <div class="profile-stat-card" onclick="openTankLeaderboard()">
                    <div class="stat-icon"><img src="assets/icons/ui-tank.svg" alt="Tank" style="width:28px;height:28px"></div>
                    <div class="stat-value" style="color:#f87171" id="homeTankRank">#--</div>
                    <div class="stat-label">Tank</div>
                    <div class="tap-hint">tap</div>
                </div>
                <div class="profile-stat-card" onclick="openPvPArena()">
                    <div class="stat-icon"><img src="assets/icons/action-attack.svg" alt="PvP" style="width:28px;height:28px"></div>
                    <div class="stat-value" style="color:#f472b6" id="homePvPRank">#--</div>
                    <div class="stat-label">PvP</div>
                    <div class="tap-hint">tap</div>
                </div>
            </div>

            <!-- VERA Profile Tip -->
            <div class="vera-profile-tip" style="margin:12px 0;padding:10px;background:linear-gradient(135deg,rgba(94,234,212,0.1),rgba(59,130,246,0.08));border-radius:12px;border:1px solid rgba(94,234,212,0.2);display:flex;align-items:center;gap:8px">
                <div style="width:28px;height:28px;min-width:28px;background:linear-gradient(135deg,rgba(94,234,212,0.3),rgba(59,130,246,0.2));border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid rgba(94,234,212,0.4);box-shadow:0 2px 6px rgba(94,234,212,0.4)">
                    <img src="assets/icons/nav-vera.svg" alt="VERA" style="width:18px;height:18px;filter:drop-shadow(0 1px 3px rgba(94,234,212,0.8))">
                </div>
                <p style="margin:0;font-size:9px;color:#5eead4;flex:1;line-height:1.2">
                    <strong>TIP:</strong> Level up by scanning AI images and completing quests!
                </p>
            </div>

            <!-- Favorite Beast Section (Collapsible) -->
            <div class="profile-section-label">Favorite Beast</div>
            <div class="beast-section" id="favoriteBeastSection">
                <div class="beast-collapsed" onclick="toggleBeastCard('favoriteBeastSection')">
                    <div class="beast-avatar" id="favBeastAvatar">🐲</div>
                    <div class="beast-info">
                        <div class="beast-header">
                            <span class="beast-name" id="favBeastName">No Beast</span>
                            <span class="beast-level" id="favBeastLevel">LV --</span>
                            <span class="beast-rarity common" id="favBeastRarity">--</span>
                        </div>
                        <div class="beast-type" id="favBeastType">Capture your first beast!</div>
                        <div class="beast-stats-mini">
                            <span class="beast-stat">ATK <span id="favBeastATK">--</span></span>
                            <span class="beast-stat">DEF <span id="favBeastDEF">--</span></span>
                            <span class="beast-stat">SPD <span id="favBeastSPD">--</span></span>
                        </div>
                    </div>
                    <div class="beast-toggle" id="beastToggleBtn">
                        <img src="assets/icons/search.svg" alt="View" style="width:20px;height:20px">
                    </div>
                </div>
                <div class="beast-expanded">
                    <div class="beast-divider"></div>
                    <div class="beast-full-stats">
                        <div class="beast-stat-box"><div class="val" id="favBeastATKFull">--</div><div class="lbl">Attack</div></div>
                        <div class="beast-stat-box"><div class="val" id="favBeastDEFFull">--</div><div class="lbl">Defense</div></div>
                        <div class="beast-stat-box"><div class="val" id="favBeastSPDFull">--</div><div class="lbl">Speed</div></div>
                        <div class="beast-stat-box"><div class="val" id="favBeastTotal">--</div><div class="lbl">Total</div></div>
                    </div>
                    <div class="beast-xp-section">
                        <span class="beast-xp-label">Beast XP</span>
                        <div class="beast-xp-bar"><div class="beast-xp-fill" id="favBeastXpFill" style="width:0%"></div></div>
                        <span class="beast-xp-text" id="favBeastXpText">0 / 100</span>
                    </div>
                    <div class="beast-actions">
                        <button class="beast-btn" onclick="viewBeastDetails()">
                            <img src="assets/icons/search.svg" alt="" style="width:16px;height:16px;margin-right:4px"> View
                        </button>
                        <button class="beast-btn" onclick="openBeastLineup()">
                            <img src="assets/icons/inventory.svg" alt="" style="width:16px;height:16px;margin-right:4px"> Lineup
                        </button>
                        <button class="beast-btn primary" onclick="startBeastBattle()">
                            <img src="assets/icons/action-attack.svg" alt="" style="width:16px;height:16px;margin-right:4px"> Battle
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- VEILBREAKERS - The Ultimate Beast Collection & Battle RPG      -->
        <!-- ═══════════════════════════════════════════════════════════════ -->
        <div id="heroGameBanner" style="margin-bottom:14px;border-radius:16px;overflow:hidden;box-shadow:0 8px 32px rgba(0,0,0,0.4);border:2px solid rgba(139,92,246,0.35)">
            <div class="game-card-hero" style="position:relative;height:160px;background:linear-gradient(135deg,#0f0a1a 0%,#1a0f2e 25%,#2d1b4e 50%,#3d1f6d 75%,#1a1033 100%);overflow:hidden">
                <!-- Animated glow effects -->
                <div style="position:absolute;left:-20%;top:-30%;width:60%;height:80%;background:radial-gradient(circle,rgba(139,92,246,0.35) 0%,transparent 60%);animation:pulse 3s ease-in-out infinite"></div>
                <div style="position:absolute;right:-15%;bottom:-20%;width:50%;height:60%;background:radial-gradient(circle,rgba(244,114,182,0.2) 0%,transparent 60%);animation:pulse 4s ease-in-out infinite reverse"></div>
                <!-- Beast Icon -->
                <div style="position:absolute;right:12px;top:50%;transform:translateY(-50%)">
                    <img src="assets/icons/beasts.svg" alt="Beast" style="width:100px;height:100px;filter:drop-shadow(0 8px 32px rgba(139,92,246,0.8))">
                </div>
                <!-- Title & Description -->
                <div style="position:absolute;left:16px;bottom:12px;max-width:65%">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap">
                        <h2 style="margin:0;font-size:24px;font-weight:900;color:#fff;text-shadow:0 3px 20px rgba(139,92,246,0.8)">VEILBREAKERS</h2>
                        <span class="feature-badge featured">
                            <img src="assets/icons/star.svg" alt="" style="width:14px;height:14px;margin-right:4px"> FEATURED
                        </span>
                    </div>
                    <p style="margin:0;font-size:11px;color:#e2e8f0;line-height:1.4">Hunt, capture, and train mythical beasts. Battle in ranked PvP arenas, evolve your creatures through fusion, and rise through the leaderboards. Build your ultimate beast squad!</p>
                </div>
            </div>
            <!-- Game Features -->
            <div style="background:rgba(139,92,246,0.12);padding:10px 14px;display:flex;gap:6px;flex-wrap:wrap">
                <span style="background:rgba(220,38,38,0.2);padding:4px 8px;border-radius:5px;font-size:9px;font-weight:700;color:#fca5a5;border:1px solid rgba(220,38,38,0.3);display:inline-flex;align-items:center;gap:4px">
                    <img src="assets/icons/arena.svg" alt="" style="width:12px;height:12px"> PvP Battles
                </span>
                <span style="background:rgba(251,191,36,0.2);padding:4px 8px;border-radius:5px;font-size:9px;font-weight:700;color:#fcd34d;border:1px solid rgba(251,191,36,0.3);display:inline-flex;align-items:center;gap:4px">
                    <img src="assets/icons/ranking.svg" alt="" style="width:12px;height:12px"> Ranked Seasons
                </span>
                <span style="background:rgba(16,185,129,0.2);padding:4px 8px;border-radius:5px;font-size:9px;font-weight:700;color:#6ee7b7;border:1px solid rgba(16,185,129,0.3);display:inline-flex;align-items:center;gap:4px">
                    <img src="assets/icons/capture.svg" alt="" style="width:12px;height:12px"> Beast Capture
                </span>
                <span style="background:rgba(168,85,247,0.2);padding:4px 8px;border-radius:5px;font-size:9px;font-weight:700;color:#d8b4fe;border:1px solid rgba(168,85,247,0.3);display:inline-flex;align-items:center;gap:4px">
                    <img src="assets/icons/evolution.svg" alt="" style="width:12px;height:12px"> Evolution
                </span>
                <span style="background:rgba(59,130,246,0.2);padding:4px 8px;border-radius:5px;font-size:9px;font-weight:700;color:#93c5fd;border:1px solid rgba(59,130,246,0.3);display:inline-flex;align-items:center;gap:4px">
                    <img src="assets/icons/fusion.svg" alt="" style="width:12px;height:12px"> Fusion
                </span>
                <span style="background:rgba(244,114,182,0.2);padding:4px 8px;border-radius:5px;font-size:9px;font-weight:700;color:#f9a8d4;border:1px solid rgba(244,114,182,0.3);display:inline-flex;align-items:center;gap:4px">
                    <img src="assets/icons/arena.svg" alt="" style="width:12px;height:12px"> Arenas
                </span>
            </div>
            <div style="padding:10px 14px;background:rgba(0,0,0,0.3)">
                <button onclick="showToast('Veilbreakers coming soon! Build your beast army!', 'info')" style="width:100%;background:linear-gradient(135deg,#8b5cf6,#7c3aed);border:none;color:#fff;padding:11px;border-radius:10px;font-weight:800;font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 4px 20px rgba(139,92,246,0.4)">
                    <img src="assets/icons/play.svg" alt="" style="width:16px;height:16px"> COMING SOON
                </button>
            </div>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- AI OUTBREAK: TANK BATTLE                                        -->
        <!-- ═══════════════════════════════════════════════════════════════ -->
        <div style="border-radius:16px;margin-bottom:14px;overflow:hidden;border:1px solid rgba(220,38,38,0.3);box-shadow:0 6px 24px rgba(0,0,0,0.3)">
            <div class="game-card-hero" style="position:relative;height:100px;background:linear-gradient(135deg,#1a0a0a 0%,#2d1515 50%,#1a0f0f 100%);overflow:hidden">
                <div style="position:absolute;right:-10%;top:-20%;width:50%;height:70%;background:radial-gradient(circle,rgba(220,38,38,0.2) 0%,transparent 70%)"></div>
                <div style="position:absolute;right:16px;top:50%;transform:translateY(-50%)">
                    <img src="assets/icons/tank.svg" alt="Tank" style="width:80px;height:80px;filter:drop-shadow(0 6px 20px rgba(220,38,38,0.7))">
                </div>
                <div style="position:absolute;left:16px;top:50%;transform:translateY(-50%)">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;flex-wrap:wrap">
                        <span style="font-size:16px;font-weight:900;color:#fff">TANK BATTLE</span>
                        <span class="feature-badge live">🔴 LIVE</span>
                    </div>
                    <p style="margin:0;font-size:10px;color:#fca5a5;max-width:200px">Destroy waves of enemies in action-packed combat!</p>
                </div>
            </div>
            <div style="padding:10px 14px;background:rgba(0,0,0,0.3);display:flex;gap:6px;flex-wrap:wrap">
                <span style="background:rgba(220,38,38,0.2);padding:4px 8px;border-radius:5px;font-size:9px;font-weight:700;color:#fca5a5;display:inline-flex;align-items:center;gap:4px">
                    <img src="assets/icons/map.svg" alt="" style="width:12px;height:12px"> Campaign
                </span>
                <span style="background:rgba(220,38,38,0.2);padding:4px 8px;border-radius:5px;font-size:9px;font-weight:700;color:#fca5a5;display:inline-flex;align-items:center;gap:4px">
                    <img src="assets/icons/energy.svg" alt="" style="width:12px;height:12px"> Endless
                </span>
                <span style="background:rgba(220,38,38,0.2);padding:4px 8px;border-radius:5px;font-size:9px;font-weight:700;color:#fca5a5;display:inline-flex;align-items:center;gap:4px">
                    <img src="assets/icons/boss.svg" alt="" style="width:12px;height:12px"> Boss Rush
                </span>
            </div>
            <div style="padding:10px 14px;background:linear-gradient(180deg,rgba(220,38,38,0.1),rgba(0,0,0,0.4))">
                <button onclick="startTankShooter()" style="width:100%;background:linear-gradient(135deg,#dc2626,#b91c1c);border:none;color:#fff;padding:10px;border-radius:8px;font-weight:800;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px">
                    <img src="assets/icons/play.svg" alt="" style="width:16px;height:16px"> PLAY NOW
                </button>
            </div>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- VERA HELPER TIP - SCAN SUGGESTION                               -->
        <!-- ═══════════════════════════════════════════════════════════════ -->
        <div class="vera-helper-tip" style="margin-bottom:14px;background:linear-gradient(135deg,rgba(147,197,253,0.12),rgba(196,181,253,0.08));border-radius:16px;padding:14px;border:1px solid rgba(147,197,253,0.25);display:flex;align-items:center;gap:12px;position:relative;overflow:hidden">
            <div style="position:absolute;top:-20px;right:-20px;width:80px;height:80px;background:radial-gradient(circle,rgba(147,197,253,0.2),transparent);border-radius:50%;animation:pulse 3s ease-in-out infinite"></div>
            <div style="width:50px;height:50px;min-width:50px;background:linear-gradient(135deg,rgba(147,197,253,0.3),rgba(196,181,253,0.2));border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid rgba(147,197,253,0.4);box-shadow:0 4px 12px rgba(147,197,253,0.3);position:relative">
                <img src="assets/icons/nav-vera.svg" alt="VERA" style="width:32px;height:32px;filter:drop-shadow(0 2px 8px rgba(147,197,253,0.8))">
            </div>
            <div style="flex:1">
                <div style="font-weight:700;font-size:13px;color:#93c5fd;margin-bottom:4px;display:flex;align-items:center;gap:6px">
                    <span>VERA's Tip</span>
                    <span style="font-size:10px;padding:2px 6px;background:rgba(147,197,253,0.2);border-radius:5px;color:#bfdbfe">NEW</span>
                </div>
                <p style="margin:0;font-size:11px;color:#cbd5e1;line-height:1.4">Upload an AI-generated image to start earning coins! Deep scans reveal hidden artifacts and level you up faster.</p>
            </div>
            <button onclick="openView('scanView')" style="min-width:70px;padding:8px 12px;background:linear-gradient(135deg,#93c5fd,#7c3aed);border:none;border-radius:10px;color:#fff;font-weight:700;font-size:11px;cursor:pointer;box-shadow:0 4px 16px rgba(147,197,253,0.4)">
                Scan Now
            </button>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- BEAST TRAINING CENTER                                           -->
        <!-- ═══════════════════════════════════════════════════════════════ -->
        <div id="beastTrainingSection" style="border-radius:16px;margin-bottom:14px;overflow:hidden;border:1px solid rgba(16,185,129,0.3);box-shadow:0 6px 24px rgba(0,0,0,0.3)">
            <div class="game-card-hero" style="position:relative;height:100px;background:linear-gradient(135deg,#052e16 0%,#14532d 50%,#064e3b 100%);overflow:hidden">
                <div style="position:absolute;right:-10%;top:-20%;width:50%;height:70%;background:radial-gradient(circle,rgba(16,185,129,0.25) 0%,transparent 70%)"></div>
                <div style="position:absolute;right:16px;top:50%;transform:translateY(-50%)">
                    <img src="assets/icons/training.svg" alt="Training" style="width:70px;height:70px;filter:drop-shadow(0 6px 20px rgba(16,185,129,0.7))">
                </div>
                <div style="position:absolute;left:16px;top:50%;transform:translateY(-50%)">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;flex-wrap:wrap">
                        <span style="font-size:16px;font-weight:900;color:#fff">Beast Training</span>
                        <span class="feature-badge soon">⏳ SOON</span>
                    </div>
                    <p style="margin:0;font-size:10px;color:#a7f3d0;max-width:200px">Train, purify, and fuse your beasts!</p>
                </div>
            </div>
            <div style="padding:10px 14px;background:rgba(0,0,0,0.3);display:flex;gap:6px;flex-wrap:wrap">
                <span style="background:rgba(16,185,129,0.2);padding:4px 8px;border-radius:5px;font-size:9px;font-weight:700;color:#6ee7b7;display:inline-flex;align-items:center;gap:4px">
                    <img src="assets/icons/training.svg" alt="" style="width:12px;height:12px"> Training
                </span>
                <span style="background:rgba(59,130,246,0.2);padding:4px 8px;border-radius:5px;font-size:9px;font-weight:700;color:#93c5fd;display:inline-flex;align-items:center;gap:4px">
                    <img src="assets/icons/sparkles.svg" alt="" style="width:12px;height:12px"> Purify
                </span>
                <span style="background:rgba(168,85,247,0.2);padding:4px 8px;border-radius:5px;font-size:9px;font-weight:700;color:#d8b4fe;display:inline-flex;align-items:center;gap:4px">
                    <img src="assets/icons/fusion.svg" alt="" style="width:12px;height:12px"> Fuse
                </span>
                <span style="background:rgba(244,114,182,0.2);padding:4px 8px;border-radius:5px;font-size:9px;font-weight:700;color:#f9a8d4;display:inline-flex;align-items:center;gap:4px">
                    <img src="assets/icons/wand.svg" alt="" style="width:12px;height:12px"> Enhance
                </span>
                <span style="background:rgba(251,191,36,0.2);padding:4px 8px;border-radius:5px;font-size:9px;font-weight:700;color:#fcd34d;display:inline-flex;align-items:center;gap:4px">
                    <img src="assets/icons/stats.svg" alt="" style="width:12px;height:12px"> Skills
                </span>
            </div>
            <div style="padding:10px 14px;background:linear-gradient(180deg,rgba(16,185,129,0.1),rgba(0,0,0,0.4))">
                <button onclick="showToast('Beast Training coming soon!', 'info')" style="width:100%;background:linear-gradient(135deg,rgba(16,185,129,0.3),rgba(5,150,105,0.2));border:1px solid rgba(16,185,129,0.4);color:#6ee7b7;padding:10px;border-radius:8px;font-weight:800;font-size:12px;cursor:pointer">🔒 Coming Q1 2025</button>
            </div>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- VERA HELPER TIP - VEILBREAKERS                                  -->
        <!-- ═══════════════════════════════════════════════════════════════ -->
        <div class="vera-helper-tip" style="margin-bottom:14px;background:linear-gradient(135deg,rgba(139,92,246,0.1),rgba(244,114,182,0.08));border-radius:16px;padding:12px;border:1px solid rgba(139,92,246,0.2);display:flex;align-items:flex-start;gap:10px;position:relative;overflow:hidden">
            <div style="position:absolute;top:-15px;left:-15px;width:60px;height:60px;background:radial-gradient(circle,rgba(139,92,246,0.25),transparent);border-radius:50%;animation:pulse 4s ease-in-out infinite reverse"></div>
            <div style="width:40px;height:40px;min-width:40px;background:linear-gradient(135deg,rgba(139,92,246,0.35),rgba(244,114,182,0.2));border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid rgba(139,92,246,0.4);box-shadow:0 3px 10px rgba(139,92,246,0.4);margin-top:2px">
                <img src="assets/icons/nav-vera.svg" alt="VERA" style="width:26px;height:26px;filter:drop-shadow(0 2px 6px rgba(139,92,246,0.8))">
            </div>
            <div style="flex:1">
                <div style="font-weight:700;font-size:12px;color:#c4b5fd;margin-bottom:3px">VERA says:</div>
                <p style="margin:0;font-size:10px;color:#cbd5e1;line-height:1.3">"Veilbreakers will let you capture and battle mythical AI beasts! Start scanning images now to level up and unlock early access when it launches!"</p>
            </div>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- VERA CAMEO - TANK BATTLE ENCOURAGEMENT                          -->
        <!-- ═══════════════════════════════════════════════════════════════ -->
        <div class="vera-cameo-small" style="margin-bottom:14px;padding:10px 12px;background:linear-gradient(135deg,rgba(220,38,38,0.08),rgba(251,146,60,0.05));border-radius:12px;border:1px solid rgba(220,38,38,0.15);display:flex;align-items:center;gap:8px">
            <div style="width:32px;height:32px;min-width:32px;background:linear-gradient(135deg,rgba(220,38,38,0.3),rgba(251,146,60,0.2));border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid rgba(220,38,38,0.4);box-shadow:0 2px 8px rgba(220,38,38,0.4)">
                <img src="assets/icons/nav-vera.svg" alt="VERA" style="width:20px;height:20px;filter:drop-shadow(0 1px 4px rgba(220,38,38,0.8))">
            </div>
            <p style="margin:0;font-size:10px;color:#fca5a5;flex:1;line-height:1.3">
                <strong style="color:#f87171">VERA:</strong> "Tank Battle is LIVE! Destroy waves of enemies and climb the leaderboards. Top players earn exclusive rewards every week!"
            </p>
        </div>

    </div>
</div>

<style>
@keyframes gradientFlow {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}
@keyframes float {
    0%, 100% { transform: translateY(-50%) translateX(0); }
    50% { transform: translateY(-55%) translateX(-5px); }
}

/* VERA Helper Tips & Cameos - Responsive Styles */
.vera-helper-tip,
.vera-cameo-small,
.vera-profile-tip {
    transition: all 0.3s ease;
}

.vera-helper-tip:hover,
.vera-cameo-small:hover,
.vera-profile-tip:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(147,197,253,0.3);
}

/* Mobile adjustments for VERA tips */
@media (max-width: 480px) {
    .vera-helper-tip {
        flex-direction: column;
        align-items: flex-start !important;
        padding: 12px !important;
        gap: 10px !important;
    }

    .vera-helper-tip button {
        width: 100%;
        min-width: unset !important;
    }

    .vera-cameo-small {
        padding: 8px 10px !important;
        gap: 6px !important;
    }

    .vera-cameo-small p {
        font-size: 9px !important;
    }

    .vera-profile-tip {
        padding: 8px !important;
        gap: 6px !important;
    }

    .vera-profile-tip p {
        font-size: 8px !important;
    }
}

/* VERA tip animations */
@keyframes veraGlow {
    0%, 100% {
        box-shadow: 0 4px 12px rgba(147,197,253,0.3);
    }
    50% {
        box-shadow: 0 6px 20px rgba(147,197,253,0.6);
    }
}

.vera-helper-tip > div:first-of-type,
.vera-cameo-small > div:first-of-type,
.vera-profile-tip > div:first-of-type {
    animation: veraGlow 3s ease-in-out infinite;
}
</style>

<!-- HISTORY VIEW -->
<div class="view" id="historyView">
    <div class="view-header">
        <div style="display:flex;align-items:center;gap:4px">
            <button class="back-btn" onclick="closeView()"><span class="ad-icon-slot" data-ad-icon="back" data-ad-size="16"></span></button>
            <button class="home-btn" onclick="openView('homeView')" title="Home"><span class="ad-icon-slot" data-ad-icon="home" data-ad-size="16"></span></button>
        </div>
        <span class="view-title">📋 History</span>
        <div class="coins-display" id="historyViewCoins">
            <img src="assets/icons/currency-coin.svg" alt="Coins" style="width:16px;height:16px;vertical-align:middle">
            <span>0</span>
        </div>
    </div>
    <div class="view-body view-body-padded" id="historyContent">
        <div class="history-empty"><div style="font-size:40px;margin-bottom:8px">📋</div><p>No scans yet</p></div>
    </div>
</div>

<!-- LEADERBOARD VIEW -->
<div class="view" id="leaderboardView">
    <div class="view-header">
        <div style="display:flex;align-items:center;gap:4px">
            <button class="back-btn" onclick="closeView()"><span class="ad-icon-slot" data-ad-icon="back" data-ad-size="16"></span></button>
            <button class="home-btn" onclick="openView('homeView')" title="Home"><span class="ad-icon-slot" data-ad-icon="home" data-ad-size="16"></span></button>
        </div>
        <span class="view-title"><span class="ad-icon-slot" data-ad-icon="trophy" data-ad-size="16"></span> Tank Commanders</span>
        <div class="coins-display" id="leaderboardViewCoins">
            <span class="ad-icon-slot" data-ad-icon="coins" data-ad-size="16"></span>
            <span>0</span>
        </div>
    </div>
    <div class="view-body view-body-padded">
        <!-- Epic Header -->
        <div style="text-align:center;margin-bottom:20px;padding:20px;background:linear-gradient(135deg,rgba(220,38,38,0.1),rgba(94,234,212,0.05));border-radius:16px;border:1px solid rgba(220,38,38,0.2)">
            <h2 style="margin:0;font-size:22px;font-weight:900;background:linear-gradient(135deg,#ff4757,#ffa502);-webkit-background-clip:text;-webkit-text-fill-color:transparent;display:flex;align-items:center;justify-content:center;gap:8px">
                <img src="assets/icons/ui-tank.svg" alt="" style="width:24px;height:24px"> TOP TANK COMMANDERS <img src="assets/icons/ui-tank.svg" alt="" style="width:24px;height:24px">
            </h2>
            <p style="margin:8px 0 0;color:var(--text3);font-size:12px">Legends who destroy the most AI fakes</p>
        </div>

        <!-- REWARDS TEASER -->
        <div class="rewards-card" style="background:linear-gradient(145deg,rgba(26,31,46,0.95),rgba(18,22,31,0.98));border:1px solid rgba(94,234,212,0.2);border-radius:16px;padding:16px;margin-bottom:20px">
            <div class="rewards-title" style="font-size:14px;font-weight:700;margin-bottom:12px;color:var(--primary);display:flex;align-items:center;gap:6px">
                <img src="assets/icons/trophy.svg" alt="" style="width:18px;height:18px"> Weekly Battle Rewards
            </div>
            <div class="rewards-list" style="display:flex;flex-direction:column;gap:8px">
                <div class="reward-item" style="display:flex;align-items:center;gap:10px;padding:10px;background:rgba(255,215,0,0.1);border-radius:10px;border-left:3px solid gold">
                    <span class="reward-icon" style="font-size:20px">👑</span>
                    <span class="reward-text" style="flex:1;font-size:12px;color:var(--text2)">SUPREME COMMANDER: 500 coins + Custom tank skin</span>
                    <span class="reward-tier" style="background:linear-gradient(135deg,#ffd700,#ff8c00);padding:2px 8px;border-radius:10px;font-size:10px;font-weight:700;color:#000">#1</span>
                </div>
                <div class="reward-item" style="display:flex;align-items:center;gap:10px;padding:10px;background:rgba(192,192,192,0.1);border-radius:10px;border-left:3px solid silver">
                    <span class="reward-icon" style="font-size:20px">⭐</span>
                    <span class="reward-text" style="flex:1;font-size:12px;color:var(--text2)">ELITE: 200 coins + Exclusive badge</span>
                    <span class="reward-tier" style="background:linear-gradient(135deg,#c0c0c0,#8b8989);padding:2px 8px;border-radius:10px;font-size:10px;font-weight:700;color:#000">Top 3</span>
                </div>
                <div class="reward-item" style="display:flex;align-items:center;gap:10px;padding:10px;background:rgba(94,234,212,0.1);border-radius:10px;border-left:3px solid var(--primary)">
                    <span class="reward-icon" style="font-size:20px">🎖️</span>
                    <span class="reward-text" style="flex:1;font-size:12px;color:var(--text2)">VETERAN: 50 coins + 2x XP boost</span>
                    <span class="reward-tier" style="background:linear-gradient(135deg,#00d4aa,#0984e3);padding:2px 8px;border-radius:10px;font-size:10px;font-weight:700;color:#000">Top 10</span>
                </div>
            </div>
        </div>
        <div class="podium" id="podium"></div>
        <div id="leaderboardContent"></div>
    </div>
</div>

<!-- PROFILE VIEW - Redesigned to match home profile card -->
<div class="view" id="profileView">
    <div class="view-header">
        <div style="display:flex;align-items:center;gap:4px">
            <button class="back-btn" onclick="closeView()"><span class="ad-icon-slot" data-ad-icon="back" data-ad-size="16"></span></button>
            <button class="home-btn" onclick="openView('homeView')" title="Home"><span class="ad-icon-slot" data-ad-icon="home" data-ad-size="16"></span></button>
        </div>
        <span class="view-title">👤 Profile</span>
        <div class="coins-display" id="profileViewCoins">
            <img src="assets/icons/currency-coin.svg" alt="Coins" style="width:16px;height:16px;vertical-align:middle">
            <span id="profileViewCoinsValue">0</span>
        </div>
    </div>
    <div class="view-body view-body-padded">

        <!-- Hero Profile Card -->
        <div class="profile-hero-card">
            <!-- Top Area: Avatar + Info -->
            <div class="profile-top-area">
                <div class="profile-avatar-lg" id="profileAvatarLg" onclick="changeProfilePic()">
                    <span id="profileAvatarEmoji">🧑‍🚀</span>
                </div>
                <div class="profile-middle-col">
                    <div class="profile-name-row">
                        <span class="profile-username" id="profileUserName">Guest</span>
                        <span class="profile-level-badge">LV <span id="profileLevel">1</span></span>
                    </div>
                    <div class="profile-title" id="profileUserTitle">Newcomer</div>
                    <div class="profile-email-small" id="profileEmailDisplay">Sign in to save progress</div>
                    <div class="profile-xp-row">
                        <div class="profile-xp-bar-container">
                            <div class="profile-xp-bar-fill" id="profileXpBarFill" style="width: 0%"></div>
                        </div>
                        <span class="profile-xp-text"><span id="profileXP">0</span>/<span id="profileXpRequired">100</span> XP</span>
                    </div>
                </div>
            </div>

            <!-- Edit Profile Button -->
            <button class="profile-edit-btn" onclick="openAvatarView()">
                <span>🎨</span> Edit Profile
            </button>
        </div>

        <!-- Badges Section -->
        <div class="profile-section-title">🎖️ Badges <button class="see-all-btn" onclick="openAllBadges()">See All →</button></div>
        <div class="badges-grid-modern" id="badgesPreview">
            <!-- Populated by JS -->
        </div>
    </div>
</div>

<!-- ALL BADGES VIEW -->
<div class="view" id="allBadgesView">
    <div class="view-header">
        <div style="display:flex;align-items:center;gap:4px">
            <button class="back-btn" onclick="closeView()"><span class="ad-icon-slot" data-ad-icon="back" data-ad-size="16"></span></button>
            <button class="home-btn" onclick="openView('homeView')" title="Home"><span class="ad-icon-slot" data-ad-icon="home" data-ad-size="16"></span></button>
        </div>
        <span class="view-title"><span class="ad-icon-slot" data-ad-icon="badges" data-ad-size="16"></span> All Badges</span>
        <div class="coins-display" id="badgesViewCoins">
            <img src="assets/icons/currency-coin.svg" alt="Coins" style="width:16px;height:16px;vertical-align:middle">
            <span>0</span>
        </div>
    </div>
    <div class="view-body view-body-padded" id="allBadgesContent"></div>
</div>

<!-- QUESTS VIEW - POLISHED -->
<div class="view" id="questsView">
    <div class="view-header">
        <div style="display:flex;align-items:center;gap:4px">
            <button class="back-btn" onclick="closeView()"><span class="ad-icon-slot" data-ad-icon="back" data-ad-size="16"></span></button>
            <button class="home-btn" onclick="openView('homeView')" title="Home"><span class="ad-icon-slot" data-ad-icon="home" data-ad-size="16"></span></button>
        </div>
        <span class="view-title"><span class="ad-icon-slot" data-ad-icon="quest" data-ad-size="16"></span> Quests</span>
        <div class="coins-display" id="questsViewCoins">
            <img src="assets/icons/currency-coin.svg" alt="Coins" style="width:16px;height:16px;vertical-align:middle">
            <span>0</span>
        </div>
    </div>
    <div class="view-body view-body-padded">
        <!-- Quest Summary Card -->
        <div class="quest-summary-card">
            <div class="quest-summary-stat">
                <span class="quest-summary-value" id="questsCompleted">0</span>
                <span class="quest-summary-label">Completed</span>
            </div>
            <div class="quest-summary-stat">
                <span class="quest-summary-value" id="questsAvailable">0</span>
                <span class="quest-summary-label">Available</span>
            </div>
        </div>

        <div class="quest-section">
            <div class="quest-section-header">
                <h3>📅 Daily Quests</h3>
                <div class="quest-timer" id="dailyTimer">Resets in: --:--:--</div>
            </div>
            <div class="quest-list" id="dailyQuests"></div>
        </div>
        <div class="quest-section">
            <div class="quest-section-header">
                <h3>🌟 Weekly Challenges</h3>
                <div class="quest-timer" id="weeklyTimer">Resets in: -- days</div>
            </div>
            <div class="quest-list" id="weeklyQuests"></div>
        </div>
        <div class="quest-section">
            <div class="quest-section-header">
                <h3>🏆 Special Events</h3>
            </div>
            <div class="quest-list" id="specialQuests"></div>
        </div>
    </div>
</div>

<!-- AVATAR CUSTOMIZATION VIEW -->
<div class="view" id="avatarView">
    <div class="view-header">
        <div style="display:flex;align-items:center;gap:4px">
            <button class="back-btn" onclick="closeView()"><span class="ad-icon-slot" data-ad-icon="back" data-ad-size="16"></span></button>
            <button class="home-btn" onclick="openView('homeView')" title="Home"><span class="ad-icon-slot" data-ad-icon="home" data-ad-size="16"></span></button>
        </div>
        <span class="view-title"><span class="ad-icon-slot" data-ad-icon="profile" data-ad-size="16"></span> Character Designer</span>
        <div class="coins-display" id="avatarViewCoins">
            <span class="ad-icon-slot" data-ad-icon="coins" data-ad-size="16"></span>
            <span id="designerCoinsCount">0</span>
        </div>
    </div>
    <div class="view-body view-body-padded">

        <!-- Phaser Character Canvas (Bone-Rigged Animation) - Hidden until Phaser loads -->
        <div id="phaserCharacterCanvas" class="loading" style="display:none">
            <div class="drag-hint">Drag to rotate</div>
        </div>

        <!-- Animation Controls - Hidden until Phaser works -->
        <div class="animation-controls" style="display:none">
            <button class="anim-btn active" onclick="playCharacterAnimation('idle'); this.parentNode.querySelector('.active')?.classList.remove('active'); this.classList.add('active');">
                <span class="anim-icon">🧘</span>
                <span class="anim-label">Idle</span>
            </button>
            <button class="anim-btn" onclick="playCharacterAnimation('walk'); this.parentNode.querySelector('.active')?.classList.remove('active'); this.classList.add('active');">
                <span class="anim-icon">🚶</span>
                <span class="anim-label">Walk</span>
            </button>
            <button class="anim-btn" onclick="playCharacterAnimation('attack'); this.parentNode.querySelector('.active')?.classList.remove('active'); this.classList.add('active');">
                <span class="anim-icon">⚔️</span>
                <span class="anim-label">Attack</span>
            </button>
            <button class="anim-btn" onclick="playCharacterAnimation('victory'); this.parentNode.querySelector('.active')?.classList.remove('active'); this.classList.add('active');">
                <span class="anim-icon">🎉</span>
                <span class="anim-label">Victory</span>
            </button>
        </div>

        <!-- Color Customization Section - Hidden until implemented -->
        <div class="color-picker-section" style="display:none">
            <h4><span class="ad-icon-slot" data-ad-icon="palette" data-ad-size="16"></span> Colors</h4>
            <div id="skinColorPicker"></div>
            <div id="hairColorPicker"></div>
            <div id="eyeColorPicker"></div>
            <div id="clothesColorPicker"></div>
        </div>

        <!-- Character Stage - Visual Preview -->
        <div class="character-stage" id="characterStage">
            <!-- Mode Toggle -->
            <div class="character-mode-toggle">
                <button class="mode-btn active" id="standModeBtn" onclick="setCharacterMode('stand')">
                    <span class="ad-icon-slot" data-ad-icon="profile" data-ad-size="14"></span> Stand
                </button>
                <button class="mode-btn" id="tankModeBtn" onclick="setCharacterMode('tank')">
                    <span class="ad-icon-slot" data-ad-icon="tank" data-ad-size="14"></span> Tank
                </button>
            </div>

            <!-- Tank Riding Container -->
            <div class="tank-ride-container" id="tankRideContainer">
                <div class="tank-body"><img src="assets/game/sprites/tank.svg" alt="Tank" class="tank-visual"></div>
            </div>

            <!-- Character Container with body parts -->
            <div class="character-container" id="characterContainer">
                <!-- Back item layer -->
                <div class="character-part char-back" id="charBack" onclick="selectBodyPart('back')" title="Back Item"></div>

                <!-- Hat layer -->
                <div class="character-part char-hat" id="charHat" onclick="selectBodyPart('hat')" title="Hat"></div>

                <!-- Head layer -->
                <div class="character-part char-head" id="charHead" onclick="selectBodyPart('head')" title="Head"></div>

                <!-- Glasses layer -->
                <div class="character-part char-glasses" id="charGlasses" onclick="selectBodyPart('glasses')" title="Glasses"></div>

                <!-- Left Arm -->
                <div class="character-part char-left-arm" id="charLeftArm" onclick="selectBodyPart('leftArm')" title="Left Arm"></div>

                <!-- Torso layer -->
                <div class="character-part char-torso" id="charTorso" onclick="selectBodyPart('torso')" title="Torso"></div>

                <!-- Right Arm -->
                <div class="character-part char-right-arm" id="charRightArm" onclick="selectBodyPart('rightArm')" title="Right Arm"></div>

                <!-- Weapon layer -->
                <div class="character-part char-weapon" id="charWeapon" onclick="selectBodyPart('weapon')" title="Weapon"></div>

                <!-- Legs layer -->
                <div class="character-part char-legs" id="charLegs" onclick="selectBodyPart('legs')" title="Legs"></div>

                <!-- Pet layer -->
                <div class="character-part char-pet" id="charPet" onclick="selectBodyPart('pet')" title="Pet"></div>

                <!-- Effect/Aura layer -->
                <div class="char-effect" id="charEffect">
                    <div class="effect-particles" id="effectParticles"></div>
                </div>
                <div class="character-extra-layer" id="characterExtraLayer"></div>
            </div>

            <!-- Ground shadow -->
            <div class="character-shadow" id="characterShadow"></div>

            <!-- Character Name -->
            <div class="character-name-display">
                <span id="characterNameLabel">Truth Seeker</span>
            </div>
        </div>


        <div class="designer-section-header">
            <h3><span class="ad-icon-slot" data-ad-icon="corruption" data-ad-size="16"></span> Mutation Controls</h3>
            <span class="item-count">Max 2 extra limbs each</span>
        </div>
        <div class="mutation-controls" id="mutationControls">
            <div class="mutation-control">
                <span>Extra Arms</span>
                <button class="mutation-btn" onclick="adjustMutations('arms', -1)">-</button>
                <span id="extraArmsCount">0</span>
                <button class="mutation-btn" onclick="adjustMutations('arms', 1)">+</button>
            </div>
            <div class="mutation-control">
                <span>Extra Legs</span>
                <button class="mutation-btn" onclick="adjustMutations('legs', -1)">-</button>
                <span id="extraLegsCount">0</span>
                <button class="mutation-btn" onclick="adjustMutations('legs', 1)">+</button>
            </div>
        </div>

        <!-- Equipment Slots Overview -->
        <div class="designer-section-header">
            <h3><span class="ad-icon-slot" data-ad-icon="inventory" data-ad-size="16"></span> Equipped Items</h3>
            <span class="item-count" id="equippedCount">0/10</span>
        </div>
        <div class="equipment-slots" id="equipmentSlots">
            <div class="equip-slot" data-slot="head" onclick="selectBodyPart('head')">
                <span class="equip-slot-icon" id="slotHeadIcon"></span>
                <span class="equip-slot-label">Head</span>
            </div>
            <div class="equip-slot" data-slot="torso" onclick="selectBodyPart('torso')">
                <span class="equip-slot-icon" id="slotTorsoIcon"></span>
                <span class="equip-slot-label">Torso</span>
            </div>
            <div class="equip-slot" data-slot="legs" onclick="selectBodyPart('legs')">
                <span class="equip-slot-icon" id="slotLegsIcon"></span>
                <span class="equip-slot-label">Legs</span>
            </div>
            <div class="equip-slot" data-slot="weapon" onclick="selectBodyPart('weapon')">
                <span class="equip-slot-icon" id="slotWeaponIcon"></span>
                <span class="equip-slot-label">Weapon</span>
            </div>
            <div class="equip-slot" data-slot="hat" onclick="selectBodyPart('hat')">
                <span class="equip-slot-icon" id="slotHatIcon"></span>
                <span class="equip-slot-label">Hat</span>
            </div>
            <div class="equip-slot" data-slot="glasses" onclick="selectBodyPart('glasses')">
                <span class="equip-slot-icon" id="slotGlassesIcon"></span>
                <span class="equip-slot-label">Glasses</span>
            </div>
            <div class="equip-slot" data-slot="back" onclick="selectBodyPart('back')">
                <span class="equip-slot-icon" id="slotBackIcon"></span>
                <span class="equip-slot-label">Back</span>
            </div>
            <div class="equip-slot" data-slot="pet" onclick="selectBodyPart('pet')">
                <span class="equip-slot-icon" id="slotPetIcon"></span>
                <span class="equip-slot-label">Pet</span>
            </div>
        </div>

        <!-- Body Part Selection Tabs -->
        <div class="designer-section-header">
            <h3><span class="ad-icon-slot" data-ad-icon="store" data-ad-size="16"></span> Select Items</h3>
        </div>
        <div class="body-part-tabs" id="bodyPartTabs">
            <button class="body-part-tab active" data-part="all" onclick="filterDesignerItems('all', this)"><span class="ad-icon-slot" data-ad-icon="sparkles" data-ad-size="14"></span> All</button>
            <button class="body-part-tab" data-part="head" onclick="filterDesignerItems('head', this)"><span class="ad-icon-slot" data-ad-icon="profile" data-ad-size="14"></span> Heads</button>
            <button class="body-part-tab" data-part="torso" onclick="filterDesignerItems('torso', this)"><span class="ad-icon-slot" data-ad-icon="shield" data-ad-size="14"></span> Torso</button>
            <button class="body-part-tab" data-part="legs" onclick="filterDesignerItems('legs', this)"><span class="ad-icon-slot" data-ad-icon="stats" data-ad-size="14"></span> Legs</button>
            <button class="body-part-tab" data-part="weapon" onclick="filterDesignerItems('weapon', this)"><span class="ad-icon-slot" data-ad-icon="wand" data-ad-size="14"></span> Weapons</button>
            <button class="body-part-tab" data-part="hat" onclick="filterDesignerItems('hat', this)"><span class="ad-icon-slot" data-ad-icon="star" data-ad-size="14"></span> Hats</button>
            <button class="body-part-tab" data-part="glasses" onclick="filterDesignerItems('glasses', this)"><span class="ad-icon-slot" data-ad-icon="search" data-ad-size="14"></span> Glasses</button>
            <button class="body-part-tab" data-part="back" onclick="filterDesignerItems('back', this)"><span class="ad-icon-slot" data-ad-icon="sparkles" data-ad-size="14"></span> Back</button>
            <button class="body-part-tab" data-part="pet" onclick="filterDesignerItems('pet', this)"><span class="ad-icon-slot" data-ad-icon="beasts" data-ad-size="14"></span> Pets</button>
        </div>

        <!-- Items Selection Grid -->
        <div class="items-selection-grid" id="itemsSelectionGrid">
            <!-- Items will be populated by JavaScript -->
        </div>

        <!-- Shop CTA Banner -->
        <div class="shop-cta-section" style="margin-top: 24px;">
            <button onclick="openShop()" style="width: 100%; padding: 16px 20px; background: linear-gradient(135deg, #6366f1, #8b5cf6); border: 2px solid rgba(139, 92, 246, 0.5); border-radius: 16px; color: white; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 12px; font-size: 16px; font-weight: 700;">
                <span style="font-size: 24px;">🏪</span>
                <span>Visit Shop for More Items</span>
                <span style="font-size: 18px;">→</span>
            </button>
        </div>
    </div>
</div>

<!-- GACHA RESULTS MODAL -->
<div class="modal" id="gachaResultModal" style="display:none">
    <div class="modal-content gacha-result-content">
        <div class="gacha-result-header">
            <h2><span class="ad-icon-slot" data-ad-icon="lootbox" data-ad-size="18"></span> You Got:</h2>
            <button class="modal-close" onclick="closeGachaResult()"><span class="ad-icon-slot" data-ad-icon="back" data-ad-size="14"></span></button>
        </div>
        <div class="gacha-results-grid" id="gachaResultsGrid"></div>
        <div class="gacha-result-actions">
            <button class="btn-primary" onclick="closeGachaResult()">Awesome!</button>
            <button class="btn-secondary" onclick="closeGachaResult(); rollGacha(1)">Roll Again</button>
        </div>
    </div>
</div>

<!-- QUESTS POPUP (Floating on Home Screen) -->
<div class="quests-popup" id="questsPopup" style="display:none">
    <div class="quests-popup-header">
        <h3>📋 Daily Quests</h3>
        <button class="popup-close" onclick="toggleQuestsPopup()">✕</button>
    </div>
    <div class="quests-popup-body" id="questsPopupBody">
        <!-- Quest items populated by JS -->
    </div>
    <div class="quests-popup-footer">
        <button class="btn-secondary" onclick="openQuestsView(); toggleQuestsPopup();">View All Quests</button>
    </div>
</div>

<!-- LOGIN VIEW -->
<div class="view" id="loginView">
    <div class="view-header">
        <span class="view-title" id="loginViewTitle">Sign In</span>
        <button class="view-close" onclick="closeView()">✕</button>
    </div>
    <div class="view-body">
        <div class="login-content">
            <div class="login-hero">
                <div class="logo-icon" id="loginLogo" style="margin:0 auto 14px"></div>
                <h2 id="loginHeroTitle">Welcome Back</h2>
                <p id="loginHeroSubtitle">Sign in to access all features</p>
            </div>
            <div class="login-error" id="loginError"></div>
            <div class="login-form">
                <div class="input-group hidden" id="nameGroup"><label>Display Name</label><input type="text" id="nameInput" placeholder="Your name"></div>
                <div class="input-group"><label>Email</label><input type="email" id="emailInput" placeholder="you@example.com"></div>
                <div class="input-group"><label>Password</label><input type="password" id="passwordInput" placeholder="••••••••"></div>
                <div class="forgot-password" id="forgotPasswordLink"><a onclick="showForgotPassword()">Forgot your password?</a></div>
                <button class="login-submit" id="loginSubmit" onclick="submitLogin()">Sign In</button>
            </div>
            <div class="login-toggle" id="loginToggle">Don't have an account? <a onclick="toggleLoginMode()">Sign Up</a></div>
            <button class="login-guest" onclick="continueAsGuest()">Continue as Guest</button>
        </div>
    </div>
</div>

<!-- SQUADS VIEW -->
<div class="view" id="squadsView">
    <div class="view-header">
        <div style="display:flex;align-items:center;gap:4px">
            <button class="back-btn" onclick="closeView()"><span class="ad-icon-slot" data-ad-icon="back" data-ad-size="16"></span></button>
            <button class="home-btn" onclick="openView('homeView')" title="Home"><span class="ad-icon-slot" data-ad-icon="home" data-ad-size="16"></span></button>
        </div>
        <span class="view-title"><span class="ad-icon-slot" data-ad-icon="friends" data-ad-size="16"></span> Squads</span>
        <button class="icon-btn" onclick="showCreateSquad()">➕</button>
    </div>
    <div class="view-body view-body-padded">
        <!-- My Squad Card -->
        <div class="my-squad-card" id="mySquadCard" style="display:none">
            <div class="squad-header">
                <img class="squad-avatar" id="squadAvatar" src="" alt="">
                <div class="squad-info">
                    <div class="squad-name" id="squadName">Loading...</div>
                    <div class="squad-members" id="squadMemberCount">0/5 members</div>
                </div>
                <button class="squad-settings-btn" onclick="showSquadSettings()">⚙️</button>
            </div>

            <!-- Weekly Challenge -->
            <div class="weekly-challenge">
                <div class="challenge-header">
                    <span>🏆 Weekly Challenge</span>
                    <span id="challengeTimer">Resets in 3d 12h</span>
                </div>
                <div class="challenge-progress">
                    <div class="challenge-bar">
                        <div class="challenge-fill" id="challengeFill" style="width:0%"></div>
                    </div>
                    <div class="challenge-label">
                        <span id="challengeProgress">0</span> / <span id="challengeGoal">100</span> points
                    </div>
                </div>
            </div>

            <!-- Squad Members -->
            <div class="squad-members-list" id="squadMembersList"></div>

            <!-- Squad Stats -->
            <div class="squad-stats">
                <div class="squad-stat">
                    <div class="squad-stat-value" id="squadRank">--</div>
                    <div class="squad-stat-label">Global Rank</div>
                </div>
                <div class="squad-stat">
                    <div class="squad-stat-value" id="squadPoints">0</div>
                    <div class="squad-stat-label">Total Points</div>
                </div>
                <div class="squad-stat">
                    <div class="squad-stat-value" id="squadAccuracy">--</div>
                    <div class="squad-stat-label">Accuracy</div>
                </div>
            </div>
        </div>

        <!-- No Squad State -->
        <div class="no-squad" id="noSquadState">
            <div style="font-size:60px;margin-bottom:16px">👥</div>
            <h3 style="margin:0 0 8px">Join a Squad!</h3>
            <p style="color:var(--text2);margin:0 0 24px;line-height:1.5">
                Team up with 4 other players. Compete in weekly challenges,
                climb the squad leaderboard, and earn exclusive rewards!
            </p>
            <button class="cta-btn" onclick="showJoinSquad()">
                🔍 Browse Squads
            </button>
            <button class="cta-btn-secondary" onclick="showCreateSquad()">
                ➕ Create Squad
            </button>
        </div>

        <!-- Squad Leaderboard -->
        <div class="section-header" style="margin-top:32px">
            <h3>🏆 Squad Leaderboard</h3>
        </div>
        <div id="squadLeaderboardContent"></div>
    </div>
</div>

<!-- OUTBREAKS VIEW - Tank Shooter Battle Mode -->
<div class="view" id="outbreaksView">
    <div class="view-header">
        <div style="display:flex;align-items:center;gap:4px">
            <button class="back-btn" onclick="closeView()"><span class="ad-icon-slot" data-ad-icon="back" data-ad-size="16"></span></button>
            <button class="home-btn" onclick="openView('homeView')" title="Home"><span class="ad-icon-slot" data-ad-icon="home" data-ad-size="16"></span></button>
        </div>
        <span class="view-title"><span class="ad-icon-slot" data-ad-icon="tank" data-ad-size="16"></span> Tank Battle</span>
        <div style="width:44px"></div>
    </div>
    <div class="view-body view-body-padded">
        <!-- HERO BATTLE SCENE - Epic Tank vs AI Monsters -->
        <div class="battle-hero" style="background:linear-gradient(180deg, rgba(220,38,38,0.05) 0%, transparent 100%);border-radius:20px;padding:28px 20px">
            <div class="battle-scene" style="gap:30px">
                <!-- Your Tank (left side) -->
                <div class="battle-tank battle-tank-hero">
                    <img src="assets/game/sprites/tank.svg" alt="Tank Commander" class="battle-tank-visual">
                    <div class="tank-label" style="margin-top:8px">COMMANDER</div>
                </div>

                <!-- VS Symbol -->
                <div class="battle-vs">VS</div>

                <!-- AI Monsters (right side) -->
                <div class="battle-enemies">
                    <div class="enemy-monster enemy-1" title="GLITCH - Corrupts your aim">
                        <img src="assets/game/bestiary/common_1.svg" alt="Glitch Imp">
                    </div>
                    <div class="enemy-monster enemy-2" title="PHANTOM - Hard to detect">
                        <img src="assets/game/bestiary/uncommon_2.svg" alt="Phantom Veil">
                    </div>
                    <div class="enemy-monster enemy-3" title="VIRUS - Spreads fast">
                        <img src="assets/game/bestiary/rare_2.svg" alt="Neural Virus">
                    </div>
                    <div class="enemy-monster boss" title="BOSS INCOMING">
                        <img src="assets/game/bestiary/legendary_1.svg" alt="Legendary Boss">
                    </div>
                    <div class="enemy-label">AI THREATS DETECTED</div>
                </div>
            </div>
            <h1 class="battle-title" style="font-size:26px;margin-top:20px">OUTBREAK DETECTED</h1>
            <p class="battle-subtitle" style="font-size:13px">Digital monsters are invading! Pilot your tank and destroy them all!</p>
        </div>

        <!-- Active Outbreak Card -->
        <div class="outbreak-card active-outbreak" id="activeOutbreak">
            <div class="outbreak-badge"><span class="ad-icon-slot" data-ad-icon="warning" data-ad-size="14"></span> ACTIVE NOW</div>
            <div class="outbreak-card-header">
                <h2 id="outbreakCardTitle">Deepfake Invasion</h2>
                <div class="outbreak-difficulty" id="outbreakDifficulty">
                    <span class="ad-icon-slot" data-ad-icon="star" data-ad-size="14"></span><span class="ad-icon-slot" data-ad-icon="star" data-ad-size="14"></span><span class="ad-icon-slot" data-ad-icon="star" data-ad-size="14"></span>
                </div>
            </div>
            <p class="outbreak-description" id="outbreakDescription">
                Waves of corrupted beasts are attacking! Jump in your tank and blast them before they overwhelm the zone!
            </p>

            <!-- Timer -->
            <div class="outbreak-timer-big">
                <div class="timer-label"><span class="ad-icon-slot" data-ad-icon="refresh" data-ad-size="12"></span> Event Ends In</div>
                <div class="timer-display" id="outbreakTimerBig">23:45:12</div>
            </div>

            <!-- Battle Stats -->
            <div class="battle-stats">
                <div class="battle-stat-card">
                    <div class="stat-icon"><span class="ad-icon-slot" data-ad-icon="crosshair" data-ad-size="16"></span></div>
                    <div class="stat-value" id="totalFakesDestroyed">1,247</div>
                    <div class="stat-label">Fakes Destroyed</div>
                </div>
                <div class="battle-stat-card">
                    <div class="stat-icon"><span class="ad-icon-slot" data-ad-icon="trophy" data-ad-size="16"></span></div>
                    <div class="stat-value" id="highestWave">Wave 12</div>
                    <div class="stat-label">Your Best</div>
                </div>
                <div class="battle-stat-card">
                    <div class="stat-icon"><span class="ad-icon-slot" data-ad-icon="coins" data-ad-size="16"></span></div>
                    <div class="stat-value" id="coinsThisOutbreak">350</div>
                    <div class="stat-label">Coins Earned</div>
                </div>
            </div>

            <!-- Rewards -->
            <div class="outbreak-rewards">
                <div class="rewards-label"><span class="ad-icon-slot" data-ad-icon="trophy" data-ad-size="14"></span> Battle Rewards</div>
                <div class="reward-pills">
                    <div class="reward-pill"><span class="ad-icon-slot" data-ad-icon="coins" data-ad-size="14"></span> Coins per Wave</div>
                    <div class="reward-pill"><span class="ad-icon-slot" data-ad-icon="star" data-ad-size="14"></span> Grade Bonus (S+ = 2.5x)</div>
                    <div class="reward-pill"><span class="ad-icon-slot" data-ad-icon="badges" data-ad-size="14"></span> "Tank Commander" Badge</div>
                </div>
            </div>

            <!-- BIG PLAY BUTTON -->
            <button class="tank-play-btn" onclick="startTankShooter()">
                <div class="tank-btn-glow"></div>
                <div class="tank-btn-content">
                    <span class="tank-btn-icon"><span class="ad-icon-slot" data-ad-icon="play" data-ad-size="20"></span></span>
                    <span class="tank-btn-text">BATTLE NOW</span>
                    <span class="tank-btn-sub">Destroy AI Fakes!</span>
                </div>
            </button>
        </div>

        <!-- Leaderboard -->
        <div class="outbreak-card" style="margin-top:20px;">
            <h3 style="margin-bottom:16px;display:flex;align-items:center;gap:8px;">
                <span class="ad-icon-slot" data-ad-icon="trophy" data-ad-size="16"></span> Top Tank Commanders
            </h3>
            <div id="outbreakTopHunters"></div>
        </div>

        <!-- Past Battles -->
        <div class="section-header" style="margin-top:32px">
            <h3><span class="ad-icon-slot" data-ad-icon="history" data-ad-size="16"></span> Your Battle History</h3>
        </div>
        <div id="pastOutbreaks" class="battle-history">
            <div class="history-placeholder">Play some battles to see your history!</div>
        </div>
    </div>
</div>

<!-- TRUTH CANNON GAME (Fullscreen Overlay) -->
<div class="truth-cannon-game" id="truthCannonGame" style="display:none">
    <!-- Game Header -->
    <div class="game-header">
        <button class="game-close-btn" onclick="closeTruthCannon()"><span class="ad-icon-slot" data-ad-icon="back" data-ad-size="16"></span></button>
        <div class="game-stats-row">
            <div class="game-stat">
                <div class="game-stat-label">WAVE</div>
                <div class="game-stat-value" id="gameWave">1</div>
            </div>
            <div class="game-stat">
                <div class="game-stat-label">SCORE</div>
                <div class="game-stat-value" id="gameScore">0</div>
            </div>
            <div class="game-stat">
                <div class="game-stat-label">COMBO</div>
                <div class="game-stat-value" id="gameCombo">x1</div>
            </div>
        </div>
    </div>

    <!-- Health Bar -->
    <div class="credibility-bar-container">
        <div class="credibility-label">
            <span>TANK HEALTH</span>
            <span id="credibilityPercent">100%</span>
        </div>
        <div class="credibility-bar">
            <div class="credibility-fill" id="credibilityFill" style="width:100%"></div>
        </div>
    </div>

    <!-- Game Canvas -->
    <canvas id="gameCanvas"></canvas>

    <!-- Power-Ups Bar -->
    <div class="powerups-bar" id="powerupsBar" style="display:flex;justify-content:center;gap:8px;padding:12px;background:rgba(0,0,0,0.3)">
        <button class="powerup-btn" id="powerup1" onclick="activatePowerUp('slowMo')" data-cooldown="0">
            <div class="powerup-icon">⏰</div>
            <div class="powerup-name">Slow-Mo</div>
            <div class="powerup-cooldown" style="display:none">0s</div>
        </button>
        <button class="powerup-btn" id="powerup2" onclick="activatePowerUp('scatterShot')" data-cooldown="0">
            <div class="powerup-icon">💥</div>
            <div class="powerup-name">Scatter</div>
            <div class="powerup-cooldown" style="display:none">0s</div>
        </button>
        <button class="powerup-btn" id="powerup3" onclick="activatePowerUp('xRay')" data-cooldown="0">
            <div class="powerup-icon">👁️</div>
            <div class="powerup-name">X-Ray</div>
            <div class="powerup-cooldown" style="display:none">0s</div>
        </button>
        <button class="powerup-btn" id="powerup4" onclick="activatePowerUp('shield')" data-cooldown="0">
            <div class="powerup-icon">🛡️</div>
            <div class="powerup-name">Shield</div>
            <div class="powerup-cooldown" style="display:none">0s</div>
        </button>
        <button class="powerup-btn" id="powerup5" onclick="activatePowerUp('emp')" data-cooldown="0">
            <div class="powerup-icon">⚡</div>
            <div class="powerup-name">EMP</div>
            <div class="powerup-cooldown" style="display:none">0s</div>
        </button>
    </div>

    <!-- Mobile Controls Overlay -->
    <div id="mobileControls" style="display:none;position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none">
        <div id="joystickZone" style="position:absolute;bottom:80px;left:20px;width:120px;height:120px;pointer-events:all"></div>
        <button id="fireBtn" style="position:absolute;bottom:100px;right:20px;width:80px;height:80px;border-radius:50%;background:rgba(255,68,120,0.8);border:3px solid #fff;font-size:32px;display:flex;align-items:center;justify-content:center;pointer-events:all">🔥</button>
    </div>

    <!-- Game Over Screen -->
    <div class="game-over-screen" id="gameOverScreen" style="display:none">
        <div class="game-over-content">
            <h1>MISSION COMPLETE</h1>
            <div class="game-over-grade" id="gameOverGrade" style="font-size:48px;font-weight:900;margin-bottom:16px;color:var(--primary)">S</div>
            <div class="game-over-stats">
                <div class="game-over-stat">
                    <div class="game-over-stat-label">Wave</div>
                    <div class="game-over-stat-value" id="finalWave">--</div>
                </div>
                <div class="game-over-stat">
                    <div class="game-over-stat-label">Score</div>
                    <div class="game-over-stat-value" id="finalScore">--</div>
                </div>
                <div class="game-over-stat">
                    <div class="game-over-stat-label">Enemies</div>
                    <div class="game-over-stat-value" id="finalFakes">--</div>
                </div>
            </div>
            <div class="game-over-rewards">
                <div class="reward-earned">
                    <span style="font-size:32px">🪙</span>
                    <span id="coinsEarned" style="font-size:32px;font-weight:700">+0</span>
                </div>
            </div>
            <div class="game-over-buttons">
                <button class="game-retry-btn" onclick="retryTankShooter()">
                    🔄 PLAY AGAIN
                </button>
                <button class="game-quit-btn" onclick="closeTankShooter()">
                    ← Back to Outbreaks
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bottom Navigation -->
<div class="game-nav" id="gameNav" style="display:none">
    <button class="game-nav-btn" data-view="squadsView" onclick="openView('squadsView')">
        <div class="game-nav-icon"><span class="ad-icon-slot" data-ad-icon="friends" data-ad-size="20"></span></div>
        <div class="game-nav-label">Squad</div>
    </button>
    <button class="game-nav-btn" data-view="leaderboardView" onclick="openView('leaderboardView')">
        <div class="game-nav-icon"><span class="ad-icon-slot" data-ad-icon="trophy" data-ad-size="20"></span></div>
        <div class="game-nav-label">Ranks</div>
    </button>
    <button class="game-nav-btn" data-view="shopView" onclick="openView('shopView')">
        <div class="game-nav-icon"><span class="ad-icon-slot" data-ad-icon="coins" data-ad-size="20"></span></div>
        <div class="game-nav-label">Shop</div>
    </button>
</div>

<!-- HELP VIEW -->
<div class="view" id="helpView">
    <div class="view-header">
        <div style="display:flex;align-items:center;gap:4px">
            <button class="back-btn" onclick="closeView()"><span class="ad-icon-slot" data-ad-icon="back" data-ad-size="16"></span></button>
            <button class="home-btn" onclick="openView('homeView')" title="Home"><span class="ad-icon-slot" data-ad-icon="home" data-ad-size="16"></span></button>
        </div>
        <span class="view-title">❓ Help</span>
        <div style="width:44px"></div>
    </div>
    <div class="view-body view-body-padded">
        <div class="help-section">
            <div class="help-header" onclick="toggleHelp(this)"><div class="help-title">📲 How to Install</div><span class="help-toggle">▼</span></div>
            <div class="help-content"><div class="help-text"><p><strong>Android:</strong> Tap install banner or menu → Install app</p><p><strong>iOS:</strong> Tap Share → Add to Home Screen → Add</p><p>Install for fastest performance and offline access!</p></div></div>
        </div>
        <div class="help-section">
            <div class="help-header" onclick="toggleHelp(this)"><div class="help-title">🪙 Truth Coins & Progression</div><span class="help-toggle">▼</span></div>
            <div class="help-content"><div class="help-text">
                <p><strong>Earn Coins:</strong> Scan images (+10-50), complete quests (+30-500), win games (+50-300), vote on submissions (+10)</p>
                <p><strong>Spend Coins:</strong> Shop items, gacha rolls (100-900 coins), exclusive cosmetics</p>
                <p><strong>Level Up:</strong> Gain XP from scans and quests to unlock new badges and features!</p>
            </div></div>
        </div>
        <div class="help-section">
            <div class="help-header" onclick="toggleHelp(this)"><div class="help-title">⚡ Quest System</div><span class="help-toggle">▼</span></div>
            <div class="help-content"><div class="help-text">
                <p><strong>Daily Quests:</strong> Reset every 24 hours - scan images, vote, play games (30-60 coins each)</p>
                <p><strong>Weekly Challenges:</strong> Reset every 7 days - longer goals, bigger rewards (200-500 coins + exclusive cosmetics)</p>
                <p><strong>Special Quests:</strong> One-time achievements - reach milestones, earn rare avatars and frames!</p>
                <p>Access quests from your profile menu!</p>
            </div></div>
        </div>
        <div class="help-section">
            <div class="help-header" onclick="toggleHelp(this)"><div class="help-title">🎨 Avatar Customization</div><span class="help-toggle">▼</span></div>
            <div class="help-content"><div class="help-text">
                <p><strong>Avatars:</strong> 50+ AI-themed characters - robots, cyborgs, holograms, glitch effects</p>
                <p><strong>Frames:</strong> 30+ decorative borders - neon circuits, quantum fields, hologram rings</p>
                <p><strong>Effects:</strong> 20+ particle effects - sparkles, lightning, flames, vortex</p>
                <p><strong>Titles:</strong> 40+ prestigious titles displayed under your name</p>
                <p><strong>Rarity Tiers:</strong> Common (gray), Rare (blue), Epic (purple), Legendary (gold)</p>
                <p>Your equipped avatar appears in the leaderboard, profile, AND sticks out of your tank in the game!</p>
            </div></div>
        </div>
        <div class="help-section">
            <div class="help-header" onclick="toggleHelp(this)"><div class="help-title">🎲 Gacha / Mystery Rolls</div><span class="help-toggle">▼</span></div>
            <div class="help-content"><div class="help-text">
                <p><strong>Single Roll:</strong> 100 coins - 1 random cosmetic item</p>
                <p><strong>10-Roll:</strong> 900 coins (10% discount!) - 10 random items with guaranteed rare+</p>
                <p><strong>Drop Rates:</strong> 60% Common, 25% Rare, 12% Epic, 3% Legendary</p>
                <p>Collect them all! Duplicate protection increases your luck over time.</p>
            </div></div>
        </div>
        <div class="help-section">
            <div class="help-header" onclick="toggleHelp(this)"><div class="help-title">🎮 Tank Shooter Game</div><span class="help-toggle">▼</span></div>
            <div class="help-content"><div class="help-text">
                <p><strong>Access:</strong> Click the 🎮 button in the header</p>
                <p><strong>Controls:</strong> Arrow keys / WASD / Touch joystick to move, Space / Tap to shoot</p>
                <p><strong>Power-Ups:</strong> Use number keys 1-5 or tap power-up buttons - Shield, Slow-Mo, Scatter Shot, Laser, Missiles, and more!</p>
                <p><strong>Waves:</strong> 30+ waves of increasing difficulty, boss every 5 waves</p>
                <p><strong>Enemies:</strong> Spam Bots, Fake News Drones, Deepfake Tanks, Bot Swarms, Elite AI Bosses, and more!</p>
                <p><strong>Rewards:</strong> Earn coins based on waves cleared, bonus for perfect runs!</p>
                <p>Your equipped avatar and cosmetics appear in your tank!</p>
            </div></div>
        </div>
        <div class="help-section">
            <div class="help-header" onclick="toggleHelp(this)"><div class="help-title">🛒 Shop System</div><span class="help-toggle">▼</span></div>
            <div class="help-content"><div class="help-text">
                <p><strong>Cosmetics:</strong> Exclusive skins, backgrounds, badge styles</p>
                <p><strong>Power-Ups:</strong> Game boosts, scan enhancers, XP multipliers</p>
                <p><strong>Exclusive Badges:</strong> Premium badges not available elsewhere</p>
                <p><strong>Boosters:</strong> Temporary buffs for coins, XP, or accuracy</p>
                <p>20+ items available, more added regularly!</p>
            </div></div>
        </div>
        <div class="help-section">
            <div class="help-header" onclick="toggleHelp(this)"><div class="help-title">🎖️ Badges & Achievements</div><span class="help-toggle">▼</span></div>
            <div class="help-content"><div class="help-text">
                <p>Earn badges by completing achievements:</p>
                <p>• <strong>First Steps:</strong> Complete your first battle</p>
                <p>• <strong>Beast Hunter:</strong> Capture 100 beasts in Veilbreakers</p>
                <p>• <strong>Voting Champion:</strong> Vote on 1000 submissions</p>
                <p>• <strong>Level Milestones:</strong> Reach levels 5, 10, 20, 50, 100</p>
                <p>• <strong>Perfect Warrior:</strong> 10 victories with 100% accuracy</p>
                <p>And 30+ more badges to collect! Each badge awards coins on first unlock.</p>
            </div></div>
        </div>
        <div class="help-section">
            <div class="help-header" onclick="toggleHelp(this)"><div class="help-title">🔒 Privacy & Security</div><span class="help-toggle">▼</span></div>
            <div class="help-content"><div class="help-text">
                <p><strong>Your Data:</strong> Scan history is private. Images analyzed client-side in your browser.</p>
                <p><strong>Public Info:</strong> Only your username, level, badges, and leaderboard rank are visible to others.</p>
                <p><strong>Security:</strong> Enterprise-grade encryption, rate limiting, and abuse prevention active.</p>
                <p><strong>No Tracking:</strong> We don't sell your data or track your activity outside the app.</p>
            </div></div>
        </div>
        <div class="help-section">
            <div class="help-header" onclick="toggleHelp(this)"><div class="help-title">💡 Tips & Tricks</div><span class="help-toggle">▼</span></div>
            <div class="help-content"><div class="help-text">
                <p>🎯 <strong>Complete daily quests</strong> for consistent coin income!</p>
                <p>⚡ <strong>Upgrade your tank</strong> with power-ups for better wave performance</p>
                <p>🎮 <strong>Play Tank Shooter</strong> during quest cooldowns to earn extra coins</p>
                <p>🎲 <strong>Save 900 coins</strong> for 10-roll gacha (better value than singles)</p>
                <p>✨ <strong>Equip legendary cosmetics</strong> to stand out on the leaderboard!</p>
            </div></div>
        </div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════ -->
<!-- BEAST COLLECTION VIEW                                                    -->
<!-- ═══════════════════════════════════════════════════════════════════════ -->
<div class="view" id="beastCollectionView">
    <div class="view-header">
        <div style="display:flex;align-items:center;gap:4px">
            <button class="back-btn" onclick="closeView()"><span class="ad-icon-slot" data-ad-icon="back" data-ad-size="16"></span></button>
            <button class="home-btn" onclick="openView('homeView')" title="Home"><span class="ad-icon-slot" data-ad-icon="home" data-ad-size="16"></span></button>
        </div>
        <span class="view-title">🐉 Beast Collection</span>
        <div class="coins-display">
            <img src="assets/icons/currency-coin.svg" alt="Coins" style="width:16px;height:16px;vertical-align:middle">
            <span id="beastViewCoins">0</span>
        </div>
    </div>
    <div class="view-body view-body-padded">
        <!-- Beast Stats Summary -->
        <div class="beast-summary-card">
            <div class="beast-summary-stat">
                <div class="summary-value" id="totalBeasts">0</div>
                <div class="summary-label">Total Beasts</div>
            </div>
            <div class="beast-summary-stat">
                <div class="summary-value" id="legendaryBeasts">0</div>
                <div class="summary-label">Legendary</div>
            </div>
            <div class="beast-summary-stat">
                <div class="summary-value" id="beastPower">0</div>
                <div class="summary-label">Total Power</div>
            </div>
        </div>

        <!-- Filter Tabs -->
        <div class="beast-filter-tabs">
            <button class="beast-filter-tab active" onclick="filterBeasts('all', this)">All</button>
            <button class="beast-filter-tab" onclick="filterBeasts('fire', this)">🔥 Fire</button>
            <button class="beast-filter-tab" onclick="filterBeasts('water', this)">💧 Water</button>
            <button class="beast-filter-tab" onclick="filterBeasts('electric', this)">⚡ Electric</button>
            <button class="beast-filter-tab" onclick="filterBeasts('dark', this)">🌑 Dark</button>
        </div>

        <!-- Beast Grid -->
        <div class="beast-grid" id="beastGrid">
            <!-- Empty State -->
            <div class="beast-empty-state" id="beastEmptyState">
                <div style="font-size:60px;margin-bottom:16px">🥚</div>
                <h3>No Beasts Yet!</h3>
                <p>Capture your first beast in Veilbreakers mode to start building your collection!</p>
                <button class="cta-btn" onclick="showToast('Veilbreakers coming soon!', 'info')" style="margin-top:16px">
                    🎮 Play Veilbreakers
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════ -->
<!-- FRIENDS VIEW                                                              -->
<!-- ═══════════════════════════════════════════════════════════════════════ -->
<div class="view" id="friendsView">
    <div class="view-header">
        <div style="display:flex;align-items:center;gap:4px">
            <button class="back-btn" onclick="closeView()"><span class="ad-icon-slot" data-ad-icon="back" data-ad-size="16"></span></button>
            <button class="home-btn" onclick="openView('homeView')" title="Home"><span class="ad-icon-slot" data-ad-icon="home" data-ad-size="16"></span></button>
        </div>
        <span class="view-title">👥 Friends</span>
        <button class="icon-btn" onclick="showAddFriend()" title="Add Friend">➕</button>
    </div>
    <div class="view-body view-body-padded">
        <!-- Friend Stats -->
        <div class="friend-stats-bar">
            <div class="friend-stat">
                <span class="friend-stat-value" id="friendCount">0</span>
                <span class="friend-stat-label">Friends</span>
            </div>
            <div class="friend-stat">
                <span class="friend-stat-value" id="onlineCount">0</span>
                <span class="friend-stat-label">Online</span>
            </div>
            <div class="friend-stat">
                <span class="friend-stat-value" id="pendingRequests">0</span>
                <span class="friend-stat-label">Pending</span>
            </div>
        </div>

        <!-- Friend Requests Section -->
        <div class="friends-section" id="friendRequestsSection" style="display:none">
            <div class="section-header">
                <h3>📬 Friend Requests</h3>
            </div>
            <div class="friend-requests-list" id="friendRequestsList"></div>
        </div>

        <!-- Online Friends -->
        <div class="friends-section">
            <div class="section-header">
                <h3>🟢 Online Now</h3>
            </div>
            <div class="friends-list" id="onlineFriendsList">
                <div class="friends-empty">No friends online right now</div>
            </div>
        </div>

        <!-- All Friends -->
        <div class="friends-section">
            <div class="section-header">
                <h3>👥 All Friends</h3>
            </div>
            <div class="friends-list" id="allFriendsList">
                <div class="friends-empty" id="noFriendsState">
                    <div style="font-size:50px;margin-bottom:12px">👋</div>
                    <h4>No Friends Yet</h4>
                    <p>Add friends to compete together, trade items, and climb the leaderboard!</p>
                    <button class="cta-btn" onclick="showAddFriend()" style="margin-top:16px">
                        ➕ Add Your First Friend
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════ -->
<!-- TRADING VIEW                                                              -->
<!-- ═══════════════════════════════════════════════════════════════════════ -->
<div class="view" id="tradingView">
    <div class="view-header">
        <div style="display:flex;align-items:center;gap:4px">
            <button class="back-btn" onclick="closeView()"><span class="ad-icon-slot" data-ad-icon="back" data-ad-size="16"></span></button>
            <button class="home-btn" onclick="openView('homeView')" title="Home"><span class="ad-icon-slot" data-ad-icon="home" data-ad-size="16"></span></button>
        </div>
        <span class="view-title">🔄 Trading Hub</span>
        <div class="coins-display">
            <img src="assets/icons/currency-coin.svg" alt="Coins" style="width:16px;height:16px;vertical-align:middle">
            <span id="tradingViewCoins">0</span>
        </div>
    </div>
    <div class="view-body view-body-padded">
        <!-- Trading Stats -->
        <div class="trading-stats-card">
            <div class="trading-stat">
                <div class="trading-stat-icon">📤</div>
                <div class="trading-stat-value" id="tradesSent">0</div>
                <div class="trading-stat-label">Sent</div>
            </div>
            <div class="trading-stat">
                <div class="trading-stat-icon">📥</div>
                <div class="trading-stat-value" id="tradesReceived">0</div>
                <div class="trading-stat-label">Received</div>
            </div>
            <div class="trading-stat">
                <div class="trading-stat-icon">✅</div>
                <div class="trading-stat-value" id="tradesCompleted">0</div>
                <div class="trading-stat-label">Completed</div>
            </div>
        </div>

        <!-- Active Trades Section -->
        <div class="section-header">
            <h3>📋 Active Trades</h3>
        </div>
        <div class="trades-list" id="activeTradesList">
            <div class="trades-empty">
                <div style="font-size:50px;margin-bottom:12px">📦</div>
                <h4>No Active Trades</h4>
                <p>Start a trade with a friend to swap cosmetics, beasts, or items!</p>
            </div>
        </div>

        <!-- Create Trade Button -->
        <button class="create-trade-btn" onclick="showCreateTrade()">
            <span>🔄</span> Create New Trade
        </button>

        <!-- Trade History -->
        <div class="section-header" style="margin-top:24px">
            <h3>📜 Trade History</h3>
        </div>
        <div class="trades-list" id="tradeHistoryList">
            <div class="trades-empty">No completed trades yet</div>
        </div>
    </div>
</div>

<!-- SHOP VIEW -->
<div class="view" id="shopView">
    <div class="view-header">
        <div style="display:flex;align-items:center;gap:4px">
            <button class="back-btn" onclick="closeView()"><span class="ad-icon-slot" data-ad-icon="back" data-ad-size="16"></span></button>
            <button class="home-btn" onclick="openView('homeView')" title="Home"><span class="ad-icon-slot" data-ad-icon="home" data-ad-size="16"></span></button>
        </div>
        <span class="view-title"><span class="ad-icon-slot" data-ad-icon="store" data-ad-size="16"></span> Shop</span>
        <div style="display:flex;align-items:center;gap:8px;padding:4px 12px;background:var(--surface2);border-radius:8px;font-size:12px;font-weight:700">
            <span class="ad-icon-slot" data-ad-icon="coins" data-ad-size="16"></span>
            <span id="shopCoinsDisplay">0</span>
        </div>
    </div>
    <div class="view-body view-body-padded">
        <!-- COSMETICS CATEGORY -->
        <div class="shop-category">
            <h3 class="shop-category-title"><span class="ad-icon-slot" data-ad-icon="sparkles" data-ad-size="16"></span> Cosmetics</h3>
            <div class="shop-grid" id="cosmeticsShop"></div>
        </div>

        <!-- BADGES CATEGORY -->
        <!-- Badges section removed: Badges are achievement-only, never purchasable -->

        <!-- POWER-UPS CATEGORY -->
        <div class="shop-category">
            <h3 class="shop-category-title"><span class="ad-icon-slot" data-ad-icon="wand" data-ad-size="16"></span> Power-Ups</h3>
            <div class="shop-grid" id="powerupsShop"></div>
        </div>

        <!-- TANK UPGRADES CATEGORY -->
        <div class="shop-category">
            <h3 class="shop-category-title"><span class="ad-icon-slot" data-ad-icon="tank" data-ad-size="16"></span> Tank Upgrades</h3>
            <div class="shop-grid" id="tank_upgradesShop"></div>
        </div>

        <!-- BOOSTERS CATEGORY -->
        <div class="shop-category">
            <h3 class="shop-category-title"><span class="ad-icon-slot" data-ad-icon="star" data-ad-size="16"></span> Boosters</h3>
            <div class="shop-grid" id="boostersShop"></div>
        </div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════ -->
<!-- SETTINGS VIEW                                                             -->
<!-- ═══════════════════════════════════════════════════════════════════════ -->
<div class="view" id="settingsView">
    <div class="view-header">
        <div style="display:flex;align-items:center;gap:4px">
            <button class="back-btn" onclick="closeView()"><span class="ad-icon-slot" data-ad-icon="back" data-ad-size="16"></span></button>
            <button class="home-btn" onclick="openView('homeView')" title="Home"><span class="ad-icon-slot" data-ad-icon="home" data-ad-size="16"></span></button>
        </div>
        <span class="view-title">⚙️ Settings</span>
        <div style="width:44px"></div>
    </div>
    <div class="view-body view-body-padded">

        <!-- Account Section -->
        <div class="help-section">
            <div class="help-header" onclick="toggleHelp(this)">
                <div class="help-title">👤 Account</div>
                <span class="help-toggle">▼</span>
            </div>
            <div class="help-content">
                <div style="display:flex;flex-direction:column;gap:8px;padding:8px 0">
                    <button class="cta-btn" onclick="openProfile()" style="width:100%">
                        👤 View Profile
                    </button>
                    <button class="cta-btn" onclick="openAvatarBuilder()" style="width:100%;background:linear-gradient(135deg,var(--secondary),var(--secondary-bright))">
                        🎨 Edit Avatar
                    </button>
                    <button class="cta-btn" onclick="handleLogout()" style="width:100%;background:linear-gradient(135deg,#dc2626,#ef4444)">
                        🚪 Sign Out
                    </button>
                </div>
            </div>
        </div>

        <!-- Notifications Section -->
        <div class="help-section">
            <div class="help-header" onclick="toggleHelp(this)">
                <div class="help-title">🔔 Notifications</div>
                <span class="help-toggle">▼</span>
            </div>
            <div class="help-content">
                <div class="help-text">
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border)">
                        <div>
                            <div style="font-weight:600;margin-bottom:4px">📬 Quest Reminders</div>
                            <div style="font-size:11px;color:var(--text3)">Daily quest notifications</div>
                        </div>
                        <label style="position:relative;display:inline-block;width:44px;height:24px">
                            <input type="checkbox" id="notifQuests" onchange="saveSettings()" style="opacity:0;width:0;height:0">
                            <span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:var(--surface3);border-radius:24px;transition:0.4s"></span>
                        </label>
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border)">
                        <div>
                            <div style="font-weight:600;margin-bottom:4px">🎮 Game Events</div>
                            <div style="font-size:11px;color:var(--text3)">Outbreak and boss alerts</div>
                        </div>
                        <label style="position:relative;display:inline-block;width:44px;height:24px">
                            <input type="checkbox" id="notifEvents" onchange="saveSettings()" checked style="opacity:0;width:0;height:0">
                            <span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:var(--primary);border-radius:24px;transition:0.4s"></span>
                        </label>
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0">
                        <div>
                            <div style="font-weight:600;margin-bottom:4px">👥 Friend Requests</div>
                            <div style="font-size:11px;color:var(--text3)">New friend notifications</div>
                        </div>
                        <label style="position:relative;display:inline-block;width:44px;height:24px">
                            <input type="checkbox" id="notifFriends" onchange="saveSettings()" checked style="opacity:0;width:0;height:0">
                            <span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:var(--primary);border-radius:24px;transition:0.4s"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Privacy Section -->
        <div class="help-section">
            <div class="help-header" onclick="toggleHelp(this)">
                <div class="help-title">🔒 Privacy</div>
                <span class="help-toggle">▼</span>
            </div>
            <div class="help-content">
                <div class="help-text">
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border)">
                        <div>
                            <div style="font-weight:600;margin-bottom:4px">👁️ Profile Visibility</div>
                            <div style="font-size:11px;color:var(--text3)">Show profile to all players</div>
                        </div>
                        <label style="position:relative;display:inline-block;width:44px;height:24px">
                            <input type="checkbox" id="privacyProfile" onchange="saveSettings()" checked style="opacity:0;width:0;height:0">
                            <span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:var(--primary);border-radius:24px;transition:0.4s"></span>
                        </label>
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border)">
                        <div>
                            <div style="font-weight:600;margin-bottom:4px">📊 Show Stats</div>
                            <div style="font-size:11px;color:var(--text3)">Display stats on leaderboard</div>
                        </div>
                        <label style="position:relative;display:inline-block;width:44px;height:24px">
                            <input type="checkbox" id="privacyStats" onchange="saveSettings()" checked style="opacity:0;width:0;height:0">
                            <span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:var(--primary);border-radius:24px;transition:0.4s"></span>
                        </label>
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0">
                        <div>
                            <div style="font-weight:600;margin-bottom:4px">🕵️ Anonymous Mode</div>
                            <div style="font-size:11px;color:var(--text3)">Hide name from global lists</div>
                        </div>
                        <label style="position:relative;display:inline-block;width:44px;height:24px">
                            <input type="checkbox" id="privacyAnonymous" onchange="saveSettings()" style="opacity:0;width:0;height:0">
                            <span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:var(--surface3);border-radius:24px;transition:0.4s"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Help & Support Section -->
        <div class="help-section">
            <div class="help-header" onclick="toggleHelp(this)">
                <div class="help-title">❓ Help & Support</div>
                <span class="help-toggle">▼</span>
            </div>
            <div class="help-content">
                <div style="display:flex;flex-direction:column;gap:8px;padding:8px 0">
                    <button class="cta-btn" onclick="openHelp()" style="width:100%">
                        📖 Help & FAQ
                    </button>
                    <button class="cta-btn" onclick="showToast('Contact: support@authenticadetector.com', 'info', 5000)" style="width:100%;background:linear-gradient(135deg,var(--cyan),var(--primary))">
                        📧 Contact Support
                    </button>
                    <button class="cta-btn" onclick="showToast('Version 7.5.0 (Dec 2025)', 'info')" style="width:100%;background:linear-gradient(135deg,#6366f1,var(--secondary))">
                        ℹ️ About
                    </button>
                </div>
            </div>
        </div>

        <!-- App Preferences Section -->
        <div class="help-section">
            <div class="help-header" onclick="toggleHelp(this)">
                <div class="help-title">🎨 Appearance</div>
                <span class="help-toggle">▼</span>
            </div>
            <div class="help-content">
                <div class="help-text">
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border)">
                        <div>
                            <div style="font-weight:600;margin-bottom:4px">🔊 Sound Effects</div>
                            <div style="font-size:11px;color:var(--text3)">Game and UI sounds</div>
                        </div>
                        <label style="position:relative;display:inline-block;width:44px;height:24px">
                            <input type="checkbox" id="prefSounds" onchange="saveSettings()" checked style="opacity:0;width:0;height:0">
                            <span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:var(--primary);border-radius:24px;transition:0.4s"></span>
                        </label>
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border)">
                        <div>
                            <div style="font-weight:600;margin-bottom:4px">✨ Animations</div>
                            <div style="font-size:11px;color:var(--text3)">UI animations and effects</div>
                        </div>
                        <label style="position:relative;display:inline-block;width:44px;height:24px">
                            <input type="checkbox" id="prefAnimations" onchange="saveSettings()" checked style="opacity:0;width:0;height:0">
                            <span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:var(--primary);border-radius:24px;transition:0.4s"></span>
                        </label>
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border)">
                        <div>
                            <div style="font-weight:600;margin-bottom:4px">🧚 VERA Assistant</div>
                            <div style="font-size:11px;color:var(--text3)">Show VERA helper on screen</div>
                        </div>
                        <label style="position:relative;display:inline-block;width:44px;height:24px">
                            <input type="checkbox" id="prefVera" onchange="saveSettings();toggleVeraVisibility()" checked style="opacity:0;width:0;height:0">
                            <span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:var(--primary);border-radius:24px;transition:0.4s"></span>
                        </label>
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border)">
                        <div>
                            <div style="font-weight:600;margin-bottom:4px">🔔 VERA Sounds</div>
                            <div style="font-size:11px;color:var(--text3)">VERA's voice and sound effects</div>
                        </div>
                        <label style="position:relative;display:inline-block;width:44px;height:24px">
                            <input type="checkbox" id="prefVeraSounds" onchange="saveSettings();toggleVeraSounds()" checked style="opacity:0;width:0;height:0">
                            <span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:var(--primary);border-radius:24px;transition:0.4s"></span>
                        </label>
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0">
                        <div>
                            <div style="font-weight:600;margin-bottom:4px">🌙 Dark Mode</div>
                            <div style="font-size:11px;color:var(--text3)">Always enabled (VERA theme)</div>
                        </div>
                        <label style="position:relative;display:inline-block;width:44px;height:24px">
                            <input type="checkbox" checked disabled style="opacity:0;width:0;height:0">
                            <span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:var(--primary);border-radius:24px;opacity:0.5"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Danger Zone -->
        <div class="help-section">
            <div class="help-header" onclick="toggleHelp(this)">
                <div class="help-title" style="color:var(--danger)">⚠️ Danger Zone</div>
                <span class="help-toggle">▼</span>
            </div>
            <div class="help-content">
                <div style="display:flex;flex-direction:column;gap:8px;padding:8px 0">
                    <button class="cta-btn" onclick="confirmClearCache()" style="width:100%;background:linear-gradient(135deg,#f59e0b,#fb923c)">
                        🗑️ Clear Cache
                    </button>
                    <button class="cta-btn" onclick="confirmDeleteAccount()" style="width:100%;background:linear-gradient(135deg,#dc2626,#ef4444)">
                        💀 Delete Account
                    </button>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- PUBLIC PROFILE MODAL -->
<div class="modal-overlay" id="publicProfileModal">
    <div class="modal"><button class="modal-close" onclick="closePublicProfile()">✕</button><div id="publicProfileContent"></div></div>
</div>

<!-- LOGIN REQUIRED MODAL -->
<div class="modal-overlay" id="loginRequiredModal">
    <div class="modal" style="text-align:center;padding:24px;position:relative">
        <button class="modal-close" onclick="closeLoginRequired()" style="position:absolute;top:8px;right:8px">✕</button>
        <div style="font-size:40px;margin-bottom:12px">🔒</div>
        <h3 style="margin-bottom:4px;font-size:16px">Feature Locked</h3>
        <p style="color:var(--text2);font-size:12px;margin-bottom:16px">Premium features require sign in.</p>
        <button class="login-submit" onclick="openLoginFromModal()" style="margin-bottom:8px">Sign In / Sign Up</button>
        <button class="login-guest" onclick="closeLoginRequired()">Maybe Later</button>
    </div>
</div>

<input type="file" id="profilePicInput" accept="image/*" style="display:none" onchange="handleProfilePic(event)">

<link rel="stylesheet" href="PROFESSIONAL_UI_OVERHAUL.css">
<link rel="stylesheet" href="ai-cosmetics-gacha.css">
<link rel="stylesheet" href="vera-controller.css?v=4.0.0">
<link rel="stylesheet" href="UI_FIXES.css?v=1.0.1">
<link rel="stylesheet" href="avatar-system-unity.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
<script src="tank-shooter-enhanced.js"></script>
<script src="tank-game-enhancements.js?v=1.0.1"></script>
<script src="avatar-cosmetics-system.js"></script>
<script src="ai-cosmetics-gacha.js"></script>
<script src="avatar-system-unity.js"></script>
<script src="vera-controller.js?v=4.0.0" defer></script>
<script src="vera-gsap.js?v=1.1.0" defer></script>
<!-- Rive Animation Runtime (for professional VERA animations) -->
<script src="https://unpkg.com/@rive-app/canvas@2.15.2"></script>
<script src="vera-rive.js?v=1.0.1" defer></script>

<script>
// Initialize Lucide icons for professional UI
if (typeof lucide !== 'undefined') {
    lucide.createIcons();
    console.log('[Graphics] Lucide icons initialized');
}
if (window.IconLibrary) {
    window.IconLibrary.apply();
}

// Inject header action buttons into all view headers
function injectHeaderActions() {
    const headerActionsHTML = `
        <div class="header-actions" style="display:flex;align-items:center;gap:4px">
            <button onclick="toggleQuestsPopup()" title="Quests" class="header-action-btn" style="width:32px;height:32px;border-radius:50%;border:1px solid rgba(94,234,212,0.4);background:linear-gradient(135deg,rgba(94,234,212,0.15),rgba(20,184,166,0.08));cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center">📋</button>
            <button onclick="claimDailyBonus()" title="Daily Bonus" class="header-action-btn" style="width:32px;height:32px;border-radius:50%;border:1px solid rgba(251,191,36,0.4);background:linear-gradient(135deg,rgba(251,191,36,0.15),rgba(245,158,11,0.08));cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center">🎁</button>
            <button onclick="openSettings()" title="Settings" class="header-action-btn" style="width:32px;height:32px;border-radius:50%;border:1px solid rgba(100,116,139,0.3);background:rgba(100,116,139,0.1);cursor:pointer;display:flex;align-items:center;justify-content:center">
                <img src="assets/icons/ui-settings.svg" alt="Settings" style="width:16px;height:16px">
            </button>
        </div>
    `;

    // Skip these views that already have custom right-side content or shouldn't have actions
    const skipViews = ['loginView', 'settingsView', 'questsView'];

    document.querySelectorAll('.view-header').forEach(header => {
        const viewEl = header.closest('.view');
        if (!viewEl) return;

        // Skip if already has header-actions or is in skip list
        if (header.querySelector('.header-actions')) return;
        if (skipViews.includes(viewEl.id)) return;

        // Find or create right-side container
        let rightSide = header.querySelector('.coins-display');
        if (rightSide) {
            // Insert actions before coins display
            rightSide.insertAdjacentHTML('beforebegin', headerActionsHTML);
        } else {
            // No coins display, append to end
            header.insertAdjacentHTML('beforeend', headerActionsHTML);
        }
    });

    console.log('[Init] Header actions injected into view headers');
}

// Initialize cosmetics system on page load
document.addEventListener('DOMContentLoaded', () => {
    // Re-initialize Lucide icons after DOM loads (catches dynamically added elements)
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
    if (window.IconLibrary) {
        window.IconLibrary.apply();
    }

    // Inject header action buttons
    injectHeaderActions();

    if (typeof initCosmeticsSystem === 'function') {
        console.log('[Init] Starting cosmetics system...');
        initCosmeticsSystem();
    }

    if (typeof initAvatarSystem === 'function') {
        console.log('[Init] Starting Unity-style avatar system...');
        initAvatarSystem();
    }

    // Apply VERA settings from localStorage
    const veraEnabled = localStorage.getItem('veraEnabled');
    const veraSoundsEnabled = localStorage.getItem('veraSoundsEnabled');

    if (veraEnabled === 'false') {
        const veraContainer = document.querySelector('.help-bot');
        if (veraContainer) veraContainer.style.display = 'none';
    }

    // Store sounds preference for VERA controller to read
    if (veraSoundsEnabled !== null) {
        window.veraSoundsEnabled = veraSoundsEnabled !== 'false';
    }
});

// Chrome PWA: Handle visual viewport resize (keyboard, address bar)
if (window.visualViewport) {
    window.visualViewport.addEventListener('resize', () => {
        // Update CSS variable for actual visible height
        document.documentElement.style.setProperty('--vh', `${window.visualViewport.height * 0.01}px`);
        // Scroll focused element into view when keyboard opens
        const activeEl = document.activeElement;
        if (activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA')) {
            setTimeout(() => activeEl.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
        }
    });
    // Set initial value
    document.documentElement.style.setProperty('--vh', `${window.visualViewport.height * 0.01}px`);
}
</script>

<script type="module">
// ============================================================
// AUTHENTICADETECTOR v12 - VEILBREAKERS & TANK BATTLE
// ============================================================

const $ = id => document.getElementById(id);

// ==================== CONFIG ====================
const SUPABASE_URL = 'https://vrvoyxxdlcpysthzjbeu.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZydm95eHhkbGNweXN0aHpqYmV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5ODcyMjUsImV4cCI6MjA4MTU2MzIyNX0.zwakHpqJY4moTqDyggoEx01CIo76gzFIgjtaPcamHkg';
const APP_VERSION = '12.0.0';
const DETECTOR_VERSION = '6.0.0';
const APP_NAME = 'AuthenticaDetector';

const rotatingBannerMessages = [
    { title: 'VEILBREAKERS PROTOCOL', detail: 'New zones soon: Neon Alley, Mirror Shrine, Bloom Gardens.' },
    { title: 'DAILY KEYS ONLINE', detail: 'Earn 3-5 keys/day. Use them to hunt and capture AI beasts.' },
    { title: 'TOOLKIT READY', detail: 'Noise Lens + Edge Prism now train your eye for AI tells.' },
    { title: 'SQUAD FOCUS', detail: 'Invite friends, share hunts, and climb the rankings.' },
    { title: 'TANK BATTLE LIVE', detail: 'Farm coins, unlock cosmetics, and prep for raids.' }
];
const rotatingBannerText = document.getElementById('rotatingBannerText');
const rotatingBannerSubtext = document.getElementById('rotatingBannerSubtext');
if (rotatingBannerText) {
    let bannerIndex = 0;
    rotatingBannerText.textContent = rotatingBannerMessages[bannerIndex].title;
    if (rotatingBannerSubtext) {
        rotatingBannerSubtext.textContent = rotatingBannerMessages[bannerIndex].detail;
    }
    setInterval(() => {
        bannerIndex = (bannerIndex + 1) % rotatingBannerMessages.length;
        rotatingBannerText.textContent = rotatingBannerMessages[bannerIndex].title;
        if (rotatingBannerSubtext) {
            rotatingBannerSubtext.textContent = rotatingBannerMessages[bannerIndex].detail;
        }
    }, 4500);
}

// ==================== STATE ====================
let supabase = null, useLocalFallback = true;
let user = null, isInstalled = false, deferredPrompt = null;
let currentResult = null;
let analysisAborted = false;
let isLoginMode = false;
let activeOutbreak = null;
let userProgression = null; // User progression data (level, xp, coins, etc.)
let userSquad = null; // User's current squad data

// AI Detection Models - WE USE REAL AI DETECTORS NOW
let aiDetectorPipeline = null;
let modelLoaded = false, modelLoading = false;

const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

// ==================== SVG ASSETS ====================
const LOGO_SVG = `<svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
<defs>
    <linearGradient id="logoGrad" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stop-color="#00d4aa"/>
        <stop offset="50%" stop-color="#0984e3"/>
        <stop offset="100%" stop-color="#6c5ce7"/>
    </linearGradient>
    <linearGradient id="eyeGrad" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stop-color="#00ffcc"/>
        <stop offset="100%" stop-color="#00b894"/>
    </linearGradient>
    <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
        <feGaussianBlur stdDeviation="1.5" result="blur"/>
        <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
    </filter>
</defs>
<!-- Background hex shape -->
<path d="M24 2L44 13V35L24 46L4 35V13L24 2Z" fill="url(#logoGrad)" opacity="0.95"/>
<!-- Scanner ring -->
<circle cx="24" cy="24" r="15" stroke="#00ffcc" stroke-width="1.5" fill="none" opacity="0.6" stroke-dasharray="4 2">
    <animateTransform attributeName="transform" type="rotate" values="0 24 24;360 24 24" dur="8s" repeatCount="indefinite"/>
</circle>
<!-- AI Eye -->
<ellipse cx="24" cy="24" rx="10" ry="8" stroke="#fff" stroke-width="2" fill="none" filter="url(#glow)"/>
<circle cx="24" cy="24" r="4" fill="url(#eyeGrad)">
    <animate attributeName="r" values="4;5;4" dur="2s" repeatCount="indefinite"/>
</circle>
<circle cx="25" cy="23" r="1.5" fill="#fff" opacity="0.9"/>
<!-- Detection beams -->
<path d="M24 8V14M24 34V40" stroke="#00ffcc" stroke-width="1.5" stroke-linecap="round" opacity="0.7">
    <animate attributeName="opacity" values="0.7;1;0.7" dur="1.5s" repeatCount="indefinite"/>
</path>
<path d="M8 24H14M34 24H40" stroke="#00ffcc" stroke-width="1.5" stroke-linecap="round" opacity="0.7">
    <animate attributeName="opacity" values="0.7;1;0.7" dur="1.5s" repeatCount="indefinite" begin="0.75s"/>
</path>
<!-- Corner brackets -->
<path d="M12 16V12H16M32 12H36V16M36 32V36H32M16 36H12V32" stroke="#fff" stroke-width="1.5" stroke-linecap="round" opacity="0.5"/>
</svg>`;

const ANALYSIS_ICON = `<svg viewBox="0 0 72 72" fill="none">
<circle cx="36" cy="36" r="32" stroke="var(--border)" stroke-width="2"/>
<circle class="scan-ring" cx="36" cy="36" r="32" stroke="var(--primary)" stroke-width="2" stroke-dasharray="50 150"/>
<rect x="20" y="20" width="32" height="32" rx="4" stroke="var(--text2)" stroke-width="2"/>
<circle class="pulse-core" cx="36" cy="36" r="8" fill="var(--primary)"/>
<path d="M30 36h12M36 30v12" stroke="#000" stroke-width="2" stroke-linecap="round"/>
</svg>`;

// ==================== WOW FACTS ====================
const WOW_FACTS = [
    { icon: 'stats', text: "The Veilbreakers Protocol was designed to train hunters in detecting corrupted digital entities." },
    { icon: 'sparkles', text: "Over 34 MILLION digital beasts roam the corrupted zones waiting to be captured!" },
    { icon: 'warning', text: "Veteran hunters report that identifying rare beasts requires training your eye for subtle tells." },
    { icon: 'coins', text: "The beast collection economy has grown to over 500 million coins traded by active hunters!" },
    { icon: 'warning', text: "The Great Outbreak of Zone 7 nearly overwhelmed the defense grid before hunters rallied." },
    { icon: 'search', text: "Modern beasts have evolved! They now mimic authentic patterns 94% more effectively." },
    { icon: 'scan', text: "Each beast family leaves unique corruption signatures in the digital noise field." },
    { icon: 'chat', text: "60% of hunters have accidentally released a captured beast back into the wild." },
    { icon: 'trophy', text: "The 2024 Tournament saw legendary beast battles across 40+ regional arenas." },
    { icon: 'boss', text: "The Apex Corruption Beast creates illusions so convincing even master hunters struggle." },
    { icon: 'sparkles', text: "It takes 3 seconds for a beast to spawn. It takes 20+ minutes to properly study and capture one." },
    { icon: 'scan', text: "Your scanning tools analyze 50+ invisible corruption signals - noise patterns, frequency spikes, data artifacts." }
];
let currentFactIndex = 0;

// ==================== BADGES (Expanded) ====================
const BADGES = {
    // COMMON
    first_scan: { id: 'first_scan', name: 'First Steps', desc: 'Complete your first battle', icon: 'scan', req: 1, type: 'total', rarity: 'common', points: 10 },
    ai_spotter: { id: 'ai_spotter', name: 'Beast Spotter', desc: 'Capture your first beast', icon: 'warning', req: 1, type: 'ai', rarity: 'common', points: 15 },
    first_real: { id: 'first_real', name: 'Reality Check', desc: 'Clear your first wave', icon: 'verify', req: 1, type: 'real', rarity: 'common', points: 12 },
    five_scans: { id: 'five_scans', name: 'Getting Started', desc: 'Complete 5 battles', icon: 'stats', req: 5, type: 'total', rarity: 'common', points: 25 },
    ten_scans: { id: 'ten_scans', name: 'Double Digits', desc: 'Complete 10 battles', icon: 'stats', req: 10, type: 'total', rarity: 'common', points: 50 },
    first_deep: { id: 'first_deep', name: 'Zone Explorer', desc: 'First zone exploration', icon: 'search', req: 1, type: 'deep', rarity: 'common', points: 20 },
    first_quick: { id: 'first_quick', name: 'Quick Strike', desc: 'First quick battle', icon: 'scan', req: 1, type: 'quick', rarity: 'common', points: 20 },
    first_forensics: { id: 'first_forensics', name: 'Pattern Tracker', desc: 'First beast analysis', icon: 'info', req: 1, type: 'forensics', rarity: 'common', points: 25 },
    truth_seeker: { id: 'truth_seeker', name: 'Truth Seeker', desc: 'Clear 5 waves', icon: 'shield', req: 5, type: 'real', rarity: 'common', points: 30 },
    ai_breaker: { id: 'ai_breaker', name: 'Beast Breaker', desc: 'Capture 5 beasts', icon: 'corruption', req: 5, type: 'ai', rarity: 'common', points: 30 },
    twenty_scans: { id: 'twenty_scans', name: 'On the Board', desc: 'Complete 20 battles', icon: 'stats', req: 20, type: 'total', rarity: 'common', points: 40 },
    deep_5: { id: 'deep_5', name: 'Zone Diver', desc: 'Explore 5 zones', icon: 'search', req: 5, type: 'deep', rarity: 'common', points: 45 },

    // RARE
    detective: { id: 'detective', name: 'Hunter Detective', desc: 'Complete 25 battles', icon: 'search', req: 25, type: 'total', rarity: 'rare', points: 100 },
    ai_hunter: { id: 'ai_hunter', name: 'Beast Hunter', desc: 'Capture 10 beasts', icon: 'crosshair', req: 10, type: 'ai', rarity: 'rare', points: 75 },
    streak_3: { id: 'streak_3', name: 'On Fire', desc: '3 victories in a row', icon: 'star', req: 3, type: 'streak', rarity: 'rare', points: 50 },
    forensics_fan: { id: 'forensics_fan', name: 'Pattern Expert', desc: '5 beast analyses', icon: 'info', req: 5, type: 'forensics', rarity: 'rare', points: 60 },
    daily_scanner: { id: 'daily_scanner', name: 'Daily Hunter', desc: 'Battle 3 days in a row', icon: 'refresh', req: 3, type: 'daily_streak', rarity: 'rare', points: 80 },
    quick_draw: { id: 'quick_draw', name: 'Quick Draw', desc: '10 quick battles', icon: 'scan', req: 10, type: 'quick', rarity: 'rare', points: 40 },
    real_guardian: { id: 'real_guardian', name: 'Wave Guardian', desc: 'Clear 15 waves', icon: 'shield', req: 15, type: 'real', rarity: 'rare', points: 70 },
    ai_tracker: { id: 'ai_tracker', name: 'Beast Tracker', desc: 'Capture 20 beasts', icon: 'warning', req: 20, type: 'ai', rarity: 'rare', points: 90 },
    deep_diver: { id: 'deep_diver', name: 'Zone Diver', desc: 'Explore 10 zones', icon: 'search', req: 10, type: 'deep', rarity: 'rare', points: 95 },
    quick_runner: { id: 'quick_runner', name: 'Quick Runner', desc: 'Complete 20 quick battles', icon: 'scan', req: 20, type: 'quick', rarity: 'rare', points: 85 },
    forensics_hawk: { id: 'forensics_hawk', name: 'Analysis Hawk', desc: 'Complete 10 beast analyses', icon: 'info', req: 10, type: 'forensics', rarity: 'rare', points: 90 },
    accuracy_80: { id: 'accuracy_80', name: 'Steady Aim', desc: 'Maintain 80% victory rate', icon: 'stats', req: 80, type: 'accuracy', rarity: 'rare', points: 120 },
    fifty_scans: { id: 'fifty_scans', name: 'Halfway Hero', desc: 'Complete 50 battles', icon: 'stats', req: 50, type: 'total', rarity: 'rare', points: 110 },
    week_tracker: { id: 'week_tracker', name: 'Week Warrior', desc: 'Battle 5 days in a row', icon: 'refresh', req: 5, type: 'daily_streak', rarity: 'rare', points: 130 },

    // EPIC
    master: { id: 'master', name: 'Master Hunter', desc: 'Complete 75 battles', icon: 'trophy', req: 75, type: 'total', rarity: 'epic', points: 200 },
    ai_expert: { id: 'ai_expert', name: 'Beast Expert', desc: 'Capture 50 beasts', icon: 'boss', req: 50, type: 'ai', rarity: 'epic', points: 150 },
    streak_5: { id: 'streak_5', name: 'Unstoppable', desc: '5 victories in a row', icon: 'star', req: 5, type: 'streak', rarity: 'epic', points: 100 },
    centurion: { id: 'centurion', name: 'Centurion', desc: 'Complete 100 battles', icon: 'trophy', req: 100, type: 'total', rarity: 'epic', points: 300 },
    week_warrior: { id: 'week_warrior', name: 'Week Warrior', desc: 'Battle 7 days straight', icon: 'refresh', req: 7, type: 'daily_streak', rarity: 'epic', points: 200 },
    sharp_eye: { id: 'sharp_eye', name: 'Sharp Eye', desc: 'Reach 90% victory rate', icon: 'search', req: 90, type: 'accuracy', rarity: 'epic', points: 250 },
    deep_sage: { id: 'deep_sage', name: 'Zone Sage', desc: 'Explore 25 zones', icon: 'wand', req: 25, type: 'deep', rarity: 'epic', points: 220 },
    quick_strike: { id: 'quick_strike', name: 'Quick Strike', desc: 'Complete 50 quick battles', icon: 'scan', req: 50, type: 'quick', rarity: 'epic', points: 210 },
    forensics_elite: { id: 'forensics_elite', name: 'Analysis Elite', desc: 'Complete 25 beast analyses', icon: 'info', req: 25, type: 'forensics', rarity: 'epic', points: 230 },
    real_sentinel: { id: 'real_sentinel', name: 'Wave Sentinel', desc: 'Clear 50 waves', icon: 'shield', req: 50, type: 'real', rarity: 'epic', points: 240 },
    ai_slayer: { id: 'ai_slayer', name: 'Beast Slayer', desc: 'Capture 75 beasts', icon: 'crosshair', req: 75, type: 'ai', rarity: 'epic', points: 260 },
    streak_7: { id: 'streak_7', name: 'Blazing Streak', desc: '7 victories in a row', icon: 'star', req: 7, type: 'streak', rarity: 'epic', points: 190 },
    month_guard: { id: 'month_guard', name: 'Month Guard', desc: 'Battle 14 days straight', icon: 'refresh', req: 14, type: 'daily_streak', rarity: 'epic', points: 280 },
    hundred_fifty: { id: 'hundred_fifty', name: 'One-Fifty Club', desc: 'Complete 150 battles', icon: 'stats', req: 150, type: 'total', rarity: 'epic', points: 320 },

    // LEGENDARY
    legend: { id: 'legend', name: 'Legend', desc: 'Complete 250 battles', icon: 'trophy', req: 250, type: 'total', rarity: 'legendary', points: 500 },
    ai_nemesis: { id: 'ai_nemesis', name: 'Beast Nemesis', desc: 'Capture 100 beasts', icon: 'boss', req: 100, type: 'ai', rarity: 'legendary', points: 400 },
    perfect_10: { id: 'perfect_10', name: 'Perfect 10', desc: '10 victories in a row', icon: 'star', req: 10, type: 'streak', rarity: 'legendary', points: 300 },
    month_master: { id: 'month_master', name: 'Month Master', desc: 'Battle 30 days', icon: 'refresh', req: 30, type: 'daily_streak', rarity: 'legendary', points: 500 },
    elite_detector: { id: 'elite_detector', name: 'Elite Champion', desc: '95% victory rate (50+ battles)', icon: 'verify', req: 95, type: 'accuracy', rarity: 'legendary', points: 750 },
    founding_member: { id: 'founding_member', name: 'Founding Member', desc: 'Beta supporter', icon: 'badges', req: 1, type: 'special', rarity: 'legendary', points: 1000 },
    deep_oracle: { id: 'deep_oracle', name: 'Zone Oracle', desc: 'Explore 50 zones', icon: 'wand', req: 50, type: 'deep', rarity: 'legendary', points: 450 },
    quick_legend: { id: 'quick_legend', name: 'Quick Legend', desc: 'Complete 100 quick battles', icon: 'scan', req: 100, type: 'quick', rarity: 'legendary', points: 450 },
    forensics_master: { id: 'forensics_master', name: 'Analysis Master', desc: 'Complete 50 beast analyses', icon: 'info', req: 50, type: 'forensics', rarity: 'legendary', points: 480 },
    real_paragon: { id: 'real_paragon', name: 'Wave Paragon', desc: 'Clear 150 waves', icon: 'shield', req: 150, type: 'real', rarity: 'legendary', points: 500 }
};

// ==================== SHOP ITEMS (Expanded catalog) ====================
const SHOP_ITEMS = {
    // COSMETICS
    avatar_border_gold: {
        id: 'avatar_border_gold',
        name: 'Golden Border',
        desc: 'Cosmetic avatar border (visual only)',
        category: 'cosmetics',
        cost: 250,
        icon: 'trophy',
        rarity: 'rare'
    },
    avatar_border_neon: {
        id: 'avatar_border_neon',
        name: 'Neon Border',
        desc: 'Glowing cyan border (visual only)',
        category: 'cosmetics',
        cost: 300,
        icon: 'sparkles',
        rarity: 'rare'
    },
    bg_nebula: {
        id: 'bg_nebula',
        name: 'Nebula BG',
        desc: 'Cosmetic profile backdrop',
        category: 'cosmetics',
        cost: 200,
        icon: 'star',
        rarity: 'common'
    },
    bg_synthwave: {
        id: 'bg_synthwave',
        name: 'Synthwave BG',
        desc: 'Retro neon profile backdrop',
        category: 'cosmetics',
        cost: 150,
        icon: 'sparkles',
        rarity: 'common'
    },
    badge_frame_platinum: {
        id: 'badge_frame_platinum',
        name: 'Platinum Frame',
        desc: 'Elite badge frame (visual only)',
        category: 'cosmetics',
        cost: 500,
        icon: 'badges',
        rarity: 'epic'
    },
    aura_pulse: {
        id: 'aura_pulse',
        name: 'Pulse Aura',
        desc: 'Animated aura (visual only)',
        category: 'cosmetics',
        cost: 650,
        icon: 'sparkles',
        rarity: 'epic'
    },
    profile_holo: {
        id: 'profile_holo',
        name: 'Holo Profile Frame',
        desc: 'Hologram profile frame',
        category: 'cosmetics',
        cost: 420,
        icon: 'info',
        rarity: 'rare'
    },
    nameplate_onyx: {
        id: 'nameplate_onyx',
        name: 'Onyx Nameplate',
        desc: 'Premium nameplate (visual only)',
        category: 'cosmetics',
        cost: 700,
        icon: 'shield',
        rarity: 'epic'
    },

    // POWER-UPS (GAME-ONLY)
    scan_boost_2x: {
        id: 'scan_boost_2x',
        name: 'Battle XP Boost',
        desc: 'Game-only: double XP for battles',
        category: 'powerups',
        cost: 400,
        icon: 'stats',
        rarity: 'rare'
    },
    xp_multiplier_3x: {
        id: 'xp_multiplier_3x',
        name: 'Raid XP Surge',
        desc: 'Game-only: 3x XP for 24h',
        category: 'powerups',
        cost: 600,
        icon: 'stats',
        rarity: 'epic'
    },
    accuracy_boost: {
        id: 'accuracy_boost',
        name: 'Aim Stabilizer',
        desc: 'Game-only: tighter spread for tanks',
        category: 'powerups',
        cost: 500,
        icon: 'crosshair',
        rarity: 'rare'
    },
    daily_bonus_coins: {
        id: 'daily_bonus_coins',
        name: 'Daily Coin Cache',
        desc: 'Game-only: +100 coins/day (7d)',
        category: 'powerups',
        cost: 700,
        icon: 'coins',
        rarity: 'epic'
    },
    priority_queue: {
        id: 'priority_queue',
        name: 'Instant Match Queue',
        desc: 'Game-only: faster matchmaking',
        category: 'powerups',
        cost: 1000,
        icon: 'shield',
        rarity: 'epic'
    },
    deep_scan_credit: {
        id: 'deep_scan_credit',
        name: 'Veilbreak Key',
        desc: 'Game-only: +1 special hunt key',
        category: 'powerups',
        cost: 350,
        icon: 'wand',
        rarity: 'rare'
    },
    quick_scan_pack: {
        id: 'quick_scan_pack',
        name: 'Rapid Keys Pack',
        desc: 'Game-only: +3 quick hunt keys',
        category: 'powerups',
        cost: 450,
        icon: 'scan',
        rarity: 'rare'
    },
    revive_token: {
        id: 'revive_token',
        name: 'Revive Token',
        desc: 'Game-only: revive once in battle',
        category: 'powerups',
        cost: 900,
        icon: 'heart',
        rarity: 'epic'
    },

    // TANK UPGRADES
    tank_armor_light: {
        id: 'tank_armor_light',
        name: 'Light Armor',
        desc: '+25% tank HP',
        category: 'tank_upgrades',
        cost: 500,
        icon: 'shield',
        rarity: 'common',
        effect: { hp_boost: 0.25 }
    },
    tank_armor_heavy: {
        id: 'tank_armor_heavy',
        name: 'Heavy Armor',
        desc: '+50% tank HP, -10% speed',
        category: 'tank_upgrades',
        cost: 1200,
        icon: 'shield',
        rarity: 'rare',
        effect: { hp_boost: 0.50, speed_penalty: 0.10 }
    },
    tank_treads_speed: {
        id: 'tank_treads_speed',
        name: 'Speed Treads',
        desc: '+30% movement speed',
        category: 'tank_upgrades',
        cost: 800,
        icon: 'stats',
        rarity: 'common',
        effect: { speed_boost: 0.30 }
    },
    tank_treads_allterrain: {
        id: 'tank_treads_allterrain',
        name: 'All-Terrain Treads',
        desc: '+20% speed, ignore slowdown',
        category: 'tank_upgrades',
        cost: 1500,
        icon: 'stats',
        rarity: 'rare',
        effect: { speed_boost: 0.20, ignore_slow: true }
    },
    tank_ammo_blast: {
        id: 'tank_ammo_blast',
        name: 'Blast Radius Ammo',
        desc: '+40% explosion radius',
        category: 'tank_upgrades',
        cost: 1000,
        icon: 'warning',
        rarity: 'rare',
        effect: { blast_radius: 0.40 }
    },
    tank_ammo_pierce: {
        id: 'tank_ammo_pierce',
        name: 'Piercing Rounds',
        desc: 'Shots pierce 2 enemies',
        category: 'tank_upgrades',
        cost: 1800,
        icon: 'crosshair',
        rarity: 'epic',
        effect: { pierce_count: 2 }
    },
    tank_model_stealth: {
        id: 'tank_model_stealth',
        name: 'Stealth Tank',
        desc: 'Invisible when stationary',
        category: 'tank_upgrades',
        cost: 3500,
        icon: 'corruption',
        rarity: 'epic',
        effect: { stealth_mode: true }
    },
    tank_model_destroyer: {
        id: 'tank_model_destroyer',
        name: 'Destroyer Tank',
        desc: '2x damage, 2x fire rate',
        category: 'tank_upgrades',
        cost: 5000,
        icon: 'boss',
        rarity: 'legendary',
        effect: { damage_mult: 2, fire_rate_mult: 2 }
    },
    tank_model_titan: {
        id: 'tank_model_titan',
        name: 'TITAN Tank',
        desc: 'Ultimate: 3x HP, 2x damage, shield',
        category: 'tank_upgrades',
        cost: 10000,
        icon: 'trophy',
        rarity: 'legendary',
        effect: { hp_mult: 3, damage_mult: 2, has_shield: true }
    },
    turret_overclock: {
        id: 'turret_overclock',
        name: 'Turret Overclock',
        desc: '+35% fire rate',
        category: 'tank_upgrades',
        cost: 2200,
        icon: 'wand',
        rarity: 'epic',
        effect: { fire_rate_mult: 1.35 }
    },

    // BOOSTERS
    truth_cannon_ammo: {
        id: 'truth_cannon_ammo',
        name: 'Cannon Ammo x50',
        desc: '50 truth cannon rounds',
        category: 'boosters',
        cost: 400,
        icon: 'crosshair',
        rarity: 'rare'
    },
    outbreak_defense: {
        id: 'outbreak_defense',
        name: 'Outbreak Defense',
        desc: '+50% outbreak rewards',
        category: 'boosters',
        cost: 600,
        icon: 'shield',
        rarity: 'epic'
    },
    critical_hit: {
        id: 'critical_hit',
        name: 'Critical Hit Boost',
        desc: '+20% battle crit chance',
        category: 'boosters',
        cost: 500,
        icon: 'star',
        rarity: 'rare'
    },
    time_warp: {
        id: 'time_warp',
        name: 'Time Warp',
        desc: 'Instant zone exploration boost',
        category: 'boosters',
        cost: 800,
        icon: 'refresh',
        rarity: 'epic'
    },
    immunity_shield: {
        id: 'immunity_shield',
        name: 'Immunity Shield',
        desc: 'Protect against 5 hits in battle',
        category: 'boosters',
        cost: 700,
        icon: 'shield',
        rarity: 'epic'
    },
    loot_magnet: {
        id: 'loot_magnet',
        name: 'Loot Magnet',
        desc: '+25% drop rate in battles',
        category: 'boosters',
        cost: 650,
        icon: 'coins',
        rarity: 'rare'
    },
    boss_radar: {
        id: 'boss_radar',
        name: 'Boss Radar',
        desc: 'Increases boss encounter chance',
        category: 'boosters',
        cost: 950,
        icon: 'boss',
        rarity: 'epic'
    },

    // BADGES - REMOVED: Badges are achievement-only, never purchasable
    // All badge purchases have been removed per game design requirements
};

// Badge definitions moved to achievement system - see BADGE_DEFINITIONS below

// ==================== TIER SYSTEM ====================
const TIERS = {
    1: { name: 'KING', class: 'tier-king', color: '#ffd700' },
    2: { name: 'VICEROY', class: 'tier-viceroy', color: '#c0c0c0' },
    3: { name: 'ARCHDUKE', class: 'tier-archduke', color: '#cd7f32' },
    4: { name: 'LEGEND', class: 'tier-legend', color: '#9b59b6' },
    10: { name: 'ELITE', class: 'tier-elite', color: '#3498db' },
    25: { name: 'VETERAN', class: 'tier-veteran', color: '#27ae60' },
    50: { name: 'RISING', class: 'tier-rising', color: '#7f8c8d' },
    100: { name: 'ROOKIE', class: 'tier-rising', color: '#95a5a6' }
};

function getTier(rank) {
    if (rank === 1) return TIERS[1];
    if (rank === 2) return TIERS[2];
    if (rank === 3) return TIERS[3];
    if (rank <= 10) return TIERS[4];
    if (rank <= 25) return TIERS[10];
    if (rank <= 50) return TIERS[25];
    if (rank <= 100) return TIERS[50];
    return TIERS[100];
}

// ==================== HELPERS ====================

// Safe JSON parse - prevents crashes from corrupted localStorage
function safeJSONParse(str, fallback = null) {
    if (!str || str === 'undefined' || str === 'null') return fallback;
    try {
        return JSON.parse(str);
    } catch (e) {
        console.warn('[JSON] Parse failed:', e.message);
        return fallback;
    }
}

// Safe localStorage getter with default
function getStorage(key, fallback = null) {
    try {
        const value = localStorage.getItem(key);
        if (value === null) return fallback;
        return safeJSONParse(value, fallback);
    } catch (e) {
        console.warn('[Storage] Get failed:', key, e.message);
        return fallback;
    }
}

// Safe localStorage setter
function setStorage(key, value) {
    try {
        localStorage.setItem(key, JSON.stringify(value));
        return true;
    } catch (e) {
        console.error('[Storage] Set failed:', key, e.message);
        return false;
    }
}

// Debounce helper - prevents double-clicks
function debounce(func, wait = 300) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Throttle helper - limits rapid firing
function throttle(func, limit = 300) {
    let inThrottle;
    return function(...args) {
        if (!inThrottle) {
            func.apply(this, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
        }
    };
}

function toast(msg) {
    let c = document.querySelector('.toast-container');
    if (!c) { c = document.createElement('div'); c.className = 'toast-container'; document.body.appendChild(c); }
    const t = document.createElement('div'); t.className = 'toast'; t.textContent = msg; c.appendChild(t);
    setTimeout(() => t.remove(), 3000);
}

// Enhanced toast with type support (success, error, info, warning)
window.showToast = function(message, type = 'info', duration = 3000) {
    let container = document.querySelector('.toast-container');
    if (!container) {
        container = document.createElement('div');
        container.className = 'toast-container';
        document.body.appendChild(container);
    }

    const toastEl = document.createElement('div');
    toastEl.className = `toast toast-${type}`;

    // Add icon based on type
    const icons = {
        success: '✅',
        error: '❌',
        warning: '⚠️',
        info: 'ℹ️'
    };

    toastEl.innerHTML = `<span style="margin-right:8px">${icons[type] || icons.info}</span>${message}`;

    // Type-specific styling
    const styles = {
        success: 'background: linear-gradient(135deg, #10b981, #059669); border-left: 4px solid #34d399;',
        error: 'background: linear-gradient(135deg, #ef4444, #dc2626); border-left: 4px solid #f87171;',
        warning: 'background: linear-gradient(135deg, #f59e0b, #d97706); border-left: 4px solid #fbbf24;',
        info: 'background: linear-gradient(135deg, #3b82f6, #2563eb); border-left: 4px solid #60a5fa;'
    };
    toastEl.style.cssText = styles[type] || styles.info;

    container.appendChild(toastEl);

    // Animate in
    toastEl.style.animation = 'slideInRight 0.3s ease-out';

    setTimeout(() => {
        toastEl.style.animation = 'slideOutRight 0.3s ease-in';
        setTimeout(() => toastEl.remove(), 300);
    }, duration);
};

// Daily Bonus System
window.claimDailyBonus = function() {
    const lastClaim = localStorage.getItem('lastDailyBonus');
    const now = new Date();
    const today = now.toDateString();

    if (lastClaim === today) {
        showToast('Daily bonus already claimed! Come back tomorrow.', 'warning');
        return;
    }

    // Calculate streak
    let streak = parseInt(localStorage.getItem('dailyStreak') || '0');
    const lastClaimDate = lastClaim ? new Date(lastClaim) : null;

    if (lastClaimDate) {
        const yesterday = new Date(now);
        yesterday.setDate(yesterday.getDate() - 1);
        if (lastClaimDate.toDateString() === yesterday.toDateString()) {
            streak++;
        } else {
            streak = 1; // Reset streak if more than a day gap
        }
    } else {
        streak = 1;
    }

    // Bonus coins based on streak (max 7-day streak cycle)
    const streakDay = ((streak - 1) % 7) + 1;
    const bonusAmounts = [50, 75, 100, 150, 200, 300, 500]; // Days 1-7
    const bonusCoins = bonusAmounts[streakDay - 1];

    // Save claim
    localStorage.setItem('lastDailyBonus', today);
    localStorage.setItem('dailyStreak', streak.toString());

    // Award coins
    const currentCoins = parseInt(localStorage.getItem('truthCoins') || '0');
    const newCoins = currentCoins + bonusCoins;
    localStorage.setItem('truthCoins', newCoins.toString());

    // Also update userProgression object so display functions work
    if (window.userProgression) {
        window.userProgression.truth_coins = newCoins;
    } else {
        window.userProgression = { truth_coins: newCoins };
    }

    // Update displays
    if (typeof updateAllCoinDisplays === 'function') {
        updateAllCoinDisplays();
    }

    // Also update the header currency bar directly
    const headerCoinCount = document.getElementById('headerCoinCount');
    if (headerCoinCount) headerCoinCount.textContent = newCoins;

    // Show celebration
    showToast(`🎁 Day ${streakDay} Bonus: +${bonusCoins} coins! (${streak} day streak)`, 'success', 4000);

    // Try to sync with database if user is logged in
    if (window.user && window.supabase) {
        window.supabase.rpc('award_coins_atomic', {
            p_user_id: window.user.id,
            p_amount: bonusCoins
        }).then(result => {
            if (result.data) {
                console.log('[Daily Bonus] Synced to database:', result.data);
            }
        }).catch(err => {
            console.warn('[Daily Bonus] DB sync failed, local only:', err);
        });
    }
};

function showView(id) {
    // Reset navigation state to prevent lockouts
    isNavigating = false;

    // Hide all views
    document.querySelectorAll('.view').forEach(v => {
        v.classList.remove('active');
        v.style.opacity = '0';
    });

    // Show the requested view
    const view = $(id);
    if (view) {
        view.classList.add('active');
        view.style.opacity = '1';
        currentView = id;

        // Hide game nav for non-game views
        const GAME_VIEWS = ['outbreaksView', 'squadsView', 'leaderboardView', 'shopView'];
        const gameNav = $('gameNav');
        if (gameNav) {
            gameNav.style.display = GAME_VIEWS.includes(id) ? 'flex' : 'none';
        }
    } else {
        console.warn('[View] Not found:', id);
        // Fallback to home
        const homeView = $('homeView');
        if (homeView) {
            homeView.classList.add('active');
            homeView.style.opacity = '1';
            currentView = 'homeView';
        }
    }
}
// Note: closeView is defined in the TruthHunters game section below
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
function round(v) {
    const num = Number(v);
    if (isNaN(num) || v === null || v === undefined) return 50; // Safe default
    return Math.round(Math.max(0, Math.min(100, num)));  // Clamp to 0-100
}
function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

// ==================== INIT LOGOS ====================
function initLogos() {
    document.querySelectorAll('.logo-icon').forEach(el => el.innerHTML = LOGO_SVG);
    if ($('mainLogo')) $('mainLogo').innerHTML = LOGO_SVG;
    if ($('loginLogo')) $('loginLogo').innerHTML = LOGO_SVG;
    if ($('analysisIcon')) $('analysisIcon').innerHTML = ANALYSIS_ICON;
}

// ==================== FACTS ====================
function initFacts() { 
    updateFact(); 
    setInterval(updateFact, 8000); 
}

function updateFact() {
    currentFactIndex = (currentFactIndex + 1) % WOW_FACTS.length;
    const f = WOW_FACTS[currentFactIndex];
    const iconMarkup = `<span class="ad-icon-slot" data-ad-icon="${f.icon}" data-ad-size="18"></span>`;
    if ($('factIcon')) $('factIcon').innerHTML = iconMarkup;
    if ($('factText')) $('factText').textContent = f.text;
    if ($('progressFactIcon')) $('progressFactIcon').innerHTML = iconMarkup;
    if ($('progressFactText')) $('progressFactText').textContent = f.text;
    if (window.IconLibrary) {
        window.IconLibrary.apply(document.getElementById('factIcon'));
        window.IconLibrary.apply(document.getElementById('progressFactIcon'));
    }
}

// ==================== SUPABASE ====================
function initSupabase() {
    try {
        if (SUPABASE_URL.includes('YOUR_PROJECT')) { 
            console.log('[Supabase] Using local fallback mode');
            useLocalFallback = true; 
            return; 
        }
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: { autoRefreshToken: true, persistSession: true, storage: localStorage }
        });
        useLocalFallback = false;
        console.log('[Supabase] Connected');
    } catch (e) { 
        console.error('[Supabase] Init failed:', e);
        useLocalFallback = true; 
    }
}

// ==================== PWA INSTALL ====================
window.addEventListener('beforeinstallprompt', e => {
    e.preventDefault();
    deferredPrompt = e;
    if (!isInstalled && !isIOS) $('installBanner')?.classList.add('show');
    updateStatusBar();
    console.log('[PWA] Install prompt captured');
});

window.addEventListener('appinstalled', () => {
    isInstalled = true;
    localStorage.setItem('app_installed', 'true');
    $('installBanner')?.classList.remove('show');
    $('iosHelper')?.classList.remove('show');
    updateStatusBar(); 
    updateGating(); 
    toast('🎉 App installed!');
});

function checkInstallState() {
    // CRITICAL FIX: Only trust localStorage if we're actually in standalone mode
    // After uninstall, localStorage persists but standalone mode is false
    if (isStandalone) {
        isInstalled = true;
        localStorage.setItem('app_installed', 'true');
    } else {
        // Not in standalone mode = not installed (even if localStorage says otherwise)
        // This fixes the install banner not showing after uninstall
        isInstalled = false;
        localStorage.removeItem('app_installed');
    }

    if (isInstalled) {
        $('installBanner')?.classList.remove('show');
        $('iosHelper')?.classList.remove('show');
    } else if (isIOS && !localStorage.getItem('ios_dismissed')) {
        setTimeout(() => { if (!isInstalled) $('iosHelper')?.classList.add('show'); }, 2000);
    }
    updateStatusBar();
}

window.promptInstall = async function() {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') {
            isInstalled = true;
            localStorage.setItem('app_installed', 'true');
            $('installBanner')?.classList.remove('show');
            updateStatusBar();
            updateGating();
        }
        deferredPrompt = null;
    } else if (isIOS) {
        $('iosHelper')?.classList.add('show'); 
    } else { 
        toast('Use browser menu → Install app'); 
    }
};

window.dismissIosHelper = () => {
    $('iosHelper')?.classList.remove('show');
    localStorage.setItem('ios_dismissed', 'true');
};

// ==================== STATUS BAR ====================
function updateStatusBar() {
    const ic = $('installChip'), lc = $('loginChip'), sc = $('signupChip'), sb = $('statusBar');

    // Skip if elements don't exist
    if (!ic && !lc && !sc && !sb) return;

    if (ic) {
        if (isInstalled) {
            ic.classList.remove('pending');
            ic.classList.add('complete');
            ic.innerHTML = '<span>✓</span> Installed';
        } else {
            ic.classList.add('pending');
            ic.classList.remove('complete');
            ic.innerHTML = '<span>📲</span> Install';
        }
    }

    if (lc) {
        if (user) {
            lc.classList.remove('pending');
            lc.classList.add('complete');
            lc.innerHTML = '<span>✓</span> Signed In';
            lc.onclick = () => openProfile();
        } else {
            lc.classList.add('pending');
            lc.classList.remove('complete');
            lc.innerHTML = '<span>🔑</span> Sign In';
            lc.onclick = () => openLogin();
        }
    }

    if (sc) {
        if (user) {
            sc.classList.add('hidden');
        } else {
            sc.classList.remove('hidden');
        }
    }

    // Hide status bar only when BOTH are complete
    if (sb) {
        sb.style.display = (isInstalled && user) ? 'none' : 'flex';
    }
}

// ==================== AUTH ====================
async function loadUser() {
    // Try Supabase first
    if (!useLocalFallback && supabase) {
        try {
            const { data: { session } } = await supabase.auth.getSession();
            if (session?.user) {
                user = { 
                    id: session.user.id, 
                    email: session.user.email, 
                    name: session.user.user_metadata?.display_name || session.user.email.split('@')[0] 
                };
                // Load profile
                const { data: p } = await supabase.from('profiles').select('display_name,avatar_url').eq('id', user.id).single();
                if (p) { 
                    user.name = p.display_name || user.name; 
                    user.avatar_url = p.avatar_url; 
                }
                updateUserUI();
                await loadUserStats();
                await loadUserProgression();
                await loadUserBadges();
                return;
            }
        } catch (e) { console.error('[Auth] Session load failed:', e); }
    }
    
    // Fall back to localStorage
    const saved = getStorage('auth_user');
    if (saved) {
        user = saved;
        updateUserUI();
        await loadUserStats();
        await loadUserProgression();
        await loadUserBadges();
    }
}

function saveUser() {
    if (user) setStorage('auth_user', user);
    else localStorage.removeItem('auth_user');
}

function updateUserUI() {
    // Safe DOM update helper
    const safeSet = (id, value, isHTML = false) => {
        const el = $(id);
        if (el) {
            if (isHTML) el.innerHTML = value;
            else el.textContent = value;
        }
    };

    if (user) {
        const initial = (user.name && user.name[0]) ? user.name[0].toUpperCase() :
                       (user.email && user.email[0]) ? user.email[0].toUpperCase() : '?';
        safeSet('userInitial', initial);
        safeSet('userBtn', user.avatar_url ? `<img src="${user.avatar_url}">` : `<span id="userInitial">${initial}</span>`, true);
        safeSet('profileName', user.name || (user.email ? user.email.split('@')[0] : 'User'));
        safeSet('profileEmail', user.email || '');
        safeSet('profileAvatar', user.avatar_url ? `<img src="${user.avatar_url}">` : initial, true);
        safeSet('loginLogoutText', 'Sign Out');
        safeSet('loginLogoutIcon', '🚪');
    } else {
        safeSet('userInitial', '👤');
        safeSet('userBtn', '<span id="userInitial">👤</span>', true);
        safeSet('profileName', 'Guest');
        safeSet('profileEmail', 'Sign in to save progress');
        safeSet('profileAvatar', '?', true);
        safeSet('loginLogoutText', 'Sign In');
        safeSet('loginLogoutIcon', '🔑');
    }
    updateStatusBar();
    updateGating();
}

async function loadUserStats() {
    if (!user) return;
    
    let stats = { total: 0, ai: 0, real: 0, deep: 0, quick: 0, forensics: 0, streak: 0, maxStreak: 0, points: 0, accuracy: 0, dailyStreak: 0 }; // Note: forensics renamed to 'beast_analysis' in UI but kept for DB compatibility
    
    // Try Supabase
    if (!useLocalFallback && supabase) {
        try {
            const { data } = await supabase.from('user_stats').select('*').eq('user_id', user.id).single();
            if (data) {
                stats = {
                    total: data.total_scans || 0,
                    ai: data.ai_found || 0,
                    real: data.real_found || 0,
                    deep: data.deep_scans || 0,
                    quick: data.quick_scans || 0,
                    forensics: data.forensics_scans || 0,
                    streak: data.current_streak || 0,
                    maxStreak: data.max_streak || 0,
                    points: data.points || 0,
                    accuracy: data.accuracy || 0,
                    dailyStreak: data.daily_streak || 0
                };
            }
        } catch (e) { console.error('[Stats] Load failed:', e); }
    }
    
    // Merge with local
    const local = getStorage(`stats_${user.id}`, {});
    if (local.total > stats.total) stats = { ...stats, ...local };

    setStorage(`stats_${user.id}`, stats);

    // Safe DOM updates with null checks
    const statScans = $('statScans');
    const statFound = $('statFound');
    const statPoints = $('statPoints');
    if (statScans) statScans.textContent = stats.total || 0;
    if (statFound) statFound.textContent = stats.ai || 0;
    if (statPoints) statPoints.textContent = stats.points || 0;
}

function updateGating() {
    const canDeep = user; // Only need login now, not install
    const deepLock = $('deepLock');
    const advancedPanel = $('advancedPanel');
    if (canDeep) {
        if (deepLock) deepLock.classList.add('hidden');
        if (advancedPanel) advancedPanel.classList.remove('hidden');
    } else {
        if (deepLock) deepLock.classList.remove('hidden');
        if (advancedPanel) advancedPanel.classList.add('hidden');
    }
}

// ==================== PROFILE CARD FUNCTIONS ====================
// Toggle the collapsible beast card section
window.toggleBeastCard = function(sectionId) {
    const section = document.getElementById(sectionId);
    if (section) {
        section.classList.toggle('open');
        const toggleBtn = section.querySelector('.beast-toggle');
        if (toggleBtn) {
            toggleBtn.classList.toggle('expanded');
        }
    }
};

// Open beast collection view
window.openBeastCollection = function() {
    showToast('Beast Collection coming soon! Capture beasts in Veilbreakers!', 'info');
};

// Open tank leaderboard
window.openTankLeaderboard = function() {
    // Try to open the tank view if it exists, otherwise show toast
    if (typeof showView === 'function') {
        showView('tankView');
    } else {
        showToast('Tank Leaderboard coming soon!', 'info');
    }
};

// Open PvP Arena
window.openPvPArena = function() {
    // Login requirement check
    if (!user) {
        showToast('Please log in to play!', 'warning');
        return;
    }

    showToast('PvP Arena coming soon in Veilbreakers!', 'info');
};

// View beast details
window.viewBeastDetails = function() {
    // Login requirement check
    if (!user) {
        showToast('Please log in to play!', 'warning');
        return;
    }

    showToast('Beast details coming soon!', 'info');
};

// Open beast lineup editor
window.openBeastLineup = function() {
    // Login requirement check
    if (!user) {
        showToast('Please log in to play!', 'warning');
        return;
    }

    showToast('Beast Lineup editor coming soon!', 'info');
};

// Start beast battle
window.startBeastBattle = function() {
    // Login requirement check
    if (!user) {
        showToast('Please log in to play!', 'warning');
        return;
    }

    showToast('Beast battles coming soon in Veilbreakers!', 'info');
};

// Update favorite beast display (call this when user data loads)
function updateFavoriteBeastDisplay(beast) {
    if (!beast) {
        // Default state - no beast
        const safeSet = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };
        safeSet('favBeastName', 'No Beast');
        safeSet('favBeastLevel', 'LV --');
        safeSet('favBeastType', 'Capture your first beast!');
        safeSet('favBeastATK', '--');
        safeSet('favBeastDEF', '--');
        safeSet('favBeastSPD', '--');
        safeSet('favBeastATKFull', '--');
        safeSet('favBeastDEFFull', '--');
        safeSet('favBeastSPDFull', '--');
        safeSet('favBeastTotal', '--');
        safeSet('favBeastXpText', '0 / 100');
        const rarityEl = document.getElementById('favBeastRarity');
        if (rarityEl) { rarityEl.textContent = '--'; rarityEl.className = 'beast-rarity common'; }
        return;
    }

    // Update with beast data
    const safeSet = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };
    safeSet('favBeastName', beast.name || 'Unknown');
    safeSet('favBeastLevel', `LV ${beast.level || 1}`);
    safeSet('favBeastType', beast.type || 'Mystery Beast');
    safeSet('favBeastATK', beast.atk || 0);
    safeSet('favBeastDEF', beast.def || 0);
    safeSet('favBeastSPD', beast.spd || 0);
    safeSet('favBeastATKFull', beast.atk || 0);
    safeSet('favBeastDEFFull', beast.def || 0);
    safeSet('favBeastSPDFull', beast.spd || 0);
    safeSet('favBeastTotal', (beast.atk || 0) + (beast.def || 0) + (beast.spd || 0));

    const avatarEl = document.getElementById('favBeastAvatar');
    if (avatarEl && beast.emoji) avatarEl.textContent = beast.emoji;

    const rarityEl = document.getElementById('favBeastRarity');
    if (rarityEl) {
        rarityEl.textContent = (beast.rarity || 'common').toUpperCase();
        rarityEl.className = `beast-rarity ${(beast.rarity || 'common').toLowerCase()}`;
    }

    // Update XP bar
    const xpFill = document.getElementById('favBeastXpFill');
    const xpText = document.getElementById('favBeastXpText');
    if (xpFill && beast.xp !== undefined && beast.xpRequired) {
        xpFill.style.width = `${Math.min((beast.xp / beast.xpRequired) * 100, 100)}%`;
    }
    if (xpText && beast.xp !== undefined && beast.xpRequired) {
        xpText.textContent = `${beast.xp} / ${beast.xpRequired}`;
    }
}

// Update profile XP bar (call when user stats load)
function updateProfileXpBar(currentXp, requiredXp) {
    const xpFill = document.getElementById('homeXpBarFill');
    const xpCurrent = document.getElementById('homeAvatarXP');
    const xpRequired = document.getElementById('homeXpRequired');

    if (xpFill) {
        const percentage = Math.min((currentXp / requiredXp) * 100, 100);
        xpFill.style.width = `${percentage}%`;
    }
    if (xpCurrent) xpCurrent.textContent = currentXp;
    if (xpRequired) xpRequired.textContent = requiredXp;
}

// ==================== LOGIN ====================
window.openLogin = function(isSignup = false) {
    // Guard: If already logged in, go to profile instead
    if (user) {
        toast('You are already signed in!');
        openProfile();
        return;
    }

    isLoginMode = isSignup;
    updateLoginUI();
    showView('loginView');

    // Add keyboard support - Enter to submit
    setTimeout(() => {
        const inputs = [$('emailInput'), $('passwordInput'), $('nameInput')].filter(Boolean);
        inputs.forEach(input => {
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    window.submitLogin();
                }
            });
            // Clear error when user starts typing
            input.addEventListener('input', () => {
                hideLoginError();
            });
        });
    }, 100);
};

function updateLoginUI() {
    if (isLoginMode) {
        $('loginViewTitle').textContent = 'Sign Up'; 
        $('loginHeroTitle').textContent = 'Create Account';
        $('loginHeroSubtitle').textContent = 'Join to unlock all features';
        $('nameGroup').classList.remove('hidden'); 
        $('loginSubmit').textContent = 'Create Account';
        $('loginToggle').innerHTML = 'Already have an account? <a onclick="toggleLoginMode()">Sign In</a>';
    } else {
        $('loginViewTitle').textContent = 'Sign In'; 
        $('loginHeroTitle').textContent = 'Welcome Back';
        $('loginHeroSubtitle').textContent = 'Sign in to access all features';
        $('nameGroup').classList.add('hidden'); 
        $('loginSubmit').textContent = 'Sign In';
        $('loginToggle').innerHTML = "Don't have an account? <a onclick=\"toggleLoginMode()\">Sign Up</a>";
    }
    $('loginError').classList.remove('show');
}

window.toggleLoginMode = () => { isLoginMode = !isLoginMode; updateLoginUI(); };

// VERA Integration - Open auth modal from VERA prompts
window.openAuthModal = function(mode = 'login') {
    const isSignup = mode === 'signup';
    window.openLogin(isSignup);
};

window.submitLogin = async function() {
    console.log('[Login] Starting login/signup');

    const emailInput = $('emailInput');
    const passwordInput = $('passwordInput');
    const nameInput = $('nameInput');

    if (!emailInput || !passwordInput) {
        console.error('[Login] Input elements not found');
        showLoginError('Login form not loaded properly. Refresh page.');
        return;
    }

    const email = emailInput.value.trim();
    const password = passwordInput.value;
    const name = nameInput ? nameInput.value.trim() : '';

    console.log('[Login] Mode:', isLoginMode ? 'signup' : 'signin', 'Email:', email);

    // Clear previous error
    hideLoginError();

    // Validation
    if (!email || !password) {
        showLoginError('Please fill in all fields');
        return;
    }

    // Email validation
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        showLoginError('Please enter a valid email address');
        return;
    }

    if (isLoginMode && !name) {
        showLoginError('Please enter your name');
        return;
    }

    if (password.length < 6) {
        showLoginError('Password must be at least 6 characters');
        return;
    }

    const submitBtn = $('loginSubmit');
    submitBtn.disabled = true;
    submitBtn.textContent = isLoginMode ? 'Creating Account...' : 'Signing In...';

    try {
        console.log('[Login] Using', useLocalFallback ? 'local storage' : 'Supabase');

        if (!useLocalFallback && supabase) {
            // Supabase auth
            if (isLoginMode) {
                console.log('[Login] Attempting Supabase signup');
                const { data, error } = await supabase.auth.signUp({
                    email,
                    password,
                    options: { data: { display_name: name } }
                });

                if (error) {
                    console.error('[Login] Supabase signup error:', error);
                    throw new Error(error.message || 'Signup failed');
                }

                if (!data || !data.user) {
                    throw new Error('No user data returned from signup');
                }

                console.log('[Login] Signup successful, user:', data.user.id);
                user = { id: data.user.id, email: data.user.email, name };

                // Award founding member badge
                setTimeout(() => awardBadge('founding_member'), 500);
                toast('🎉 Account created successfully!');
            } else {
                console.log('[Login] Attempting Supabase signin');
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });

                if (error) {
                    console.error('[Login] Supabase signin error:', error);
                    throw new Error(error.message || 'Invalid email or password');
                }

                if (!data || !data.user) {
                    throw new Error('No user data returned from signin');
                }

                console.log('[Login] Signin successful, user:', data.user.id);
                user = {
                    id: data.user.id,
                    email: data.user.email,
                    name: data.user.user_metadata?.display_name || email.split('@')[0]
                };
                toast('Welcome back!');
            }
        } else {
            // Local auth fallback
            console.log('[Login] Using local authentication');
            const users = getStorage('users', {});

            if (isLoginMode) {
                if (users[email]) {
                    throw new Error('An account with this email already exists. Please sign in instead.');
                }
                users[email] = { email, password, name, created: Date.now() };
                setStorage('users', users);
                user = { id: email, email, name };
                setTimeout(() => awardBadge('founding_member'), 500);
                toast('✅ Account created!');
                console.log('[Login] Local signup successful');
            } else {
                if (!users[email]) {
                    throw new Error('No account found with this email. Please sign up first.');
                }
                if (users[email].password !== password) {
                    throw new Error('Incorrect password. Please try again.');
                }
                user = { id: email, email, name: users[email].name };
                toast('Welcome back!');
                console.log('[Login] Local signin successful');
            }
        }

        // Save and update UI
        saveUser();
        updateUserUI();
        await loadUserStats();
        await loadUserProgression();
        await loadUserBadges();

        // Clear form
        emailInput.value = '';
        passwordInput.value = '';
        if (nameInput) nameInput.value = '';

        // Go to home
        console.log('[Login] Redirecting to home');
        showView('homeView');

    } catch (e) {
        console.error('[Login] Error:', e);
        showLoginError(e.message || 'Login failed. Please try again.');
    } finally {
        submitBtn.disabled = false;
        updateLoginUI();
    }
};

function hideLoginError() {
    const errorEl = $('loginError');
    if (errorEl) {
        errorEl.classList.remove('show');
        errorEl.textContent = '';
    }
}

function showLoginError(msg) {
    const errorEl = $('loginError');
    if (errorEl) {
        // Make error messages more user-friendly
        let friendlyMsg = msg;
        if (msg.includes('Invalid login credentials')) {
            friendlyMsg = 'Invalid email or password. Please try again.';
        } else if (msg.includes('Email not confirmed')) {
            friendlyMsg = 'Please check your email and confirm your account first.';
        } else if (msg.includes('User already registered')) {
            friendlyMsg = 'This email is already registered. Try signing in instead.';
        } else if (msg.includes('Password should be')) {
            friendlyMsg = 'Password must be at least 6 characters long.';
        } else if (msg.includes('rate limit') || msg.includes('too many')) {
            friendlyMsg = 'Too many attempts. Please wait a moment and try again.';
        }
        errorEl.textContent = friendlyMsg;
        errorEl.classList.add('show');
    }
}

// Forgot password functionality
window.showForgotPassword = async function() {
    const emailInput = $('emailInput');
    const email = emailInput ? emailInput.value.trim() : '';

    if (!email) {
        showLoginError('Please enter your email address first, then click "Forgot password"');
        return;
    }

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        showLoginError('Please enter a valid email address');
        return;
    }

    hideLoginError();

    try {
        if (!supabase) {
            showLoginError('Unable to connect. Please try again later.');
            return;
        }

        const { error } = await supabase.auth.resetPasswordForEmail(email, {
            redirectTo: window.location.origin + '/#resetPassword'
        });

        if (error) throw error;

        toast('Password reset email sent! Check your inbox.');
        showLoginError('Check your email for password reset instructions.');
        // Change the error styling to success for this message
        const errorEl = $('loginError');
        if (errorEl) {
            errorEl.style.background = 'rgba(46, 213, 115, 0.15)';
            errorEl.style.borderColor = 'var(--success)';
            errorEl.style.color = '#2ed573';
        }
    } catch (e) {
        console.error('[Auth] Password reset failed:', e);
        showLoginError(e.message || 'Failed to send reset email. Please try again.');
    }
};

// Award a specific badge to user
async function awardBadge(badgeId, coinReward = 0) {
    if (!user) return;

    const badge = BADGES[badgeId];
    if (!badge) {
        console.warn('[Badge] Unknown badge:', badgeId);
        return;
    }

    try {
        // Use atomic badge award function (idempotent + coin reward)
        const { data, error } = await supabase.rpc('award_badge_atomic', {
            p_user_id: user.id,
            p_badge_id: badgeId,
            p_coin_reward: coinReward
        });

        if (error) throw error;

        if (data && data.length > 0) {
            const result = data[0];

            if (result.awarded) {
                // Badge was newly awarded
                const unlockedBadges = getStorage('unlocked_badges', []);
                unlockedBadges.push(badgeId);
                setStorage('unlocked_badges', unlockedBadges);

                // Show notification
                showBadgeUnlock(badge);

                // Update coins if rewarded
                if (result.new_coins > 0) {
                    userProgression.truth_coins = result.new_coins;
                    updateCoinsDisplay();
                }

                // Update quest progress for badge earned
                updateQuestProgress('badge_earned');

                console.log(`[Badge] Awarded: ${badgeId} ${coinReward > 0 ? `(+${coinReward} coins)` : ''}`);
            } else if (result.already_had) {
                console.log('[Badge] Already unlocked:', badgeId);
            }
        }
    } catch (err) {
        console.error('[Badge] Failed to award badge:', err);

        // Fallback to local-only unlock (no coin reward)
        const unlockedBadges = getStorage('unlocked_badges', []);
        if (!unlockedBadges.includes(badgeId)) {
            unlockedBadges.push(badgeId);
            setStorage('unlocked_badges', unlockedBadges);
            showBadgeUnlock(badge);
        }
    }
}

window.continueAsGuest = () => { showView('homeView'); toast('Continuing as guest'); };

window.handleLoginLogout = async function() {
    if (user) { 
        if (!useLocalFallback && supabase) {
            try { await supabase.auth.signOut(); } catch(e) {}
        }
        user = null; 
        saveUser(); 
        updateUserUI(); 
        toast('Signed out'); 
    } else {
        openLogin();
    }
};

window.openLoginFromModal = () => { 
    $('loginRequiredModal').classList.remove('show'); 
    openLogin(); 
};

window.closeLoginRequired = () => {
    $('loginRequiredModal').classList.remove('show');
};

// ==================== GLOBAL ERROR HANDLERS ====================
// Catch unhandled promise rejections to prevent button/UI breakage
window.addEventListener('unhandledrejection', (event) => {
    console.error('[Global] Unhandled promise rejection:', event.reason);
    // Prevent the default browser error popup
    event.preventDefault();
    // Show user-friendly message if not already shown
    if (event.reason?.message && !event.reason.message.includes('already shown')) {
        toast('Something went wrong. Please try again.');
    }
});

// Catch global errors
window.addEventListener('error', (event) => {
    console.error('[Global] Uncaught error:', event.error || event.message);
    // Don't show toast for every error, just log
});

// ==================== PWA UPDATE PROMPT ====================
function showUpdatePrompt() {
    // Don't show if already showing
    if (document.getElementById('updatePrompt')) return;

    const prompt = document.createElement('div');
    prompt.id = 'updatePrompt';
    prompt.style.cssText = `
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
        color: white;
        padding: 16px 24px;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(139, 92, 246, 0.4), 0 0 0 1px rgba(255,255,255,0.1);
        z-index: 10000;
        display: flex;
        align-items: center;
        gap: 16px;
        font-family: 'Inter', sans-serif;
        animation: slideUp 0.3s ease-out;
        max-width: 90vw;
    `;
    prompt.innerHTML = `
        <div style="flex:1">
            <div style="font-weight:700;font-size:14px;margin-bottom:4px">🎉 Update Available!</div>
            <div style="font-size:12px;opacity:0.9">A new version is ready to install</div>
        </div>
        <button id="updateNowBtn" style="
            background: white;
            color: #8b5cf6;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            transition: transform 0.2s;
        ">Update Now</button>
        <button id="updateLaterBtn" style="
            background: transparent;
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 10px 16px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
        ">Later</button>
    `;

    // Add animation keyframe
    if (!document.getElementById('updatePromptStyles')) {
        const style = document.createElement('style');
        style.id = 'updatePromptStyles';
        style.textContent = `
            @keyframes slideUp {
                from { transform: translateX(-50%) translateY(100px); opacity: 0; }
                to { transform: translateX(-50%) translateY(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
    }

    document.body.appendChild(prompt);

    // Handle "Update Now" click
    document.getElementById('updateNowBtn').addEventListener('click', () => {
        prompt.remove();
        // Tell the waiting service worker to skip waiting and activate
        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
            navigator.serviceWorker.ready.then(reg => {
                if (reg.waiting) {
                    reg.waiting.postMessage({ type: 'SKIP_WAITING' });
                }
            });
        }
        // Force refresh after a short delay
        setTimeout(() => {
            window.location.reload(true);
        }, 500);
    });

    // Handle "Later" click
    document.getElementById('updateLaterBtn').addEventListener('click', () => {
        prompt.remove();
        // Show reminder toast
        toast('Tap the refresh icon to update later');
    });
}

// ==================== INIT ====================
async function init() {
    console.log(`[AuthenticaDetector] v${APP_VERSION} starting...`);

    initSupabase();
    initLogos();
    initFacts();
    checkInstallState();

    await loadUser();
    renderBadgesPreview();
    updateGating();
    updateStatusBar();

    // Initialize Truth Hunters game
    await initTruthHunters();

    // Initialize cosmetics system (if not already initialized)
    if (typeof initCosmeticsSystem === 'function') {
        initCosmeticsSystem();
    }

    // Register service worker with update detection
    if ('serviceWorker' in navigator) {
        try {
            const registration = await navigator.serviceWorker.register('/sw.js');
            console.log('[SW] Registered');

            // Check for updates periodically (every 60 seconds when app is open)
            setInterval(() => {
                registration.update();
            }, 60000);

            // Listen for new service worker updates
            registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                console.log('[SW] New version found, installing...');

                newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        // New version available - show update prompt
                        console.log('[SW] New version ready! Showing update prompt.');
                        showUpdatePrompt();
                    }
                });
            });

            // Handle controller change (new service worker took over)
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                console.log('[SW] Controller changed, reloading...');
                // Reload automatically when new SW takes control
                window.location.reload();
            });

        } catch (e) {
            console.log('[SW] Registration failed:', e);
        }
    }
    
    // Handle share target
    handleShareTarget();
    
    // Auth state listener
    if (!useLocalFallback && supabase) {
        supabase.auth.onAuthStateChange(async (event, session) => {
            console.log('[Auth] State change:', event);
            if (event === 'SIGNED_IN' && session?.user) {
                user = {
                    id: session.user.id,
                    email: session.user.email,
                    name: session.user.user_metadata?.display_name || session.user.email.split('@')[0]
                };
                saveUser();
                updateUserUI();
                await loadUserStats();
                await loadUserProgression();
                await loadUserBadges();
            } else if (event === 'SIGNED_OUT') {
                user = null;
                saveUser();
                updateUserUI();
            }
        });
    }
    
    console.log(`[AuthenticaDetector] Ready! Installed: ${isInstalled}, User: ${user?.email || 'guest'}`);
}

// ============================================================
// TRUTH HUNTERS GAME FUNCTIONS
// ============================================================

// ==================== GAME STATE ====================
// BACK BUTTON FIX - Replace openView and closeView functions

// View stack for proper navigation
let viewStack = ['homeView'];
let currentView = null;
let isNavigating = false; // Guard against recursive navigation
let lastNavTime = 0; // Debounce navigation

const GAME_VIEWS = ['outbreaksView', 'squadsView', 'leaderboardView', 'shopView'];

window.openView = function(viewId) {
    // Reset navigation lock after safety timeout (prevents permanent lockout)
    clearTimeout(window._navSafetyTimer);
    window._navSafetyTimer = setTimeout(() => { isNavigating = false; }, 500);

    // Debounce navigation (prevent rapid re-calls)
    const now = Date.now();
    if (now - lastNavTime < 80) {
        console.log('[View] Navigation debounced');
        return;
    }
    lastNavTime = now;

    // Guard against recursive navigation (but with safety valve)
    if (isNavigating && now - lastNavTime < 400) {
        console.log('[View] Navigation already in progress, skipping');
        return;
    }

    isNavigating = true;
    console.log('[View] Opening view:', viewId);

    try {
        // Determine if this is a game view
        const isGameView = GAME_VIEWS.includes(viewId);

        // Close ALL views first for clean transition
        document.querySelectorAll('.view').forEach(v => {
            v.classList.remove('active');
            v.style.opacity = '0';
        });

        // Immediate view activation (no delay for responsiveness)
        const view = $(viewId);
        if (view) {
            view.classList.add('active');
            view.style.opacity = '1';
            currentView = viewId;

            // Add to view stack and push to browser history
            if (viewStack[viewStack.length - 1] !== viewId) {
                viewStack.push(viewId);
                // Push state to enable back button
                try {
                    history.pushState({ view: viewId }, '', '#' + viewId);
                } catch(e) { console.warn('[View] History push failed:', e); }
            }

            // Handle game navigation bar
            const gameNav = $('gameNav');
            if (gameNav) {
                if (isGameView) {
                    gameNav.style.display = 'flex';
                    // Update active nav button
                    document.querySelectorAll('.game-nav-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.view === viewId);
                    });
                } else {
                    gameNav.style.display = 'none';
                }
            }

            // Load data based on view (async, don't block)
            setTimeout(() => {
                try {
                    if (viewId === 'outbreaksView') loadOutbreaksView();
                    else if (viewId === 'squadsView') loadSquadsView();
                    else if (viewId === 'leaderboardView') loadLeaderboardView();
                    else if (viewId === 'shopView') loadShopView();
                } catch(e) { console.error('[View] Load error:', e); }
            }, 10);
        } else {
            console.warn('[View] View not found:', viewId);
        }
    } catch(e) {
        console.error('[View] Navigation error:', e);
    } finally {
        // Always unlock navigation after short delay
        setTimeout(() => { isNavigating = false; }, 60);
    }
};

window.closeView = function() {
    console.log('[View] Closing current view:', currentView);

    try {
        // Reset any stuck navigation state
        isNavigating = false;

        // Pop from view stack
        if (viewStack.length > 1) {
            viewStack.pop();
        }

        // Go back to previous view (or home if stack is empty)
        const previousView = viewStack[viewStack.length - 1] || 'homeView';

        // Close current view
        if (currentView) {
            const view = $(currentView);
            if (view) {
                view.classList.remove('active');
                view.style.opacity = '0';
            }
        }

        // Immediately open previous view
        openView(previousView);
    } catch(e) {
        console.error('[View] closeView error:', e);
        // Emergency fallback - go home
        isNavigating = false;
        const homeView = $('homeView');
        if (homeView) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            homeView.classList.add('active');
            homeView.style.opacity = '1';
            currentView = 'homeView';
        }
    }
};

// Go directly to home (clears navigation stack)
window.goHome = function() {
    console.log('[View] Going directly to home');
    viewStack = ['homeView'];
    isNavigating = false;

    // Close all views
    document.querySelectorAll('.view').forEach(v => {
        v.classList.remove('active');
        v.style.opacity = '0';
    });

    // Open home
    const homeView = $('homeView');
    if (homeView) {
        homeView.classList.add('active');
        homeView.style.opacity = '1';
        currentView = 'homeView';
    }

    // Hide game nav
    const gameNav = $('gameNav');
    if (gameNav) gameNav.style.display = 'none';

    // Update history
    try {
        history.replaceState({ view: 'homeView', isBase: true }, '', '#homeView');
    } catch(e) {}
};

// Emergency navigation reset - call this if buttons ever break
window.resetNavigation = function() {
    console.log('[View] Emergency navigation reset');
    isNavigating = false;
    isHandlingPopstate = false;
    viewStack = ['homeView'];
    currentView = 'homeView';
    document.querySelectorAll('.view').forEach(v => {
        v.classList.remove('active');
        v.style.opacity = '0';
    });
    const homeView = $('homeView');
    if (homeView) {
        homeView.classList.add('active');
        homeView.style.opacity = '1';
    }
    const gameNav = $('gameNav');
    if (gameNav) gameNav.style.display = 'none';
    console.log('[View] Navigation reset complete');
};

// Auto-reset stuck navigation every 10 seconds as safety net
setInterval(() => {
    if (isNavigating) {
        console.warn('[View] Navigation appears stuck, auto-resetting');
        isNavigating = false;
    }
}, 10000);

// Handle browser back button (Android physical back button)
let isHandlingPopstate = false; // Guard against rapid popstate events
let lastBackTime = 0; // Track timing for double-back-to-home
const DOUBLE_BACK_THRESHOLD = 500; // ms - double tap within this time goes to home

window.addEventListener('popstate', function(event) {
    // Debounce popstate events
    if (isHandlingPopstate) {
        console.log('[View] Popstate already being handled, skipping');
        return;
    }
    isHandlingPopstate = true;

    const now = Date.now();
    const timeSinceLastBack = now - lastBackTime;
    lastBackTime = now;

    console.log('[View] Popstate event:', event.state, 'timeSinceLastBack:', timeSinceLastBack);

    // Helper to directly show view WITHOUT pushing to history (prevents loops)
    function showViewDirect(viewId) {
        // Close all views
        document.querySelectorAll('.view').forEach(v => {
            v.classList.remove('active');
            v.style.opacity = '0';
        });

        setTimeout(() => {
            const view = $(viewId);
            if (view) {
                view.classList.add('active');
                view.style.opacity = '1';
                currentView = viewId;

                // Update game nav
                const isGameView = GAME_VIEWS.includes(viewId);
                const gameNav = $('gameNav');
                if (gameNav) {
                    gameNav.style.display = isGameView ? 'flex' : 'none';
                    if (isGameView) {
                        document.querySelectorAll('.game-nav-btn').forEach(btn => {
                            btn.classList.toggle('active', btn.dataset.view === viewId);
                        });
                    }
                }
            }
            isHandlingPopstate = false;
        }, 50);
    }

    // DOUBLE-BACK-TO-HOME: If user presses back twice quickly, go straight to home
    if (timeSinceLastBack < DOUBLE_BACK_THRESHOLD && currentView !== 'homeView') {
        console.log('[View] DOUBLE-BACK detected! Going directly to home');
        // Clear the entire stack and go home
        viewStack = ['homeView'];
        history.replaceState({ view: 'homeView', isBase: true }, '', '#homeView');
        history.pushState({ view: 'homeView' }, '', '#homeView');
        showViewDirect('homeView');
        return;
    }

    if (event.state && event.state.view) {
        const targetView = event.state.view;

        // If trying to go back from home (base entry), stay in app
        if (event.state.isBase && currentView === 'homeView') {
            // Re-push entry to prevent app exit
            history.pushState({ view: 'homeView' }, '', '#homeView');
            console.log('[View] Prevented app exit - staying on homeView');
            isHandlingPopstate = false;
            return;
        }

        // Remove from stack without adding to history again
        if (viewStack.length > 1) {
            viewStack.pop();
        }

        showViewDirect(targetView);
    } else {
        // No state - this shouldn't happen, but handle gracefully
        // Re-push home state to prevent exit
        history.pushState({ view: 'homeView' }, '', '#homeView');
        viewStack = ['homeView'];
        showViewDirect('homeView');
    }
});

// Initialize: Set initial state for home view
// Push TWO history entries so first back press stays in app
if (window.location.hash) {
    const initialView = window.location.hash.substring(1);
    if (initialView && $(initialView)) {
        // First, set a base entry
        history.replaceState({ view: 'homeView', isBase: true }, '', '#homeView');
        // Then open the requested view
        openView(initialView);
    } else {
        history.replaceState({ view: 'homeView', isBase: true }, '', '#homeView');
        // Push another entry so back button works
        history.pushState({ view: 'homeView' }, '', '#homeView');
    }
} else {
    // Create base entry
    history.replaceState({ view: 'homeView', isBase: true }, '', '#homeView');
    // Push another entry so back button doesn't exit immediately
    history.pushState({ view: 'homeView' }, '', '#homeView');
}

// Prevent app exit on back button when on home view
window.addEventListener('beforeunload', (e) => {
    // Only show warning if user has unsaved work (e.g., mid-battle)
    if (typeof isScanning !== 'undefined' && isScanning) {
        e.preventDefault();
        e.returnValue = 'A battle is in progress. Are you sure you want to leave?';
    }
});

// ==================== PROGRESSION ====================
async function loadUserProgression() {
    if (!user) return;

    try {
        const { data, error } = await supabase
            .from('user_progression')
            .select('*')
            .eq('user_id', user.id)
            .single();

        if (error && error.code !== 'PGRST116') throw error;

        userProgression = data || {
            user_id: user.id,
            level: 1,
            xp: 0,
            xp_to_next_level: 100,
            truth_coins: 0,
            reputation_score: 100,
            accuracy_rate: 0
        };

        updateProgressionUI();

    } catch (err) {
        console.error('[Progression] Failed to load:', err);
    }
}

async function addXP(amount) {
    if (!user || !userProgression) return;

    userProgression.xp += amount;

    // Check for level up
    while (userProgression.xp >= userProgression.xp_to_next_level) {
        userProgression.level += 1;
        userProgression.xp -= userProgression.xp_to_next_level;
        userProgression.xp_to_next_level = Math.floor(userProgression.xp_to_next_level * 1.5);

        // Update quest progress for level reached
        updateQuestProgress('level_reached', userProgression.level);

        // Show level up notification
        showLevelUpNotification(userProgression.level);
    }

    // Update in database
    await saveUserProgression();
    updateProgressionUI();
}

async function awardCoins(amount, reason) {
    if (!user || !userProgression) {
        console.error('[Progression] Cannot award coins - user or userProgression is null:', { user: !!user, userProgression: !!userProgression, amount, reason });
        return;
    }

    try {
        // Use atomic coin award function (prevents race conditions)
        const { data, error } = await supabase.rpc('award_coins_atomic', {
            p_user_id: user.id,
            p_amount: amount
        });

        if (error) throw error;

        if (data && data.length > 0) {
            // Update local state with server response
            userProgression.truth_coins = data[0].truth_coins;
            userProgression.lifetime_coins_earned = data[0].lifetime_coins_earned;
            updateCoinsDisplay();

            // Update quest progress for total coins earned
            updateQuestProgress('coins_earned_total', data[0].lifetime_coins_earned);

            console.log(`[Progression] Awarded ${amount} coins for ${reason} (New total: ${data[0].truth_coins})`);
        }
    } catch (err) {
        console.error('[Progression] Failed to award coins:', err);
        // Fallback to local update
        userProgression.truth_coins += amount;
        userProgression.lifetime_coins_earned = (userProgression.lifetime_coins_earned || 0) + amount;
        await saveUserProgression();
        updateCoinsDisplay();
    }
}

async function saveUserProgression() {
    if (!user || !userProgression) return;

    try {
        const { error } = await supabase
            .from('user_progression')
            .upsert({
                user_id: user.id,
                level: userProgression.level,
                xp: userProgression.xp,
                xp_to_next_level: userProgression.xp_to_next_level,
                truth_coins: userProgression.truth_coins,
                lifetime_coins_earned: userProgression.lifetime_coins_earned,
                reputation_score: userProgression.reputation_score,
                accuracy_rate: userProgression.accuracy_rate,
                updated_at: new Date().toISOString()
            });

        if (error) throw error;

    } catch (err) {
        console.error('[Progression] Failed to save:', err);
    }
}

// ==================== BADGE PERSISTENCE ====================
// Load user badges from database to sync with localStorage
async function loadUserBadges() {
    if (!user) return;

    try {
        const { data, error } = await supabase
            .from('user_badges')
            .select('badge_id')
            .eq('user_id', user.id);

        if (error) throw error;

        if (data && data.length > 0) {
            // Extract badge IDs from database
            const dbBadges = data.map(row => row.badge_id);

            // Get current localStorage badges (in case there are any not yet synced)
            const localBadges = getStorage('unlocked_badges', []);

            // Merge: database badges take priority, but keep any local badges not in DB
            const mergedBadges = [...new Set([...dbBadges, ...localBadges])];

            // Update localStorage with merged badges
            setStorage('unlocked_badges', mergedBadges);

            console.log(`[Badges] Loaded ${dbBadges.length} badges from DB, ${mergedBadges.length} total after merge`);
        } else {
            console.log('[Badges] No badges found in database');
        }
    } catch (err) {
        console.error('[Badges] Failed to load from DB:', err);
        // Keep localStorage badges as fallback
    }
}

function updateProgressionUI() {
    updateCoinsDisplay();
    updateGameCTA();
    // Update other progression displays
}

function updateCoinsDisplay() {
    // Get coins from userProgression or localStorage fallback
    let coins = userProgression?.truth_coins || 0;
    if (coins === 0) {
        coins = parseInt(localStorage.getItem('truthCoins') || '0');
    }

    const displays = ['coinsCount', 'headerCoins', 'userCoins', 'historyViewCoins', 'leaderboardViewCoins', 'profileViewCoins', 'badgesViewCoins', 'questsViewCoins', 'headerCoinCount'];
    displays.forEach(id => {
        const el = $(id);
        if (el) {
            if (id === 'coinsCount' || id === 'headerCoinCount') {
                el.textContent = coins;
            } else if (id === 'userCoins') {
                el.textContent = `${coins} 🪙`;
            } else {
                el.innerHTML = `<span style="font-size:16px">🪙</span><span>${coins}</span>`;
            }
        }
    });
}

// Alias for updateCoinsDisplay
window.updateAllCoinDisplays = updateCoinsDisplay;

function updateGameCTA() {
    const cta = $('gameCTA');
    if (!cta || !user) return;

    // Show CTA for logged in users
    cta.style.display = 'block';

    // Update level
    const levelEl = $('userLevel');
    if (levelEl && userProgression) {
        levelEl.textContent = `Lvl ${userProgression.level || 1}`;
    }

    // Update coins (handled by updateCoinsDisplay)

    // Update rank (TODO: fetch from leaderboard)
    const rankEl = $('userRank');
    if (rankEl) {
        rankEl.textContent = '#--';  // Will be updated when leaderboard loads
    }
}

function showLevelUpNotification(level) {
    // Create notification overlay
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.9);
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.3s;
    `;

    notification.innerHTML = `
        <div style="text-align:center;animation:bounceIn 0.5s">
            <div style="font-size:80px;margin-bottom:16px">🎉</div>
            <div style="font-size:32px;font-weight:800;color:var(--gold);margin-bottom:8px">LEVEL UP!</div>
            <div style="font-size:48px;font-weight:800;color:var(--primary)">Level ${level}</div>
            <div style="margin-top:24px;color:var(--text2)">Tap to continue</div>
        </div>
    `;

    document.body.appendChild(notification);

    notification.addEventListener('click', () => {
        notification.remove();
    });

    setTimeout(() => {
        notification.remove();
    }, 5000);
}

// ==================== OUTBREAKS ====================
async function loadActiveOutbreak() {
    try {
        const { data, error } = await supabase
            .from('outbreak_events')
            .select('*')
            .eq('status', 'active')
            .single();

        if (error && error.code !== 'PGRST116') throw error;

        activeOutbreak = data;

        if (activeOutbreak) {
            showOutbreakBanner();
            updateOutbreakTimers();
        } else {
            hideOutbreakBanner();
        }

    } catch (err) {
        console.error('[Outbreak] Failed to load:', err);
    }
}

function showOutbreakBanner() {
    const banner = $('activeOutbreakBanner');
    if (!banner || !activeOutbreak) return;

    $('outbreakTitle').textContent = activeOutbreak.title;
    banner.style.display = 'flex';

    // Show pulse on nav
    const pulse = $('outbreakPulse');
    if (pulse) pulse.style.display = 'block';
}

function hideOutbreakBanner() {
    const banner = $('activeOutbreakBanner');
    if (banner) banner.style.display = 'none';

    const pulse = $('outbreakPulse');
    if (pulse) pulse.style.display = 'none';
}

function updateOutbreakTimers() {
    if (!activeOutbreak) return;

    const timerSmall = $('outbreakTimer'); // Banner timer
    const timerBig = $('outbreakTimerBig'); // View timer

    const updateTime = () => {
        const now = new Date();
        const end = new Date(activeOutbreak.ends_at);
        const diff = end - now;

        if (diff <= 0) {
            if (timerSmall) timerSmall.textContent = 'Ended';
            if (timerBig) timerBig.textContent = 'Event Ended';
            hideOutbreakBanner();
            return;
        }

        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);

        const timeStr = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

        if (timerSmall) timerSmall.textContent = `Ends in ${timeStr}`;
        if (timerBig) timerBig.textContent = timeStr;
    };

    updateTime();
    setInterval(updateTime, 1000);
}

async function loadOutbreaksView() {
    console.log('[Outbreak] Loading Outbreaks view');
    await loadActiveOutbreak();
    renderOutbreakView();
    // TODO: Load upcoming and past outbreaks
}

function renderOutbreakView() {
    if (!activeOutbreak) {
        console.log('[Outbreak] No active outbreak');
        const card = $('activeOutbreak');
        if (card) card.style.display = 'none';
        return;
    }

    // Show outbreak card
    const card = $('activeOutbreak');
    if (card) card.style.display = 'block';

    // Update title and description
    const title = $('outbreakCardTitle');
    const desc = $('outbreakDescription');
    if (title) title.textContent = activeOutbreak.title || 'Active Outbreak';
    if (desc) desc.textContent = activeOutbreak.description || '';

    // Update difficulty (1-5 fire emojis)
    const difficultyEl = $('outbreakDifficulty');
    if (difficultyEl && activeOutbreak.difficulty) {
        const fires = '🔥'.repeat(activeOutbreak.difficulty);
        difficultyEl.innerHTML = fires.split('').map(f => `<span>${f}</span>`).join('');
    }

    // Update goals
    const subGoal = $('submissionsGoal');
    const voteGoal = $('votesGoal');
    if (subGoal) subGoal.textContent = activeOutbreak.target_submissions || 50;
    if (voteGoal) voteGoal.textContent = activeOutbreak.target_votes || 200;

    // Start timer
    updateOutbreakTimers();
}

// ==================== SQUADS ====================
async function loadSquadsView() {
    console.log('[Squads] Loading Squads view');
    await loadUserSquad();
}

async function loadUserSquad() {
    if (!user) return;

    try {
        // Get user's squad membership
        const { data: membership, error: memberError } = await supabase
            .from('squad_members')
            .select('squad_id, role')
            .eq('user_id', user.id)
            .single();

        if (memberError && memberError.code !== 'PGRST116') throw memberError;

        if (membership) {
            // Load squad details
            const { data: squad, error: squadError } = await supabase
                .from('squads')
                .select('*')
                .eq('id', membership.squad_id)
                .single();

            if (squadError) throw squadError;

            userSquad = squad;
            renderUserSquad();
        } else {
            renderNoSquad();
        }

    } catch (err) {
        console.error('[Squad] Failed to load:', err);
    }
}

function renderUserSquad() {
    if (!userSquad) return;

    // Show squad card, hide no-squad state
    const mySquadCard = $('mySquadCard');
    const noSquadState = $('noSquadState');

    if (mySquadCard) mySquadCard.style.display = 'block';
    if (noSquadState) noSquadState.style.display = 'none';

    // Update squad info
    const squadAvatar = $('squadAvatar');
    const squadName = $('squadName');
    const squadMemberCount = $('squadMemberCount');
    const squadRank = $('squadRank');
    const squadPoints = $('squadPoints');
    const squadAccuracy = $('squadAccuracy');
    const challengeFill = $('challengeFill');
    const challengeProgress = $('challengeProgress');
    const challengeGoal = $('challengeGoal');

    if (squadAvatar) squadAvatar.src = userSquad.avatar_url || '';
    if (squadName) squadName.textContent = userSquad.name || 'My Squad';
    if (squadMemberCount) squadMemberCount.textContent = `${userSquad.member_count || 1}/5 members`;
    if (squadRank) squadRank.textContent = userSquad.squad_rank ? `#${userSquad.squad_rank}` : '--';
    if (squadPoints) squadPoints.textContent = userSquad.total_points || 0;
    if (squadAccuracy) squadAccuracy.textContent = userSquad.accuracy ? `${Math.round(userSquad.accuracy * 100)}%` : '--';

    // Challenge progress
    const progress = userSquad.weekly_progress || 0;
    const goal = userSquad.weekly_goal || 100;
    const percentage = Math.min((progress / goal) * 100, 100);

    if (challengeFill) challengeFill.style.width = `${percentage}%`;
    if (challengeProgress) challengeProgress.textContent = progress;
    if (challengeGoal) challengeGoal.textContent = goal;
}

function renderNoSquad() {
    // Show no-squad state, hide squad card
    const mySquadCard = $('mySquadCard');
    const noSquadState = $('noSquadState');

    if (mySquadCard) mySquadCard.style.display = 'none';
    if (noSquadState) noSquadState.style.display = 'block';
}

window.showCreateSquad = function() {
    if (!user) {
        toast('Please sign in to create a squad');
        openLogin();
        return;
    }

    // Create modal for squad creation
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.id = 'createSquadModal';
    modal.innerHTML = `
        <div class="modal" style="max-width:400px;padding:24px">
            <h3 style="margin:0 0 16px;font-size:18px">➕ Create New Squad</h3>
            <div class="input-group" style="margin-bottom:16px">
                <label style="font-size:12px;color:var(--text2)">Squad Name</label>
                <input type="text" id="newSquadName" placeholder="e.g., Truth Seekers" style="width:100%;padding:12px;border:1px solid var(--border);border-radius:8px;background:var(--surface);color:var(--text)">
            </div>
            <div class="input-group" style="margin-bottom:24px">
                <label style="font-size:12px;color:var(--text2)">Description (optional)</label>
                <textarea id="newSquadDesc" placeholder="What's your squad about?" rows="2" style="width:100%;padding:12px;border:1px solid var(--border);border-radius:8px;background:var(--surface);color:var(--text);resize:none"></textarea>
            </div>
            <button class="cta-btn" onclick="createSquad()">Create Squad</button>
            <button class="cta-btn-secondary" onclick="closeCreateSquadModal()" style="margin-top:8px">Cancel</button>
        </div>
    `;
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeCreateSquadModal();
    });
    document.body.appendChild(modal);
    modal.classList.add('show');
};

window.closeCreateSquadModal = function() {
    const modal = $('createSquadModal');
    if (modal) modal.remove();
};

window.createSquad = async function() {
    // Login requirement check
    if (!user) {
        showToast('Please log in to create a squad!', 'warning');
        return;
    }

    const name = $('newSquadName')?.value?.trim();
    const description = $('newSquadDesc')?.value?.trim();

    if (!name) {
        toast('Please enter a squad name');
        return;
    }

    try {
        if (useLocalFallback || !supabase) {
            // Create locally
            userSquad = {
                id: Date.now(),
                name,
                description,
                total_points: 0,
                member_count: 1,
                weekly_goal: 100,
                weekly_progress: 0
            };
            localStorage.setItem('user_squad', JSON.stringify(userSquad));
            toast('Squad created!');
        } else {
            const { data, error } = await supabase
                .from('squads')
                .insert({
                    name,
                    description,
                    created_by: user.id
                })
                .select()
                .single();

            if (error) throw error;

            // Add user as leader
            await supabase.from('squad_members').insert({
                squad_id: data.id,
                user_id: user.id,
                role: 'leader'
            });

            userSquad = data;
            toast('Squad created!');
        }

        closeCreateSquadModal();
        renderUserSquad();
    } catch (err) {
        console.error('[Squad] Create failed:', err);
        toast('Failed to create squad: ' + err.message);
    }
};

window.showJoinSquad = async function() {
    if (!user) {
        toast('Please sign in to join a squad');
        openLogin();
        return;
    }

    // Create modal for browsing squads
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.id = 'joinSquadModal';
    modal.innerHTML = `
        <div class="modal" style="max-width:400px;padding:24px;max-height:80vh;overflow-y:auto">
            <h3 style="margin:0 0 16px;font-size:18px">🔍 Browse Squads</h3>
            <div id="squadList" style="margin-bottom:16px">
                <div style="text-align:center;padding:20px;color:var(--text2)">Loading squads...</div>
            </div>
            <button class="cta-btn-secondary" onclick="closeJoinSquadModal()">Cancel</button>
        </div>
    `;
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeJoinSquadModal();
    });
    document.body.appendChild(modal);
    modal.classList.add('show');

    // Load available squads
    try {
        if (useLocalFallback || !supabase) {
            $('squadList').innerHTML = `
                <div style="text-align:center;padding:20px;color:var(--text2)">
                    No squads available yet. Why not create one?
                </div>
            `;
        } else {
            const { data, error } = await supabase
                .from('squads')
                .select('*')
                .eq('is_public', true)
                .limit(20);

            if (error) throw error;

            if (!data || data.length === 0) {
                $('squadList').innerHTML = `
                    <div style="text-align:center;padding:20px;color:var(--text2)">
                        No squads available yet. Why not create one?
                    </div>
                `;
            } else {
                $('squadList').innerHTML = data.map(squad => `
                    <div style="background:var(--surface);padding:12px;border-radius:12px;margin-bottom:8px;display:flex;align-items:center;gap:12px">
                        <div style="width:48px;height:48px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;font-size:24px">👥</div>
                        <div style="flex:1">
                            <div style="font-weight:600">${squad.name}</div>
                            <div style="font-size:12px;color:var(--text2)">${squad.total_points || 0} points</div>
                        </div>
                        <button class="cta-btn" style="padding:8px 16px;font-size:12px" onclick="joinSquad('${squad.id}')">Join</button>
                    </div>
                `).join('');
            }
        }
    } catch (err) {
        console.error('[Squad] Load failed:', err);
        $('squadList').innerHTML = `<div style="color:var(--danger);padding:20px;text-align:center">Failed to load squads</div>`;
    }
};

window.closeJoinSquadModal = function() {
    const modal = $('joinSquadModal');
    if (modal) modal.remove();
};

window.joinSquad = async function(squadId) {
    // Login requirement check
    if (!user) {
        showToast('Please log in to join a squad!', 'warning');
        return;
    }

    try {
        if (!useLocalFallback && supabase) {
            const { error } = await supabase
                .from('squad_members')
                .insert({
                    squad_id: squadId,
                    user_id: user.id,
                    role: 'member'
                });

            if (error) throw error;
        }

        toast('Joined squad!');
        closeJoinSquadModal();
        await loadUserSquad();
    } catch (err) {
        console.error('[Squad] Join failed:', err);
        toast('Failed to join squad: ' + err.message);
    }
};

// ==================== LEADERBOARD ====================
// Demo leaderboard data for when database is empty
const DEMO_LEADERBOARD = [
    { display_name: 'TankMaster2024', avatar_url: null, total_points: 15420, total_scans: 342, level: 28 },
    { display_name: 'AIHunterPro', avatar_url: null, total_points: 12850, total_scans: 298, level: 24 },
    { display_name: 'DeepfakeSlayer', avatar_url: null, total_points: 11200, total_scans: 265, level: 22 },
    { display_name: 'TruthSeeker99', avatar_url: null, total_points: 9750, total_scans: 231, level: 19 },
    { display_name: 'PixelDetective', avatar_url: null, total_points: 8400, total_scans: 198, level: 17 },
    { display_name: 'FakeBreaker', avatar_url: null, total_points: 7200, total_scans: 172, level: 15 },
    { display_name: 'ScanMachine', avatar_url: null, total_points: 6100, total_scans: 145, level: 13 },
    { display_name: 'AIBuster', avatar_url: null, total_points: 5200, total_scans: 124, level: 11 },
    { display_name: 'TruthTank', avatar_url: null, total_points: 4500, total_scans: 108, level: 10 },
    { display_name: 'DetectorBot', avatar_url: null, total_points: 3800, total_scans: 92, level: 9 }
];

async function loadLeaderboardView() {
    console.log('[Leaderboard] Loading leaderboard');

    try {
        const { data, error } = await supabase
            .from('truth_hunters_leaderboard')
            .select('*')
            .limit(100);

        if (error) throw error;

        // Use demo data if database is empty
        const leaderboardData = (data && data.length > 0) ? data : DEMO_LEADERBOARD;
        renderLeaderboard(leaderboardData);

    } catch (err) {
        console.error('[Leaderboard] Failed to load:', err);
        // Fallback to demo data on error
        renderLeaderboard(DEMO_LEADERBOARD);
    }
}

function renderLeaderboard(leaderboard) {
    const container = $('leaderboardContent');
    const fallbackAvatar = 'assets/vera/vera_fairy.svg';
    const fallbackEmoji = typeof updateLeaderboardAvatars === 'function' ? updateLeaderboardAvatars() : '🧑‍🚀';
    if (!container) return;

    if (!leaderboard || leaderboard.length === 0) {
        container.innerHTML = `
            <div style="text-align:center;padding:40px 20px;color:var(--text3)">
                <div style="font-size:48px;margin-bottom:16px">🏆</div>
                <div style="font-size:16px;font-weight:600;margin-bottom:8px">No Rankings Yet</div>
                <div style="font-size:13px">Be the first to climb the leaderboard!</div>
            </div>
        `;
        return;
    }

    // Render podium for top 3
    const top3 = leaderboard.slice(0, 3);
    const rest = leaderboard.slice(3);

    let html = `<div class="podium">`;
    top3.forEach((p, i) => {
        const pos = i === 0 ? 'first' : i === 1 ? 'second' : 'third';
        const tier = getTier(i + 1);
        html += `
            <div class="podium-item ${pos}">
                <div class="podium-avatar">
                    ${i === 0 ? '<span class="podium-crown"><span class="ad-icon-slot" data-ad-icon="trophy" data-ad-size="16"></span></span>' : ''}
                    <img src="${p.avatar_url || fallbackAvatar}">
                </div>
                <div class="podium-name">${p.display_name || 'Anonymous'}</div>
                <div class="podium-points">${p.total_points || 0} pts</div>
                <span class="podium-tier ${tier.class}">${tier.name}</span>
            </div>
        `;
    });
    html += `</div>`;

    // Group remaining players by tier with visual separation
    if (rest.length > 0) {
        // Define tier groups with their display info
        const tierGroups = [
            { name: 'LEGEND', class: 'tier-legend', range: [4, 10], bracket: 'LEGEND TIER' },
            { name: 'ELITE', class: 'tier-elite', range: [11, 25], bracket: 'ELITE TIER' },
            { name: 'VETERAN', class: 'tier-veteran', range: [26, 50], bracket: 'VETERAN TIER' },
            { name: 'RISING', class: 'tier-rising', range: [51, 100], bracket: 'RISING TIER' }
        ];

        // Group players by tier
        const grouped = {};
        rest.forEach((p, i) => {
            const rank = i + 4;
            const tier = getTier(rank);
            if (!grouped[tier.name]) {
                grouped[tier.name] = [];
            }
            grouped[tier.name].push({ ...p, rank: rank, tier: tier });
        });

        html += `<div class="lb-list">`;

        // Render each tier group with header and bracketed separator
        tierGroups.forEach(group => {
            if (grouped[group.name] && grouped[group.name].length > 0) {
                html += `
                    <div class="tier-group-section tier-group-${group.name.toLowerCase()}">
                        <div class="tier-group-header ${group.class}">
                            <span class="tier-group-bracket">[</span>
                            <span class="tier-group-label">${group.bracket}</span>
                            <span class="tier-group-bracket">]</span>
                        </div>
                        <div class="tier-group-content">
                `;

                grouped[group.name].forEach((p) => {
                    html += `
                        <div class="lb-item">
                            <div class="lb-rank ${p.rank <= 10 ? 'top10' : 'normal'}">${p.rank}</div>
                            <div class="lb-avatar"><img src="${p.avatar_url || fallbackAvatar}"></div>
                            <div class="lb-info">
                                <div class="lb-name">${p.display_name || 'Anonymous'}</div>
                                <div class="lb-stats">${p.total_scans || 0} scans</div>
                            </div>
                            <div class="lb-points">${p.total_points || 0}</div>
                            <span class="lb-tier ${p.tier.class}">${p.tier.name}</span>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            }
        });

        html += `</div>`;
    }

    container.innerHTML = html;
    if (window.IconLibrary) {
        window.IconLibrary.apply(container);
    }
    if (window.IconLibrary) {
        window.IconLibrary.apply(container);
    }
}

// ==================== SHOP ====================
let userOwnedItems = new Set();

async function loadShopView() {
    console.log('[Shop] Loading Shop view');

    // Update coins display in shop header
    const shopCoinsDisplay = $('shopCoinsDisplay');
    if (shopCoinsDisplay && userProgression) {
        shopCoinsDisplay.textContent = userProgression.truth_coins || 0;
    }

    // Load user owned items from localStorage
    loadOwnedItems();

    // Render shop categories (badges removed - achievement-only)
    renderShopCategory('cosmetics');
    renderShopCategory('powerups');
    renderShopCategory('tank_upgrades');
    // renderShopCategory('badges'); // REMOVED: Badges are achievement-only
    renderShopCategory('boosters');
}

function loadOwnedItems() {
    try {
        const owned = getStorage('userOwnedItems', []);
        userOwnedItems = new Set(owned);
    } catch (err) {
        console.error('[Shop] Failed to load owned items:', err);
        userOwnedItems = new Set();
    }
}

function saveOwnedItems() {
    try {
        setStorage('userOwnedItems', Array.from(userOwnedItems));
    } catch (err) {
        console.error('[Shop] Failed to save owned items:', err);
    }
}

function renderShopCategory(category) {
    const container = $(`${category}Shop`);
    if (!container) return;

    const items = Object.values(SHOP_ITEMS).filter(item => item.category === category);

    let html = '';
    items.forEach(item => {
        const owned = userOwnedItems.has(item.id);
        const currentCoins = userProgression?.truth_coins || 0;
        const canAfford = currentCoins >= item.cost;

        html += `
            <div class="shop-item ${owned ? 'purchased' : ''} ${!canAfford && !owned ? 'locked' : ''}">
                <div class="shop-item-rarity" data-rarity="${item.rarity}">${item.rarity}</div>
                <div class="shop-item-icon"><span class="ad-icon-slot" data-ad-icon="${item.icon}" data-ad-size="22"></span></div>
                <div class="shop-item-name">${item.name}</div>
                <div class="shop-item-desc">${item.desc}</div>
                <div class="shop-item-cost">
                    <span class="shop-item-cost-icon"><span class="ad-icon-slot" data-ad-icon="coins" data-ad-size="14"></span></span>
                    <span>${item.cost}</span>
                </div>
                ${owned ?
                    `<button class="shop-item-btn owned" disabled>Owned</button>` :
                    `<button class="shop-item-btn purchase ${!canAfford ? 'insufficient' : ''}"
                        onclick="purchaseItem('${item.id}')"
                        ${!canAfford ? 'disabled' : ''}>
                        Buy
                    </button>`
                }
            </div>
        `;
    });

    container.innerHTML = html;
}

async function purchaseItem(itemId) {
    if (!user || !userProgression) {
        toast('Please log in first');
        return;
    }

    const item = SHOP_ITEMS[itemId];
    if (!item) {
        console.error('[Shop] Item not found:', itemId);
        return;
    }

    if (userOwnedItems.has(itemId)) {
        toast('You already own this item');
        return;
    }

    const currentCoins = userProgression.truth_coins || 0;
    if (currentCoins < item.cost) {
        toast('Not enough coins');
        return;
    }

    try {
        // Deduct coins atomically using existing awardCoins function with negative amount
        const { data, error } = await supabase.rpc('award_coins_atomic', {
            p_user_id: user.id,
            p_amount: -item.cost
        });

        if (error) {
            console.error('[Shop] Purchase error:', error);
            toast('Purchase failed. Try again.');
            return;
        }

        if (data && data.length > 0) {
            // Update local state
            userProgression.truth_coins = data[0].truth_coins;

            // Add to owned items
            userOwnedItems.add(itemId);
            saveOwnedItems();

            // Update UI
            updateCoinsDisplay();
            updateShopDisplay();

            toast(`Purchased ${item.name}!`);
            console.log(`[Shop] Successfully purchased ${item.name} for ${item.cost} coins`);
        }
    } catch (err) {
        console.error('[Shop] Purchase error:', err);
        toast('Purchase failed. Try again.');
    }
}

function updateShopDisplay() {
    // Re-render all shop categories to reflect purchases
    const activeView = currentView;
    if (activeView === 'shopView') {
        renderShopCategory('cosmetics');
        renderShopCategory('powerups');
        renderShopCategory('tank_upgrades');
        // renderShopCategory('badges'); // REMOVED: Badges are achievement-only
        renderShopCategory('boosters');

        // Update coins display
        const shopCoinsDisplay = $('shopCoinsDisplay');
        if (shopCoinsDisplay && userProgression) {
            shopCoinsDisplay.textContent = userProgression.truth_coins || 0;
        }
    }
}

// ==================== MISSING CORE FUNCTIONS ====================

// File Input Trigger
window.triggerFileInput = function() {
    const input = $('fileInput');
    if (input) input.click();
};

// File upload handlers removed - detection engine disabled

// Detection engine removed - functionality disabled

// Placeholder for startScan to prevent errors
window.startScan = async function(mode) {
    toast('AI Detection has been disabled');
    return;
};

// Placeholder for cancelScan
window.cancelScan = function() {
    toast('No scan to cancel');
};

// Placeholder for updateForensics
window.updateForensics = function() {
    toast('Forensics mode unavailable');
};

// Placeholder for newScan
window.newScan = function() {
    toast('Scan functionality disabled');
};

// END OF DETECTION ENGINE PLACEHOLDERS

// ==================== NAVIGATION FUNCTIONS ====================

window.openProfile = function() {
    showView('profileView');
    renderBadgesPreview();
    loadProfileStats();
};

window.openHelp = function() {
    showView('helpView');
};

window.openHistory = function() {
    showView('historyView');
    renderHistory();
};

window.openLeaderboard = function() {
    openView('leaderboardView');
};

// ==================== GAME MODE DROPDOWN ====================
window.toggleGameModes = function(game) {
    const dropdown = document.getElementById(game + 'ModesDropdown');
    if (dropdown) {
        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
    }
};

// Close dropdowns when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('[onclick*="toggleGameModes"]')) {
        document.querySelectorAll('[id$="ModesDropdown"]').forEach(d => d.style.display = 'none');
    }
});

// ==================== SOCIAL NAVIGATION ====================
window.openFriends = function() {
    showView('squadsView'); // Use squads view for now, has friends section
    showToast('Friends list coming soon!', 'info');
};

window.openSquads = function() {
    showView('squadsView');
};

window.openTradingHub = function() {
    showToast('Trading Hub coming soon! Trade items with other players.', 'info');
};

window.openSettings = function() {
    openView('settingsView');
    loadSettings();
};

// Settings management functions
window.saveSettings = function() {
    const settings = {
        notifications: {
            quests: document.getElementById('notifQuests')?.checked || false,
            events: document.getElementById('notifEvents')?.checked || true,
            friends: document.getElementById('notifFriends')?.checked || true
        },
        privacy: {
            profile: document.getElementById('privacyProfile')?.checked || true,
            stats: document.getElementById('privacyStats')?.checked || true,
            anonymous: document.getElementById('privacyAnonymous')?.checked || false
        },
        preferences: {
            sounds: document.getElementById('prefSounds')?.checked || true,
            animations: document.getElementById('prefAnimations')?.checked || true,
            vera: document.getElementById('prefVera')?.checked !== false,
            veraSounds: document.getElementById('prefVeraSounds')?.checked !== false
        }
    };

    localStorage.setItem('userSettings', JSON.stringify(settings));
    if (window.showToast) showToast('Settings saved!', 'success');
};

window.loadSettings = function() {
    const saved = localStorage.getItem('userSettings');
    if (!saved) return;

    try {
        const settings = JSON.parse(saved);

        // Load notification settings
        if (settings.notifications) {
            if (document.getElementById('notifQuests'))
                document.getElementById('notifQuests').checked = settings.notifications.quests || false;
            if (document.getElementById('notifEvents'))
                document.getElementById('notifEvents').checked = settings.notifications.events !== false;
            if (document.getElementById('notifFriends'))
                document.getElementById('notifFriends').checked = settings.notifications.friends !== false;
        }

        // Load privacy settings
        if (settings.privacy) {
            if (document.getElementById('privacyProfile'))
                document.getElementById('privacyProfile').checked = settings.privacy.profile !== false;
            if (document.getElementById('privacyStats'))
                document.getElementById('privacyStats').checked = settings.privacy.stats !== false;
            if (document.getElementById('privacyAnonymous'))
                document.getElementById('privacyAnonymous').checked = settings.privacy.anonymous || false;
        }

        // Load preference settings
        if (settings.preferences) {
            if (document.getElementById('prefSounds'))
                document.getElementById('prefSounds').checked = settings.preferences.sounds !== false;
            if (document.getElementById('prefAnimations'))
                document.getElementById('prefAnimations').checked = settings.preferences.animations !== false;
            if (document.getElementById('prefVera'))
                document.getElementById('prefVera').checked = settings.preferences.vera !== false;
            if (document.getElementById('prefVeraSounds'))
                document.getElementById('prefVeraSounds').checked = settings.preferences.veraSounds !== false;

            // Apply VERA settings immediately
            toggleVeraVisibility();
            toggleVeraSounds();
        }
    } catch (e) {
        console.error('Error loading settings:', e);
    }
};

// VERA visibility toggle
window.toggleVeraVisibility = function() {
    const isEnabled = document.getElementById('prefVera')?.checked !== false;

    // Store preference
    localStorage.setItem('veraEnabled', isEnabled.toString());

    // Try multiple selectors for VERA container
    const veraContainer = document.querySelector('.vera-container') || document.querySelector('.help-bot');

    if (isEnabled) {
        // Re-enable VERA
        if (veraContainer) {
            veraContainer.style.display = 'block';
        } else if (window.VeraController && typeof window.VeraController.init === 'function') {
            // Re-initialize if container doesn't exist
            window.VeraController.init();
        }
    } else {
        // Disable VERA
        if (veraContainer) {
            veraContainer.style.display = 'none';
        }
        if (window.VeraController && typeof window.VeraController.setEnabled === 'function') {
            window.VeraController.setEnabled(false);
        }
    }
};

// VERA sounds toggle
window.toggleVeraSounds = function() {
    const isEnabled = document.getElementById('prefVeraSounds')?.checked !== false;

    // Store preference
    localStorage.setItem('veraSoundsEnabled', isEnabled.toString());

    // Update VERA sound system
    if (window.VeraSoundFX && typeof window.VeraSoundFX.setEnabled === 'function') {
        window.VeraSoundFX.setEnabled(isEnabled);
    }
    if (window.VeraController && typeof window.VeraController.setSoundsEnabled === 'function') {
        window.VeraController.setSoundsEnabled(isEnabled);
    }
};

window.confirmClearCache = function() {
    if (confirm('Clear all cached data? This will not delete your account or progress.')) {
        localStorage.removeItem('userSettings');
        localStorage.removeItem('characterDesignerState');
        if ('caches' in window) {
            caches.keys().then(names => {
                names.forEach(name => caches.delete(name));
            });
        }
        showToast('Cache cleared successfully!', 'success');
    }
};

window.confirmDeleteAccount = function() {
    if (confirm('⚠️ WARNING: This will permanently delete your account and ALL data. This cannot be undone!\n\nAre you absolutely sure?')) {
        if (confirm('Final confirmation: Delete your account forever?')) {
            showToast('Account deletion not yet implemented. Contact support@authenticadetector.com', 'error', 5000);
            // TODO: Implement actual account deletion via Supabase
        }
    }
};

window.handleLogout = async function() {
    if (!confirm('Are you sure you want to sign out?')) return;

    try {
        // Sign out from Supabase if available
        if (window.supabase) {
            const { error } = await window.supabase.auth.signOut();
            if (error) console.error('Logout error:', error);
        }

        // Clear local user data
        user = null;
        saveUser(); // Persist logout state
        localStorage.removeItem('userSettings');

        // Update UI
        updateUserUI();

        // Navigate to home
        showView('homeView');

        showToast('Signed out successfully', 'success');
    } catch (error) {
        console.error('Logout failed:', error);
        showToast('Logout failed. Please try again.', 'error');
    }
};

window.openAllBadges = function() {
    showView('allBadgesView');
    renderAllBadges();
};

// ==================== AVATAR/COSMETICS NAVIGATION ====================

window.openAvatarSelector = function() {
    // Open the avatar/cosmetics customization view
    showView('avatarView');
    // Initialize the cosmetics display if the function exists
    if (typeof initCosmeticsSystem === 'function') {
        initCosmeticsSystem();
    } else if (typeof switchCosmeticTab === 'function') {
        switchCosmeticTab('avatars');
    }
};

window.openAvatarView = function() {
    // Same as openAvatarSelector - customization view
    showView('avatarView');
    if (typeof initCosmeticsSystem === 'function') {
        initCosmeticsSystem();
    }
    // Initialize character designer
    if (typeof initCharacterDesigner === 'function') {
        initCharacterDesigner();
    }
    // Initialize Phaser Character Creator
    initPhaserCharacterCreator();
};

window.openAvatarBuilder = function() {
    // Alias for openAvatarView - opens character designer
    openAvatarView();
};

window.openShop = function() {
    // Open shop view
    openView('shopView');
    // Initialize shop content if function exists
    if (typeof loadShopItems === 'function') {
        loadShopItems();
    }
    // Update coin display
    updateAllCoinDisplays();
};

// Initialize Phaser Character Creator
function initPhaserCharacterCreator() {
    // Dispatch event for Phaser initialization
    window.dispatchEvent(new CustomEvent('avatarViewOpened'));

    // Initialize color pickers
    if (typeof ColorPickerUI !== 'undefined') {
        const skinContainer = document.getElementById('skinColorPicker');
        const hairContainer = document.getElementById('hairColorPicker');
        const eyeContainer = document.getElementById('eyeColorPicker');
        const clothesContainer = document.getElementById('clothesColorPicker');

        if (skinContainer && !skinContainer.hasChildNodes()) {
            new ColorPickerUI(skinContainer, 'skin', setCharacterColor);
        }
        if (hairContainer && !hairContainer.hasChildNodes()) {
            new ColorPickerUI(hairContainer, 'hair', setCharacterColor);
        }
        if (eyeContainer && !eyeContainer.hasChildNodes()) {
            new ColorPickerUI(eyeContainer, 'eyes', setCharacterColor);
        }
        if (clothesContainer && !clothesContainer.hasChildNodes()) {
            new ColorPickerUI(clothesContainer, 'clothes', setCharacterColor);
        }
    }

    // Remove loading state after Phaser initializes
    setTimeout(() => {
        const canvas = document.getElementById('phaserCharacterCanvas');
        if (canvas) canvas.classList.remove('loading');
    }, 1500);
}

// ==================== CHARACTER DESIGNER SYSTEM ====================
// Full piece-by-piece avatar customization with tank riding mode

// Character Designer State
let characterDesignerState = {
    mode: 'stand', // 'stand' or 'tank'
    selectedPart: null,
    mutations: {
        arms: 0,
        legs: 0
    },
    equipped: {
        head: { id: 'default', icon: 'profile', name: 'Default Face', rarity: 'common' },
        torso: { id: 'shirt', icon: 'shield', name: 'Basic Shirt', rarity: 'common' },
        legs: { id: 'pants', icon: 'stats', name: 'Basic Pants', rarity: 'common' },
        weapon: { id: 'sword', icon: 'crosshair', name: 'Pixel Sword', rarity: 'rare' },
        hat: null,
        glasses: null,
        back: null,
        pet: { id: 'cat', icon: 'beasts', name: 'Cyber Cat', rarity: 'common' },
        leftArm: { id: 'default_arm', icon: 'shield', name: 'Default Arm', rarity: 'common' },
        rightArm: { id: 'default_arm', icon: 'shield', name: 'Default Arm', rarity: 'common' }
    }
};

// Character Designer Items Database
const CHARACTER_ITEMS = {
    head: [
        { id: 'default', icon: 'profile', name: 'Default Face', rarity: 'common', price: 0 },
        { id: 'detective', icon: 'search', name: 'Detective', rarity: 'common', price: 50 },
        { id: 'scientist', icon: 'stats', name: 'Scientist', rarity: 'common', price: 60 },
        { id: 'hacker', icon: 'scan', name: 'Hacker', rarity: 'uncommon', price: 120 },
        { id: 'cyborg', icon: 'settings', name: 'Cyborg', rarity: 'uncommon', price: 150 },
        { id: 'alien', icon: 'beasts', name: 'Alien', rarity: 'rare', price: 300 },
        { id: 'ghost', icon: 'corruption', name: 'Ghost', rarity: 'rare', price: 350 },
        { id: 'demon', icon: 'warning', name: 'Demon', rarity: 'epic', price: 600 },
        { id: 'dragon', icon: 'boss', name: 'Dragon', rarity: 'epic', price: 800 },
        { id: 'skull', icon: 'warning', name: 'Skull King', rarity: 'legendary', price: 1500 },
        { id: 'neural', icon: 'stats', name: 'Neural Net', rarity: 'legendary', price: 2000 }
    ],
    torso: [
        { id: 'shirt', icon: 'shield', name: 'Basic Shirt', rarity: 'common', price: 0 },
        { id: 'hoodie', icon: 'scan', name: 'Hacker Hoodie', rarity: 'common', price: 80 },
        { id: 'suit', icon: 'stats', name: 'Executive Suit', rarity: 'uncommon', price: 200 },
        { id: 'armor', icon: 'shield', name: 'Pixel Armor', rarity: 'rare', price: 400 },
        { id: 'robe', icon: 'wand', name: 'Wizard Robe', rarity: 'rare', price: 450 },
        { id: 'cape', icon: 'sparkles', name: 'Hero Cape', rarity: 'epic', price: 700 },
        { id: 'cyber', icon: 'settings', name: 'Cyber Suit', rarity: 'epic', price: 900 },
        { id: 'golden', icon: 'trophy', name: 'Golden Armor', rarity: 'legendary', price: 1800 }
    ],
    legs: [
        { id: 'pants', icon: 'stats', name: 'Basic Pants', rarity: 'common', price: 0 },
        { id: 'shorts', icon: 'stats', name: 'Pixel Shorts', rarity: 'common', price: 50 },
        { id: 'jeans', icon: 'stats', name: 'Data Jeans', rarity: 'uncommon', price: 120 },
        { id: 'boots', icon: 'shield', name: 'Combat Boots', rarity: 'rare', price: 350 },
        { id: 'hover', icon: 'sparkles', name: 'Hover Boots', rarity: 'epic', price: 750 },
        { id: 'flames', icon: 'warning', name: 'Flame Legs', rarity: 'legendary', price: 1600 }
    ],
    weapon: [
        { id: 'magnify', icon: 'search', name: 'Truth Magnifier', rarity: 'common', price: 100, bonus: '+5% accuracy' },
        { id: 'scanner', icon: 'scan', name: 'Quantum Scanner', rarity: 'uncommon', price: 200, bonus: '+10% accuracy' },
        { id: 'sword', icon: 'crosshair', name: 'Pixel Sword', rarity: 'rare', price: 350 },
        { id: 'hammer', icon: 'shield', name: 'Ban Hammer', rarity: 'rare', price: 400 },
        { id: 'wand', icon: 'wand', name: 'Detection Wand', rarity: 'epic', price: 600, bonus: '+20% accuracy' },
        { id: 'laser', icon: 'warning', name: 'Truth Laser', rarity: 'epic', price: 750 },
        { id: 'staff', icon: 'wand', name: 'Algorithm Staff', rarity: 'legendary', price: 1200, bonus: '+30% accuracy' },
        { id: 'trident', icon: 'boss', name: 'Data Trident', rarity: 'legendary', price: 2000, bonus: '+35% accuracy' }
    ],
    hat: [
        { id: 'cap', icon: 'profile', name: 'Hacker Cap', rarity: 'common', price: 80 },
        { id: 'fedora', icon: 'search', name: 'Detective Hat', rarity: 'common', price: 100 },
        { id: 'helmet', icon: 'shield', name: 'VR Helmet', rarity: 'uncommon', price: 180 },
        { id: 'wizard', icon: 'wand', name: 'Wizard Hat', rarity: 'rare', price: 350 },
        { id: 'crown', icon: 'trophy', name: 'Gold Crown', rarity: 'epic', price: 800 },
        { id: 'halo', icon: 'sparkles', name: 'Truth Halo', rarity: 'legendary', price: 1500 }
    ],
    glasses: [
        { id: 'shades', icon: 'search', name: 'AI Shades', rarity: 'common', price: 100 },
        { id: 'goggles', icon: 'scan', name: 'Tech Goggles', rarity: 'uncommon', price: 180 },
        { id: 'monocle', icon: 'search', name: 'Sherlock Monocle', rarity: 'rare', price: 300 },
        { id: 'visor', icon: 'stats', name: 'Cyber Visor', rarity: 'epic', price: 650 },
        { id: 'laser_eyes', icon: 'warning', name: 'Laser Eyes', rarity: 'legendary', price: 1400 }
    ],
    back: [
        { id: 'cape', icon: 'sparkles', name: 'Hero Cape', rarity: 'uncommon', price: 250 },
        { id: 'wings', icon: 'sparkles', name: 'Angel Wings', rarity: 'rare', price: 500 },
        { id: 'demon_wings', icon: 'corruption', name: 'Demon Wings', rarity: 'epic', price: 800 },
        { id: 'dragon_wings', icon: 'boss', name: 'Dragon Wings', rarity: 'legendary', price: 1800 },
        { id: 'jetpack', icon: 'settings', name: 'Jetpack', rarity: 'legendary', price: 2000 }
    ],
    pet: [
        { id: 'cat', icon: 'beasts', name: 'Cyber Cat', rarity: 'common', price: 150 },
        { id: 'dog', icon: 'heart', name: 'Truth Dog', rarity: 'common', price: 180 },
        { id: 'bird', icon: 'sparkles', name: 'Scout Bird', rarity: 'uncommon', price: 250 },
        { id: 'robot', icon: 'settings', name: 'Mini Bot', rarity: 'rare', price: 400 },
        { id: 'dragon_pet', icon: 'boss', name: 'Mini Dragon', rarity: 'epic', price: 700 },
        { id: 'phoenix', icon: 'sparkles', name: 'Phoenix', rarity: 'legendary', price: 1600 }
    ]
};

const SLOT_ICON_MAP = {
    head: 'profile',
    torso: 'shield',
    legs: 'stats',
    weapon: 'wand',
    hat: 'star',
    glasses: 'search',
    back: 'sparkles',
    pet: 'beasts',
    leftArm: 'shield',
    rightArm: 'shield'
};

function getItemIconName(item, slot) {
    if (item?.icon) return item.icon;
    if (item?.id && slot && CHARACTER_ITEMS[slot]) {
        const match = CHARACTER_ITEMS[slot].find(entry => entry.id === item.id);
        if (match?.icon) return match.icon;
    }
    return SLOT_ICON_MAP[slot] || 'sparkles';
}

function normalizeEquippedItem(slot, item) {
    if (!item) return null;
    if (item.icon) return item;
    const icon = getItemIconName(item, slot);
    return { ...item, icon };
}

// Initialize Character Designer
function initCharacterDesigner() {
    console.log('[Character Designer] Initializing...');

    // Load saved state
    loadCharacterDesignerState();

    // Update coins display
    updateDesignerCoins();

    // Render items grid
    renderDesignerItems('all');

    // Apply equipped items to character
    updateCharacterPreview();

    // Update mutation controls + extra limb renders
    updateMutationControls();
    renderExtraLimbs();

    // Update equipped count
    updateEquippedCount();
}

// Load saved character state from localStorage
function loadCharacterDesignerState() {
    try {
        const saved = localStorage.getItem('character_designer_state');
        if (saved) {
            const parsed = JSON.parse(saved);
            characterDesignerState = { ...characterDesignerState, ...parsed };
            if (!characterDesignerState.mutations) {
                characterDesignerState.mutations = { arms: 0, legs: 0 };
            }
            if (characterDesignerState.equipped) {
                Object.keys(characterDesignerState.equipped).forEach(slot => {
                    characterDesignerState.equipped[slot] = normalizeEquippedItem(
                        slot,
                        characterDesignerState.equipped[slot]
                    );
                });
            }
        } else {
            // New user - set up default equipment (free items)
            initializeDefaultEquipment();
        }
    } catch (e) {
        console.error('[Character Designer] Failed to load state:', e);
        initializeDefaultEquipment();
    }
}

// Initialize default equipment for new users
function initializeDefaultEquipment() {
    console.log('[Character Designer] Setting up default equipment for new user');
    // Equip free default items
    const defaultItems = {
        head: CHARACTER_ITEMS.head.find(i => i.id === 'default'),
        torso: CHARACTER_ITEMS.torso.find(i => i.id === 'shirt'),
        legs: CHARACTER_ITEMS.legs.find(i => i.id === 'pants')
    };

    Object.entries(defaultItems).forEach(([slot, item]) => {
        if (item) {
            characterDesignerState.equipped[slot] = normalizeEquippedItem(slot, item);
        }
    });

    // Save the default state
    saveCharacterDesignerState();
}

// Save character state
function saveCharacterDesignerState() {
    try {
        localStorage.setItem('character_designer_state', JSON.stringify(characterDesignerState));
    } catch (e) {
        console.error('[Character Designer] Failed to save state:', e);
    }
}

// Update coins display in designer
function updateDesignerCoins() {
    const coinsEl = document.getElementById('designerCoinsCount');
    if (coinsEl) {
        const coins = userProgression?.truth_coins || parseInt(localStorage.getItem('truth_coins') || '0');
        coinsEl.textContent = coins.toLocaleString();
    }
}

// Set character mode (stand or tank)
function setCharacterMode(mode) {
    characterDesignerState.mode = mode;

    const standBtn = document.getElementById('standModeBtn');
    const tankBtn = document.getElementById('tankModeBtn');
    const tankContainer = document.getElementById('tankRideContainer');
    const charContainer = document.getElementById('characterContainer');

    if (mode === 'tank') {
        standBtn?.classList.remove('active');
        tankBtn?.classList.add('active');
        tankContainer?.classList.add('active');
        charContainer?.classList.add('riding');
    } else {
        standBtn?.classList.add('active');
        tankBtn?.classList.remove('active');
        tankContainer?.classList.remove('active');
        charContainer?.classList.remove('riding');
    }

    saveCharacterDesignerState();
    renderExtraLimbs();
}
window.setCharacterMode = setCharacterMode;

function updateMutationControls() {
    const armsEl = document.getElementById('extraArmsCount');
    const legsEl = document.getElementById('extraLegsCount');
    if (armsEl) armsEl.textContent = characterDesignerState.mutations?.arms || 0;
    if (legsEl) legsEl.textContent = characterDesignerState.mutations?.legs || 0;
}

function adjustMutations(type, delta) {
    const maxExtra = 2;
    if (!characterDesignerState.mutations) {
        characterDesignerState.mutations = { arms: 0, legs: 0 };
    }
    const current = characterDesignerState.mutations[type] || 0;
    const next = Math.max(0, Math.min(maxExtra, current + delta));
    characterDesignerState.mutations[type] = next;
    saveCharacterDesignerState();
    updateMutationControls();
    renderExtraLimbs();
}
window.adjustMutations = adjustMutations;

function renderExtraLimbs() {
    const layer = document.getElementById('characterExtraLayer');
    if (!layer) return;
    layer.innerHTML = '';

    const isTank = characterDesignerState.mode === 'tank';
    const armTop = isTank ? 78 : 72;
    const legTop = isTank ? 138 : 130;

    const armSlots = [
        { left: '6%', top: `${armTop}px`, rotate: -18 },
        { right: '6%', top: `${armTop}px`, rotate: 18 }
    ];
    const legSlots = [
        { left: '24%', top: `${legTop}px`, rotate: -8 },
        { right: '24%', top: `${legTop}px`, rotate: 8 }
    ];

    const extraArms = Math.max(0, Math.min(2, characterDesignerState.mutations?.arms || 0));
    const extraLegs = Math.max(0, Math.min(2, characterDesignerState.mutations?.legs || 0));

    armSlots.slice(0, extraArms).forEach(slot => {
        const arm = document.createElement('div');
        arm.className = 'char-extra-arm';
        arm.style.width = '28px';
        arm.style.height = '56px';
        arm.style.top = slot.top;
        if (slot.left) arm.style.left = slot.left;
        if (slot.right) arm.style.right = slot.right;
        arm.style.transform = `rotate(${slot.rotate}deg)`;
        layer.appendChild(arm);
    });

    legSlots.slice(0, extraLegs).forEach(slot => {
        const leg = document.createElement('div');
        leg.className = 'char-extra-leg';
        leg.style.width = '30px';
        leg.style.height = '58px';
        leg.style.top = slot.top;
        if (slot.left) leg.style.left = slot.left;
        if (slot.right) leg.style.right = slot.right;
        leg.style.transform = `rotate(${slot.rotate}deg)`;
        layer.appendChild(leg);
    });
}

// Select a body part for customization
function selectBodyPart(part) {
    // Remove selected from all parts
    document.querySelectorAll('.character-part').forEach(el => {
        el.classList.remove('selected');
    });

    // Add selected to clicked part
    const partId = 'char' + part.charAt(0).toUpperCase() + part.slice(1);
    const partEl = document.getElementById(partId) || document.querySelector(`[data-part="${part}"]`);
    if (partEl) {
        partEl.classList.add('selected');
    }

    characterDesignerState.selectedPart = part;

    // Filter items to show only this part
    filterDesignerItems(part);

    // Update tab
    document.querySelectorAll('.body-part-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.part === part) {
            tab.classList.add('active');
        }
    });
}
window.selectBodyPart = selectBodyPart;

// Filter items by body part
function filterDesignerItems(part, clickedBtn) {
    // Update active tab
    document.querySelectorAll('.body-part-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    if (clickedBtn) {
        clickedBtn.classList.add('active');
    }

    renderDesignerItems(part);
}
window.filterDesignerItems = filterDesignerItems;

// Render items in selection grid
function renderDesignerItems(part) {
    const grid = document.getElementById('itemsSelectionGrid');
    if (!grid) return;

    grid.innerHTML = '';

    // Get items to show
    let itemsToShow = [];
    if (part === 'all') {
        // Show all items from all categories
        Object.keys(CHARACTER_ITEMS).forEach(category => {
            CHARACTER_ITEMS[category].forEach(item => {
                itemsToShow.push({ ...item, slot: category });
            });
        });
    } else {
        // Show items from specific category
        const items = CHARACTER_ITEMS[part] || [];
        items.forEach(item => {
            itemsToShow.push({ ...item, slot: part });
        });
    }

    // Sort by rarity
    const rarityOrder = { common: 1, uncommon: 2, rare: 3, epic: 4, legendary: 5 };
    itemsToShow.sort((a, b) => rarityOrder[a.rarity] - rarityOrder[b.rarity]);

    // Render each item
    itemsToShow.forEach(item => {
        const isEquipped = characterDesignerState.equipped[item.slot]?.id === item.id;
        const isOwned = item.price === 0 || isItemOwned(item.slot, item.id);

        const card = document.createElement('div');
        card.className = `item-card rarity-${item.rarity} ${isEquipped ? 'equipped' : ''} ${!isOwned ? 'locked' : ''}`;
        const itemIcon = getItemIconName(item, item.slot);
        card.innerHTML = `
            <span class=\"item-card-icon\">
                <span class=\"avatar-item-icon ad-icon-slot\" data-ad-icon=\"${itemIcon}\" data-ad-size=\"18\"></span>
            </span>
            <span class=\"item-card-name\">${item.name}</span>
            ${!isOwned ? `<span class=\"item-card-price\"><span class=\"ad-icon-slot\" data-ad-icon=\"coins\" data-ad-size=\"14\"></span> ${item.price}</span>` : ''}
            ${item.bonus ? `<span style=\"font-size:9px;color:#2ecc71;\">${item.bonus}</span>` : ''}
        `;

        if (isOwned) {
            card.onclick = () => equipDesignerItem(item.slot, item);
        } else {
            card.onclick = () => purchaseDesignerItem(item.slot, item);
        }

        grid.appendChild(card);
        if (window.IconLibrary) {
            window.IconLibrary.apply(card);
        }
    });
}

// Check if item is owned
function isItemOwned(slot, itemId) {
    try {
        const owned = JSON.parse(localStorage.getItem('owned_character_items') || '{}');
        return owned[slot]?.includes(itemId) || false;
    } catch (e) {
        return false;
    }
}

// Purchase an item
async function purchaseDesignerItem(slot, item) {
    const coins = typeof userProgression !== 'undefined' ? userProgression.truth_coins : 0;

    if (coins < item.price) {
        toast(`Not enough coins! Need ${item.price} coins.`, 'error');
        return;
    }

    // Deduct coins
    if (typeof userProgression !== 'undefined') {
        userProgression.truth_coins -= item.price;
        updateDesignerCoins();
        if (typeof updateCoinsDisplay === 'function') updateCoinsDisplay();
    }

    // Add to owned items
    try {
        const owned = JSON.parse(localStorage.getItem('owned_character_items') || '{}');
        if (!owned[slot]) owned[slot] = [];
        owned[slot].push(item.id);
        localStorage.setItem('owned_character_items', JSON.stringify(owned));
    } catch (e) {
        console.error('[Character Designer] Failed to save owned item:', e);
    }

    toast(`Purchased ${item.name}!`, 'success');

    // Auto-equip
    equipDesignerItem(slot, item);

    // Refresh grid
    renderDesignerItems(characterDesignerState.selectedPart || 'all');
}

// Equip an item
function equipDesignerItem(slot, item) {
    characterDesignerState.equipped[slot] = item;
    saveCharacterDesignerState();
    updateCharacterPreview();
    updateEquippedCount();

    // Refresh grid
    renderDesignerItems(characterDesignerState.selectedPart || 'all');

    toast(`Equipped ${item.name}!`, 'success');
}

// Update character preview with equipped items
function updateCharacterPreview() {
    const equipped = characterDesignerState.equipped;

    const updatePart = (partId, item, slot) => {
        const el = document.getElementById(partId);
        if (!el) return;
        if (item) {
            const iconName = getItemIconName(item, slot);
            el.innerHTML = `<span class="avatar-item-icon ad-icon-slot" data-ad-icon="${iconName}" data-ad-size="20"></span>`;
        } else {
            el.innerHTML = '';
        }
    };

    updatePart('charHead', equipped.head, 'head');
    updatePart('charTorso', equipped.torso, 'torso');
    updatePart('charLegs', equipped.legs, 'legs');
    updatePart('charWeapon', equipped.weapon, 'weapon');
    updatePart('charHat', equipped.hat, 'hat');
    updatePart('charGlasses', equipped.glasses, 'glasses');
    updatePart('charBack', equipped.back, 'back');
    updatePart('charPet', equipped.pet, 'pet');
    updatePart('charLeftArm', equipped.leftArm, 'leftArm');
    updatePart('charRightArm', equipped.rightArm, 'rightArm');

    const updateSlot = (slotId, item, slot) => {
        const el = document.getElementById(slotId);
        const slotEl = el?.closest('.equip-slot');
        if (!el) return;
        if (item) {
            const iconName = getItemIconName(item, slot);
            el.innerHTML = `<span class="avatar-item-icon ad-icon-slot" data-ad-icon="${iconName}" data-ad-size="18"></span>`;
            slotEl?.classList.add('filled', `rarity-${item.rarity}`);
        } else {
            const defaultIcon = getDefaultSlotIcon(slot);
            el.innerHTML = `<span class="avatar-item-icon ad-icon-slot" data-ad-icon="${defaultIcon}" data-ad-size="18"></span>`;
            slotEl?.classList.remove('filled', 'rarity-common', 'rarity-uncommon', 'rarity-rare', 'rarity-epic', 'rarity-legendary');
        }
    };

    updateSlot('slotHeadIcon', equipped.head, 'head');
    updateSlot('slotTorsoIcon', equipped.torso, 'torso');
    updateSlot('slotLegsIcon', equipped.legs, 'legs');
    updateSlot('slotWeaponIcon', equipped.weapon, 'weapon');
    updateSlot('slotHatIcon', equipped.hat, 'hat');
    updateSlot('slotGlassesIcon', equipped.glasses, 'glasses');
    updateSlot('slotBackIcon', equipped.back, 'back');
    updateSlot('slotPetIcon', equipped.pet, 'pet');

    renderExtraLimbs();

    // Update character name based on equipped items
    updateCharacterName();

    if (window.IconLibrary) {
        window.IconLibrary.apply(document.getElementById('characterContainer'));
        window.IconLibrary.apply(document.getElementById('equipmentSlots'));
    }
}

// Get default icon for empty slot
function getDefaultSlotIcon(slot) {
    return SLOT_ICON_MAP[slot] || 'sparkles';
}

// Update equipped count display
function updateEquippedCount() {
    const countEl = document.getElementById('equippedCount');
    if (!countEl) return;

    const equipped = characterDesignerState.equipped;
    let count = 0;
    Object.values(equipped).forEach(item => {
        if (item) count++;
    });
    countEl.textContent = `${count}/10`;
}

// Update character name based on equipped items
function updateCharacterName() {
    const nameEl = document.getElementById('characterNameLabel');
    if (!nameEl) return;

    const equipped = characterDesignerState.equipped;

    // Generate cool title based on equipped legendary/epic items
    let title = 'Truth Seeker';

    if (equipped.head?.rarity === 'legendary') {
        title = equipped.head.name + ' Master';
    } else if (equipped.weapon?.rarity === 'legendary') {
        title = equipped.weapon.name + ' Wielder';
    } else if (equipped.back?.rarity === 'legendary') {
        title = 'Winged ' + (equipped.head?.name || 'Hunter');
    } else if (equipped.head?.rarity === 'epic') {
        title = 'Epic ' + equipped.head.name;
    }

    nameEl.textContent = title;
}

// Gacha roll for character designer
async function rollDesignerGacha(tier) {
    const costs = { basic: 100, premium: 400, legendary: 1000 };
    const cost = costs[tier];

    const coins = typeof userProgression !== 'undefined' ? userProgression.truth_coins : 0;

    if (coins < cost) {
        toast(`Not enough coins! Need ${cost} coins.`, 'error');
        return;
    }

    // Deduct coins
    if (typeof userProgression !== 'undefined') {
        userProgression.truth_coins -= cost;
        updateDesignerCoins();
        if (typeof updateCoinsDisplay === 'function') updateCoinsDisplay();
    }

    // Determine rarity
    const rand = Math.random() * 100;
    let rarity;
    if (tier === 'basic') {
        if (rand < 70) rarity = 'common';
        else if (rand < 95) rarity = 'uncommon';
        else rarity = 'rare';
    } else if (tier === 'premium') {
        if (rand < 40) rarity = 'uncommon';
        else if (rand < 75) rarity = 'rare';
        else if (rand < 95) rarity = 'epic';
        else rarity = 'legendary';
    } else {
        if (rand < 30) rarity = 'rare';
        else if (rand < 70) rarity = 'epic';
        else rarity = 'legendary';
    }

    // Find random item of that rarity
    const allItems = [];
    Object.keys(CHARACTER_ITEMS).forEach(slot => {
        CHARACTER_ITEMS[slot].forEach(item => {
            if (item.rarity === rarity) {
                allItems.push({ ...item, slot });
            }
        });
    });

    if (allItems.length === 0) {
        toast('Roll failed! Refunding...', 'error');
        if (typeof userProgression !== 'undefined') {
            userProgression.truth_coins += cost;
            updateDesignerCoins();
        }
        return;
    }

    const wonItem = allItems[Math.floor(Math.random() * allItems.length)];

    // Add to owned
    try {
        const owned = JSON.parse(localStorage.getItem('owned_character_items') || '{}');
        if (!owned[wonItem.slot]) owned[wonItem.slot] = [];
        if (!owned[wonItem.slot].includes(wonItem.id)) {
            owned[wonItem.slot].push(wonItem.id);
        }
        localStorage.setItem('owned_character_items', JSON.stringify(owned));
    } catch (e) {
        console.error('[Character Designer] Failed to save won item:', e);
    }

    // Show result
    const rarityColors = {
        common: '#95a5a6',
        uncommon: '#3498db',
        rare: '#9b59b6',
        epic: '#f39c12',
        legendary: '#e74c3c'
    };

    toast(`You won: ${wonItem.name} (${rarity.toUpperCase()})!`, 'success');

    // Refresh grid
    renderDesignerItems(characterDesignerState.selectedPart || 'all');
}
window.rollDesignerGacha = rollDesignerGacha;

// Initialize on load
window.initCharacterDesigner = initCharacterDesigner;

// ==================== SOUND SYSTEM ====================
// Simple sound effects for game actions

const SoundManager = {
    enabled: true,
    volume: 0.5,

    // Sound definitions (using Web Audio API for generated sounds)
    sounds: {
        // UI Sounds
        coin: { frequency: 880, duration: 0.1, type: 'sine', sweep: 1100 },
        success: { frequency: 600, duration: 0.15, type: 'sine', sweep: 900 },
        error: { frequency: 180, duration: 0.25, type: 'square' },
        click: { frequency: 500, duration: 0.04, type: 'sine' },
        tap: { frequency: 600, duration: 0.03, type: 'triangle' },
        hover: { frequency: 800, duration: 0.02, type: 'sine' },

        // Progress & Rewards
        levelUp: { frequency: 400, duration: 0.4, type: 'sine', sweep: 1000 },
        reward: { frequency: 550, duration: 0.25, type: 'sine', sweep: 800 },
        unlock: { frequency: 700, duration: 0.3, type: 'sine', sweep: 1200 },
        achievement: { frequency: 600, duration: 0.5, type: 'sine', sweep: 1400 },

        // Game Sounds
        scan: { frequency: 300, duration: 0.5, type: 'sawtooth' },
        shoot: { frequency: 120, duration: 0.12, type: 'square' },
        explosion: { frequency: 80, duration: 0.35, type: 'sawtooth' },
        powerup: { frequency: 600, duration: 0.25, type: 'sine', sweep: 1200 },
        damage: { frequency: 100, duration: 0.15, type: 'square' },
        shield: { frequency: 400, duration: 0.2, type: 'triangle', sweep: 600 },
        combo: { frequency: 500, duration: 0.15, type: 'sine', sweep: 1000 },

        // VERA Sounds
        veraHello: { frequency: 700, duration: 0.15, type: 'sine', sweep: 900 },
        veraHelp: { frequency: 600, duration: 0.2, type: 'sine', sweep: 800 },
        veraTip: { frequency: 550, duration: 0.12, type: 'triangle', sweep: 700 },

        // Gacha Sounds
        gachaRoll: { frequency: 200, duration: 0.8, type: 'sawtooth', sweep: 800 },
        gachaCommon: { frequency: 400, duration: 0.2, type: 'sine' },
        gachaRare: { frequency: 600, duration: 0.3, type: 'sine', sweep: 800 },
        gachaEpic: { frequency: 700, duration: 0.4, type: 'sine', sweep: 1000 },
        gachaLegendary: { frequency: 500, duration: 0.6, type: 'sine', sweep: 1500 },

        // Navigation
        navOpen: { frequency: 500, duration: 0.08, type: 'sine' },
        navClose: { frequency: 400, duration: 0.06, type: 'sine' },
        modalOpen: { frequency: 450, duration: 0.1, type: 'triangle' },
        modalClose: { frequency: 350, duration: 0.08, type: 'triangle' }
    },

    audioContext: null,

    init() {
        try {
            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            console.log('[Sound] Audio system initialized');
        } catch (e) {
            console.warn('[Sound] Web Audio API not supported');
            this.enabled = false;
        }

        // Load saved preference
        const savedEnabled = localStorage.getItem('sound_enabled');
        if (savedEnabled !== null) {
            this.enabled = savedEnabled === 'true';
        }

        const savedVolume = localStorage.getItem('sound_volume');
        if (savedVolume !== null) {
            this.volume = parseFloat(savedVolume);
        }
    },

    play(soundName) {
        if (!this.enabled || !this.audioContext) return;

        const sound = this.sounds[soundName];
        if (!sound) return;

        try {
            // Resume audio context if suspended (required by browsers)
            if (this.audioContext.state === 'suspended') {
                this.audioContext.resume();
            }

            const oscillator = this.audioContext.createOscillator();
            const gainNode = this.audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(this.audioContext.destination);

            oscillator.type = sound.type || 'sine';
            oscillator.frequency.setValueAtTime(sound.frequency, this.audioContext.currentTime);

            // Apply frequency sweep if defined
            if (sound.sweep) {
                oscillator.frequency.linearRampToValueAtTime(
                    sound.sweep,
                    this.audioContext.currentTime + sound.duration
                );
            }

            // Envelope
            gainNode.gain.setValueAtTime(this.volume * 0.3, this.audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(
                0.01,
                this.audioContext.currentTime + sound.duration
            );

            oscillator.start(this.audioContext.currentTime);
            oscillator.stop(this.audioContext.currentTime + sound.duration);
        } catch (e) {
            console.warn('[Sound] Failed to play sound:', e);
        }
    },

    toggle() {
        this.enabled = !this.enabled;
        localStorage.setItem('sound_enabled', this.enabled);
        toast(this.enabled ? '🔊 Sound ON' : '🔇 Sound OFF');
        return this.enabled;
    },

    setVolume(vol) {
        this.volume = Math.max(0, Math.min(1, vol));
        localStorage.setItem('sound_volume', this.volume);
    }
};

// Initialize sound system
document.addEventListener('DOMContentLoaded', () => SoundManager.init());

// Also init on first user interaction (required by browsers)
document.addEventListener('click', () => {
    if (SoundManager.audioContext?.state === 'suspended') {
        SoundManager.audioContext.resume();
    }
}, { once: true });

// Helper function for easy sound playing
function playSound(name) {
    SoundManager.play(name);
}
window.playSound = playSound;
window.SoundManager = SoundManager;

// ==================== ANIMATION MANAGER ====================
// Professional Lottie animations and particle effects

const AnimationManager = {
    // Free Lottie animation URLs from LottieFiles
    animations: {
        loading: 'https://lottie.host/4db68bbd-31f6-4cd8-84eb-189571c57333/mCv6xRG0MJ.json',
        success: 'https://lottie.host/cc4a3b47-cee9-41c4-b2a3-d7ada0ddc13c/BqPvbRxKGx.json',
        coin: 'https://lottie.host/39f431c9-6d67-4e93-aa6d-74fb51be7d7a/cO87MuQrRb.json',
        confetti: 'https://lottie.host/7e4a4d6b-b1c1-4f4b-8d55-c8c8c7b3b7e7/xDqFn9KmNr.json',
        star: 'https://lottie.host/6e91b0d3-4e4f-4f4f-8d0b-c8c8c7b3b7e7/ySt2n9KmNr.json',
        sparkle: 'https://lottie.host/embed/79be4379-f93e-488a-b8d5-db3fb5df5b24/7VbfWKkqHG.json',
        levelUp: 'https://lottie.host/embed/d40a9b5b-a3e5-4e4a-8e4b-c8c8c7b3b7e7/gHj2n9KmNr.json',
        trophy: 'https://lottie.host/embed/5bfd1f38-77cf-4e48-a6c0-c80a0d2d47c4/k7TJ5LqvHq.json'
    },

    // Play a Lottie animation in a container
    play(containerId, animationType, options = {}) {
        const container = document.getElementById(containerId);
        if (!container) return;

        const url = this.animations[animationType];
        if (!url) return;

        const player = document.createElement('lottie-player');
        player.src = url;
        player.background = 'transparent';
        player.speed = options.speed || 1;
        player.style.width = options.width || '80px';
        player.style.height = options.height || '80px';

        if (options.loop) {
            player.loop = true;
        }
        player.autoplay = true;

        container.innerHTML = '';
        container.appendChild(player);

        // Auto-remove after animation completes (unless looping)
        if (!options.loop) {
            setTimeout(() => {
                if (player.parentNode === container) {
                    player.remove();
                }
            }, (options.duration || 2000));
        }

        return player;
    },

    // Show confetti celebration (for level ups, achievements)
    showConfetti() {
        const overlay = document.createElement('div');
        overlay.className = 'lottie-confetti';
        overlay.innerHTML = `
            <lottie-player
                src="${this.animations.confetti}"
                background="transparent"
                speed="1"
                style="width:100%;height:100%"
                autoplay
            ></lottie-player>
        `;
        document.body.appendChild(overlay);

        setTimeout(() => overlay.remove(), 3000);
        playSound('achievement');
    },

    // Create floating coin animation
    showCoinEarned(x, y, amount) {
        const coin = document.createElement('div');
        coin.style.cssText = `
            position: fixed;
            left: ${x}px;
            top: ${y}px;
            z-index: 9999;
            pointer-events: none;
            font-size: 18px;
            font-weight: bold;
            color: var(--gold);
            text-shadow: 0 0 10px rgba(255,215,0,0.5);
            animation: floatUpFade 1s ease-out forwards;
        `;
        coin.textContent = `+${amount}`;
        document.body.appendChild(coin);

        setTimeout(() => coin.remove(), 1000);
        playSound('coin');
    },

    // Add sparkle effect to element
    addSparkle(element) {
        const rect = element.getBoundingClientRect();
        const sparkle = document.createElement('div');
        sparkle.className = 'lottie-sparkle';
        sparkle.style.left = `${rect.left + rect.width/2 - 12}px`;
        sparkle.style.top = `${rect.top + rect.height/2 - 12}px`;
        sparkle.innerHTML = `
            <lottie-player
                src="${this.animations.sparkle}"
                background="transparent"
                speed="1.5"
                style="width:24px;height:24px"
                autoplay
            ></lottie-player>
        `;
        document.body.appendChild(sparkle);

        setTimeout(() => sparkle.remove(), 800);
    }
};

// Add float up animation for coin popups
if (!document.getElementById('floatUpFadeStyle')) {
    const style = document.createElement('style');
    style.id = 'floatUpFadeStyle';
    style.textContent = `
        @keyframes floatUpFade {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-60px) scale(1.2); }
        }
    `;
    document.head.appendChild(style);
}

window.AnimationManager = AnimationManager;

// ==================== QUEST SYSTEM ====================

// Quest Definitions
const QUEST_DEFINITIONS = {
    daily: [
        {
            id: 'daily_login',
            icon: '🎁',
            title: 'Daily Login',
            description: 'Log in today',
            target: 1,
            reward: { coins: 25 },
            trackedEvent: 'daily_login',
            autoComplete: true
        },
        {
            id: 'tank_warrior',
            icon: '🔫',
            title: 'Tank Warrior',
            description: 'Clear 3 waves in Tank Battle',
            target: 3,
            reward: { coins: 50 },
            trackedEvent: 'wave_cleared'
        },
        {
            id: 'enemy_slayer',
            icon: '💥',
            title: 'Enemy Slayer',
            description: 'Destroy 50 enemies',
            target: 50,
            reward: { coins: 40 },
            trackedEvent: 'enemy_destroyed'
        },
        {
            id: 'beast_trainer',
            icon: '🐉',
            title: 'Beast Trainer',
            description: 'Train a beast 3 times',
            target: 3,
            reward: { coins: 35 },
            trackedEvent: 'beast_trained'
        },
        {
            id: 'coin_collector',
            icon: '🪙',
            title: 'Coin Collector',
            description: 'Earn 100 coins today',
            target: 100,
            reward: { coins: 30 },
            trackedEvent: 'coins_earned_daily'
        },
        {
            id: 'social_butterfly',
            icon: '👥',
            title: 'Social Butterfly',
            description: 'Add 1 friend',
            target: 1,
            reward: { coins: 50 },
            trackedEvent: 'friend_added'
        }
    ],
    weekly: [
        {
            id: 'wave_master',
            icon: '🏆',
            title: 'Wave Master',
            description: 'Clear 50 waves total',
            target: 50,
            reward: { coins: 300 },
            trackedEvent: 'wave_cleared'
        },
        {
            id: 'boss_slayer',
            icon: '👹',
            title: 'Boss Slayer',
            description: 'Defeat 5 bosses',
            target: 5,
            reward: { coins: 250 },
            trackedEvent: 'boss_defeated'
        },
        {
            id: 'beast_collector',
            icon: '🦴',
            title: 'Beast Collector',
            description: 'Capture 10 beasts',
            target: 10,
            reward: { coins: 400 },
            trackedEvent: 'beast_captured'
        },
        {
            id: 'badge_hunter',
            icon: '🎖️',
            title: 'Badge Hunter',
            description: 'Earn 3 new badges',
            target: 3,
            reward: { cosmetic: 'Special Avatar Border' },
            trackedEvent: 'badge_earned'
        },
        {
            id: 'powerup_pro',
            icon: '⚡',
            title: 'Power-Up Pro',
            description: 'Use 25 power-ups',
            target: 25,
            reward: { coins: 200 },
            trackedEvent: 'powerup_used'
        }
    ],
    special: [
        {
            id: 'first_battle',
            icon: '🎮',
            title: 'First Battle',
            description: 'Complete your first Tank Battle',
            target: 1,
            reward: { coins: 100 },
            trackedEvent: 'battle_completed'
        },
        {
            id: 'getting_started',
            icon: '🌱',
            title: 'Getting Started',
            description: 'Reach level 5',
            target: 5,
            reward: { cosmetic: 'Rare Avatar' },
            trackedEvent: 'level_reached'
        },
        {
            id: 'wave_legend',
            icon: '🎓',
            title: 'Wave Legend',
            description: 'Clear wave 20',
            target: 20,
            reward: { cosmetic: 'Epic Avatar + Frame' },
            trackedEvent: 'max_wave_reached'
        }
    ]
};

// Initialize quest system
function initializeQuests() {
    let userQuests = getStorage('userQuests', null);

    if (!userQuests) {
        // Create default quest structure
        userQuests = {
            daily: {
                lastReset: Date.now(),
                quests: QUEST_DEFINITIONS.daily.map(q => ({
                    id: q.id,
                    progress: q.autoComplete ? q.target : 0,
                    completed: q.autoComplete || false,
                    claimed: false
                }))
            },
            weekly: {
                lastReset: Date.now(),
                quests: QUEST_DEFINITIONS.weekly.map(q => ({
                    id: q.id,
                    progress: q.autoComplete ? q.target : 0,
                    completed: q.autoComplete || false,
                    claimed: false
                }))
            },
            special: {
                quests: QUEST_DEFINITIONS.special.map(q => ({
                    id: q.id,
                    progress: q.autoComplete ? q.target : 0,
                    completed: q.autoComplete || false,
                    claimed: false
                }))
            }
        };
        setStorage('userQuests', userQuests);
    }

    // Sync quests - add any new quests that were added to definitions
    let needsSave = false;
    ['daily', 'weekly', 'special'].forEach(type => {
        if (!userQuests[type]?.quests) return;
        const defs = QUEST_DEFINITIONS[type] || [];

        // Add any new quests from definitions
        defs.forEach(def => {
            const exists = userQuests[type].quests.find(q => q.id === def.id);
            if (!exists) {
                userQuests[type].quests.push({
                    id: def.id,
                    progress: def.autoComplete ? def.target : 0,
                    completed: def.autoComplete || false,
                    claimed: false
                });
                needsSave = true;
                console.log('[Quests] Added new quest:', def.id);
            }
        });

        // Auto-complete any autoComplete quests that aren't claimed yet
        userQuests[type].quests.forEach(quest => {
            const def = defs.find(q => q.id === quest.id);
            if (def?.autoComplete && !quest.completed && !quest.claimed) {
                quest.progress = def.target;
                quest.completed = true;
                needsSave = true;
                console.log('[Quests] Auto-completed:', quest.id);
            }
        });
    });
    if (needsSave) {
        setStorage('userQuests', userQuests);
    }

    // Check if resets are needed
    checkQuestResets();

    return userQuests;
}

// Check and reset daily/weekly quests if needed
function checkQuestResets() {
    const userQuests = getStorage('userQuests', null);
    if (!userQuests) return;

    const now = Date.now();
    let needsSave = false;

    // Check daily reset (24 hours)
    const dayInMs = 24 * 60 * 60 * 1000;
    if (now - userQuests.daily.lastReset > dayInMs) {
        userQuests.daily.lastReset = now;
        userQuests.daily.quests = QUEST_DEFINITIONS.daily.map(q => ({
            id: q.id,
            progress: 0,
            completed: false,
            claimed: false
        }));
        needsSave = true;
    }

    // Check weekly reset (7 days)
    const weekInMs = 7 * dayInMs;
    if (now - userQuests.weekly.lastReset > weekInMs) {
        userQuests.weekly.lastReset = now;
        userQuests.weekly.quests = QUEST_DEFINITIONS.weekly.map(q => ({
            id: q.id,
            progress: 0,
            completed: false,
            claimed: false
        }));
        needsSave = true;
    }

    if (needsSave) {
        setStorage('userQuests', userQuests);
    }
}

// Update quest progress
function updateQuestProgress(eventType, amount = 1) {
    const userQuests = getStorage('userQuests', null);
    if (!userQuests) return;

    let updated = false;

    // Update daily quests
    userQuests.daily.quests.forEach(quest => {
        const def = QUEST_DEFINITIONS.daily.find(q => q.id === quest.id);
        if (def && def.trackedEvent === eventType && !quest.completed) {
            quest.progress = Math.min(quest.progress + amount, def.target);
            if (quest.progress >= def.target) {
                quest.completed = true;
                showQuestCompleted(def, 'daily');
            }
            updated = true;
        }
    });

    // Update weekly quests
    userQuests.weekly.quests.forEach(quest => {
        const def = QUEST_DEFINITIONS.weekly.find(q => q.id === quest.id);
        if (def && def.trackedEvent === eventType && !quest.completed) {
            quest.progress = Math.min(quest.progress + amount, def.target);
            if (quest.progress >= def.target) {
                quest.completed = true;
                showQuestCompleted(def, 'weekly');
            }
            updated = true;
        }
    });

    // Update special quests
    userQuests.special.quests.forEach(quest => {
        const def = QUEST_DEFINITIONS.special.find(q => q.id === quest.id);
        if (def && def.trackedEvent === eventType && !quest.completed) {
            // For level quests, set progress to the amount (level value)
            if (eventType === 'level_reached') {
                quest.progress = amount;
            } else if (eventType === 'coins_earned_total') {
                quest.progress = amount;
            } else {
                quest.progress = Math.min(quest.progress + amount, def.target);
            }

            if (quest.progress >= def.target) {
                quest.completed = true;
                showQuestCompleted(def, 'special');
            }
            updated = true;
        }
    });

    if (updated) {
        setStorage('userQuests', userQuests);
    }
}

// Show quest completed notification
function showQuestCompleted(questDef, questType) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed; top: 80px; right: 16px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        padding: 16px 20px; border-radius: 12px; z-index: 9999;
        box-shadow: 0 8px 32px rgba(94,234,212,0.3);
        animation: slideInRight 0.3s ease-out;
        max-width: 300px;
    `;

    const rewardText = questDef.reward.coins
        ? `+${questDef.reward.coins} coins`
        : questDef.reward.cosmetic;

    notification.innerHTML = `
        <div style="display:flex;align-items:center;gap:12px">
            <div style="font-size:32px">${questDef.icon}</div>
            <div style="flex:1">
                <div style="font-size:12px;color:rgba(255,255,255,0.8);margin-bottom:2px">QUEST COMPLETED!</div>
                <div style="font-size:14px;font-weight:700;color:white">${questDef.title}</div>
                <div style="font-size:11px;color:rgba(255,255,255,0.9);margin-top:4px">Reward: ${rewardText}</div>
            </div>
        </div>
    `;

    document.body.appendChild(notification);
    notification.addEventListener('click', () => notification.remove());
    setTimeout(() => notification.remove(), 4000);
}

// Claim quest reward
async function claimQuestReward(questId, questType) {
    console.log('[Quests] Claiming reward for:', questId, questType);

    const userQuests = getStorage('userQuests', null);
    if (!userQuests) {
        console.error('[Quests] No userQuests found');
        toast('Error: Quest data not found', 'error');
        return;
    }

    const questList = userQuests[questType]?.quests;
    if (!questList) {
        console.error('[Quests] No quest list for type:', questType);
        return;
    }

    const quest = questList.find(q => q.id === questId);

    if (!quest) {
        console.error('[Quests] Quest not found:', questId);
        return;
    }

    if (!quest.completed) {
        toast('Complete the quest first!', 'warning');
        return;
    }

    if (quest.claimed) {
        toast('Already claimed!', 'warning');
        return;
    }

    const def = QUEST_DEFINITIONS[questType]?.find(q => q.id === questId);
    if (!def) {
        console.error('[Quests] Quest definition not found:', questId);
        return;
    }

    // Award reward
    if (def.reward.coins) {
        // Try to award coins (works for both logged in and guest)
        try {
            if (user && userProgression) {
                await awardCoins(def.reward.coins, `Quest: ${def.title}`);
            } else {
                // Guest mode - just update local progression
                if (typeof userProgression !== 'undefined' && userProgression) {
                    userProgression.truth_coins = (userProgression.truth_coins || 0) + def.reward.coins;
                    if (typeof updateCoinsDisplay === 'function') updateCoinsDisplay();
                }
            }
            playSound('coin');
            toast(`+${def.reward.coins} 🪙 coins earned!`, 'success');
        } catch (err) {
            console.error('[Quests] Failed to award coins:', err);
            playSound('error');
            toast('Failed to award coins', 'error');
            return;
        }
    }

    if (def.reward.cosmetic) {
        // Store cosmetic reward
        const cosmetics = getStorage('cosmetic_rewards', []);
        if (!cosmetics.includes(def.reward.cosmetic)) {
            cosmetics.push(def.reward.cosmetic);
            setStorage('cosmetic_rewards', cosmetics);
        }
        playSound('reward');
        toast(`Unlocked: ${def.reward.cosmetic}!`, 'success');
    }

    // Mark as claimed
    quest.claimed = true;
    setStorage('userQuests', userQuests);

    // Re-render quests
    renderQuests();

    console.log('[Quests] Successfully claimed reward for:', def.title);
}
// Expose to window for onclick handlers
window.claimQuestReward = claimQuestReward;

// Render quests in UI
function renderQuests() {
    const userQuests = getStorage('userQuests', null);
    if (!userQuests) return;

    // Calculate summary stats
    let totalCompleted = 0;
    let totalAvailable = 0;
    let totalCoinsEarned = 0;

    const countQuests = (quests, defs) => {
        quests.forEach(q => {
            const def = defs.find(d => d.id === q.id);
            if (q.claimed) {
                totalCompleted++;
                totalCoinsEarned += (def?.reward?.coins || 0);
            } else {
                totalAvailable++;
            }
        });
    };

    countQuests(userQuests.daily.quests, QUEST_DEFINITIONS.daily);
    countQuests(userQuests.weekly.quests, QUEST_DEFINITIONS.weekly);
    countQuests(userQuests.special.quests, QUEST_DEFINITIONS.special);

    // Update summary card
    const completedEl = $('questsCompleted');
    const availableEl = $('questsAvailable');
    const coinsEl = $('questsCoinsEarned');
    if (completedEl) completedEl.textContent = totalCompleted;
    if (availableEl) availableEl.textContent = totalAvailable;
    if (coinsEl) coinsEl.textContent = totalCoinsEarned;

    // Render daily quests
    const dailyContainer = $('dailyQuests');
    if (dailyContainer) {
        dailyContainer.innerHTML = userQuests.daily.quests.map(quest => {
            const def = QUEST_DEFINITIONS.daily.find(q => q.id === quest.id);
            return renderQuestCard(quest, def, 'daily');
        }).join('');
    }

    // Render weekly quests
    const weeklyContainer = $('weeklyQuests');
    if (weeklyContainer) {
        weeklyContainer.innerHTML = userQuests.weekly.quests.map(quest => {
            const def = QUEST_DEFINITIONS.weekly.find(q => q.id === quest.id);
            return renderQuestCard(quest, def, 'weekly');
        }).join('');
    }

    // Render special quests
    const specialContainer = $('specialQuests');
    if (specialContainer) {
        specialContainer.innerHTML = userQuests.special.quests.map(quest => {
            const def = QUEST_DEFINITIONS.special.find(q => q.id === quest.id);
            return renderQuestCard(quest, def, 'special');
        }).join('');
    }
}

// Helper function to convert emoji icons to SVG paths
function getIconSVG(icon, size = 24) {
    const iconMap = {
        '🏆': 'assets/icons/trophy.svg',
        '🎖️': 'assets/icons/medal.svg',
        '⭐': 'assets/icons/star.svg',
        '⚡': 'assets/icons/lightning.svg',
        '👑': 'assets/icons/crown.svg',
        '💎': 'assets/icons/currency-crystal.svg'
    };

    if (iconMap[icon]) {
        return `<img src="${iconMap[icon]}" alt="" style="width:${size}px;height:${size}px">`;
    }
    // Fallback to emoji if no SVG mapping
    return icon;
}

// Render individual quest card - Polished version
function renderQuestCard(quest, def, questType) {
    if (!def) return '';

    const progress = Math.min(quest.progress, def.target);
    const percentage = (progress / def.target) * 100;
    const isCompleted = quest.completed;
    const isClaimed = quest.claimed;
    const isClaimable = isCompleted && !isClaimed;

    const coinReward = def.reward.coins || 0;

    let buttonHtml = '';
    if (isClaimed) {
        buttonHtml = '<button class="quest-claim-btn" disabled>✓ Claimed</button>';
    } else if (isCompleted) {
        buttonHtml = `<button class="quest-claim-btn" onclick="claimQuestReward('${quest.id}', '${questType}')">Claim</button>`;
    } else {
        buttonHtml = `<button class="quest-claim-btn" disabled>In Progress</button>`;
    }

    // Card classes based on state
    let cardClasses = 'quest-card';
    if (isClaimed) cardClasses += ' completed claimed';
    else if (isClaimable) cardClasses += ' claimable';

    // Progress bar class
    const progressClass = isCompleted ? 'quest-progress-fill complete' : 'quest-progress-fill';

    return `
        <div class="${cardClasses}">
            <div class="quest-icon">${getIconSVG(def.icon, 32)}</div>
            <div class="quest-info">
                <div class="quest-title">${def.title}</div>
                <div class="quest-desc">${def.description}</div>
                <div class="quest-progress">
                    <div class="quest-progress-bar">
                        <div class="${progressClass}" style="width: ${percentage}%"></div>
                    </div>
                    <span class="quest-progress-text">${progress}/${def.target}</span>
                </div>
            </div>
            <div class="quest-reward">
                <div class="quest-reward-value">🪙 ${coinReward}</div>
                <div class="quest-reward-label">Reward</div>
            </div>
            ${buttonHtml}
        </div>
    `;
}

// Update quest timers with urgent indicator
function updateQuestTimers() {
    const userQuests = getStorage('userQuests', null);
    if (!userQuests) return;

    const now = Date.now();
    const ONE_HOUR = 60 * 60 * 1000;
    const ONE_DAY = 24 * ONE_HOUR;

    // Daily timer - urgent if < 1 hour remaining
    const dailyTimer = $('dailyTimer');
    if (dailyTimer) {
        const dailyRemaining = ONE_DAY - (now - userQuests.daily.lastReset);
        if (dailyRemaining > 0) {
            const hours = Math.floor(dailyRemaining / ONE_HOUR);
            const minutes = Math.floor((dailyRemaining % ONE_HOUR) / (60 * 1000));
            const seconds = Math.floor((dailyRemaining % (60 * 1000)) / 1000);
            dailyTimer.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            // Add urgent class if less than 1 hour remaining
            if (dailyRemaining < ONE_HOUR) {
                dailyTimer.classList.add('urgent');
            } else {
                dailyTimer.classList.remove('urgent');
            }
        } else {
            dailyTimer.textContent = 'Reset now!';
            dailyTimer.classList.add('urgent');
        }
    }

    // Weekly timer - urgent if < 1 day remaining
    const weeklyTimer = $('weeklyTimer');
    if (weeklyTimer) {
        const weeklyRemaining = 7 * ONE_DAY - (now - userQuests.weekly.lastReset);
        if (weeklyRemaining > 0) {
            const days = Math.floor(weeklyRemaining / ONE_DAY);
            const hours = Math.floor((weeklyRemaining % ONE_DAY) / ONE_HOUR);
            weeklyTimer.textContent = `${days}d ${hours}h`;
            // Add urgent class if less than 1 day remaining
            if (weeklyRemaining < ONE_DAY) {
                weeklyTimer.classList.add('urgent');
            } else {
                weeklyTimer.classList.remove('urgent');
            }
        } else {
            weeklyTimer.textContent = 'Reset now!';
            weeklyTimer.classList.add('urgent');
        }
    }
}

// Open quests view
window.openQuestsView = function() {
    console.log('[Quests] Opening quests view...');
    checkQuestResets();
    initializeQuests();
    showView('questsView');
    renderQuests();
    updateQuestTimers();
    updateCoinsDisplay();
    console.log('[Quests] Quests view opened');

    // Update timers every second
    if (window.questTimerInterval) {
        clearInterval(window.questTimerInterval);
    }
    window.questTimerInterval = setInterval(updateQuestTimers, 1000);
};

// Initialize quest system on app load
document.addEventListener('DOMContentLoaded', () => {
    initializeQuests();
});

// Toggle quests popup on home screen
window.toggleQuestsPopup = function() {
    const popup = document.getElementById('questsPopup');
    if (!popup) return;

    if (popup.style.display === 'none' || popup.style.display === '') {
        // Show popup
        checkQuestResets();
        initializeQuests();
        populateQuestsPopup();
        popup.style.display = 'block';
    } else {
        // Hide popup
        popup.style.display = 'none';
    }
};

// Populate quests popup with daily quests
function populateQuestsPopup() {
    const body = document.getElementById('questsPopupBody');
    if (!body) return;

    const questProgress = JSON.parse(localStorage.getItem('questProgress') || '{}');
    const dailyQuests = QUEST_DEFINITIONS.daily || [];

    let html = '';
    let claimableCount = 0;

    dailyQuests.slice(0, 5).forEach(quest => {
        const progress = questProgress[quest.id] || { current: 0, claimed: false };
        const isComplete = progress.current >= quest.target;
        const isClaimable = isComplete && !progress.claimed;

        if (isClaimable) claimableCount++;

        html += `
            <div class="popup-quest-item ${isClaimable ? 'claimable' : ''}">
                <div class="popup-quest-icon">${quest.icon}</div>
                <div class="popup-quest-info">
                    <div class="popup-quest-title">${quest.title}</div>
                    <div class="popup-quest-progress">${progress.current}/${quest.target} ${isComplete ? '(Complete!)' : ''}</div>
                </div>
                <div class="popup-quest-reward">
                    <span>🪙</span>
                    <span>${quest.reward.coins}</span>
                </div>
            </div>
        `;
    });

    body.innerHTML = html || '<p style="text-align:center;color:var(--text2)">No quests available</p>';

    // Update badge count
    const badge = document.getElementById('questsBadge');
    if (badge) {
        badge.textContent = claimableCount;
        badge.style.display = claimableCount > 0 ? 'flex' : 'none';
    }
}

// Update quests badge on home screen
function updateQuestsBadge() {
    const questProgress = JSON.parse(localStorage.getItem('questProgress') || '{}');
    const dailyQuests = QUEST_DEFINITIONS.daily || [];

    let claimableCount = 0;
    dailyQuests.forEach(quest => {
        const progress = questProgress[quest.id] || { current: 0, claimed: false };
        if (progress.current >= quest.target && !progress.claimed) {
            claimableCount++;
        }
    });

    const badge = document.getElementById('questsBadge');
    if (badge) {
        badge.textContent = claimableCount;
        badge.style.display = claimableCount > 0 ? 'flex' : 'none';
    }
}

// Profile stats
function loadProfileStats() {
    // Get stats from user-specific storage (matches loadUserStats)
    const stats = user ? getStorage(`stats_${user.id}`, {}) : getStorage('user_stats', {});
    // Use correct element IDs that exist in the DOM
    if ($('statScans')) $('statScans').textContent = stats.total || 0;
    if ($('statFound')) $('statFound').textContent = stats.ai || 0;
    if ($('statPoints')) $('statPoints').textContent = stats.points || 0;
}

// Render history
function renderHistory() {
    const container = $('historyContent');
    if (!container) return;

    const history = getStorage('scan_history', []);

    if (history.length === 0) {
        container.innerHTML = `
            <div class="history-empty">
                <div style="font-size:40px;margin-bottom:12px">📋</div>
                <div>No scans yet</div>
                <div style="font-size:11px;margin-top:4px">Your scan history will appear here</div>
            </div>
        `;
        return;
    }

    container.innerHTML = history.map(item => `
        <div class="pro-list-item fade-in-up">
            <div class="pro-list-icon"><span class="ad-icon-slot" data-ad-icon="${item.verdict === 'ai' ? 'warning' : item.verdict === 'real' ? 'verify' : 'info'}" data-ad-size="16"></span></div>
            <div class="pro-list-content">
                <div class="pro-list-title">${item.verdict === 'ai' ? 'AI Generated' : item.verdict === 'real' ? 'Real Image' : 'Uncertain'}</div>
                <div class="pro-list-subtitle">${item.mode} scan • ${new Date(item.timestamp).toLocaleDateString()}</div>
            </div>
            <div class="history-score ${item.verdict}">${item.aiScore}%</div>
        </div>
    `).join('');

    if (window.IconLibrary) {
        window.IconLibrary.apply(container);
    }
}

// Render badges preview (for profile page) with enhanced design
function renderBadgesPreview() {
    const grid = $('badgesPreview');
    if (!grid) return;

    const unlockedBadges = getStorage('unlocked_badges', []);
    const allBadges = Object.values(BADGES);
    const badgeKeys = allBadges.slice(0, 6);
    const unlockedCount = badgeKeys.filter(b => unlockedBadges.includes(b.id)).length;

    grid.innerHTML = badgeKeys.map(badge => {
        const isUnlocked = unlockedBadges.includes(badge.id);
        const badgeIcon = `<span class="ad-icon-slot" data-ad-icon="${badge.icon}" data-ad-size="18"></span>`;
        const checkIcon = isUnlocked ? `<span class="ad-icon-slot" data-ad-icon="verify" data-ad-size="10"></span>` : '';
        return `
            <div class="badge-item" style="position:relative;transition:transform 0.2s ease"
                 onmouseover="this.style.transform='scale(1.1)'"
                 onmouseout="this.style.transform='scale(1)'">
                <div class="badge-icon ${isUnlocked ? badge.rarity : 'locked'}"
                     style="box-shadow:${isUnlocked ? '0 4px 12px rgba(0,0,0,0.3)' : 'none'};
                             transition:all 0.2s ease">${badgeIcon}</div>
                <div class="badge-name" title="${badge.name}: ${badge.desc}">${badge.name}</div>
                <div style="position:absolute;top:0;right:-4px;width:18px;height:18px;
                           border-radius:50%;background:${isUnlocked ? 'var(--primary)' : 'var(--surface2)'};
                           color:white;display:flex;align-items:center;justify-content:center;
                           font-size:10px;font-weight:700;box-shadow:0 2px 4px rgba(0,0,0,0.2)">
                    ${checkIcon}
                </div>
            </div>
        `;
    }).join('');

    if (window.IconLibrary) {
        window.IconLibrary.apply(grid);
    }

    // Add footer showing progress
    const container = grid.parentElement;
    if (container && !container.querySelector('.badges-footer')) {
        const footer = document.createElement('div');
        footer.className = 'badges-footer';
        footer.style.cssText = 'padding-top:8px;border-top:1px solid var(--border);' +
            'text-align:center;font-size:11px;color:var(--text3);margin-top:8px';
        footer.innerHTML = `${unlockedCount}/${badgeKeys.length} badges earned`;
        container.appendChild(footer);
    }
}

// Render all badges with enhanced design
function renderAllBadges() {
    const container = $('allBadgesContent');
    if (!container) return;

    const unlockedBadges = getStorage('unlocked_badges', []);
    const rarities = ['common', 'rare', 'epic', 'legendary'];

    let html = '';
    rarities.forEach(rarity => {
        const badges = Object.values(BADGES).filter(b => b.rarity === rarity);
        const rarityIcons = {
            common: 'star',
            rare: 'sparkles',
            epic: 'trophy',
            legendary: 'boss'
        };

        html += `
            <div style="margin-bottom:32px">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px">
                    <span class="ad-icon-slot" data-ad-icon="${rarityIcons[rarity]}" data-ad-size="18"></span>
                    <div style="font-size:16px;font-weight:800;text-transform:capitalize;color:var(--text);
                        text-shadow:0 2px 8px rgba(0,0,0,.1)">${rarity} Badges</div>
                    <span style="font-size:12px;color:var(--text3);margin-left:auto">${badges.length} total</span>
                </div>
                <div class="enhanced-badges-grid">
                    ${badges.map(badge => {
                        const isUnlocked = unlockedBadges.includes(badge.id);
                        const badgeIcon = `<span class="ad-icon-slot" data-ad-icon="${badge.icon}" data-ad-size="22"></span>`;
                        const statusIcon = isUnlocked
                            ? `<span class="ad-icon-slot" data-ad-icon="verify" data-ad-size="12"></span>`
                            : `<span class="ad-icon-slot" data-ad-icon="warning" data-ad-size="12"></span>`;
                        return `
                            <div class="badge-card ${isUnlocked ? 'unlocked' : 'locked'}">
                                <div class="badge-tooltip">${badge.name}</div>
                                <div class="badge-status-indicator ${isUnlocked ? '' : 'locked'}">${statusIcon}</div>
                                <div class="badge-card-icon ${isUnlocked ? badge.rarity : 'locked'}">${badgeIcon}</div>
                                <div class="badge-card-title">${badge.name}</div>
                                <div class="badge-card-desc">${badge.desc}</div>
                                <div class="badge-card-points">${badge.points} pts</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
    if (window.IconLibrary) {
        window.IconLibrary.apply(container);
    }
}

// Change profile picture
window.changeProfilePic = function() {
    $('profilePicInput')?.click();
};

window.handleProfilePic = async function(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async (e) => {
        const dataUrl = e.target.result;

        // Update UI with null checks
        const avatar = $('profileAvatar');
        if (avatar) avatar.innerHTML = `<img src="${dataUrl}" style="width:100%;height:100%;object-fit:cover">`;

        const userBtn = $('userBtn');
        if (userBtn) userBtn.innerHTML = `<img src="${dataUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;

        // Save locally
        if (user) {
            user.avatar_url = dataUrl;
            saveUser();
        }

        toast('Profile picture updated!');
    };
    reader.onerror = () => {
        console.error('[Profile] FileReader error reading avatar');
        toast('Failed to upload profile picture. Please try again.');
    };
    reader.readAsDataURL(file);
};

// Toggle login mode
window.toggleLoginMode = function() {
    isLoginMode = !isLoginMode;
    updateLoginUI();
};

// Toggle help sections
window.toggleHelp = function(el) {
    const content = el.nextElementSibling;
    const toggle = el.querySelector('.help-toggle');
    if (content && toggle) {
        content.classList.toggle('show');
        toggle.textContent = content.classList.contains('show') ? '▲' : '▼';
    }
};

// Close public profile modal
window.closePublicProfile = function() {
    $('publicProfileModal')?.classList.remove('show');
};

// Show squad settings
window.showSquadSettings = function() {
    toast('Squad settings coming soon!');
};

// Handle share target (PWA)
function handleShareTarget() {
    const urlParams = new URLSearchParams(window.location.search);
    const sharedUrl = urlParams.get('url') || urlParams.get('text');
    const sharedTitle = urlParams.get('title');

    if (sharedUrl) {
        console.log('[Share Target] Received URL:', sharedUrl);
        toast('Shared content received!');
        // Could auto-fetch image from URL here
    }

    // Clean URL
    if (urlParams.toString()) {
        window.history.replaceState({}, document.title, window.location.pathname);
    }
}

// ==================== INIT TRUTH HUNTERS ====================
async function initTruthHunters() {
    console.log('[TruthHunters] Initializing game...');

    if (user) {
        await loadUserProgression();
        await loadUserBadges();
        await loadActiveOutbreak();
    }
}

// ============================================================
// TRUTH CANNON - PHYSICS GAME ENGINE
// ============================================================

let gameState = {
    running: false,
    wave: 1,
    score: 0,
    combo: 1,
    credibility: 100,
    fakesDestroyed: 0,
    cannonX: 0,
    cannonY: 0,
    isPulling: false,
    pullX: 0,
    pullY: 0,
    truthBomb: null,
    bubbles: [],
    particles: [],
    bubbleSpawnTimer: 0,
    waveTimer: 0,
    lastTime: 0
};

const GAME_CONFIG = {
    GRAVITY: 0.3,
    BOUNCE_DAMPENING: 0.7,
    MAX_PULL: 120,
    BUBBLE_RADIUS: 30,
    BOMB_RADIUS: 12,
    BUBBLE_SPEED_BASE: 0.5,
    BUBBLE_SPAWN_INTERVAL: 2000,
    CREDIBILITY_LOSS_REAL_HIT: 20,
    CREDIBILITY_LOSS_FAKE_REACH_BOTTOM: 10,
    POINTS_PER_FAKE: 100,
    MAX_BUBBLES: 20,           // Cap max bubbles to prevent lag
    MAX_PARTICLES: 100,        // Cap max particles to prevent lag
    MAX_WAVE_SPEED_MULT: 3.0,  // Cap speed multiplier at wave 20+
    MIN_SPAWN_INTERVAL: 500    // Fastest spawn rate (at wave 15+)
};

class TruthBomb {
    constructor(x, y) {
        this.x = x;
        this.y = y;
        this.vx = 0;
        this.vy = 0;
        this.radius = GAME_CONFIG.BOMB_RADIUS;
        this.active = true;
    }

    launch(power, angle) {
        this.vx = Math.cos(angle) * power;
        this.vy = Math.sin(angle) * power;
    }

    update(canvas) {
        if (!this.active) return;

        this.vy += GAME_CONFIG.GRAVITY;
        this.x += this.vx;
        this.y += this.vy;

        // Wall bounces
        if (this.x < this.radius || this.x > canvas.width - this.radius) {
            this.vx *= -GAME_CONFIG.BOUNCE_DAMPENING;
            this.x = Math.max(this.radius, Math.min(canvas.width - this.radius, this.x));
        }

        // Deactivate if off screen
        if (this.y > canvas.height + 50) {
            this.active = false;
        }
    }

    draw(ctx) {
        if (!this.active) return;

        // Glow effect
        const gradient = ctx.createRadialGradient(this.x, this.y, 0, this.x, this.y, this.radius * 2);
        gradient.addColorStop(0, 'rgba(26, 188, 156, 0.8)');
        gradient.addColorStop(1, 'rgba(26, 188, 156, 0)');
        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.radius * 2, 0, Math.PI * 2);
        ctx.fill();

        // Core
        ctx.fillStyle = '#1abc9c';
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
        ctx.fill();

        // Highlight
        ctx.fillStyle = '#6ef4d0';
        ctx.beginPath();
        ctx.arc(this.x - 4, this.y - 4, 4, 0, Math.PI * 2);
        ctx.fill();
    }
}

class Bubble {
    constructor(x, y, isFake) {
        this.x = x;
        this.y = y;
        this.vy = GAME_CONFIG.BUBBLE_SPEED_BASE * (0.8 + Math.random() * 0.4);
        this.radius = GAME_CONFIG.BUBBLE_RADIUS;
        this.isFake = isFake;
        this.active = true;
        this.wobble = Math.random() * Math.PI * 2;
        this.wobbleSpeed = 0.05 + Math.random() * 0.05;
    }

    update(canvas) {
        if (!this.active) return;

        // Speed increases with wave but caps at MAX_WAVE_SPEED_MULT to prevent impossible difficulty
        const speedMultiplier = Math.min(1 + gameState.wave * 0.1, GAME_CONFIG.MAX_WAVE_SPEED_MULT);
        this.y += this.vy * speedMultiplier;
        this.wobble += this.wobbleSpeed;
        this.x += Math.sin(this.wobble) * 0.5;

        // Reached bottom - game over if fake
        if (this.y > canvas.height - this.radius) {
            this.active = false;
            if (this.isFake) {
                loseCredibility(GAME_CONFIG.CREDIBILITY_LOSS_FAKE_REACH_BOTTOM);
            }
        }
    }

    draw(ctx) {
        if (!this.active) return;

        // Glow
        const glowColor = this.isFake ? 'rgba(255, 68, 120, 0.3)' : 'rgba(68, 255, 120, 0.3)';
        const gradient = ctx.createRadialGradient(this.x, this.y, 0, this.x, this.y, this.radius * 1.5);
        gradient.addColorStop(0, glowColor);
        gradient.addColorStop(1, 'rgba(0,0,0,0)');
        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.radius * 1.5, 0, Math.PI * 2);
        ctx.fill();

        // Bubble body
        ctx.fillStyle = this.isFake ? 'rgba(255, 68, 120, 0.6)' : 'rgba(68, 255, 120, 0.6)';
        ctx.strokeStyle = this.isFake ? '#ff4478' : '#44ff78';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
        ctx.fill();
        ctx.stroke();

        // Icon
        ctx.fillStyle = '#fff';
        ctx.font = '24px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(this.isFake ? '🤖' : '📷', this.x, this.y);

        // Glitchy effect for fakes
        if (this.isFake && Math.random() > 0.9) {
            ctx.fillStyle = 'rgba(255, 0, 100, 0.3)';
            ctx.fillRect(this.x - this.radius, this.y - 2, this.radius * 2, 4);
        }
    }
}

class Particle {
    constructor(x, y, color) {
        this.x = x;
        this.y = y;
        this.vx = (Math.random() - 0.5) * 8;
        this.vy = (Math.random() - 0.5) * 8 - 2;
        this.life = 1.0;
        this.color = color;
        this.size = 3 + Math.random() * 5;
    }

    update() {
        this.x += this.vx;
        this.y += this.vy;
        this.vy += 0.2; // Gravity
        this.life -= 0.02;
    }

    draw(ctx) {
        ctx.globalAlpha = this.life;
        ctx.fillStyle = this.color;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fill();
        ctx.globalAlpha = 1;
    }
}

window.startTruthCannon = function() {
    // Login requirement check
    if (!user) {
        showToast('Please log in to play!', 'warning');
        return;
    }

    console.log('[TruthCannon] Starting game...');

    const gameContainer = $('truthCannonGame');
    const canvas = $('gameCanvas');
    const ctx = canvas.getContext('2d');

    // Setup canvas size
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight - 160; // Account for UI

    // Reset game state
    gameState = {
        running: true,
        wave: 1,
        score: 0,
        combo: 1,
        credibility: 100,
        fakesDestroyed: 0,
        cannonX: canvas.width / 2,
        cannonY: canvas.height - 40,
        isPulling: false,
        pullX: canvas.width / 2,
        pullY: canvas.height - 40,
        truthBomb: null,
        bubbles: [],
        particles: [],
        bubbleSpawnTimer: 0,
        waveTimer: 0,
        lastTime: Date.now(),
        enemiesInWave: 0,
        enemiesDestroyed: 0,
        waveActive: false,
        showingWaveAnnouncement: false,
        waveAnnouncementTimer: 0
    };

    // Show game
    gameContainer.style.display = 'flex';
    $('gameOverScreen').style.display = 'none';
    updateGameUI();

    // Touch/Mouse controls
    let touchId = null;

    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const touch = e.changedTouches[0];
        touchId = touch.identifier;
        startPull(touch.clientX, touch.clientY);
    });

    canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        const touch = Array.from(e.changedTouches).find(t => t.identifier === touchId);
        if (touch) updatePull(touch.clientX, touch.clientY);
    });

    canvas.addEventListener('touchend', (e) => {
        e.preventDefault();
        const touch = Array.from(e.changedTouches).find(t => t.identifier === touchId);
        if (touch) {
            releasePull();
            touchId = null;
        }
    });

    canvas.addEventListener('mousedown', (e) => {
        startPull(e.clientX, e.clientY);
    });

    canvas.addEventListener('mousemove', (e) => {
        if (gameState.isPulling) updatePull(e.clientX, e.clientY);
    });

    canvas.addEventListener('mouseup', () => {
        releasePull();
    });

    // Start game loop
    requestAnimationFrame(gameLoop);

    // Enable enhanced wave system
    if (typeof enableEnhancedWaveSystem === 'function') {
        console.log('[TankGame] Activating enhanced wave system...');
        enableEnhancedWaveSystem();
    } else {
        console.warn('[TankGame] Enhanced wave system not loaded');
    }
};

function startPull(clientX, clientY) {
    if (!gameState.running || gameState.truthBomb) return;

    const canvas = $('gameCanvas');
    const rect = canvas.getBoundingClientRect();
    const x = clientX - rect.left;
    const y = clientY - rect.top;

    // Only start pull if near cannon
    const dx = x - gameState.cannonX;
    const dy = y - gameState.cannonY;
    if (Math.sqrt(dx * dx + dy * dy) < 60) {
        gameState.isPulling = true;
        gameState.pullX = x;
        gameState.pullY = y;
    }
}

function updatePull(clientX, clientY) {
    if (!gameState.isPulling) return;

    const canvas = $('gameCanvas');
    const rect = canvas.getBoundingClientRect();
    let x = clientX - rect.left;
    let y = clientY - rect.top;

    // Constrain pull distance
    const dx = gameState.cannonX - x;
    const dy = gameState.cannonY - y;
    const distance = Math.sqrt(dx * dx + dy * dy);

    if (distance > GAME_CONFIG.MAX_PULL) {
        const ratio = GAME_CONFIG.MAX_PULL / distance;
        x = gameState.cannonX - dx * ratio;
        y = gameState.cannonY - dy * ratio;
    }

    gameState.pullX = x;
    gameState.pullY = y;
}

function releasePull() {
    if (!gameState.isPulling || gameState.truthBomb) return;

    gameState.isPulling = false;

    const dx = gameState.cannonX - gameState.pullX;
    const dy = gameState.cannonY - gameState.pullY;
    const distance = Math.sqrt(dx * dx + dy * dy);

    if (distance > 20) {
        const power = Math.min(distance / 8, 15);
        const angle = Math.atan2(dy, dx);

        gameState.truthBomb = new TruthBomb(gameState.cannonX, gameState.cannonY);
        gameState.truthBomb.launch(power, angle);

        // Haptic feedback
        if (navigator.vibrate) navigator.vibrate(50);
    }
}

function gameLoop() {
    if (!gameState.running) return;

    try {
        const canvas = $('gameCanvas');
        if (!canvas) {
            console.error('[TruthCannon] Canvas not found, stopping game');
            gameState.running = false;
            return;
        }

        const ctx = canvas.getContext('2d');
        const now = Date.now();
        const deltaTime = Math.min(now - gameState.lastTime, 100); // Cap deltaTime to prevent huge jumps
        gameState.lastTime = now;

        // Update wave announcement timer
        if (gameState.showingWaveAnnouncement) {
            gameState.waveAnnouncementTimer -= deltaTime;
            if (gameState.waveAnnouncementTimer <= 0) {
                gameState.showingWaveAnnouncement = false;
                gameState.waveActive = true; // Resume spawning after announcement
            }
        }

        // Clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Update game state (skip spawning during announcement)
        if (!gameState.showingWaveAnnouncement) {
            updateBubbles(canvas, deltaTime);
            updateTruthBomb(canvas);
            updateParticles();
            checkCollisions();
        } else {
            // Still update existing entities during announcement
            updateTruthBomb(canvas);
            updateParticles();
            gameState.bubbles.forEach(bubble => {
                if (bubble.update && bubble.update.length > 1) {
                    bubble.update(canvas, gameState);
                } else if (bubble.update) {
                    bubble.update(canvas);
                }
            });
        }

        // Draw everything
        drawBubbles(ctx);
        drawTruthBomb(ctx);
        drawCannon(ctx);
        drawTrajectory(ctx);
        drawParticles(ctx);

        requestAnimationFrame(gameLoop);
    } catch (error) {
        console.error('[TruthCannon] Error in game loop:', error);
        // Try to continue anyway
        requestAnimationFrame(gameLoop);
    }
}

function updateBubbles(canvas, deltaTime) {
    gameState.bubbleSpawnTimer += deltaTime;

    // Use enhanced wave system if available
    if (typeof WAVE_CONFIGS !== 'undefined' && gameState.waveActive) {
        const waveConfig = WAVE_CONFIGS.getWaveConfig(gameState.wave);
        const spawnInterval = waveConfig.spawnInterval;

        if (gameState.bubbleSpawnTimer > spawnInterval && gameState.bubbles.length < GAME_CONFIG.MAX_BUBBLES) {
            gameState.bubbleSpawnTimer = 0;

            const newBubble = spawnEnhancedBubble(canvas, gameState.wave);
            if (newBubble) {
                gameState.bubbles.push(newBubble);
            }
        }
    } else {
        // Fallback to original spawning
        const spawnInterval = Math.max(GAME_CONFIG.MIN_SPAWN_INTERVAL, GAME_CONFIG.BUBBLE_SPAWN_INTERVAL - gameState.wave * 100);
        if (gameState.bubbleSpawnTimer > spawnInterval && gameState.bubbles.length < GAME_CONFIG.MAX_BUBBLES) {
            gameState.bubbleSpawnTimer = 0;

            const x = GAME_CONFIG.BUBBLE_RADIUS + Math.random() * (canvas.width - GAME_CONFIG.BUBBLE_RADIUS * 2);
            const isFake = Math.random() < Math.min(0.7, 0.3 + gameState.wave * 0.05); // More fakes on higher waves, caps at 70%

            gameState.bubbles.push(new Bubble(x, -GAME_CONFIG.BUBBLE_RADIUS, isFake));
        }
    }

    // Update all bubbles (support both original and enhanced)
    gameState.bubbles.forEach(bubble => {
        if (bubble.update.length > 1) {
            bubble.update(canvas, gameState); // Enhanced bubbles
        } else {
            bubble.update(canvas); // Original bubbles
        }
    });

    // Remove inactive bubbles (cleanup for performance)
    gameState.bubbles = gameState.bubbles.filter(b => b.active);
}

function updateTruthBomb(canvas) {
    if (gameState.truthBomb) {
        gameState.truthBomb.update(canvas);
        if (!gameState.truthBomb.active) {
            gameState.truthBomb = null;
        }
    }
}

function updateParticles() {
    gameState.particles.forEach(p => p.update());
    // Remove dead particles AND cap total count for performance
    gameState.particles = gameState.particles.filter(p => p.life > 0);
    if (gameState.particles.length > GAME_CONFIG.MAX_PARTICLES) {
        gameState.particles = gameState.particles.slice(-GAME_CONFIG.MAX_PARTICLES);
    }
}

function checkCollisions() {
    if (!gameState.truthBomb || !gameState.truthBomb.active) return;

    const bomb = gameState.truthBomb;

    for (let i = gameState.bubbles.length - 1; i >= 0; i--) {
        const bubble = gameState.bubbles[i];
        if (!bubble.active) continue;

        const dx = bomb.x - bubble.x;
        const dy = bomb.y - bubble.y;
        const distance = Math.sqrt(dx * dx + dy * dy);

        if (distance < bomb.radius + bubble.radius) {
            // HIT!
            bomb.active = false;

            if (bubble.isFake) {
                // Check if bubble has HP system (enhanced bubble)
                let destroyed = true;
                if (typeof bubble.takeDamage === 'function') {
                    destroyed = bubble.takeDamage(1.0);
                }

                if (destroyed) {
                    bubble.active = false;
                    gameState.fakesDestroyed++;
                    gameState.enemiesDestroyed++; // Track for wave completion

                    gameState.score += GAME_CONFIG.POINTS_PER_FAKE * gameState.combo;
                    gameState.combo = Math.min(gameState.combo + 0.5, 5);
                    createExplosion(bubble.x, bubble.y, bubble.behavior ? bubble.behavior.color : '#ff4478');

                    // Check wave completion
                    if (typeof checkWaveComplete === 'function') {
                        checkWaveComplete();
                    }

                    // Screen shake
                    if (navigator.vibrate) navigator.vibrate([30, 50, 30]);
                } else {
                    // Damaged but not destroyed
                    const hitColor = bubble.behavior ? bubble.behavior.color : '#ff4478';
                    createExplosion(bubble.x, bubble.y, hitColor);
                    if (navigator.vibrate) navigator.vibrate(20);
                }
            } else {
                // Hit a real image - BAD!
                bubble.active = false;
                loseCredibility(GAME_CONFIG.CREDIBILITY_LOSS_REAL_HIT);
                gameState.combo = 1;
                createExplosion(bubble.x, bubble.y, '#44ff78');

                // Sad vibration
                if (navigator.vibrate) navigator.vibrate(100);
            }

            updateGameUI();
            break;
        }
    }
}

function createExplosion(x, y, color) {
    for (let i = 0; i < 20; i++) {
        gameState.particles.push(new Particle(x, y, color));
    }
}

function loseCredibility(amount) {
    gameState.credibility = Math.max(0, gameState.credibility - amount);
    updateGameUI();

    if (gameState.credibility <= 0) {
        gameOver();
    }
}

function updateGameUI() {
    $('gameWave').textContent = gameState.wave;
    $('gameScore').textContent = gameState.score.toLocaleString();
    $('gameCombo').textContent = `x${gameState.combo.toFixed(1)}`;
    $('credibilityPercent').textContent = `${Math.round(gameState.credibility)}%`;
    $('credibilityFill').style.width = `${gameState.credibility}%`;
}

function gameOver() {
    gameState.running = false;

    // Calculate coins earned (with wave bonus)
    const waveBonus = gameState.wave > 1 ? (gameState.wave - 1) * 5 : 0;
    const coinsEarned = Math.floor(gameState.score / 100) + gameState.fakesDestroyed * 2 + waveBonus;

    // Award coins
    if (user && userProgression) {
        userProgression.truth_coins = (userProgression.truth_coins || 0) + coinsEarned;
        saveUserProgression();
        updateCoinsDisplay();
    }

    // Show game over screen
    $('finalWave').textContent = gameState.wave;
    $('finalScore').textContent = gameState.score.toLocaleString();
    $('finalFakes').textContent = gameState.fakesDestroyed;
    $('coinsEarned').textContent = `+${coinsEarned}`;
    $('gameOverScreen').style.display = 'flex';
}

window.closeTruthCannon = function() {
    gameState.running = false;
    $('truthCannonGame').style.display = 'none';
};

window.retryTruthCannon = function() {
    startTruthCannon();
};

// Aliases for UI buttons that use TankShooter naming
window.startTankShooter = window.startTruthCannon;
window.closeTankShooter = window.closeTruthCannon;
window.retryTankShooter = window.retryTruthCannon;

function drawBubbles(ctx) {
    gameState.bubbles.forEach(bubble => bubble.draw(ctx));
}

function drawTruthBomb(ctx) {
    if (gameState.truthBomb) {
        gameState.truthBomb.draw(ctx);
    }
}

function drawCannon(ctx) {
    const x = gameState.cannonX;
    const y = gameState.cannonY;

    // Draw avatar on tank (if available)
    if (typeof getAvatarForTank === 'function') {
        const avatarData = getAvatarForTank();
        if (avatarData && avatarData.headEmoji) {
            ctx.font = '30px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(avatarData.headEmoji, x, y - 40);
        }
    }

    // Cannon base
    ctx.fillStyle = '#2c3e50';
    ctx.beginPath();
    ctx.arc(x, y, 20, 0, Math.PI * 2);
    ctx.fill();

    // Cannon barrel
    ctx.strokeStyle = '#34495e';
    ctx.lineWidth = 12;
    ctx.lineCap = 'round';

    if (gameState.isPulling) {
        const dx = gameState.pullX - x;
        const dy = gameState.pullY - y;
        const angle = Math.atan2(dy, dx);

        ctx.beginPath();
        ctx.moveTo(x, y);
        ctx.lineTo(x + Math.cos(angle) * 30, y + Math.sin(angle) * 30);
        ctx.stroke();
    } else {
        ctx.beginPath();
        ctx.moveTo(x, y);
        ctx.lineTo(x, y - 30);
        ctx.stroke();
    }

    // Cannon glow
    const gradient = ctx.createRadialGradient(x, y, 0, x, y, 30);
    gradient.addColorStop(0, 'rgba(26, 188, 156, 0.3)');
    gradient.addColorStop(1, 'rgba(26, 188, 156, 0)');
    ctx.fillStyle = gradient;
    ctx.beginPath();
    ctx.arc(x, y, 30, 0, Math.PI * 2);
    ctx.fill();
}

function drawTrajectory(ctx) {
    if (!gameState.isPulling) return;

    const dx = gameState.cannonX - gameState.pullX;
    const dy = gameState.cannonY - gameState.pullY;
    const distance = Math.sqrt(dx * dx + dy * dy);

    if (distance < 20) return;

    const power = Math.min(distance / 8, 15);
    const angle = Math.atan2(dy, dx);

    // Simulate trajectory
    let simX = gameState.cannonX;
    let simY = gameState.cannonY;
    let simVx = Math.cos(angle) * power;
    let simVy = Math.sin(angle) * power;

    ctx.strokeStyle = 'rgba(26, 188, 156, 0.5)';
    ctx.lineWidth = 2;
    ctx.setLineDash([5, 5]);
    ctx.beginPath();
    ctx.moveTo(simX, simY);

    for (let i = 0; i < 50; i++) {
        simVy += GAME_CONFIG.GRAVITY;
        simX += simVx;
        simY += simVy;

        if (simY > gameState.cannonY) break;

        ctx.lineTo(simX, simY);
    }

    ctx.stroke();
    ctx.setLineDash([]);
}

function drawParticles(ctx) {
    gameState.particles.forEach(p => p.draw(ctx));
}

init();
</script>

<!-- VERA is now handled by vera-controller.js -->

<script>
// Legacy VERA function stubs for backward compatibility
// New VERA is handled by vera-controller.js with layered sprite animation
window.openHelp = window.openHelp || function() {
    // Will be overridden by main app or vera-controller
    console.log('[VERA] Help requested');
};
// Old VERA code completely removed - now handled by vera-controller.js
// The new layered sprite animation system provides:
// - Fairy state with body/wings/hair layers
// - Monster transformation with dramatic effects
// - Particle system (canvas + CSS fallback)
// - Sound effects for interactions
// - Click tracking for anger escalation
// - Idle timer for auto-transformation
//
// See vera-controller.js and vera-controller.css for implementation
// Old VERA JavaScript completely removed
// All functionality is now provided by vera-controller.js

</script>
</body>
</html>
