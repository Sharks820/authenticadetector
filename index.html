<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="theme-color" content="#0a0d14">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AuthenticaDetector">
    <meta name="description" content="AuthenticaDetector - Advanced AI Image Detection. Detect AI-generated images with 90%+ accuracy.">
    <meta property="og:title" content="AuthenticaDetector - AI Image Detection">
    <meta property="og:description" content="Detect AI-generated images instantly. Free to use.">
    <meta property="og:image" content="icon-512.png">
    <title>AuthenticaDetector - AI Image Detection</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-180.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        
        /* RESET & VARIABLES - MODERN VIBRANT THEME */
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        :root{
            /* Modern dark background with depth */
            --bg:#0a0d14;
            --bg-gradient:linear-gradient(135deg, #0a0d14 0%, #1a1525 100%);
            --surface:#12161f;
            --surface2:#1a1f2e;
            --surface3:#242b3d;
            --surface-glass:rgba(18, 22, 31, 0.8);

            /* Vibrant primary colors */
            --primary:#00d4aa;
            --primary-bright:#00ffcc;
            --primary-dim:#009977;
            --primary-glow:rgba(0, 212, 170, 0.35);
            --primary-gradient:linear-gradient(135deg, #00d4aa 0%, #00ff88 100%);

            /* Purple accent for premium feel */
            --secondary:#6366f1;
            --secondary-bright:#8b5cf6;
            --secondary-glow:rgba(99, 102, 241, 0.3);
            --purple:#d946ef;

            /* Status colors */
            --danger:#ff4757;
            --danger-glow:rgba(255, 71, 87, 0.3);
            --warning:#ffa502;
            --success:#2ed573;
            --success-glow:rgba(46, 213, 115, 0.3);

            /* Leaderboard tiers with vibrant colors */
            --gold:#ffd700;
            --gold-glow:rgba(255, 215, 0, 0.4);
            --silver:#e8e8e8;
            --silver-glow:rgba(232, 232, 232, 0.3);
            --bronze:#cd7f32;
            --bronze-glow:rgba(205, 127, 50, 0.3);
            --diamond:#b9f2ff;
            --platinum:#e5e4e2;

            /* Text hierarchy */
            --text:#ffffff;
            --text2:#b4bcd0;
            --text3:#6b7280;
            --text-muted:#9ca3af;

            /* Borders and shadows */
            --border:rgba(255,255,255,0.1);
            --border-bright:rgba(255,255,255,0.2);
            --shadow:0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --shadow-lg:0 10px 15px -3px rgba(0, 0, 0, 0.4);
            --shadow-glow:0 0 20px rgba(0, 212, 170, 0.2);

            /* Safe areas */
            --safe-top:env(safe-area-inset-top,0px);
            --safe-bottom:env(safe-area-inset-bottom,0px);
        }

        /* Glassmorphism effect for cards */
        .glass {
            background: var(--surface-glass);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-bright);
            box-shadow: var(--shadow-glow);
        }
        
        /* BASE - CRITICAL RESPONSIVE FIX */
        html{height:100%;overflow:hidden}
        body{
            min-height:100%;height:100%;
            font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;
            background:var(--bg);color:var(--text);
            overflow:hidden;
            display:flex;flex-direction:column;
        }
        
        /* VIEWS - SCROLLABLE */
        .view{
            position:fixed;inset:0;
            background:var(--bg);
            display:none;flex-direction:column;
            z-index:10;
            overflow:hidden;
        }
        .view.active{display:flex}
        
        .view-header{
            flex-shrink:0;
            display:flex;align-items:center;justify-content:space-between;
            padding:12px 16px;
            padding-top:calc(12px + var(--safe-top));
            background:var(--surface);
            border-bottom:1px solid var(--border);
            min-height:56px;
        }
        .view-title{font-size:18px;font-weight:700}
        .view-close{
            width:44px;height:44px;border-radius:50%;
            background:var(--surface2);border:none;
            color:var(--text);font-size:22px;
            cursor:pointer;display:flex;align-items:center;justify-content:center;
        }
        
        /* SCROLLABLE VIEW BODY - KEY FIX */
        .view-body{
            flex:1 1 auto;
            overflow-y:auto;
            overflow-x:hidden;
            -webkit-overflow-scrolling:touch;
            overscroll-behavior:contain;
        }
        .view-body-padded{
            padding:16px;
            padding-bottom:calc(100px + var(--safe-bottom));
        }
        
        /* HOME VIEW - SCROLLABLE */
        #homeView{display:flex;flex-direction:column}
        #homeView .home-content{
            flex:1 1 auto;
            overflow-y:auto;
            overflow-x:hidden;
            -webkit-overflow-scrolling:touch;
            padding-bottom:calc(20px + var(--safe-bottom));
        }
        
        /* HOME HEADER */
        .home-header{
            flex-shrink:0;
            display:flex;align-items:center;justify-content:space-between;
            padding:10px 16px;
            padding-top:calc(10px + var(--safe-top));
            background:var(--surface);
            min-height:60px;
        }
        .logo{display:flex;align-items:center;gap:8px}
        .logo-icon{width:32px;height:32px}
        .logo-text{
            font-size:16px;font-weight:800;
            background:linear-gradient(135deg,var(--primary),#00ff88);
            -webkit-background-clip:text;-webkit-text-fill-color:transparent;
            background-clip:text;
        }
        .header-btns{display:flex;gap:6px}
        .icon-btn{
            width:38px;height:38px;border-radius:10px;
            background:var(--surface2);border:none;
            color:var(--text2);font-size:16px;
            cursor:pointer;display:flex;align-items:center;justify-content:center;
        }
        .user-btn{
            width:38px;height:38px;border-radius:50%;
            background:linear-gradient(135deg,var(--primary),#00ff88);
            border:2px solid var(--surface);color:#000;
            font-size:13px;font-weight:800;cursor:pointer;
            overflow:hidden;display:flex;align-items:center;justify-content:center;
        }
        .user-btn img{width:100%;height:100%;object-fit:cover}
        
        /* STATUS BAR - ALWAYS VISIBLE UNTIL COMPLETE */
        .status-bar{
            flex-shrink:0;
            padding:8px 16px;background:var(--surface2);
            display:flex;gap:6px;flex-wrap:wrap;
        }
        .status-chip{
            display:flex;align-items:center;gap:5px;
            padding:5px 10px;border-radius:16px;
            font-size:11px;font-weight:600;
            cursor:pointer;border:none;font-family:inherit;
        }
        .status-chip.pending{background:rgba(255,165,2,.15);color:var(--warning)}
        .status-chip.complete{background:rgba(46,213,115,.15);color:var(--success)}
        .status-chip.signup{background:rgba(99,102,241,.15);color:var(--secondary)}
        
        /* INSTALL BANNER */
        .install-banner{
            display:none;padding:12px 16px;
            background:linear-gradient(135deg,var(--secondary),#8b5cf6);
            align-items:center;gap:10px;
        }
        .install-banner.show{display:flex}
        .install-banner-icon{font-size:24px}
        .install-banner-text{flex:1}
        .install-banner-text strong{display:block;font-size:13px;margin-bottom:1px}
        .install-banner-text span{font-size:11px;opacity:.9}
        .install-banner-btn{
            padding:8px 14px;background:#fff;color:var(--secondary);
            border:none;border-radius:8px;font-weight:700;font-size:12px;cursor:pointer;
        }
        
        /* iOS HELPER */
        .ios-helper{
            display:none;margin:10px 16px;padding:14px;
            background:var(--surface);border:2px solid var(--primary);border-radius:14px;
        }
        .ios-helper.show{display:block}
        .ios-helper-title{font-size:14px;font-weight:700;margin-bottom:10px}
        .ios-steps{display:flex;flex-direction:column;gap:8px}
        .ios-step{display:flex;align-items:center;gap:10px;font-size:12px;color:var(--text2)}
        .ios-step-num{
            width:22px;height:22px;background:var(--primary);border-radius:50%;
            display:flex;align-items:center;justify-content:center;
            font-size:11px;font-weight:700;color:#000;flex-shrink:0;
        }
        .ios-dismiss{
            background:var(--surface2);border:none;color:var(--text2);
            font-size:12px;cursor:pointer;margin-top:10px;padding:8px;border-radius:8px;width:100%;
        }
        
        /* FACTS PANEL */
        .facts-panel{
            margin:10px 16px;padding:12px 14px;
            background:var(--surface);border-radius:12px;
            border-left:3px solid var(--primary);
        }
        .facts-header{
            display:flex;align-items:center;gap:6px;
            margin-bottom:6px;font-size:10px;color:var(--text3);
            text-transform:uppercase;letter-spacing:.5px;
        }
        .facts-content{
            font-size:12px;color:var(--text2);line-height:1.4;
            display:flex;align-items:flex-start;gap:8px;
        }
        .facts-icon{font-size:18px;flex-shrink:0}
        
        /* UPLOAD SECTION */
        .upload-section{padding:12px 16px}
        .upload-hero{text-align:center;margin-bottom:12px}
        .upload-hero h1{font-size:20px;font-weight:900;margin-bottom:4px}
        .upload-hero p{color:var(--text2);font-size:12px}
        
        /* DROPZONE */
        .dropzone{
            background:var(--surface);border:2px dashed var(--border);
            border-radius:16px;padding:24px 16px;text-align:center;
            cursor:pointer;transition:all .2s;margin-bottom:12px;
        }
        .dropzone:active,.dropzone.dragover{
            border-color:var(--primary);background:rgba(0,212,170,.08);
        }
        .dropzone.has-file{border-color:var(--success);border-style:solid}
        .dropzone-preview{max-width:100%;max-height:150px;border-radius:10px;object-fit:contain}
        .dropzone-content{display:flex;flex-direction:column;align-items:center;gap:8px}
        .dropzone-icon{width:60px;height:60px}
        .dropzone h3{font-size:14px;font-weight:700}
        .dropzone p{font-size:11px;color:var(--text3)}
        .file-types{display:flex;gap:4px;flex-wrap:wrap;justify-content:center;margin-top:3px}
        .file-type{padding:3px 6px;background:var(--surface2);border-radius:4px;font-size:9px;color:var(--text3)}
        .file-input{display:none}
        
        /* SCAN SECTION - FIXED AT BOTTOM */
        .scan-section{
            flex-shrink:0;
            padding:12px 16px;
            padding-bottom:calc(12px + var(--safe-bottom));
            background:var(--bg);
        }
        .scan-btns{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px}
        .scan-btn{
            padding:14px 12px;border-radius:12px;border:none;
            font-family:inherit;cursor:pointer;text-align:left;position:relative;
        }
        .scan-btn:disabled{opacity:.5;cursor:not-allowed}
        .quick-btn{background:var(--surface2);color:var(--text)}
        .deep-btn{background:linear-gradient(135deg,var(--primary),#00ff88);color:#000}
        .scan-btn-title{font-size:13px;font-weight:700;display:flex;align-items:center;gap:5px}
        .scan-btn-desc{font-size:9px;opacity:.7;margin-top:2px}
        .scan-lock{position:absolute;top:6px;right:6px;font-size:12px}
        
        /* ADVANCED PANEL */
        .advanced-panel{
            background:var(--surface);border-radius:12px;
            margin-bottom:8px;overflow:hidden;
        }
        .advanced-header{
            display:flex;align-items:center;justify-content:space-between;
            padding:10px 12px;cursor:pointer;
        }
        .advanced-header span:first-child{font-size:11px;font-weight:600}
        .advanced-toggle{font-size:9px;color:var(--text3)}
        .advanced-content{padding:0 12px 12px;display:none}
        .advanced-content.show{display:block}
        .advanced-row{
            display:flex;align-items:center;justify-content:space-between;
            padding:8px 0;border-top:1px solid var(--border);
        }
        .advanced-label{display:flex;align-items:center;gap:8px}
        .advanced-icon{font-size:16px}
        .advanced-name{font-size:11px;font-weight:600}
        .advanced-desc{font-size:9px;color:var(--text3)}
        .toggle-switch{position:relative;width:40px;height:22px}
        .toggle-switch input{opacity:0;width:0;height:0}
        .toggle-slider{
            position:absolute;cursor:pointer;inset:0;
            background:var(--surface2);border-radius:11px;transition:.3s;
        }
        .toggle-slider:before{
            content:'';position:absolute;height:16px;width:16px;
            left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.3s;
        }
        .toggle-switch input:checked + .toggle-slider{background:var(--primary)}
        .toggle-switch input:checked + .toggle-slider:before{transform:translateX(18px)}
        
        /* PROGRESS CARD */
        .progress-card{
            background:var(--surface);border-radius:14px;
            padding:14px;margin:10px 16px;
        }
        .progress-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
        .progress-title{font-size:12px;font-weight:700}
        .progress-cancel{
            background:var(--surface2);border:none;color:var(--text2);
            padding:6px 10px;border-radius:6px;font-size:10px;cursor:pointer;
        }
        .progress-bar-wrap{height:5px;background:var(--surface2);border-radius:3px;overflow:hidden;margin-bottom:8px}
        .progress-bar{height:100%;background:linear-gradient(90deg,var(--primary),#00ff88);border-radius:3px;transition:width .3s}
        .progress-status{font-size:11px;color:var(--text2);text-align:center}
        .progress-fact{
            margin-top:12px;padding:10px;background:var(--surface2);
            border-radius:8px;display:flex;gap:8px;
        }
        .progress-fact-icon{font-size:18px}
        .progress-fact-text{font-size:10px;color:var(--text2);line-height:1.4}
        
        /* RESULT CARD */
        .result-card{
            background:var(--surface);border-radius:16px;
            padding:16px;margin:10px 16px;position:relative;overflow:hidden;
        }
        .result-glow{
            position:absolute;top:-50%;left:-50%;width:200%;height:200%;
            opacity:.12;pointer-events:none;
        }
        .result-header{
            display:flex;align-items:flex-start;gap:12px;
            margin-bottom:12px;position:relative;z-index:1;
        }
        .result-icon{
            width:50px;height:50px;border-radius:12px;
            display:flex;align-items:center;justify-content:center;font-size:24px;
        }
        .result-icon.fake{background:linear-gradient(135deg,var(--danger),#ff6b7a)}
        .result-icon.real{background:linear-gradient(135deg,var(--success),#7bed9f)}
        .result-icon.uncertain{background:linear-gradient(135deg,var(--warning),#ffc048)}
        .result-info{flex:1}
        .result-label{font-size:16px;font-weight:800;margin-bottom:2px}
        .result-sublabel{font-size:11px;color:var(--text2)}
        
        .confidence-badge{
            display:inline-flex;align-items:center;gap:4px;
            padding:4px 8px;border-radius:12px;font-size:10px;font-weight:700;margin-bottom:8px;
        }
        .confidence-high{background:rgba(46,213,115,.15);color:var(--success)}
        .confidence-medium{background:rgba(255,165,2,.15);color:var(--warning)}
        .confidence-low{background:rgba(255,71,87,.15);color:var(--danger)}
        
        .result-score{margin-bottom:12px}
        .score-bar{height:8px;background:var(--surface2);border-radius:4px;overflow:hidden}
        .score-fill{height:100%;border-radius:4px;transition:width .5s}
        .score-fill.fake{background:linear-gradient(90deg,var(--danger),#ff6b7a)}
        .score-fill.real{background:linear-gradient(90deg,var(--success),#7bed9f)}
        .score-fill.uncertain{background:linear-gradient(90deg,var(--warning),#ffc048)}
        .score-labels{display:flex;justify-content:space-between;margin-top:4px;font-size:9px;color:var(--text3)}
        .score-value{text-align:center;font-size:13px;font-weight:700;margin-top:6px}
        
        /* EXPLAINERS */
        .explainers{background:var(--surface2);border-radius:10px;padding:10px;margin-bottom:12px}
        .explainers-header{display:flex;align-items:center;justify-content:space-between;cursor:pointer}
        .explainers-title{font-size:11px;font-weight:700}
        .explainers-toggle{font-size:9px;color:var(--text3)}
        .explainers-content{margin-top:8px;display:none}
        .explainers-content.show{display:block}
        .explainer-item{
            display:flex;align-items:flex-start;gap:6px;
            padding:6px 0;border-top:1px solid var(--border);
        }
        .explainer-item:first-child{border-top:none;padding-top:0}
        .explainer-icon{font-size:12px}
        .explainer-text{font-size:10px;color:var(--text2);line-height:1.4}

        /* NEW EXPLAINABILITY MODULES */
        .explainer-section{margin-top:8px}
        .explainer-section-title{font-size:11px;font-weight:700;color:var(--text);margin-bottom:8px}

        .module-card{
            background:var(--surface2);border-radius:10px;padding:12px;margin-bottom:8px;
            border:1px solid var(--border);
        }
        .module-card.ai-indicator{border-color:rgba(255,71,87,0.3);background:linear-gradient(135deg, var(--surface2) 0%, rgba(255,71,87,0.05) 100%)}
        .module-card.real-indicator{border-color:rgba(46,213,115,0.3);background:linear-gradient(135deg, var(--surface2) 0%, rgba(46,213,115,0.05) 100%)}

        .module-header{display:flex;align-items:center;gap:6px;margin-bottom:6px}
        .module-icon{font-size:14px}
        .module-name{font-size:11px;font-weight:700;flex:1;color:var(--text)}
        .module-confidence{font-size:10px;font-weight:600;padding:2px 6px;border-radius:4px;background:var(--card)}

        .module-reason{font-size:10px;color:var(--text2);line-height:1.4;margin-bottom:6px}

        .module-technical{
            font-size:9px;color:var(--text3);background:var(--card);
            padding:4px 6px;border-radius:4px;margin-bottom:6px;
            font-family:'Courier New',monospace;
        }
        .tech-label{font-weight:700}

        .module-meter{
            height:4px;background:var(--card);border-radius:2px;overflow:hidden;margin-bottom:4px;
        }
        .module-meter-fill{height:100%;transition:width 0.3s ease;border-radius:2px}

        .module-score{font-size:9px;color:var(--text3);text-align:right}

        /* COMPACT MODULE CARDS */
        .module-card-compact{
            background:var(--card);border-radius:8px;padding:8px;margin-bottom:6px;
        }
        .module-compact-header{display:flex;align-items:center;gap:6px;margin-bottom:4px}
        .module-compact-score{font-size:10px;font-weight:600;margin-left:auto}
        .module-compact-meter{height:3px;background:var(--surface2);border-radius:2px;overflow:hidden}
        .module-compact-meter-fill{height:100%;transition:width 0.3s ease;border-radius:2px}

        /* DETECTION SUMMARY */
        .detection-summary{
            background:var(--card);border-radius:8px;padding:10px;margin-top:12px;
            border:1px dashed var(--border);
        }
        .summary-stat{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
        .summary-stat:last-child{margin-bottom:0}
        .summary-label{font-size:10px;color:var(--text2);font-weight:600}
        .summary-value{font-size:10px;color:var(--primary);font-weight:700}
        
        /* FEEDBACK */
        .feedback-section{background:var(--surface2);border-radius:10px;padding:12px;margin-bottom:12px}
        .feedback-title{font-size:11px;font-weight:700;margin-bottom:8px}
        .feedback-btns{display:flex;gap:6px}
        .feedback-btn{
            flex:1;padding:8px;border:2px solid var(--border);border-radius:8px;
            background:transparent;color:var(--text2);font-size:11px;font-weight:600;
            cursor:pointer;font-family:inherit;
        }
        .feedback-btn:hover{border-color:var(--primary)}
        .feedback-btn.selected{border-color:var(--primary);background:var(--primary-glow);color:var(--text)}
        
        .result-actions{display:grid;grid-template-columns:1fr 1fr;gap:6px}
        .result-action{
            padding:10px;border-radius:8px;border:none;font-family:inherit;
            font-size:11px;font-weight:600;cursor:pointer;
            display:flex;align-items:center;justify-content:center;gap:5px;
        }
        .action-share{background:var(--primary);color:#000}
        .action-new{background:var(--surface2);color:var(--text)}
        
        /* TOAST */
        .toast-container{
            position:fixed;bottom:80px;left:50%;transform:translateX(-50%);
            z-index:9999;display:flex;flex-direction:column;gap:6px;pointer-events:none;
        }
        .toast{
            background:var(--surface2);color:var(--text);padding:10px 16px;
            border-radius:8px;font-size:12px;box-shadow:0 4px 20px rgba(0,0,0,.3);
            animation:toast-in .3s;pointer-events:auto;
        }
        @keyframes toast-in{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        
        /* PROFILE */
        .profile-header{
            background:var(--surface2);border-radius:16px;padding:18px;
            margin-bottom:12px;text-align:center;
        }
        .profile-avatar{
            width:64px;height:64px;border-radius:50%;
            background:linear-gradient(135deg,var(--primary),#00ff88);
            margin:0 auto 12px;display:flex;align-items:center;justify-content:center;
            font-size:24px;font-weight:800;color:#000;cursor:pointer;overflow:hidden;
        }
        .profile-avatar img{width:100%;height:100%;object-fit:cover}
        .profile-name{font-size:16px;font-weight:800;margin-bottom:2px}
        .profile-email{font-size:11px;color:var(--text3)}
        
        .stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px}
        .stat-card{background:var(--surface);border-radius:12px;padding:12px;text-align:center}
        .stat-value{
            font-size:20px;font-weight:800;
            background:linear-gradient(135deg,var(--primary),#00ff88);
            -webkit-background-clip:text;-webkit-text-fill-color:transparent;
        }
        .stat-label{font-size:9px;color:var(--text3);margin-top:2px}
        
        /* BADGES - PREMIUM DESIGN */
        .badges-preview{background:var(--surface);border-radius:12px;padding:12px;margin-bottom:12px}
        .badges-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
        .badges-title{font-size:12px;font-weight:700}
        .badges-see-all{font-size:10px;color:var(--primary);background:none;border:none;cursor:pointer}
        .badges-grid{display:flex;gap:6px;overflow-x:auto;padding-bottom:4px}
        .badge-item{flex-shrink:0;width:52px;text-align:center}
        .badge-icon{
            width:44px;height:44px;border-radius:10px;
            display:flex;align-items:center;justify-content:center;
            font-size:18px;margin:0 auto 3px;position:relative;
        }
        .badge-icon.common{background:linear-gradient(135deg,#4a5568,#718096);box-shadow:0 2px 6px rgba(74,85,104,.3)}
        .badge-icon.rare{background:linear-gradient(135deg,#3182ce,#63b3ed);box-shadow:0 2px 6px rgba(49,130,206,.3)}
        .badge-icon.epic{background:linear-gradient(135deg,#805ad5,#b794f4);box-shadow:0 2px 6px rgba(128,90,213,.3)}
        .badge-icon.legendary{
            background:linear-gradient(135deg,#d69e2e,#f6e05e);
            box-shadow:0 2px 10px rgba(214,158,46,.4);
            animation:badge-glow 2s ease-in-out infinite;
        }
        @keyframes badge-glow{0%,100%{box-shadow:0 2px 10px rgba(214,158,46,.4)}50%{box-shadow:0 2px 20px rgba(214,158,46,.6)}}
        .badge-icon.locked{background:var(--surface2);opacity:.4}
        .badge-name{font-size:8px;color:var(--text3)}
        
        .menu{background:var(--surface);border-radius:12px;overflow:hidden}
        .menu-item{
            display:flex;align-items:center;gap:10px;padding:12px;
            border-bottom:1px solid var(--border);cursor:pointer;
            background:none;border-left:none;border-right:none;border-top:none;
            width:100%;text-align:left;color:var(--text);font-family:inherit;font-size:12px;
        }
        .menu-item:last-child{border-bottom:none}
        .menu-icon{font-size:16px;width:22px;text-align:center}
        .menu-text{flex:1}
        .menu-arrow{color:var(--text3)}
        
        /* HISTORY */
        .history-item{
            display:flex;align-items:center;gap:10px;padding:10px;
            background:var(--surface);border-radius:10px;margin-bottom:6px;
        }
        .history-thumb{
            width:42px;height:42px;border-radius:6px;background:var(--surface2);
            display:flex;align-items:center;justify-content:center;font-size:18px;
        }
        .history-info{flex:1}
        .history-result{font-size:12px;font-weight:700}
        .history-meta{font-size:10px;color:var(--text3)}
        .history-score{font-size:12px;font-weight:700;padding:4px 8px;border-radius:5px}
        .history-score.fake{background:rgba(255,71,87,.15);color:var(--danger)}
        .history-score.real{background:rgba(46,213,115,.15);color:var(--success)}
        .history-empty{text-align:center;padding:40px 16px;color:var(--text3)}
        
        /* LEADERBOARD - EPIC TIERS */
        .podium{display:flex;justify-content:center;gap:8px;margin-bottom:14px;padding:12px}
        .podium-item{text-align:center;flex:1;max-width:90px}
        .podium-item.first{order:2;margin-top:-8px}
        .podium-item.second{order:1}
        .podium-item.third{order:3}
        .podium-avatar{
            width:50px;height:50px;border-radius:50%;margin:0 auto 6px;
            display:flex;align-items:center;justify-content:center;
            font-size:18px;font-weight:800;overflow:hidden;position:relative;
        }
        .podium-item.first .podium-avatar{
            width:60px;height:60px;font-size:22px;
            background:linear-gradient(135deg,#ffd700,#ffed4a);
            border:3px solid #ffd700;box-shadow:0 0 20px rgba(255,215,0,.5);
        }
        .podium-item.second .podium-avatar{
            background:linear-gradient(135deg,#c0c0c0,#e8e8e8);border:3px solid #c0c0c0;
        }
        .podium-item.third .podium-avatar{
            background:linear-gradient(135deg,#cd7f32,#daa520);border:3px solid #cd7f32;
        }
        .podium-avatar img{width:100%;height:100%;object-fit:cover}
        .podium-crown{position:absolute;top:-10px;font-size:14px}
        .podium-item.first .podium-crown{font-size:18px;top:-12px}
        .podium-name{font-size:10px;font-weight:700}
        .podium-item.first .podium-name{color:var(--gold)}
        .podium-points{font-size:9px;color:var(--text3)}
        .podium-tier{
            font-size:8px;text-transform:uppercase;margin-top:3px;font-weight:800;
            padding:2px 6px;border-radius:4px;display:inline-block;
        }
        .tier-king{background:linear-gradient(135deg,#ffd700,#ff8c00);color:#000}
        .tier-viceroy{background:linear-gradient(135deg,#c0c0c0,#808080);color:#000}
        .tier-archduke{background:linear-gradient(135deg,#cd7f32,#8b4513);color:#fff}
        .tier-legend{background:linear-gradient(135deg,#9b59b6,#8e44ad);color:#fff}
        .tier-elite{background:linear-gradient(135deg,#3498db,#2980b9);color:#fff}
        .tier-veteran{background:linear-gradient(135deg,#27ae60,#1e8449);color:#fff}
        .tier-rising{background:linear-gradient(135deg,#7f8c8d,#95a5a6);color:#fff}
        
        .lb-item{
            display:flex;align-items:center;gap:10px;padding:10px;
            background:var(--surface);border-radius:10px;margin-bottom:6px;cursor:pointer;
        }
        .lb-rank{
            width:28px;height:28px;border-radius:6px;
            display:flex;align-items:center;justify-content:center;
            font-size:11px;font-weight:800;
        }
        .lb-rank.top10{background:linear-gradient(135deg,var(--primary),#00ff88);color:#000}
        .lb-rank.normal{background:var(--surface2);color:var(--text2)}
        .lb-avatar{
            width:36px;height:36px;border-radius:50%;
            background:linear-gradient(135deg,var(--primary),#00ff88);
            display:flex;align-items:center;justify-content:center;
            font-size:12px;font-weight:800;color:#000;overflow:hidden;
        }
        .lb-avatar img{width:100%;height:100%;object-fit:cover}
        .lb-info{flex:1}
        .lb-name{font-size:12px;font-weight:700}
        .lb-stats{font-size:10px;color:var(--text3)}
        .lb-points{font-size:14px;font-weight:800;color:var(--primary)}
        .lb-tier{margin-left:6px}
        
        /* REWARDS SECTION */
        .rewards-card{
            background:linear-gradient(135deg,var(--surface2),var(--surface3));
            border:2px solid var(--gold);border-radius:14px;padding:14px;margin-bottom:12px;
        }
        .rewards-title{font-size:14px;font-weight:800;color:var(--gold);margin-bottom:8px;display:flex;align-items:center;gap:6px}
        .rewards-list{display:flex;flex-direction:column;gap:6px}
        .reward-item{
            display:flex;align-items:center;gap:8px;padding:8px;
            background:var(--surface);border-radius:8px;font-size:11px;
        }
        .reward-icon{font-size:18px}
        .reward-text{flex:1}
        .reward-tier{font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px}
        
        /* LOGIN */
        .login-content{padding:16px;max-width:360px;margin:0 auto}
        .login-hero{text-align:center;margin-bottom:24px}
        .login-hero .logo-icon{width:56px;height:56px;margin:0 auto 14px}
        .login-hero h2{font-size:20px;font-weight:800;margin-bottom:4px}
        .login-hero p{color:var(--text2);font-size:12px}
        .login-form{display:flex;flex-direction:column;gap:12px}
        .input-group{display:flex;flex-direction:column;gap:4px}
        .input-group label{font-size:11px;font-weight:600;color:var(--text2)}
        .input-group input{
            padding:11px 12px;background:var(--surface);border:2px solid var(--border);
            border-radius:8px;color:var(--text);font-size:13px;font-family:inherit;
        }
        .input-group input:focus{outline:none;border-color:var(--primary)}
        .login-submit{
            padding:12px;background:linear-gradient(135deg,var(--primary),#00ff88);
            border:none;border-radius:10px;color:#000;font-size:14px;font-weight:800;
            cursor:pointer;font-family:inherit;
        }
        .login-submit:disabled{opacity:.5}
        .login-forgot{text-align:right;margin-top:8px;margin-bottom:16px}
        .login-forgot a{color:var(--primary);font-size:11px;cursor:pointer;text-decoration:none}
        .login-forgot a:hover{text-decoration:underline}
        .login-toggle{text-align:center;font-size:11px;color:var(--text3);margin-top:12px}
        .login-toggle a{color:var(--primary);cursor:pointer}
        .login-guest{
            width:100%;padding:10px;background:var(--surface2);border:none;border-radius:8px;
            color:var(--text2);font-size:12px;font-weight:600;cursor:pointer;margin-top:8px;
        }
        .login-error{
            background:rgba(255,71,87,.1);border:1px solid var(--danger);color:var(--danger);
            padding:8px;border-radius:6px;font-size:11px;text-align:center;display:none;margin-bottom:12px;
        }
        .login-error.show{display:block}
        
        /* MODALS */
        .modal-overlay{
            position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;
            display:none;align-items:center;justify-content:center;padding:16px;
        }
        .modal-overlay.show{display:flex}
        .modal{
            background:var(--surface);border-radius:16px;padding:18px;
            max-width:320px;width:100%;max-height:80vh;overflow-y:auto;position:relative;
        }
        .modal-close{
            position:absolute;top:10px;right:10px;background:var(--surface2);border:none;
            color:var(--text);width:26px;height:26px;border-radius:50%;cursor:pointer;font-size:14px;
        }
        
        /* HELP */
        .help-section{background:var(--surface);border-radius:12px;margin-bottom:10px;overflow:hidden}
        .help-header{display:flex;align-items:center;justify-content:space-between;padding:12px;cursor:pointer}
        .help-title{font-size:13px;font-weight:700}
        .help-toggle{color:var(--text3);font-size:9px}
        .help-content{padding:0 12px 12px;display:none}
        .help-content.show{display:block}
        .help-text{font-size:11px;color:var(--text2);line-height:1.5}
        .help-text p{margin-bottom:8px}
        .help-text ul{margin-left:16px;margin-bottom:8px}
        .help-text li{margin-bottom:3px}
        
        .hidden{display:none!important}

        /* ==================== SHOP & GAME MECHANICS ==================== */
        .shop-categories{display:flex;gap:8px;padding:12px;overflow-x:auto;border-bottom:1px solid var(--border)}
        .shop-cat-btn{padding:8px 16px;border:none;background:var(--surface2);color:var(--text2);border-radius:20px;cursor:pointer;white-space:nowrap;font-size:13px;font-weight:600;transition:all .2s}
        .shop-cat-btn.active{background:var(--primary-gradient);color:#fff}
        .shop-cat-btn:hover{transform:scale(1.05)}
        .shop-grid,.inventory-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;padding:12px}
        .shop-item{background:var(--surface2);border-radius:12px;padding:12px;cursor:pointer;transition:all .2s;border:2px solid transparent;position:relative}
        .shop-item:hover{transform:translateY(-4px);border-color:var(--primary);box-shadow:var(--shadow-glow)}
        .shop-item.owned{opacity:0.6;border-color:var(--success)}
        .shop-item-icon{font-size:32px;text-align:center;margin-bottom:8px}
        .shop-item-name{font-size:13px;font-weight:600;color:var(--text);margin-bottom:4px}
        .shop-item-desc{font-size:10px;color:var(--text3);margin-bottom:8px;line-height:1.3}
        .shop-item-price{display:flex;align-items:center;justify-content:center;gap:4px;padding:6px;background:var(--surface3);border-radius:6px;font-weight:700;color:var(--primary)}
        .shop-item-owned{position:absolute;top:8px;right:8px;background:var(--success);color:#fff;padding:2px 6px;border-radius:4px;font-size:9px;font-weight:700}
        .user-points-badge{background:var(--primary-gradient);color:#fff;padding:6px 12px;border-radius:20px;font-size:12px;font-weight:700}
        .section-title{font-size:14px;font-weight:700;color:var(--text);padding:12px;border-bottom:1px solid var(--border)}
        .quest-btn{position:relative}
        .quest-badge{position:absolute;top:-4px;right:-4px;background:var(--danger);color:#fff;font-size:9px;font-weight:700;padding:2px 5px;border-radius:10px;min-width:16px;text-align:center}
        .quest-timer{font-size:12px;font-weight:600;color:var(--primary);background:var(--surface3);padding:6px 12px;border-radius:20px}
        .quest-streak-card{background:linear-gradient(135deg,var(--surface2),var(--surface3));border-radius:16px;padding:20px;display:flex;align-items:center;gap:16px;border:2px solid var(--border-bright)}
        .quest-streak-icon{font-size:48px;filter:drop-shadow(0 0 10px rgba(255,150,0,0.5))}
        .quest-streak-info{flex:1}
        .quest-streak-title{font-size:12px;color:var(--text3);margin-bottom:4px}
        .quest-streak-count{font-size:24px;font-weight:800;color:var(--text)}
        .quest-streak-bonus{font-size:16px;font-weight:700;color:var(--warning)}
        .quests-list{display:flex;flex-direction:column;gap:12px}
        .quest-card{background:var(--surface2);border-radius:12px;padding:16px;border-left:4px solid var(--primary);position:relative}
        .quest-card.completed{border-left-color:var(--success);opacity:0.7}
        .quest-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
        .quest-title{font-size:14px;font-weight:600;color:var(--text)}
        .quest-reward{background:var(--primary-gradient);color:#fff;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:700}
        .quest-desc{font-size:11px;color:var(--text3);margin-bottom:12px}
        .quest-progress{background:var(--surface3);border-radius:20px;height:8px;overflow:hidden;margin-bottom:4px}
        .quest-progress-bar{background:var(--primary-gradient);height:100%;transition:width .3s;border-radius:20px}
        .quest-progress-text{font-size:10px;color:var(--text2);text-align:right}
        .quest-complete-badge{position:absolute;top:16px;right:16px;font-size:24px}
        .inventory-item{background:var(--surface2);border-radius:12px;padding:12px;text-align:center;border:2px solid var(--border);position:relative}
        .inventory-item-icon{font-size:32px;margin-bottom:4px}
        .inventory-item-name{font-size:11px;font-weight:600;color:var(--text)}
        .inventory-item-count{position:absolute;top:4px;right:4px;background:var(--primary);color:#fff;font-size:10px;font-weight:700;padding:2px 6px;border-radius:10px}
        .inventory-item.active{border-color:var(--success);box-shadow:0 0 15px var(--success-glow)}
        .inventory-empty{text-align:center;padding:40px;color:var(--text3);font-size:13px}

        /* ==================== COMPREHENSIVE ANIMATION SYSTEM ==================== */

        /* REDUCED MOTION SUPPORT */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* ==================== PAGE TRANSITIONS ==================== */

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeOutDown {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(20px);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutLeft {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(-30px);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .view.active {
            animation: fadeInUp 300ms ease-out forwards;
        }

        /* ==================== SKELETON LOADING ==================== */

        @keyframes skeletonShimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }

        .skeleton {
            background: linear-gradient(90deg, var(--surface2) 25%, var(--surface3) 50%, var(--surface2) 75%);
            background-size: 1000px 100%;
            animation: skeletonShimmer 2s infinite;
            border-radius: 8px;
        }

        .skeleton-bar { height: 12px; margin-bottom: 8px; border-radius: 4px; }
        .skeleton-text { height: 16px; margin-bottom: 6px; }
        .skeleton-circle { width: 40px; height: 40px; border-radius: 50%; display: inline-block; }

        /* ==================== BUTTON INTERACTIONS ==================== */

        @keyframes buttonHover { from { transform: scale(1); } to { transform: scale(1.02); } }
        @keyframes buttonActive { from { transform: scale(1); } to { transform: scale(0.98); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes checkmark { 0% { stroke-dashoffset: 50; } 100% { stroke-dashoffset: 0; } }

        button {
            transition: transform 150ms cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 150ms ease-out, background-color 150ms ease-out, color 150ms ease-out;
            position: relative;
        }

        button:hover:not(:disabled) {
            transform: scale(1.02);
            box-shadow: var(--shadow-glow);
        }

        button:active:not(:disabled) {
            transform: scale(0.98);
        }

        .btn-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 600ms linear infinite;
        }

        .btn-loading { display: flex; align-items: center; gap: 8px; }
        .btn-success .checkmark { animation: checkmark 600ms ease-out forwards; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .btn-error { animation: shake 400ms ease-in-out; }

        /* ==================== SCAN PROGRESS ANIMATIONS ==================== */

        @keyframes progressFlow {
            0% { background-position: -100% 0; }
            100% { background-position: 100% 0; }
        }

        .progress-bar {
            background: var(--primary-gradient);
            background-size: 200% 100%;
            animation: progressFlow 1.5s ease-in-out infinite;
            transition: width 300ms ease-out;
        }

        @keyframes pulseScale {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
        }

        .scan-indicator { animation: pulseScale 1.5s ease-in-out infinite; }
        .scan-indicator-ring { animation: pulseScale 1.5s ease-in-out infinite; animation-delay: 0.3s; }

        @keyframes slideInCheckmark {
            from { opacity: 0; transform: scaleX(0); }
            to { opacity: 1; transform: scaleX(1); }
        }

        .module-checkmark { animation: slideInCheckmark 400ms cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards; }

        @keyframes countUpScore {
            from { opacity: 0; transform: scale(0.8) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .score-reveal { animation: countUpScore 600ms cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }

        /* ==================== LIST/CARD ANIMATIONS ==================== */

        @keyframes cascadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card-cascade { animation: cascadeIn 400ms ease-out forwards; }
        .card-cascade:nth-child(1) { animation-delay: 0ms; }
        .card-cascade:nth-child(2) { animation-delay: 60ms; }
        .card-cascade:nth-child(3) { animation-delay: 120ms; }
        .card-cascade:nth-child(4) { animation-delay: 180ms; }
        .card-cascade:nth-child(5) { animation-delay: 240ms; }
        .card-cascade:nth-child(n+6) { animation-delay: 300ms; }

        @keyframes cardLift { from { transform: translateY(0); } to { transform: translateY(-4px); } }

        .card-lift {
            transition: transform 250ms cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 250ms ease-out;
        }

        .card-lift:hover {
            transform: translateY(-6px);
            box-shadow: var(--shadow-lg), var(--shadow-glow);
        }

        @keyframes expandDown {
            from { opacity: 0; max-height: 0; overflow: hidden; }
            to { opacity: 1; max-height: 1000px; overflow: hidden; }
        }

        @keyframes collapseUp {
            from { opacity: 1; max-height: 1000px; overflow: hidden; }
            to { opacity: 0; max-height: 0; overflow: hidden; }
        }

        .collapse-enter { animation: expandDown 300ms ease-out forwards; }
        .collapse-exit { animation: collapseUp 300ms ease-in forwards; }

        @keyframes slideOutRemove {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }

        @keyframes fadeScaleOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.8); }
        }

        .item-remove { animation: slideOutRemove 300ms ease-in forwards; }
        .item-delete-fade { animation: fadeScaleOut 300ms ease-in forwards; }

        /* ==================== CELEBRATORY MOMENTS ==================== */

        @keyframes confetti {
            0% { transform: translate(0, 0) rotate(0deg); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) rotate(360deg); opacity: 0; }
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: var(--primary);
            border-radius: 50%;
            pointer-events: none;
            animation: confetti 800ms ease-out forwards;
        }

        @keyframes badgeUnlock {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        .badge-unlock { animation: badgeUnlock 600ms cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }

        @keyframes levelUpPulse {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); opacity: 1; }
        }

        .level-up { animation: levelUpPulse 600ms cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }

        @keyframes burstOut {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        .success-burst { animation: burstOut 500ms ease-out forwards; }

        @keyframes rankUpGlow {
            0%, 100% { box-shadow: 0 0 0 0 var(--primary-glow); }
            50% { box-shadow: 0 0 20px 10px var(--primary-glow); }
        }

        .rank-up { animation: rankUpGlow 800ms ease-out; }

        /* ==================== SUBTLE DETAILS ==================== */

        @keyframes tooltipFadeIn {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tooltip { animation: tooltipFadeIn 200ms ease-out forwards; opacity: 0; }
        .tooltip.show { animation: tooltipFadeIn 200ms ease-out forwards; }

        @keyframes iconBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }

        .icon-hover {
            transition: transform 200ms cubic-bezier(0.34, 1.56, 0.64, 1), filter 200ms ease-out;
        }

        .icon-hover:hover {
            animation: iconBounce 400ms ease-in-out;
            filter: drop-shadow(0 0 8px rgba(0, 212, 170, 0.5));
        }

        @keyframes focusGlow {
            from { box-shadow: 0 0 0 0 var(--primary-glow); }
            to { box-shadow: 0 0 0 8px rgba(0, 212, 170, 0); }
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            box-shadow: 0 0 0 3px var(--primary-glow) !important;
            animation: focusGlow 300ms ease-out;
            border-color: var(--primary) !important;
            transition: box-shadow 150ms ease-out, border-color 150ms ease-out;
        }

        @keyframes notificationSlideIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes notificationSlideOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }

        .notification { animation: notificationSlideIn 300ms ease-out forwards; }
        .notification.exit { animation: notificationSlideOut 300ms ease-in forwards; }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 800ms linear infinite;
        }

        .spinner-sm {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-top-color: var(--primary);
        }

        .spinner-lg {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top-color: var(--primary);
        }

        /* ==================== UTILITY ANIMATIONS ==================== */

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }

        .float { animation: float 3s ease-in-out infinite; }

        @keyframes glowPulse {
            0%, 100% { box-shadow: 0 0 0 0 var(--success-glow); }
            50% { box-shadow: 0 0 0 8px rgba(46, 213, 115, 0); }
        }

        .success-glow { animation: glowPulse 2s ease-out; }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.1); }
            50% { transform: scale(1); }
        }

        .heartbeat { animation: heartbeat 600ms ease-in-out; }

        @keyframes textReveal {
            from { opacity: 0; clip-path: inset(0 100% 0 0); }
            to { opacity: 1; clip-path: inset(0 0 0 0); }
        }

        .text-reveal { animation: textReveal 400ms ease-out forwards; }

        @keyframes pop {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .pop-in { animation: pop 300ms cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }

        .smooth-transition { transition: all 200ms ease-out; }

        .delay-1 { animation-delay: 100ms; }
        .delay-2 { animation-delay: 200ms; }
        .delay-3 { animation-delay: 300ms; }
        .delay-4 { animation-delay: 400ms; }
        .delay-5 { animation-delay: 500ms; }

        /* ========================================
           UI COMPONENTS LIBRARY - INTEGRATED
           AuthenticaDetector UI Components v2.0.0
           Modern, reusable component library
           ======================================== */

        /* Design System Tokens (Extended) */
        :root {
            /* Spacing scale */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-6: 24px;
            --space-8: 32px;
            --space-16: 64px;

            /* Typography */
            --font-body: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-size-xs: 11px;
            --font-size-sm: 13px;
            --font-size-base: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-2xl: 22px;
            --font-size-3xl: 28px;
            --font-size-5xl: 48px;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;
            --font-weight-extrabold: 800;
            --font-weight-black: 900;
            --line-height-normal: 1.5;
            --letter-spacing-wide: 0.05em;

            /* Border radius */
            --radius-base: 8px;
            --radius-md: 10px;
            --radius-lg: 14px;
            --radius-xl: 18px;
            --radius-full: 9999px;

            /* Colors (Extended) */
            --color-primary-500: #00d4aa;
            --color-secondary-500: #6366f1;
            --color-success-500: #2ed573;
            --color-warning-500: #ffa502;
            --color-danger-500: #ff4757;
            --color-info-500: #3498db;
            --color-neutral-100: #12161f;
            --color-neutral-200: #1a1f2e;
            --color-neutral-300: #242b3d;
            --color-neutral-400: #2f3748;
            --color-neutral-600: #6b7280;
            --color-neutral-700: #9ca3af;
            --color-neutral-800: #b4bcd0;
            --color-neutral-1000: #ffffff;

            /* Shadows */
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.2);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.4);
            --shadow-xl: 0 12px 24px rgba(0, 0, 0, 0.5);
            --shadow-2xl: 0 16px 32px rgba(0, 0, 0, 0.6);
            --shadow-primary: 0 4px 12px rgba(0, 212, 170, 0.25);
            --shadow-primary-lg: 0 8px 20px rgba(0, 212, 170, 0.35);
            --shadow-success: 0 4px 12px rgba(46, 213, 115, 0.25);
            --shadow-danger: 0 4px 12px rgba(255, 71, 87, 0.25);

            /* Durations */
            --duration-fast: 150ms;
            --duration-normal: 300ms;
            --duration-slow: 450ms;
            --duration-slower: 600ms;

            /* Easing */
            --ease-out: cubic-bezier(0, 0, 0.2, 1);
            --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
            --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);

            /* Z-index */
            --z-dropdown: 1000;
            --z-modal: 2000;
            --z-toast: 3000;
            --z-tooltip: 4000;
        }

        /* BUTTONS */
        .btn-primary {
            padding: var(--space-3) var(--space-6);
            background: linear-gradient(135deg, var(--color-primary-500), #00ff88);
            border: none;
            border-radius: var(--radius-md);
            color: #000;
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-bold);
            font-family: var(--font-body);
            cursor: pointer;
            box-shadow: var(--shadow-primary);
            transition: all var(--duration-fast) var(--ease-out);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            text-decoration: none;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-primary-lg);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(0) scale(0.98);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            padding: var(--space-3) var(--space-6);
            background: var(--color-neutral-200);
            border: 2px solid var(--color-neutral-400);
            border-radius: var(--radius-md);
            color: var(--color-neutral-1000);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            font-family: var(--font-body);
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-out);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--color-neutral-300);
            border-color: var(--color-primary-500);
        }

        .btn-secondary:active:not(:disabled) {
            transform: scale(0.98);
        }

        .btn-ghost {
            padding: var(--space-3) var(--space-6);
            background: transparent;
            border: none;
            border-radius: var(--radius-md);
            color: var(--color-neutral-800);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-medium);
            font-family: var(--font-body);
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-out);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
        }

        .btn-ghost:hover:not(:disabled) {
            background: var(--color-neutral-200);
            color: var(--color-neutral-1000);
        }

        .btn-danger {
            padding: var(--space-3) var(--space-6);
            background: linear-gradient(135deg, var(--color-danger-500), #ff6b7a);
            border: none;
            border-radius: var(--radius-md);
            color: #fff;
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-bold);
            font-family: var(--font-body);
            cursor: pointer;
            box-shadow: var(--shadow-danger);
            transition: all var(--duration-fast) var(--ease-out);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
        }

        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 71, 87, 0.35);
        }

        .btn-success {
            padding: var(--space-3) var(--space-6);
            background: linear-gradient(135deg, var(--color-success-500), #7bed9f);
            border: none;
            border-radius: var(--radius-md);
            color: #000;
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-bold);
            font-family: var(--font-body);
            cursor: pointer;
            box-shadow: var(--shadow-success);
            transition: all var(--duration-fast) var(--ease-out);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(46, 213, 115, 0.35);
        }

        .btn-icon {
            width: 44px;
            height: 44px;
            padding: 0;
            background: var(--color-neutral-200);
            border: none;
            border-radius: var(--radius-md);
            color: var(--color-neutral-800);
            font-size: var(--font-size-lg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--duration-fast) var(--ease-out);
        }

        .btn-icon:hover:not(:disabled) {
            background: var(--color-neutral-300);
            color: var(--color-neutral-1000);
        }

        .btn-icon:active:not(:disabled) {
            transform: scale(0.95);
        }

        .btn-sm {
            padding: var(--space-2) var(--space-4);
            font-size: var(--font-size-sm);
        }

        .btn-lg {
            padding: var(--space-4) var(--space-8);
            font-size: var(--font-size-lg);
        }

        .btn-block {
            width: 100%;
        }

        /* CARDS */
        .card {
            background: var(--color-neutral-100);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            box-shadow: var(--shadow-sm);
            transition: all var(--duration-normal) var(--ease-smooth);
        }

        .card-hoverable:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .card-glass {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            box-shadow: var(--shadow-md);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-4);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
            margin: 0;
        }

        .card-body {
            color: var(--color-neutral-800);
            line-height: var(--line-height-normal);
        }

        .card-footer {
            margin-top: var(--space-4);
            padding-top: var(--space-4);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: var(--space-3);
        }

        /* BADGES */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            text-transform: uppercase;
            letter-spacing: var(--letter-spacing-wide);
        }

        .badge-primary {
            background: rgba(0, 212, 170, 0.15);
            color: var(--color-primary-500);
            border: 1px solid rgba(0, 212, 170, 0.3);
        }

        .badge-secondary {
            background: rgba(99, 102, 241, 0.15);
            color: var(--color-secondary-500);
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        .badge-success {
            background: rgba(46, 213, 115, 0.15);
            color: var(--color-success-500);
            border: 1px solid rgba(46, 213, 115, 0.3);
        }

        .badge-warning {
            background: rgba(255, 165, 2, 0.15);
            color: var(--color-warning-500);
            border: 1px solid rgba(255, 165, 2, 0.3);
        }

        .badge-danger {
            background: rgba(255, 71, 87, 0.15);
            color: var(--color-danger-500);
            border: 1px solid rgba(255, 71, 87, 0.3);
        }

        .badge-info {
            background: rgba(52, 152, 219, 0.15);
            color: var(--color-info-500);
            border: 1px solid rgba(52, 152, 219, 0.3);
        }

        /* PROGRESS BARS */
        .progress {
            width: 100%;
            height: var(--space-2);
            background: var(--color-neutral-300);
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary-500), #00ff88);
            border-radius: var(--radius-full);
            transition: width var(--duration-normal) var(--ease-smooth);
        }

        .progress-sm {
            height: 4px;
        }

        .progress-lg {
            height: 12px;
        }

        /* INPUT FIELDS */
        .input {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            background: var(--color-neutral-200);
            border: 2px solid var(--color-neutral-400);
            border-radius: var(--radius-base);
            color: var(--color-neutral-1000);
            font-size: var(--font-size-base);
            font-family: var(--font-body);
            transition: all var(--duration-fast) var(--ease-out);
        }

        .input:focus {
            outline: none;
            border-color: var(--color-primary-500);
            background: var(--color-neutral-300);
            box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.1);
        }

        .input::placeholder {
            color: var(--color-neutral-600);
        }

        .input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* LOADING STATES */
        .skeleton {
            background: linear-gradient(
                90deg,
                var(--color-neutral-200) 25%,
                var(--color-neutral-300) 50%,
                var(--color-neutral-200) 75%
            );
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: var(--radius-base);
        }

        .skeleton-text {
            height: 1em;
            margin-bottom: var(--space-2);
            width: 100%;
        }

        .skeleton-heading {
            height: 2em;
            width: 60%;
            margin-bottom: var(--space-4);
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--color-neutral-400);
            border-top-color: var(--color-primary-500);
            border-radius: var(--radius-full);
            animation: spin var(--duration-slower) linear infinite;
        }

        .spinner-sm {
            width: 24px;
            height: 24px;
            border-width: 3px;
        }

        .spinner-lg {
            width: 64px;
            height: 64px;
            border-width: 5px;
        }

        /* UTILITY CLASSES */
        .hidden { display: none !important; }
        .block { display: block !important; }
        .inline-block { display: inline-block !important; }
        .flex { display: flex !important; }
        .inline-flex { display: inline-flex !important; }
        .grid { display: grid !important; }

        .flex-row { flex-direction: row; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .items-start { align-items: flex-start; }
        .items-end { align-items: flex-end; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .justify-end { justify-content: flex-end; }
        .flex-1 { flex: 1; }

        .text-left { text-align: left; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }

        .font-normal { font-weight: var(--font-weight-normal); }
        .font-medium { font-weight: var(--font-weight-medium); }
        .font-semibold { font-weight: var(--font-weight-semibold); }
        .font-bold { font-weight: var(--font-weight-bold); }

        .cursor-pointer { cursor: pointer; }
        .cursor-not-allowed { cursor: not-allowed; }

        .opacity-0 { opacity: 0; }
        .opacity-50 { opacity: 0.5; }
        .opacity-100 { opacity: 1; }

    </style>
</head>
<body>

<!-- HOME VIEW -->
<div class="view active" id="homeView">
    <div class="home-header">
        <div class="logo">
            <div class="logo-icon" id="mainLogo"></div>
            <span class="logo-text">AuthenticaDetector</span>
        </div>
        <div class="header-btns">
            <button class="btn-icon" onclick="openTankShooter()" title="Tank Shooter Game"></button>
            <button class="btn-icon" onclick="openHelp()"></button>
            <button class="btn-icon quest-btn" onclick="openQuests()" title="Daily Quests">
                <span></span>
                <span class="quest-badge" id="questBadge" style="display:none">0</span>
            </button>
            <button class="btn-icon" onclick="openShop()" title="Item Shop"></button>
            <button class="btn-icon" onclick="openHistory()"></button>
            <button class="btn-icon" onclick="openLeaderboard()"></button>
            <button class="btn-icon" id="userBtn" onclick="openProfile()"><span id="userInitial">?</span></button>
        </div>
    </div>
    
    <div class="status-bar" id="statusBar">
        <button class="btn-secondary" id="installChip" onclick="promptInstall()"><span></span> Install</button>
        <button class="btn-primary" id="signupChip" onclick="openLogin(true)"><span></span> Sign Up</button>
        <button class="btn-secondary" id="loginChip" onclick="openLogin()"><span></span> Sign In</button>
    </div>
    
    <div class="install-banner" id="installBanner">
        <span class="install-banner-icon"></span>
        <div class="install-banner-text">
            <strong>Install AuthenticaDetector</strong>
            <span>Unlock Deep Scan & more!</span>
        </div>
        <button class="btn-primary" onclick="promptInstall()">Install</button>
    </div>
    
    <div class="ios-helper" id="iosHelper">
        <div class="ios-helper-title"> Add to Home Screen</div>
        <div class="ios-steps">
            <div class="ios-step"><div class="ios-step-num">1</div><span>Tap Share </span></div>
            <div class="ios-step"><div class="ios-step-num">2</div><span>Tap "Add to Home Screen"</span></div>
            <div class="ios-step"><div class="ios-step-num">3</div><span>Tap Add</span></div>
        </div>
        <button class="btn-ghost" onclick="dismissIosHelper()">Later</button>
    </div>
    
    <!-- SCROLLABLE HOME CONTENT -->
    <div class="home-content">
        <div class="facts-panel" id="factsPanel">
            <div class="facts-header"><span></span> AI FACT</div>
            <div class="facts-content">
                <span class="facts-icon" id="factIcon"></span>
                <span id="factText">Loading...</span>
            </div>
        </div>
        
        <div class="upload-section">
            <div class="upload-hero">
                <h1>Detect AI Images</h1>
                <p>Upload any image to check if it's AI-generated</p>
            </div>
            
            <div class="dropzone" id="dropzone" onclick="triggerFileInput()">
                <img class="dropzone-preview hidden" id="dropzonePreview">
                <div class="dropzone-content" id="dropzoneContent">
                    <div class="dropzone-icon" id="analysisIcon"></div>
                    <h3>Tap to Upload</h3>
                    <p>or drag & drop</p>
                    <div class="file-types">
                        <span class="file-type">JPG</span>
                        <span class="file-type">PNG</span>
                        <span class="file-type">WEBP</span>
                        <span class="file-type">GIF</span>
                    </div>
                </div>
            </div>
            <input type="file" class="file-input" id="fileInput" accept="image/*" onchange="handleFileSelect(event)">
            
            <!-- PROGRESS -->
            <div class="card card-glass hidden" id="progressCard">
                <div class="progress-header">
                    <div class="progress-title" id="progressTitle"> Analyzing...</div>
                    <button class="btn-ghost" onclick="cancelScan()">Cancel</button>
                </div>
                <div class="progress progress-primary"><div class="progress-bar" id="progressBar" style="width:0%"></div></div>
                <div class="progress-status" id="progressStatus">Initializing...</div>
                <div class="progress-fact">
                    <span class="progress-fact-icon" id="progressFactIcon"></span>
                    <span class="progress-fact-text" id="progressFactText">Loading...</span>
                </div>
            </div>
            
            <!-- RESULT -->
            <div class="card card-glass hidden" id="resultCard">
                <div class="result-glow" id="resultGlow"></div>
                <div class="result-header">
                    <div class="result-icon" id="resultIcon"></div>
                    <div class="result-info">
                        <div class="result-label" id="resultLabel">Likely AI</div>
                        <div class="result-sublabel" id="resultSublabel">Deep Scan</div>
                    </div>
                </div>
                <div class="confidence-badge" id="confidenceBadge"><span></span><span id="confidenceText">High</span></div>
                <div class="result-score">
                    <div class="score-bar"><div class="score-fill" id="scoreFill" style="width:50%"></div></div>
                    <div class="score-labels"><span>Real</span><span>AI</span></div>
                    <div class="score-value" id="scoreValue">AI Probability: 50%</div>
                </div>
                <div class="explainers" id="explainersCard">
                    <div class="explainers-header" onclick="toggleExplainers()">
                        <div class="explainers-title"> Detection Analysis</div>
                        <span class="explainers-toggle" id="explainersToggle"></span>
                    </div>
                    <div class="explainers-content show" id="explainersContent"></div>
                </div>
                <div class="feedback-section">
                    <div class="feedback-title"> Was this accurate?</div>
                    <div class="feedback-btns">
                        <button class="btn-secondary" onclick="submitFeedback('correct')"> Correct</button>
                        <button class="btn-secondary" onclick="submitFeedback('incorrect')"> Incorrect</button>
                    </div>
                </div>
                <div class="result-actions">
                    <button class="btn-secondary" onclick="shareResult()"> Share</button>
                    <button class="btn-primary" onclick="newScan()"> New Scan</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SCAN BUTTONS - FIXED AT BOTTOM -->
    <div class="scan-section">
        <div class="advanced-panel hidden" id="advancedPanel">
            <div class="advanced-header" onclick="toggleAdvanced()">
                <span> Advanced</span>
                <span class="advanced-toggle" id="advancedToggle"></span>
            </div>
            <div class="advanced-content" id="advancedContent">
                <div class="advanced-row">
                    <div class="advanced-label">
                        <span class="advanced-icon"></span>
                        <div><div class="advanced-name">Forensics Mode</div><div class="advanced-desc">Maximum accuracy</div></div>
                    </div>
                    <label class="toggle-switch"><input type="checkbox" id="forensicsToggle" onchange="updateForensics()"><span class="toggle-slider"></span></label>
                </div>
            </div>
        </div>
        
        <div class="scan-btns">
            <button class="btn-primary btn-lg" id="quickBtn" onclick="startScan('quick')" disabled>
                <div class="scan-btn-title"> Quick Scan</div>
                <div class="scan-btn-desc">Fast basic check</div>
            </button>
            <button class="btn-primary btn-lg" id="deepBtn" onclick="startScan('deep')" disabled>
                <div class="scan-btn-title"> Deep Scan</div>
                <div class="scan-btn-desc">AI-powered  90%+</div>
                <span class="scan-lock" id="deepLock"></span>
            </button>
        </div>
    </div>
</div>

<!-- HISTORY VIEW -->
<div class="view" id="historyView">
    <div class="view-header">
        <button class="btn-ghost" onclick="closeView()" style="background:none;font-size:20px"></button>
        <span class="view-title"> History</span>
        <div style="width:44px"></div>
    </div>
    <div class="view-body view-body-padded" id="historyContent">
        <div class="history-empty"><div style="font-size:40px;margin-bottom:8px"></div><p>No scans yet</p></div>
    </div>
</div>

<!-- LEADERBOARD VIEW -->
<div class="view" id="leaderboardView">
    <div class="view-header">
        <button class="btn-ghost" onclick="closeView()" style="background:none;font-size:20px"></button>
        <span class="view-title"> Leaderboard</span>
        <div style="width:44px"></div>
    </div>
    <div class="view-body view-body-padded">
        <!-- REWARDS TEASER -->
        <div class="card card-hoverable">
            <div class="rewards-title"> Weekly Rewards</div>
            <div class="rewards-list">
                <div class="reward-item">
                    <span class="reward-icon"></span>
                    <span class="reward-text">KING: Custom badge + Featured profile</span>
                    <span class="reward-tier tier-king">#1</span>
                </div>
                <div class="reward-item">
                    <span class="reward-icon"></span>
                    <span class="reward-text">Top 3: Exclusive tier badges</span>
                    <span class="reward-tier tier-legend">Top 3</span>
                </div>
                <div class="reward-item">
                    <span class="reward-icon"></span>
                    <span class="reward-text">Top 10: 2x points next week</span>
                    <span class="reward-tier tier-elite">Top 10</span>
                </div>
            </div>
        </div>
        <div class="podium" id="podium"></div>
        <div id="leaderboardContent"></div>
    </div>
</div>

<!-- PROFILE VIEW -->
<div class="view" id="profileView">
    <div class="view-header">
        <button class="btn-ghost" onclick="closeView()" style="background:none;font-size:20px"></button>
        <span class="view-title"> Profile</span>
        <div style="width:44px"></div>
    </div>
    <div class="view-body view-body-padded">
        <div class="card">
            <div class="profile-header">
                <div class="profile-avatar" id="profileAvatar" onclick="changeProfilePic()">?</div>
                <div class="profile-name" id="profileName">Guest</div>
                <div class="profile-email" id="profileEmail">Sign in to save progress</div>
            </div>
            <div class="stats-grid">
                <div class="card"><div class="stat-value" id="statScans">0</div><div class="stat-label">Scans</div></div>
                <div class="card"><div class="stat-value" id="statFound">0</div><div class="stat-label">AI Found</div></div>
                <div class="card"><div class="stat-value" id="statPoints">0</div><div class="stat-label">Points</div></div>
            </div>
            <div class="badges-preview">
                <div class="badges-header"><span class="badges-title"> Badges</span><button class="btn-secondary" onclick="openAllBadges()">See All </button></div>
                <div class="badges-grid" id="badgesPreview"></div>
            </div>
        </div>
        <div class="menu">
            <button class="menu-item" onclick="handleLoginLogout()"><span class="menu-icon" id="loginLogoutIcon"></span><span class="menu-text" id="loginLogoutText">Sign In</span><span class="menu-arrow"></span></button>
            <button class="menu-item" onclick="openHelp()"><span class="menu-icon"></span><span class="menu-text">Help & FAQ</span><span class="menu-arrow"></span></button>
        </div>
    </div>
</div>

<!-- ALL BADGES VIEW -->
<div class="view" id="allBadgesView">
    <div class="view-header">
        <button class="btn-ghost" onclick="closeView()" style="background:none;font-size:20px"></button>
        <span class="view-title"> All Badges</span>
        <div style="width:44px"></div>
    </div>
    <div class="view-body view-body-padded" id="allBadgesContent"></div>
</div>

<!-- LOGIN VIEW -->
<div class="view" id="loginView">
    <div class="view-header">
        <span class="view-title" id="loginViewTitle">Sign In</span>
        <button class="btn-ghost" onclick="closeView()"></button>
    </div>
    <div class="view-body">
        <div class="login-content">
            <div class="login-hero">
                <div class="logo-icon" id="loginLogo" style="margin:0 auto 14px"></div>
                <h2 id="loginHeroTitle">Welcome Back</h2>
                <p id="loginHeroSubtitle">Sign in to access all features</p>
            </div>
            <div class="login-error" id="loginError"></div>
            <div class="login-form">
                <div class="input-group hidden" id="nameGroup"><label>Display Name</label><input type="text" id="nameInput" placeholder="Your name"></div>
                <div class="input-group"><label>Email</label><input type="email" id="emailInput" placeholder="you@example.com"></div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="passwordInput" placeholder="">
                </div>
                <div class="login-forgot" id="forgotLink"><a onclick="forgotPassword()">Forgot Password?</a></div>
                <button class="btn-primary" id="loginSubmit" onclick="submitLogin()">Sign In</button>
            </div>
            <div class="login-toggle" id="loginToggle">Don't have an account? <a onclick="toggleLoginMode()">Sign Up</a></div>
            <button class="btn-secondary" onclick="continueAsGuest()">Continue as Guest</button>
        </div>
    </div>
</div>

<!-- HELP VIEW -->
<div class="view" id="helpView">
    <div class="view-header">
        <button class="btn-ghost" onclick="closeView()" style="background:none;font-size:20px"></button>
        <span class="view-title"> Help</span>
        <div style="width:44px"></div>
    </div>
    <div class="view-body view-body-padded">
        <div class="help-section">
            <div class="help-header" onclick="toggleHelp(this)"><div class="help-title"> How to Install</div><span class="help-toggle"></span></div>
            <div class="help-content"><div class="help-text"><p><strong>Android:</strong> Tap install banner or menu  Install app</p><p><strong>iOS:</strong> Tap Share  Add to Home Screen  Add</p></div></div>
        </div>
        <div class="help-section">
            <div class="help-header" onclick="toggleHelp(this)"><div class="help-title"> Scan Modes</div><span class="help-toggle"></span></div>
            <div class="help-content"><div class="help-text"><p><strong>Quick Scan:</strong> Fast heuristic check (~70%)</p><p><strong>Deep Scan:</strong> AI model analysis (~90%+)</p><p><strong>Forensics:</strong> Maximum accuracy mode</p></div></div>
        </div>
        <div class="help-section">
            <div class="help-header" onclick="toggleHelp(this)"><div class="help-title"> Leaderboard & Rewards</div><span class="help-toggle"></span></div>
            <div class="help-content"><div class="help-text"><p>Earn points by scanning images and finding AI!</p><p><strong>Points:</strong> +1 Quick, +3 Deep, +5 AI Found</p><p><strong>Weekly KING</strong> gets featured profile!</p></div></div>
        </div>
        <div class="help-section">
            <div class="help-header" onclick="toggleHelp(this)"><div class="help-title"> Privacy</div><span class="help-toggle"></span></div>
            <div class="help-content"><div class="help-text"><p>Your history is private. Images analyzed locally. Others only see your name, badges & stats.</p></div></div>
        </div>
    </div>
</div>

<!-- SHOP VIEW -->
<div class="view" id="shopView">
    <div class="view-header">
        <button class="btn-ghost" onclick="closeView()"></button>
        <span class="view-title"> Item Shop</span>
        <div class="user-points-badge" id="shopPoints">0 pts</div>
    </div>
    <div class="view-body">
        <div class="shop-categories">
            <button class="btn-secondary active" onclick="filterShop('all')">All</button>
            <button class="btn-secondary" onclick="filterShop('powerups')">Power-ups</button>
            <button class="btn-secondary" onclick="filterShop('cosmetics')">Cosmetics</button>
            <button class="btn-secondary" onclick="filterShop('boosters')">Boosters</button>
        </div>
        <div id="shopItems" class="shop-grid"></div>
        <div id="inventorySection" style="margin-top:20px">
            <div class="section-title"> Your Inventory</div>
            <div id="inventoryItems" class="inventory-grid"></div>
        </div>
    </div>
</div>

<!-- DAILY QUESTS VIEW -->
<div class="view" id="questsView">
    <div class="view-header">
        <button class="btn-ghost" onclick="closeView()"></button>
        <span class="view-title"> Daily Quests</span>
        <div class="quest-timer" id="questTimer">00:00:00</div>
    </div>
    <div class="view-body view-body-padded">
        <div class="card card-hoverable" id="questStreakCard">
            <div class="quest-streak-icon"></div>
            <div class="quest-streak-info">
                <div class="quest-streak-title">Daily Streak</div>
                <div class="quest-streak-count" id="questStreakCount">0 days</div>
            </div>
            <div class="quest-streak-bonus">+<span id="streakBonusPercent">0</span>% Bonus</div>
        </div>
        <div class="section-title" style="margin-top:20px">Today's Quests</div>
        <div id="dailyQuests" class="quests-list"></div>
        <div class="section-title" style="margin-top:20px">Weekly Challenges</div>
        <div id="weeklyQuests" class="quests-list"></div>
    </div>
</div>

<!-- TANK SHOOTER GAME VIEW -->
<div class="view" id="tankShooterView" style="background: #000;">
    <div class="view-header" style="background: rgba(0,0,0,0.9);">
        <button class="btn-ghost" onclick="closeTankShooter()"></button>
        <span class="view-title"> Tank Shooter</span>
        <div style="width:44px"></div>
    </div>
    <div id="truthCannonGame" style="display:none;flex-direction:column;height:100vh;background:#000;">
        <!-- Game Stats HUD -->
        <div style="display:flex;justify-content:space-between;padding:12px;background:rgba(0,0,0,0.8);color:#fff;font-size:14px;">
            <div>Wave: <span id="gameWave">1</span></div>
            <div>Score: <span id="gameScore">0</span></div>
            <div>Combo: <span id="gameCombo">x1.0</span></div>
        </div>

        <!-- HP Bar -->
        <div style="padding:0 12px 12px;background:rgba(0,0,0,0.8);">
            <div style="font-size:12px;color:#fff;margin-bottom:4px;">
                HP: <span id="credibilityPercent">100%</span>
            </div>
            <div style="background:rgba(255,255,255,0.2);height:8px;border-radius:4px;overflow:hidden;">
                <div id="credibilityFill" style="background:#00ff88;height:100%;width:100%;transition:width 0.3s;"></div>
            </div>
        </div>

        <!-- Game Canvas -->
        <canvas id="gameCanvas" style="flex:1;display:block;"></canvas>

        <!-- Power-ups -->
        <div style="display:flex;gap:8px;padding:12px;background:rgba(0,0,0,0.8);justify-content:center;flex-wrap:wrap;">
            <button id="powerup1" onclick="activatePowerUp('slowMo')" style="background:#6c5ce7;color:#fff;border:none;padding:10px 16px;border-radius:8px;font-size:12px;cursor:pointer;position:relative;">
                 Slow-Mo
                <div class="powerup-cooldown" style="display:none;position:absolute;top:2px;right:2px;background:#ff4444;border-radius:50%;width:20px;height:20px;font-size:10px;line-height:20px;text-align:center;"></div>
            </button>
            <button id="powerup2" onclick="activatePowerUp('scatterShot')" style="background:#e17055;color:#fff;border:none;padding:10px 16px;border-radius:8px;font-size:12px;cursor:pointer;position:relative;">
                 Scatter
                <div class="powerup-cooldown" style="display:none;position:absolute;top:2px;right:2px;background:#ff4444;border-radius:50%;width:20px;height:20px;font-size:10px;line-height:20px;text-align:center;"></div>
            </button>
            <button id="powerup3" onclick="activatePowerUp('xRay')" style="background:#00b894;color:#fff;border:none;padding:10px 16px;border-radius:8px;font-size:12px;cursor:pointer;position:relative;">
                 X-Ray
                <div class="powerup-cooldown" style="display:none;position:absolute;top:2px;right:2px;background:#ff4444;border-radius:50%;width:20px;height:20px;font-size:10px;line-height:20px;text-align:center;"></div>
            </button>
            <button id="powerup4" onclick="activatePowerUp('shield')" style="background:#0984e3;color:#fff;border:none;padding:10px 16px;border-radius:8px;font-size:12px;cursor:pointer;position:relative;">
                 Shield
                <div class="powerup-cooldown" style="display:none;position:absolute;top:2px;right:2px;background:#ff4444;border-radius:50%;width:20px;height:20px;font-size:10px;line-height:20px;text-align:center;"></div>
            </button>
            <button id="powerup5" onclick="activatePowerUp('emp')" style="background:#9b59b6;color:#fff;border:none;padding:10px 16px;border-radius:8px;font-size:12px;cursor:pointer;position:relative;">
                 EMP
                <div class="powerup-cooldown" style="display:none;position:absolute;top:2px;right:2px;background:#ff4444;border-radius:50%;width:20px;height:20px;font-size:10px;line-height:20px;text-align:center;"></div>
            </button>
        </div>

        <!-- Mobile Controls -->
        <div id="mobileControls" style="display:none;position:fixed;bottom:120px;left:0;right:0;padding:20px;">
            <div style="display:flex;justify-content:space-between;align-items:flex-end;">
                <div id="joystickZone" style="width:120px;height:120px;background:rgba(255,255,255,0.1);border-radius:50%;border:2px solid rgba(255,255,255,0.3);"></div>
                <button id="fireBtn" style="width:80px;height:80px;background:rgba(255,68,68,0.8);border:none;border-radius:50%;color:#fff;font-size:32px;cursor:pointer;"></button>
            </div>
        </div>

        <!-- Game Over Screen -->
        <div id="gameOverScreen" style="display:none;position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.95);flex-direction:column;justify-content:center;align-items:center;padding:20px;color:#fff;">
            <div style="font-size:48px;margin-bottom:20px;"></div>
            <div style="font-size:32px;font-weight:bold;margin-bottom:30px;">GAME OVER</div>
            <div style="background:rgba(255,255,255,0.1);padding:20px;border-radius:12px;margin-bottom:30px;width:100%;max-width:400px;">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;font-size:16px;">
                    <div>
                        <div style="color:#999;font-size:12px;">Wave</div>
                        <div style="font-size:24px;font-weight:bold;" id="finalWave">0</div>
                    </div>
                    <div>
                        <div style="color:#999;font-size:12px;">Score</div>
                        <div style="font-size:24px;font-weight:bold;" id="finalScore">0</div>
                    </div>
                    <div>
                        <div style="color:#999;font-size:12px;">Fakes Destroyed</div>
                        <div style="font-size:24px;font-weight:bold;" id="finalFakes">0</div>
                    </div>
                    <div>
                        <div style="color:#999;font-size:12px;">Grade</div>
                        <div style="font-size:24px;font-weight:bold;color:#00ff88;" id="gameOverGrade">D</div>
                    </div>
                </div>
            </div>
            <div style="font-size:20px;color:#00ff88;margin-bottom:30px;">
                 <span id="coinsEarned">+0</span> Coins
            </div>
            <div style="display:flex;gap:12px;">
                <button onclick="retryTankShooter()" style="background:#00ff88;color:#000;border:none;padding:14px 28px;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;"> Retry</button>
                <button onclick="closeTankShooter()" style="background:rgba(255,255,255,0.1);color:#fff;border:none;padding:14px 28px;border-radius:8px;font-size:16px;cursor:pointer;"> Back</button>
            </div>
        </div>
    </div>

    <!-- Game Start Screen -->
    <div id="tankShooterStart" style="display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;padding:20px;color:#fff;">
        <div style="font-size:64px;margin-bottom:20px;"></div>
        <div style="font-size:32px;font-weight:bold;margin-bottom:12px;">Tank Shooter</div>
        <div style="color:#999;text-align:center;margin-bottom:40px;max-width:400px;">
            Defend against waves of AI-generated fakes! Survive as long as you can and climb the leaderboard.
        </div>
        <div style="background:rgba(255,255,255,0.05);padding:20px;border-radius:12px;margin-bottom:30px;max-width:400px;">
            <div style="font-size:16px;font-weight:bold;margin-bottom:12px;">How to Play:</div>
            <div style="font-size:14px;line-height:1.8;color:#ccc;">
                 <strong>Desktop:</strong> WASD to move, Mouse to aim & shoot<br>
                 <strong>Mobile:</strong> Joystick to move, Fire button to shoot<br>
                 Destroy enemies to earn points<br>
                 Use power-ups strategically<br>
                 Survive waves to earn coins
            </div>
        </div>
        <button onclick="startTankShooter()" style="background:#00ff88;color:#000;border:none;padding:16px 40px;border-radius:8px;font-size:18px;font-weight:bold;cursor:pointer;margin-bottom:12px;"> Start Game</button>
        <button onclick="closeTankShooter()" style="background:rgba(255,255,255,0.1);color:#fff;border:none;padding:12px 32px;border-radius:8px;font-size:14px;cursor:pointer;"> Back to Home</button>
    </div>
</div>

<!-- PUBLIC PROFILE MODAL -->
<div class="modal-overlay" id="publicProfileModal">
    <div class="modal"><button class="btn-ghost" onclick="closePublicProfile()"></button><div id="publicProfileContent"></div></div>
</div>

<!-- LOGIN REQUIRED MODAL -->
<div class="modal-overlay" id="loginRequiredModal">
    <div class="modal" style="text-align:center;padding:24px">
        <div style="font-size:40px;margin-bottom:12px"></div>
        <h3 style="margin-bottom:4px;font-size:16px">Feature Locked</h3>
        <p style="color:var(--text2);font-size:12px;margin-bottom:16px">Deep Scan requires sign in.</p>
        <button class="btn-primary" onclick="openLoginFromModal()" style="margin-bottom:8px">Sign In / Sign Up</button>
        <button class="btn-secondary" onclick="closeLoginRequired()">Use Quick Scan</button>
    </div>
</div>

<input type="file" id="profilePicInput" accept="image/*" style="display:none" onchange="handleProfilePic(event)">

<!-- Security Hardening Module - Load FIRST -->
<script src="security-hardening.js"></script>

<!-- Tank Shooter Game Module -->
<script src="tank-shooter.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script type="module">
// ==================== AUTHENTICADETECTOR v12 ====================
// Complete rewrite with PROPER AI detection model

import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.0.0';

// Disable local model check for faster loading
env.allowLocalModels = false;

const $ = id => document.getElementById(id);

// ==================== CONFIG ====================
const SUPABASE_URL = 'https://vrvoyxxdlcpysthzjbeu.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZydm95eHhkbGNweXN0aHpqYmV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5ODcyMjUsImV4cCI6MjA4MTU2MzIyNX0.zwakHpqJY4moTqDyggoEx01CIo76gzFIgjtaPcamHkg';
const APP_VERSION = '12.0.0';
const DETECTOR_VERSION = '3.0.0';

// ==================== STATE ====================
let supabase = null, useLocalFallback = true;
let user = null, isInstalled = false, deferredPrompt = null;
let currentFile = null, currentDataUrl = null, currentResult = null;
let analysisAborted = false;
let isLoginMode = false, scanCount = 0, sessionScanCount = 0;
let forensicsMode = false;

// AI Detection Models - PRODUCTION-GRADE MULTI-MODEL ENSEMBLE
let deepfakeDetector = null, deepfakeLoaded = false, deepfakeLoading = false;
let clipModel = null, clipProcessor = null, clipLoaded = false, clipLoading = false;
let aiDetectorCache = new Map(); // Cache for model results

// ==================== SELF-LEARNING SYSTEM ====================
// Adaptive weights that improve over time based on user feedback
let adaptiveWeights = {
    noise: 0.18,
    compression: 0.15,
    color: 0.15,
    edges: 0.12,
    frequency: 0.15,
    model: 0.25,
    // New detection signals
    exif: 0.10,
    metadata: 0.10,
    // Learning metrics
    totalFeedback: 0,
    correctPredictions: 0,
    lastUpdate: Date.now()
};

// Load saved weights from localStorage
function loadAdaptiveWeights() {
    const saved = localStorage.getItem('adaptive_weights_v3');
    if (saved) {
        try {
            const parsed = JSON.parse(saved);
            adaptiveWeights = {...adaptiveWeights, ...parsed};
            console.log('[LEARN] Loaded adaptive weights:', adaptiveWeights);
        } catch (e) {
            console.error('[LEARN] Failed to load weights:', e);
        }
    }
}

// Save weights to localStorage
function saveAdaptiveWeights() {
    try {
        localStorage.setItem('adaptive_weights_v3', JSON.stringify(adaptiveWeights));
        console.log('[LEARN] Saved adaptive weights');
    } catch (e) {
        console.error('[LEARN] Failed to save weights:', e);
    }
}

// Update weights based on feedback (self-learning algorithm)
function updateWeightsFromFeedback(signals, wasCorrect, userSaidAI) {
    if (!signals) return;

    const learningRate = 0.05; // How quickly to adapt
    const targetValue = userSaidAI ? 70 : 30; // Target signal values

    // Update each weight based on performance
    for (const [signal, value] of Object.entries(signals)) {
        if (adaptiveWeights[signal] !== undefined) {
            // If this signal was helpful (close to target), increase its weight
            // If it was misleading (far from target), decrease its weight
            const error = Math.abs(value - targetValue);
            const adjustment = wasCorrect ?
                learningRate * (1 - error/100) : // Reward accurate signals
                -learningRate * (error/100);       // Penalize inaccurate signals

            adaptiveWeights[signal] = Math.max(0.05, Math.min(0.35,
                adaptiveWeights[signal] + adjustment
            ));
        }
    }

    // Normalize weights to sum to 1.0
    const sum = Object.values(adaptiveWeights)
        .filter((v, k) => !['totalFeedback', 'correctPredictions', 'lastUpdate'].includes(Object.keys(adaptiveWeights)[k]))
        .reduce((a, b) => a + b, 0);

    for (const key in adaptiveWeights) {
        if (!['totalFeedback', 'correctPredictions', 'lastUpdate'].includes(key)) {
            adaptiveWeights[key] /= sum;
        }
    }

    // Update learning metrics
    adaptiveWeights.totalFeedback++;
    if (wasCorrect) adaptiveWeights.correctPredictions++;
    adaptiveWeights.lastUpdate = Date.now();

    saveAdaptiveWeights();

    const accuracy = ((adaptiveWeights.correctPredictions / adaptiveWeights.totalFeedback) * 100).toFixed(1);
    console.log(`[LEARN] Weights updated. Accuracy: ${accuracy}% (${adaptiveWeights.correctPredictions}/${adaptiveWeights.totalFeedback})`);
}

const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

// ==================== SVG ASSETS - MODERN PROFESSIONAL DESIGN ====================
const APP_LOGO_SVG = `<svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
<defs>
  <linearGradient id="lg1" x1="0%" y1="0%" x2="100%" y2="100%">
    <stop offset="0%" stop-color="#6366f1"/>
    <stop offset="50%" stop-color="#8b5cf6"/>
    <stop offset="100%" stop-color="#d946ef"/>
  </linearGradient>
  <linearGradient id="lg2" x1="0%" y1="0%" x2="100%" y2="0%">
    <stop offset="0%" stop-color="#00d4aa"/>
    <stop offset="100%" stop-color="#00ff88"/>
  </linearGradient>
  <filter id="glow">
    <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
    <feMerge>
      <feMergeNode in="coloredBlur"/>
      <feMergeNode in="SourceGraphic"/>
    </feMerge>
  </filter>
</defs>
<!-- Background with gradient -->
<rect width="48" height="48" rx="14" fill="url(#lg1)" opacity="0.95"/>
<!-- Shield outline -->
<path d="M24 6 L36 10 L36 20 C36 28 30 34 24 38 C18 34 12 28 12 20 L12 10 Z"
      stroke="url(#lg2)" stroke-width="2.5" fill="none" opacity="0.9" filter="url(#glow)"/>
<!-- Eye/detector symbol -->
<ellipse cx="24" cy="22" rx="8" ry="5" fill="#fff" opacity="0.25"/>
<circle cx="24" cy="22" r="3" fill="#fff" opacity="0.9"/>
<circle cx="24" cy="22" r="1.5" fill="#000" opacity="0.8"/>
<!-- Scan lines -->
<line x1="16" y1="28" x2="32" y2="28" stroke="#00d4aa" stroke-width="1.5" opacity="0.6"/>
<line x1="18" y1="31" x2="30" y2="31" stroke="#00d4aa" stroke-width="1.5" opacity="0.4"/>
<line x1="20" y1="34" x2="28" y2="34" stroke="#00d4aa" stroke-width="1.5" opacity="0.3"/>
</svg>`;

const ANALYSIS_ICON_SVG = `<svg viewBox="0 0 72 72" fill="none" xmlns="http://www.w3.org/2000/svg">
<defs>
  <linearGradient id="scanGrad" x1="0%" y1="0%" x2="100%" y2="100%">
    <stop offset="0%" stop-color="#00d4aa"/>
    <stop offset="100%" stop-color="#6366f1"/>
  </linearGradient>
</defs>
<!-- Outer ring -->
<circle cx="36" cy="36" r="32" stroke="var(--border)" stroke-width="2" opacity="0.3"/>
<!-- Animated scan ring -->
<circle class="scan-ring" cx="36" cy="36" r="32" stroke="url(#scanGrad)" stroke-width="3"
        stroke-dasharray="60 140" stroke-linecap="round" opacity="0.8"/>
<!-- Grid pattern -->
<rect x="18" y="18" width="36" height="36" rx="4" stroke="var(--text2)" stroke-width="1.5" opacity="0.4"/>
<line x1="36" y1="18" x2="36" y2="54" stroke="var(--border)" stroke-width="1" opacity="0.3"/>
<line x1="18" y1="36" x2="54" y2="36" stroke="var(--border)" stroke-width="1" opacity="0.3"/>
<!-- Central pulse -->
<circle class="pulse-core" cx="36" cy="36" r="6" fill="var(--primary)" opacity="0.4"/>
<circle cx="36" cy="36" r="3" fill="var(--primary)" opacity="0.9"/>
<!-- Crosshair -->
<path d="M30 36h12M36 30v12" stroke="#fff" stroke-width="2" stroke-linecap="round" opacity="0.7"/>
</svg>`;

// ==================== FACTS - MORE ENGAGING ====================
const FACTS = [
    { icon: '', text: "AI generates over 34 MILLION images per DAY. Most people can't tell the difference!" },
    { icon: '', text: "Your brain processes images 60,000x faster than text - that's why deepfakes fool us so easily." },
    { icon: '', text: "Humans detect AI images only 48% of the time - worse than a coin flip! AI detectors hit 95%+." },
    { icon: '', text: "The term 'deepfake' was coined in 2017. Now it's a $15 billion industry threatening elections." },
    { icon: '', text: "The 'count the fingers' trick? AI fixed that. Modern generators nail hands 90% of the time." },
    { icon: '', text: "AI still struggles with ears - check for asymmetry, impossible curves, or missing details!" },
    { icon: '', text: "Teeth are a giveaway - AI often creates wrong counts, impossible reflections, or blurry gums." },
    { icon: '', text: "Text in AI images is usually nonsense. Readable text is actually a sign of a REAL photo!" },
    { icon: '', text: "Every AI generator leaves invisible 'fingerprints' in pixel noise - detectable by algorithms." },
    { icon: '', text: "Real cameras have sensor noise patterns. AI images have mathematically 'too perfect' noise." },
    { icon: '', text: "Water reflections expose AI - look for physics violations, impossible angles, or missing objects." },
    { icon: '', text: "Jewelry and accessories often have impossible geometry in AI images - clasps that don't connect!" },
    { icon: '', text: "AI struggles with architecture - columns that don't align, windows at wrong angles, floating stairs." },
    { icon: '', text: "By 2025, experts predict 90% of online images could be AI-generated or manipulated." }
];
let currentFactIndex = 0;

// ==================== BADGES - EXPANDED ====================
const BADGES = {
    // COMMON (Easy to get)
    first_scan: { id: 'first_scan', name: 'First Steps', desc: 'Complete your first scan', icon: '', req: 1, type: 'total', rarity: 'common' },
    ai_hunter: { id: 'ai_hunter', name: 'AI Spotter', desc: 'Find your first AI image', icon: '', req: 1, type: 'ai', rarity: 'common' },
    five_scans: { id: 'five_scans', name: 'Getting Started', desc: 'Complete 5 scans', icon: '', req: 5, type: 'total', rarity: 'common' },
    ten_scans: { id: 'ten_scans', name: 'Double Digits', desc: 'Complete 10 scans', icon: '', req: 10, type: 'total', rarity: 'common' },
    first_deep: { id: 'first_deep', name: 'Deep Diver', desc: 'First Deep Scan', icon: '', req: 1, type: 'deep', rarity: 'common' },
    quick_five: { id: 'quick_five', name: 'Speed Runner', desc: '5 Quick Scans', icon: '', req: 5, type: 'quick', rarity: 'common' },
    
    // RARE (Some effort)
    twenty_five: { id: 'twenty_five', name: 'Detective', desc: '25 total scans', icon: '', req: 25, type: 'total', rarity: 'rare' },
    ten_ai: { id: 'ten_ai', name: 'AI Expert', desc: 'Find 10 AI images', icon: '', req: 10, type: 'ai', rarity: 'rare' },
    streak_3: { id: 'streak_3', name: 'On Fire', desc: '3 AI finds in a row', icon: '', req: 3, type: 'streak', rarity: 'rare' },
    deep_ten: { id: 'deep_ten', name: 'Deep Analyst', desc: '10 Deep Scans', icon: '', req: 10, type: 'deep', rarity: 'rare' },
    fifty_scans: { id: 'fifty_scans', name: 'Dedicated', desc: '50 total scans', icon: '', req: 50, type: 'total', rarity: 'rare' },
    
    // EPIC (Significant effort)
    hundred_scans: { id: 'hundred_scans', name: 'Centurion', desc: '100 total scans', icon: '', req: 100, type: 'total', rarity: 'epic' },
    fifty_ai: { id: 'fifty_ai', name: 'AI Hunter', desc: 'Find 50 AI images', icon: '', req: 50, type: 'ai', rarity: 'epic' },
    streak_5: { id: 'streak_5', name: 'Unstoppable', desc: '5 AI finds in a row', icon: '', req: 5, type: 'streak', rarity: 'epic' },
    deep_fifty: { id: 'deep_fifty', name: 'Deep Master', desc: '50 Deep Scans', icon: '', req: 50, type: 'deep', rarity: 'epic' },
    forensics_first: { id: 'forensics_first', name: 'Forensics Pro', desc: 'First Forensics scan', icon: '', req: 1, type: 'forensics', rarity: 'epic' },
    
    // LEGENDARY (Major achievement)
    two_fifty: { id: 'two_fifty', name: 'Legend', desc: '250 total scans', icon: '', req: 250, type: 'total', rarity: 'legendary' },
    hundred_ai: { id: 'hundred_ai', name: 'AI Nemesis', desc: 'Find 100 AI images', icon: '', req: 100, type: 'ai', rarity: 'legendary' },
    streak_10: { id: 'streak_10', name: 'Perfect 10', desc: '10 AI finds in a row', icon: '', req: 10, type: 'streak', rarity: 'legendary' },
    thousand: { id: 'thousand', name: 'Grandmaster', desc: '1000 total scans', icon: '', req: 1000, type: 'total', rarity: 'legendary' }
};

// ==================== TIER SYSTEM ====================
const TIERS = {
    1: { name: 'KING', class: 'tier-king' },
    2: { name: 'VICEROY', class: 'tier-viceroy' },
    3: { name: 'ARCHDUKE', class: 'tier-archduke' },
    // 4-10
    legend: { name: 'LEGEND', class: 'tier-legend', min: 4, max: 10 },
    // 11-25
    elite: { name: 'ELITE', class: 'tier-elite', min: 11, max: 25 },
    // 26-50
    veteran: { name: 'VETERAN', class: 'tier-veteran', min: 26, max: 50 },
    // 51-100
    rising: { name: 'RISING', class: 'tier-rising', min: 51, max: 100 }
};

function getTier(rank) {
    if (rank === 1) return TIERS[1];
    if (rank === 2) return TIERS[2];
    if (rank === 3) return TIERS[3];
    if (rank <= 10) return TIERS.legend;
    if (rank <= 25) return TIERS.elite;
    if (rank <= 50) return TIERS.veteran;
    if (rank <= 100) return TIERS.rising;
    return null;
}

// ==================== HELPERS ====================
function toast(msg) {
    let c = document.querySelector('.toast-container');
    if (!c) { c = document.createElement('div'); c.className = 'toast-container'; document.body.appendChild(c); }
    const t = document.createElement('div'); t.className = 'toast'; t.textContent = msg; c.appendChild(t);
    setTimeout(() => t.remove(), 3000);
}
function showView(id) { document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); $(id).classList.add('active'); }
window.closeView = () => showView('homeView');
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
function round(v) { return Math.round(v); }
function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

// ==================== INIT LOGOS ====================
function initLogos() {
    document.querySelectorAll('.logo-icon').forEach(el => el.innerHTML = APP_LOGO_SVG);
    if ($('analysisIcon')) $('analysisIcon').innerHTML = ANALYSIS_ICON_SVG;
}

// ==================== FACTS ====================
function initFacts() { updateFact(); setInterval(updateFact, 12000); }
function updateFact() {
    currentFactIndex = (currentFactIndex + 1) % FACTS.length;
    const f = FACTS[currentFactIndex];
    if ($('factIcon')) $('factIcon').textContent = f.icon;
    if ($('factText')) $('factText').textContent = f.text;
    if ($('progressFactIcon')) $('progressFactIcon').textContent = f.icon;
    if ($('progressFactText')) $('progressFactText').textContent = f.text;
}

// ==================== SUPABASE ====================
function initSupabase() {
    try {
        if (SUPABASE_URL.includes('YOUR_PROJECT')) { useLocalFallback = true; return; }
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: { autoRefreshToken: true, persistSession: true, storage: localStorage }
        });
        useLocalFallback = false;
        console.log('[Supabase] Connected');
    } catch (e) { useLocalFallback = true; console.log('[Supabase] Using local fallback'); }
}

// ==================== PWA INSTALL ====================
window.addEventListener('beforeinstallprompt', e => {
    e.preventDefault(); deferredPrompt = e;
    if (!isInstalled && !isIOS) $('installBanner')?.classList.add('show');
    updateStatusBar();
});
window.addEventListener('appinstalled', () => {
    isInstalled = true; localStorage.setItem('app_installed', 'true');
    $('installBanner')?.classList.remove('show'); $('iosHelper')?.classList.remove('show');
    updateStatusBar(); updateGating(); toast(' App installed!');
});
function checkInstallState() {
    if (isStandalone) { isInstalled = true; localStorage.setItem('app_installed', 'true'); }
    if (localStorage.getItem('app_installed') === 'true') isInstalled = true;
    if (isInstalled) { $('installBanner')?.classList.remove('show'); $('iosHelper')?.classList.remove('show'); }
    else if (isIOS && isSafari && !localStorage.getItem('ios_dismissed')) {
        setTimeout(() => { if (!isInstalled) $('iosHelper')?.classList.add('show'); }, 2500);
    }
    updateStatusBar();
}
window.promptInstall = async function() {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') { 
            isInstalled = true; localStorage.setItem('app_installed', 'true'); 
            $('installBanner')?.classList.remove('show'); 
            updateStatusBar(); updateGating(); 
        }
        deferredPrompt = null;
    } else if (isIOS) { $('iosHelper')?.classList.add('show'); }
    else { toast('Use browser menu  Install app'); }
};
window.dismissIosHelper = () => { $('iosHelper')?.classList.remove('show'); localStorage.setItem('ios_dismissed', 'true'); };

// ==================== STATUS BAR ====================
function updateStatusBar() {
    const ic = $('installChip'), lc = $('loginChip'), sc = $('signupChip');
    
    if (isInstalled) {
        ic.classList.remove('pending'); ic.classList.add('complete');
        ic.innerHTML = '<span></span> Installed';
    } else {
        ic.classList.add('pending'); ic.classList.remove('complete');
        ic.innerHTML = '<span></span> Install';
    }
    
    if (user) {
        lc.classList.remove('pending'); lc.classList.add('complete');
        lc.innerHTML = '<span></span> Signed In';
        sc.classList.add('hidden');
    } else {
        lc.classList.add('pending'); lc.classList.remove('complete');
        lc.innerHTML = '<span></span> Sign In';
        sc.classList.remove('hidden');
    }
    
    // Hide entire bar only when both complete
    $('statusBar').style.display = (isInstalled && user) ? 'none' : 'flex';
}

// ==================== AUTH ====================
async function loadUser() {
    if (!useLocalFallback && supabase) {
        try {
            const { data: { session } } = await supabase.auth.getSession();
            if (session?.user) {
                user = { id: session.user.id, email: session.user.email, name: session.user.user_metadata?.display_name || session.user.email.split('@')[0] };
                const { data: p } = await supabase.from('profiles').select('display_name,avatar_url').eq('id', user.id).single();
                if (p) { user.name = p.display_name || user.name; user.avatar = p.avatar_url; }
                updateUserUI(); loadUserStats(); return;
            }
        } catch (e) { console.log('[Auth] Session check failed:', e); }
    }
    const saved = localStorage.getItem('auth_user');
    if (saved) { user = JSON.parse(saved); updateUserUI(); loadUserStats(); }
}
function saveUser() { if (user) localStorage.setItem('auth_user', JSON.stringify(user)); else localStorage.removeItem('auth_user'); }

function updateUserUI() {
    if (user) {
        const i = user.name ? user.name[0].toUpperCase() : user.email[0].toUpperCase();
        $('userInitial').textContent = i;
        $('userBtn').innerHTML = user.avatar ? `<img src="${user.avatar}">` : `<span id="userInitial">${i}</span>`;
        $('profileName').textContent = user.name || user.email.split('@')[0];
        $('profileEmail').textContent = user.email;
        $('profileAvatar').innerHTML = user.avatar ? `<img src="${user.avatar}">` : i;
        $('loginLogoutText').textContent = 'Sign Out'; $('loginLogoutIcon').textContent = '';
    } else {
        $('userInitial').textContent = '?'; $('userBtn').innerHTML = '<span id="userInitial">?</span>';
        $('profileName').textContent = 'Guest'; $('profileEmail').textContent = 'Sign in to save progress';
        $('profileAvatar').innerHTML = '?';
        $('loginLogoutText').textContent = 'Sign In'; $('loginLogoutIcon').textContent = '';
    }
    updateStatusBar(); updateGating();
}

async function loadUserStats() {
    if (!user) return;
    let stats = { total: 0, ai: 0, deep: 0, quick: 0, forensics: 0, streak: 0, maxStreak: 0, points: 0 };
    if (!useLocalFallback && supabase) {
        try {
            const { data } = await supabase.from('user_stats').select('*').eq('user_id', user.id).single();
            if (data) stats = { 
                total: data.total_scans || 0, ai: data.ai_found || 0, 
                deep: data.deep_scans || 0, quick: data.quick_scans || 0,
                forensics: data.forensics_scans || 0,
                streak: data.current_streak || 0, maxStreak: data.max_streak || 0, 
                points: data.points || 0 
            };
        } catch (e) {}
    }
    const local = JSON.parse(localStorage.getItem(`stats_${user.id}`) || '{}');
    if ((local.total || 0) > stats.total) stats = { ...stats, ...local };
    scanCount = stats.total;
    localStorage.setItem(`stats_${user.id}`, JSON.stringify(stats));
    $('statScans').textContent = stats.total || 0; 
    $('statFound').textContent = stats.ai || 0; 
    $('statPoints').textContent = stats.points || 0;
}

function updateGating() {
    const canDeep = user; // Only require login, not install (easier for users)
    if (canDeep) { 
        $('deepLock')?.classList.add('hidden'); 
        $('advancedPanel')?.classList.remove('hidden'); 
    } else { 
        $('deepLock')?.classList.remove('hidden'); 
        $('advancedPanel')?.classList.add('hidden'); 
    }
}

window.openLogin = function(signupMode = false) { 
    isLoginMode = signupMode; 
    updateLoginUI(); 
    showView('loginView'); 
};
function updateLoginUI() {
    if (isLoginMode) {
        $('loginViewTitle').textContent = 'Sign Up';
        $('loginHeroTitle').textContent = 'Create Account';
        $('loginHeroSubtitle').textContent = 'Join to unlock all features';
        $('nameGroup').classList.remove('hidden');
        $('loginSubmit').textContent = 'Create Account';
        $('loginToggle').innerHTML = 'Already have an account? <a onclick="toggleLoginMode()">Sign In</a>';
        // Hide forgot password link in signup mode
        if ($('forgotLink')) $('forgotLink').style.display = 'none';
    } else {
        $('loginViewTitle').textContent = 'Sign In';
        $('loginHeroTitle').textContent = 'Welcome Back';
        $('loginHeroSubtitle').textContent = 'Sign in to access all features';
        $('nameGroup').classList.add('hidden');
        $('loginSubmit').textContent = 'Sign In';
        $('loginToggle').innerHTML = "Don't have an account? <a onclick=\"toggleLoginMode()\">Sign Up</a>";
        // Show forgot password link in login mode
        if ($('forgotLink')) $('forgotLink').style.display = 'block';
    }
    $('loginError').classList.remove('show');
}
window.toggleLoginMode = () => { isLoginMode = !isLoginMode; updateLoginUI(); };

window.submitLogin = async function() {
    const email = $('emailInput').value.trim(), password = $('passwordInput').value, name = $('nameInput').value.trim();
    if (!email || !password) { showLoginError('Fill all fields'); return; }
    if (isLoginMode && !name) { showLoginError('Enter your name'); return; }
    if (password.length < 6) { showLoginError('Password min 6 chars'); return; }

    // Email validation
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) { showLoginError('Invalid email address'); return; }

    $('loginSubmit').disabled = true;
    $('loginSubmit').textContent = isLoginMode ? 'Creating...' : 'Signing in...';

    try {
        if (!useLocalFallback && supabase) {
            if (isLoginMode) {
                // SIGNUP with email verification
                const { data, error } = await supabase.auth.signUp({
                    email,
                    password,
                    options: {
                        data: { display_name: name },
                        emailRedirectTo: window.location.origin + '/verified'
                    }
                });
                if (error) throw error;

                // Check if email confirmation is required
                if (data.user && !data.user.confirmed_at && data.user.identities?.length === 0) {
                    showLoginError(' Check your email to verify your account!');
                    toast(' Verification email sent! Check your inbox.', 'info', 5000);
                    // Don't log in yet - wait for verification
                    return;
                }

                user = { id: data.user.id, email: data.user.email, name };
                toast(' Account created!');
            } else {
                // LOGIN
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) {
                    // Better error messages
                    if (error.message.includes('Email not confirmed')) {
                        throw new Error('Please verify your email first. Check your inbox.');
                    }
                    throw error;
                }
                user = { id: data.user.id, email: data.user.email, name: data.user.user_metadata?.display_name || email.split('@')[0] };
                toast('Welcome back!');
            }
        } else {
            // Local fallback
            const users = JSON.parse(localStorage.getItem('local_users') || '{}');
            if (isLoginMode) {
                if (users[email]) throw new Error('Account exists');
                users[email] = { email, password, name, created: Date.now() };
                localStorage.setItem('local_users', JSON.stringify(users));
                user = { id: 'local_' + Date.now(), email, name };
                toast(' Account created!');
            } else {
                if (!users[email] || users[email].password !== password) throw new Error('Invalid credentials');
                user = { id: 'local_' + email, email, name: users[email].name };
                toast('Welcome back!');
            }
        }
        saveUser(); updateUserUI(); loadUserStats(); showView('homeView');
    } catch (e) {
        showLoginError(e.message);
    } finally {
        $('loginSubmit').disabled = false;
        updateLoginUI();
    }
};

// FORGOT PASSWORD
window.forgotPassword = async function() {
    const email = $('emailInput').value.trim();
    if (!email) {
        showLoginError('Enter your email address');
        return;
    }

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        showLoginError('Invalid email address');
        return;
    }

    try {
        if (!useLocalFallback && supabase) {
            const { error } = await supabase.auth.resetPasswordForEmail(email, {
                redirectTo: window.location.origin + '/reset-password'
            });
            if (error) throw error;
            toast(' Password reset link sent! Check your email.', 'success', 5000);
            showLoginError(' Check your email for reset link');
        } else {
            toast('Password reset not available in guest mode', 'warning');
        }
    } catch (e) {
        showLoginError('Error: ' + e.message);
    }
};

function showLoginError(msg) { $('loginError').textContent = msg; $('loginError').classList.add('show'); }
window.continueAsGuest = () => { showView('homeView'); toast('Continuing as guest'); };

window.handleLoginLogout = async function() {
    if (user) { 
        if (!useLocalFallback && supabase) try { await supabase.auth.signOut(); } catch(e){}
        user = null; saveUser(); updateUserUI(); toast('Signed out'); 
    } else openLogin();
};

window.openLoginFromModal = () => { $('loginRequiredModal').classList.remove('show'); openLogin(); };
window.closeLoginRequired = () => { $('loginRequiredModal').classList.remove('show'); if (currentFile) startScan('quick'); };

// ==================== FILE HANDLING ====================
window.triggerFileInput = () => $('fileInput').click();
window.handleFileSelect = (e) => { const f = e.target.files[0]; if (f) processFile(f); };

function processFile(file) {
    if (!file.type.startsWith('image/')) { toast('Please select an image'); return; }
    if (file.size > 50 * 1024 * 1024) { toast('File too large (max 50MB)'); return; }
    
    currentFile = file;
    const reader = new FileReader();
    reader.onload = (e) => {
        currentDataUrl = e.target.result;
        $('dropzonePreview').src = currentDataUrl; 
        $('dropzonePreview').classList.remove('hidden');
        $('dropzoneContent').classList.add('hidden'); 
        $('dropzone').classList.add('has-file');
        $('quickBtn').disabled = false; 
        $('deepBtn').disabled = false;
        $('resultCard').classList.add('hidden'); 
        $('progressCard').classList.add('hidden');
    };
    reader.readAsDataURL(file);
}

// Drag & drop
$('dropzone')?.addEventListener('dragover', e => { e.preventDefault(); $('dropzone').classList.add('dragover'); });
$('dropzone')?.addEventListener('dragleave', () => $('dropzone').classList.remove('dragover'));
$('dropzone')?.addEventListener('drop', e => { 
    e.preventDefault(); 
    $('dropzone').classList.remove('dragover'); 
    if (e.dataTransfer.files[0]) processFile(e.dataTransfer.files[0]); 
});

// ==================== SCAN ====================
window.startScan = function(mode) {
    if (!currentFile) { toast('Select an image first'); return; }
    if (mode === 'deep' && !user) { 
        $('loginRequiredModal').classList.add('show'); 
        return; 
    }
    runAnalysis(mode);
};

async function runAnalysis(mode) {
    analysisAborted = false; 
    sessionScanCount++;
    $('resultCard').classList.add('hidden'); 
    $('progressCard').classList.remove('hidden');
    $('progressBar').style.width = '0%';
    $('progressTitle').textContent = ` ${mode === 'deep' ? (forensicsMode ? 'Forensics' : 'Deep') : 'Quick'} Scan...`;
    updateFact();
    
    try {
        const result = mode === 'quick' ? await runQuickScan() : await runDeepScan();
        if (analysisAborted) return;
        displayResults(result, mode);
        await saveToHistory(result, mode);
        await updateUserStatsAfterScan(result, mode);
    } catch (e) { 
        console.error('[Scan] Error:', e);
        if (!analysisAborted) { 
            toast('Analysis failed: ' + e.message); 
            $('progressCard').classList.add('hidden'); 
        } 
    }
}

// ==================== QUICK SCAN - HEURISTICS ONLY ====================
async function runQuickScan() {
    updateProgress(10, 'Loading image...');
    const img = new Image();
    await new Promise((res, rej) => { img.onload = res; img.onerror = rej; img.src = currentDataUrl; });
    
    updateProgress(25, 'Analyzing noise patterns...');
    const noise = analyzeNoisePatterns(img);
    await sleep(100);
    
    updateProgress(45, 'Checking compression artifacts...');
    const compression = analyzeCompressionArtifacts(img);
    await sleep(100);
    
    updateProgress(65, 'Analyzing color distribution...');
    const color = analyzeColorDistribution(img);
    await sleep(100);
    
    updateProgress(85, 'Checking edge coherence...');
    const edges = analyzeEdgeCoherence(img);
    await sleep(100);
    
    updateProgress(95, 'Computing result...');
    
    // Weighted ensemble
    let aiScore = noise * 0.30 + compression * 0.25 + color * 0.25 + edges * 0.20;
    
    // Calibration: Prevent catastrophic false negatives
    const maxIndicator = Math.max(noise, compression, color, edges);
    const minIndicator = Math.min(noise, compression, color, edges);
    
    // If ANY indicator strongly suggests AI, boost the score
    if (maxIndicator > 70) {
        aiScore = Math.max(aiScore, maxIndicator * 0.75);
    }
    
    // Clamp to realistic range for heuristics
    aiScore = clamp(aiScore, 20, 80);
    
    // Confidence based on indicator agreement
    const spread = maxIndicator - minIndicator;
    let confidence = 'low';
    if (spread < 20 && (aiScore > 60 || aiScore < 40)) confidence = 'medium';
    if (spread < 15 && (aiScore > 70 || aiScore < 30)) confidence = 'high';
    
    updateProgress(100, 'Complete!');
    
    return {
        aiScore: round(aiScore),
        isAI: aiScore > 50,
        confidence,
        breakdown: { noise: round(noise), compression: round(compression), color: round(color), edges: round(edges) },
        mode: 'quick',
        version: DETECTOR_VERSION,
        // Enhanced explainability data
        moduleExplanations: [
            {
                name: 'Noise Patterns',
                icon: '',
                confidence: round(noise),
                triggered: noise > 55 || noise < 45,
                reason: noise > 65 ? 'Unnaturally uniform noise patterns typical of GAN generation' :
                        noise > 55 ? 'Noise consistency suggests possible AI generation' :
                        noise < 35 ? 'Natural camera sensor noise detected' :
                        noise < 45 ? 'Noise patterns consistent with real photography' :
                        'Noise analysis inconclusive',
                technical: `Variance analysis: ${noise > 65 ? 'Too uniform (GAN signature)' : noise < 35 ? 'Natural sensor noise' : 'Mixed indicators'}`
            },
            {
                name: 'Compression Artifacts',
                icon: '',
                confidence: round(compression),
                triggered: compression > 55 || compression < 45,
                reason: compression > 60 ? 'Periodic block artifacts suggest AI upscaling or generation' :
                        compression > 55 ? 'Compression patterns differ from typical camera output' :
                        compression < 40 ? 'Natural JPEG compression from camera' :
                        compression < 45 ? 'Compression consistent with real photos' :
                        'Compression analysis inconclusive',
                technical: `DCT block analysis: ${compression > 60 ? 'Synthetic patterns' : compression < 40 ? 'Natural JPEG' : 'Indeterminate'}`
            },
            {
                name: 'Color Distribution',
                icon: '',
                confidence: round(color),
                triggered: color > 55 || color < 45,
                reason: color > 60 ? 'Mathematically smooth color gradients typical of AI' :
                        color > 55 ? 'Color distribution appears slightly synthetic' :
                        color < 35 ? 'Natural color variation from real scene' :
                        color < 45 ? 'Color patterns consistent with photography' :
                        'Color analysis inconclusive',
                technical: `Histogram entropy: ${color > 60 ? 'Low (synthetic)' : color < 35 ? 'High (natural)' : 'Medium'}`
            },
            {
                name: 'Edge Coherence',
                icon: '',
                confidence: round(edges),
                triggered: edges > 55 || edges < 45,
                reason: edges > 60 ? 'Edge patterns suggest synthetic generation process' :
                        edges > 55 ? 'Edge coherence slightly abnormal' :
                        edges < 40 ? 'Natural edge characteristics from real imaging' :
                        edges < 45 ? 'Edges consistent with camera optics' :
                        'Edge analysis inconclusive',
                technical: `Sobel analysis: ${edges > 60 ? 'Synthetic edges' : edges < 40 ? 'Natural optical blur' : 'Mixed'}`
            }
        ]
    };
}

// ==================== DEEP SCAN - WORLD-CLASS AI DETECTION ====================
// Competing with Hive Moderation - Production-Grade Detection
async function runDeepScan() {
    updateProgress(5, 'Initializing deep detection...');

    // Load production-grade AI detection models
    await loadProductionModels();

    updateProgress(15, 'Loading image...');
    const img = new Image();
    await new Promise((res, rej) => { img.onload = res; img.onerror = rej; img.src = currentDataUrl; });

    // STEP 1: Enhanced Heuristics (8 signals)
    updateProgress(25, 'Analyzing noise patterns...');
    const noise = analyzeNoisePatterns(img);
    await sleep(40);

    updateProgress(32, 'Checking compression artifacts...');
    const compression = analyzeCompressionArtifacts(img);
    await sleep(40);

    updateProgress(39, 'Analyzing color distribution...');
    const color = analyzeColorDistribution(img);
    await sleep(40);

    updateProgress(46, 'Checking edge coherence...');
    const edges = analyzeEdgeCoherence(img);
    await sleep(40);

    updateProgress(53, 'Frequency domain analysis...');
    const frequency = analyzeFrequencyDomain(img);
    await sleep(40);

    updateProgress(60, 'Checking EXIF metadata...');
    const exif = await analyzeEXIFData(currentFile);
    await sleep(30);

    updateProgress(65, 'Analyzing file metadata...');
    const metadata = await analyzeMetadata(currentFile);
    await sleep(30);

    // STEP 2: Generator Signature Detection
    updateProgress(70, 'Detecting generator signatures...');
    const generatorSig = detectGeneratorSignatures(img, {noise, compression, color, frequency});
    await sleep(50);

    // STEP 3: Deep Learning Models (PRODUCTION-GRADE)
    let deepfakeScore = 50;
    let clipScore = 50;
    let modelConfidence = 'low';

    if (deepfakeLoaded && deepfakeDetector) {
        updateProgress(78, 'Running deepfake detector...');
        try {
            const dfResult = await deepfakeDetector(currentDataUrl);
            deepfakeScore = analyzeDeepfakeOutput(dfResult);
            modelConfidence = deepfakeScore > 75 || deepfakeScore < 25 ? 'high' : 'medium';
        } catch (e) {
            console.error('[DeepFake] Inference failed:', e);
        }
        await sleep(50);
    }

    if (clipLoaded && clipModel && clipProcessor) {
        updateProgress(85, 'Running CLIP analysis...');
        try {
            clipScore = await analyzeCLIP(currentDataUrl, clipModel, clipProcessor);
        } catch (e) {
            console.error('[CLIP] Inference failed:', e);
        }
        await sleep(50);
    }

    // STEP 4: Multi-crop Forensics Analysis
    let cropScore = deepfakeScore;
    if (forensicsMode) {
        updateProgress(91, 'Multi-region forensics...');
        cropScore = await analyzeMultipleCrops(img);
        await sleep(50);
    }

    updateProgress(95, 'Computing final ensemble...');

    // STEP 5: PRODUCTION-GRADE ENSEMBLE - Multi-Model Voting
    // Combines deep learning models + heuristics + generator signatures
    const w = adaptiveWeights;

    // Primary signals (heuristics)
    const heuristicScore = (
        noise * w.noise +
        compression * w.compression +
        color * w.color +
        edges * w.edges +
        frequency * w.frequency +
        exif * w.exif +
        metadata * w.metadata
    ) / (w.noise + w.compression + w.color + w.edges + w.frequency + w.exif + w.metadata);

    // Model signals (deep learning)
    const modelScore = (deepfakeScore + clipScore + (forensicsMode ? cropScore : deepfakeScore)) / (forensicsMode ? 3 : 2);

    // Generator signature weight
    const generatorWeight = generatorSig.confidence === 'high' ? 1.15 : (generatorSig.confidence === 'medium' ? 1.08 : 1.0);

    // Combined score with MODEL PRIORITY (models are more accurate!)
    let aiScore = (heuristicScore * 0.35 + modelScore * 0.65) * 100;

    // Apply generator signature multiplier
    if (generatorSig.detected) {
        aiScore = aiScore * generatorWeight;
    }

    // Multi-signal agreement boost
    const allSignals = [noise, compression, color, edges, frequency, exif, metadata, deepfakeScore, clipScore];
    const aiSignals = allSignals.filter(s => s > 55).length;
    const realSignals = allSignals.filter(s => s < 45).length;

    // Strong agreement bonus
    if (aiSignals >= 6) {
        aiScore = Math.min(95, aiScore * 1.12);
        modelConfidence = 'high';
    } else if (realSignals >= 6) {
        aiScore = Math.max(5, aiScore * 0.88);
        modelConfidence = 'high';
    } else if (aiSignals >= 4) {
        aiScore = Math.min(92, aiScore * 1.06);
    } else if (realSignals >= 4) {
        aiScore = Math.max(8, aiScore * 0.94);
    }

    // Forensics mode enhancement
    if (forensicsMode) {
        aiScore = Math.min(98, aiScore * 1.03);
    }

    // Clamp to realistic range
    aiScore = clamp(aiScore, 5, 98);

    // Confidence calculation (stricter for production)
    const maxSig = Math.max(...allSignals);
    const minSig = Math.min(...allSignals);
    const spread = maxSig - minSig;

    let confidence = 'low';
    if (modelConfidence === 'high' && spread < 25) confidence = 'high';
    else if (modelConfidence === 'high' || (spread < 30 && (aiScore > 70 || aiScore < 30))) confidence = 'medium';
    if (forensicsMode && aiSignals >= 6) confidence = 'high';

    updateProgress(100, 'Complete!');

    // Return comprehensive result
    return {
        aiScore: round(aiScore),
        isAI: aiScore > 50,
        confidence,
        breakdown: {
            noise: round(noise),
            compression: round(compression),
            color: round(color),
            edges: round(edges),
            frequency: round(frequency),
            exif: round(exif),
            metadata: round(metadata),
            deepfake: round(deepfakeScore),
            clip: round(clipScore),
            generator: generatorSig.type || 'unknown'
        },
        generatorInfo: generatorSig,
        mode: forensicsMode ? 'forensics' : 'deep',
        version: DETECTOR_VERSION,
        // Store for self-learning
        _rawSignals: {
            noise, compression, color, edges, frequency, exif, metadata,
            deepfake: deepfakeScore,
            clip: clipScore,
            generator: generatorSig.score
        },
        // Enhanced explainability data - ALL modules
        moduleExplanations: [
            {
                name: 'Noise Patterns',
                icon: '',
                confidence: round(noise),
                triggered: noise > 55 || noise < 45,
                reason: noise > 65 ? 'Unnaturally uniform noise - GAN fingerprint detected' :
                        noise > 55 ? 'Noise patterns show AI generation characteristics' :
                        noise < 35 ? 'Natural camera sensor noise detected' :
                        noise < 45 ? 'Noise consistent with real photography' :
                        'Noise analysis inconclusive',
                technical: `Multi-scale variance: ${noise > 65 ? 'Too uniform (StyleGAN/Midjourney)' : noise < 35 ? 'Natural Poisson noise' : 'Mixed indicators'}`
            },
            {
                name: 'Compression Artifacts',
                icon: '',
                confidence: round(compression),
                triggered: compression > 55 || compression < 45,
                reason: compression > 65 ? 'Unnatural 8x8 or 16x16 block patterns - AI upscaling signature' :
                        compression > 55 ? 'Compression artifacts differ from camera JPEG' :
                        compression < 40 ? 'Natural camera JPEG compression detected' :
                        compression < 45 ? 'Compression consistent with real photos' :
                        'Compression analysis inconclusive',
                technical: `DCT analysis: ${compression > 65 ? 'Synthetic block patterns' : compression < 40 ? 'Natural JPEG baseline' : 'Indeterminate'}`
            },
            {
                name: 'Color Distribution',
                icon: '',
                confidence: round(color),
                triggered: color > 55 || color < 45,
                reason: color > 65 ? 'Mathematically perfect gradients - AI signature' :
                        color > 55 ? 'Color distribution shows synthetic characteristics' :
                        color < 35 ? 'Natural color variation from real scene lighting' :
                        color < 45 ? 'Colors consistent with real photography' :
                        'Color analysis inconclusive',
                technical: `Histogram entropy: ${color > 65 ? 'Low entropy (synthetic)' : color < 35 ? 'High entropy (natural)' : 'Medium entropy'}`
            },
            {
                name: 'Edge Coherence',
                icon: '',
                confidence: round(edges),
                triggered: edges > 55 || edges < 45,
                reason: edges > 65 ? 'Edge artifacts typical of diffusion model generation' :
                        edges > 55 ? 'Edges show synthetic generation characteristics' :
                        edges < 40 ? 'Natural optical blur and depth-of-field' :
                        edges < 45 ? 'Edges consistent with camera lens optics' :
                        'Edge analysis inconclusive',
                technical: `Gradient analysis: ${edges > 65 ? 'Synthetic boundaries' : edges < 40 ? 'Natural lens blur' : 'Mixed signals'}`
            },
            {
                name: 'Frequency Analysis',
                icon: '',
                confidence: round(frequency),
                triggered: frequency > 55 || frequency < 45,
                reason: frequency > 65 ? 'Abnormal frequency patterns - strong AI indicator' :
                        frequency > 55 ? 'Frequency domain shows synthetic characteristics' :
                        frequency < 40 ? 'Natural frequency distribution from camera' :
                        frequency < 45 ? 'Frequencies consistent with optical capture' :
                        'Frequency analysis inconclusive',
                technical: `FFT analysis: ${frequency > 65 ? 'Unnatural high-freq artifacts' : frequency < 40 ? 'Natural freq rolloff' : 'Moderate patterns'}`
            },
            {
                name: 'EXIF Metadata',
                icon: '',
                confidence: round(exif),
                triggered: exif > 55 || exif < 45,
                reason: exif > 65 ? 'Missing or suspicious camera metadata - likely AI' :
                        exif > 55 ? 'Metadata shows anomalies or inconsistencies' :
                        exif < 35 ? 'Complete authentic camera EXIF data present' :
                        exif < 45 ? 'Metadata consistent with camera capture' :
                        'EXIF analysis inconclusive',
                technical: `Metadata check: ${exif > 65 ? 'No camera info (AI generated)' : exif < 35 ? 'Full camera EXIF' : 'Partial metadata'}`
            },
            {
                name: 'File Metadata',
                icon: '',
                confidence: round(metadata),
                triggered: metadata > 55 || metadata < 45,
                reason: metadata > 65 ? 'File structure suggests AI generation or heavy processing' :
                        metadata > 55 ? 'File metadata shows possible AI origin' :
                        metadata < 40 ? 'File properties consistent with camera output' :
                        metadata < 45 ? 'Metadata indicates natural file creation' :
                        'File metadata inconclusive',
                technical: `File analysis: ${metadata > 65 ? 'Software creation signature' : metadata < 40 ? 'Camera file structure' : 'Modified file'}`
            },
            {
                name: 'Deepfake Detector (AI Model)',
                icon: '',
                confidence: round(deepfakeScore),
                triggered: deepfakeScore > 55 || deepfakeScore < 45,
                reason: deepfakeScore > 70 ? 'Vision Transformer detected strong AI signatures' :
                        deepfakeScore > 55 ? 'Neural network detected possible AI generation' :
                        deepfakeScore < 35 ? 'AI model confirmed natural photograph' :
                        deepfakeScore < 45 ? 'Neural network leans toward real photo' :
                        'AI model inconclusive',
                technical: `ViT-based detection: ${deepfakeLoaded ? (deepfakeScore > 70 ? 'High AI confidence' : deepfakeScore < 35 ? 'High real confidence' : 'Uncertain') : 'Model not loaded'}`
            },
            {
                name: 'CLIP Semantic Analysis',
                icon: '',
                confidence: round(clipScore),
                triggered: clipScore > 55 || clipScore < 45,
                reason: clipScore > 65 ? 'Semantic inconsistencies detected - AI generation likely' :
                        clipScore > 55 ? 'Image-text alignment suggests synthetic origin' :
                        clipScore < 40 ? 'Semantics consistent with real photographs' :
                        clipScore < 45 ? 'CLIP analysis leans toward authentic' :
                        'CLIP analysis inconclusive',
                technical: `Zero-shot classification: ${clipLoaded ? (clipScore > 65 ? 'AI prompts matched' : clipScore < 40 ? 'Real photo matched' : 'Mixed results') : 'Model not loaded'}`
            },
            {
                name: 'Generator Fingerprints',
                icon: '',
                confidence: generatorSig.detected ? generatorSig.score : 50,
                triggered: generatorSig.detected,
                reason: generatorSig.type === 'midjourney' ? 'Midjourney signature detected - characteristic noise & color grading' :
                        generatorSig.type === 'dalle' ? 'DALL-E signature detected - smooth rendering with low compression' :
                        generatorSig.type === 'stable-diffusion' ? 'Stable Diffusion signature detected - high noise fingerprint' :
                        generatorSig.detected ? 'AI generator signature detected' :
                        'No specific generator identified',
                technical: `Signature match: ${generatorSig.detected ? `${generatorSig.type.toUpperCase()} (${generatorSig.confidence})` : 'None detected'}`
            },
            ...(forensicsMode ? [{
                name: 'Multi-Crop Forensics',
                icon: '',
                confidence: round(cropScore),
                triggered: Math.abs(cropScore - 50) > 15,
                reason: cropScore > 65 ? 'Multiple image regions show consistent AI artifacts' :
                        cropScore > 55 ? 'Regional analysis suggests possible AI generation' :
                        cropScore < 40 ? 'All regions show natural characteristics' :
                        cropScore < 45 ? 'Forensic analysis favors authenticity' :
                        'Multi-region analysis inconclusive',
                technical: `Regional consistency: ${cropScore > 65 ? 'Uniform AI artifacts' : cropScore < 40 ? 'Natural variation' : 'Mixed regions'}`
            }] : [])
        ].filter(m => m !== undefined)
    };
}

// ==================== PRODUCTION MODEL LOADING ====================
async function loadProductionModels() {
    // Load Deepfake Detector (ViT-based)
    if (!deepfakeLoaded && !deepfakeLoading) {
        deepfakeLoading = true;
        updateProgress(8, 'Loading deepfake detector...');
        try {
            // Use optimized deepfake detection model
            // Fallback to vision transformer if specialized model unavailable
            try {
                deepfakeDetector = await pipeline('image-classification', 'Xenova/vit-base-patch16-224');
            } catch (e) {
                console.log('[DeepFake] Specialized model unavailable, using ViT');
                deepfakeDetector = await pipeline('image-classification', 'Xenova/vit-base-patch16-224');
            }
            deepfakeLoaded = true;
            console.log('[DeepFake] Model loaded');
        } catch (e) {
            console.error('[DeepFake] Load failed:', e);
            deepfakeLoaded = false;
        }
        deepfakeLoading = false;
    }

    // Wait for models to load
    while (deepfakeLoading || clipLoading) await sleep(50);
}

// ==================== MODEL OUTPUT ANALYZERS ====================

// Analyze deepfake detector output
function analyzeDeepfakeOutput(results) {
    if (!results || !results.length) return 50;

    // DeepFake detector returns "Realism" vs "Deepfake" probabilities
    // Higher scores = more likely AI/Deepfake
    // We need to analyze the confidence distribution

    const topLabel = results[0].label.toLowerCase();
    const topScore = results[0].score;

    // Look for AI/synthetic indicators
    const aiKeywords = ['deepfake', 'fake', 'synthetic', 'generated', 'artificial', 'gan', 'diffusion'];
    const realKeywords = ['real', 'authentic', 'natural', 'photo', 'camera'];

    let score = 50;

    if (aiKeywords.some(kw => topLabel.includes(kw))) {
        // Model detected AI
        score = 50 + (topScore * 50); // 50-100 range
    } else if (realKeywords.some(kw => topLabel.includes(kw))) {
        // Model detected real
        score = 50 - (topScore * 50); // 0-50 range
    } else {
        // Uncertain - use confidence distribution
        // High confidence in any single class = likely trained content
        if (topScore > 0.8) {
            // Very confident = likely real photo (natural classes)
            score = 25;
        } else if (topScore < 0.3) {
            // Low confidence = unusual = possibly AI
            score = 65;
        } else {
            // Medium confidence
            score = 50;
        }
    }

    return clamp(score, 0, 100);
}

// Analyze CLIP semantic consistency
async function analyzeCLIP(imageUrl, model, processor) {
    try {
        // CLIP-based detection: AI images have semantic inconsistencies
        // We check if visual features match expected text descriptions
        const testPrompts = [
            "a real photograph taken with a camera",
            "an AI generated image from stable diffusion",
            "an AI generated image from Midjourney",
            "a digitally rendered artificial image",
            "an authentic natural photograph",
            "a screenshot from a computer or phone",
            "human-made digital art and illustration"
        ];

        // Use CLIP zero-shot classification (state-of-the-art)
        const clipPipeline = await pipeline('zero-shot-image-classification', 'Xenova/clip-vit-base-patch32');
        const visionResults = await clipPipeline(imageUrl, testPrompts);

        // Analyze category scores with enhanced logic
        const realScores = visionResults[0].score + visionResults[4].score + visionResults[5].score + visionResults[6].score;
        const aiScores = visionResults[1].score + visionResults[2].score + visionResults[3].score;

        // Screenshots and human art are REAL
        const screenshotBonus = visionResults[5].score > 0.3 ? -20 : 0;
        const humanArtBonus = visionResults[6].score > 0.25 ? -15 : 0;

        // Convert to 0-100 score with bonuses
        let score = ((aiScores / (realScores + aiScores)) * 100);
        score = score + screenshotBonus + humanArtBonus;

        return clamp(score, 0, 100);
    } catch (e) {
        console.error('[CLIP] Analysis failed:', e);
        return 50;
    }
}

// ==================== GENERATOR SIGNATURE DETECTION ====================
function detectGeneratorSignatures(img, signals) {
    // Detect specific AI generator fingerprints
    const {noise, compression, color, frequency} = signals;

    // Midjourney v5/v6 signatures
    const isMidjourney = (
        noise > 40 && noise < 60 &&  // Characteristic noise level
        compression < 40 &&           // Low compression artifacts
        color > 55 &&                 // Strong color grading
        frequency > 50                // Specific frequency patterns
    );

    // DALL-E 3 signatures
    const isDallE = (
        noise < 35 &&                 // Very smooth
        compression < 30 &&           // Minimal compression
        color > 50 && color < 70 &&   // Balanced colors
        frequency < 45                // Low frequency content
    );

    // Stable Diffusion signatures
    const isStableDiffusion = (
        noise > 55 &&                 // High noise fingerprint
        compression > 55 &&           // Characteristic compression
        frequency > 60                // Strong frequency artifacts
    );

    // Determine generator and confidence
    let type = null;
    let confidence = 'low';
    let score = 50;

    if (isMidjourney) {
        type = 'midjourney';
        confidence = 'medium';
        score = 70;
    } else if (isDallE) {
        type = 'dalle';
        confidence = 'medium';
        score = 68;
    } else if (isStableDiffusion) {
        type = 'stable-diffusion';
        confidence = 'high';
        score = 75;
    }

    // Check for strong multi-signal agreement
    const aiCount = [noise, compression, color, frequency].filter(s => s > 55).length;
    if (aiCount >= 3 && type) {
        confidence = 'high';
        score = 80;
    }

    return {
        detected: type !== null,
        type,
        confidence,
        score
    };
}

// ==================== ANALYSIS FUNCTIONS ====================

function analyzeNoisePatterns(img) {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const size = Math.min(img.width, img.height, 256);
    canvas.width = size; canvas.height = size;
    ctx.drawImage(img, 0, 0, size, size);
    const data = ctx.getImageData(0, 0, size, size).data;

    // ==================== ADVANCED NOISE ANALYSIS ====================
    // Multi-scale variance analysis (real camera sensor noise vs GAN noise)
    let totalVariance = 0, varianceStdDev = 0, count = 0;
    const blockSize = 8;
    const variances = [];

    for (let by = 0; by < size - blockSize; by += blockSize) {
        for (let bx = 0; bx < size - blockSize; bx += blockSize) {
            let sum = 0, sumSq = 0, n = 0;
            for (let y = by; y < by + blockSize; y++) {
                for (let x = bx; x < bx + blockSize; x++) {
                    const i = (y * size + x) * 4;
                    const gray = (data[i] + data[i+1] + data[i+2]) / 3;
                    sum += gray; sumSq += gray * gray; n++;
                }
            }
            const mean = sum / n;
            const variance = (sumSq / n) - (mean * mean);
            variances.push(variance);
            totalVariance += variance;
            count++;
        }
    }

    const avgVariance = totalVariance / count;

    // Calculate variance of variances (GANs produce too-uniform noise)
    let varianceDiffSum = 0;
    for (const v of variances) {
        varianceDiffSum += Math.pow(v - avgVariance, 2);
    }
    const varianceConsistency = Math.sqrt(varianceDiffSum / variances.length);

    // GAN fingerprint: Periodic patterns in noise (repeating neural artifacts)
    let periodicityScore = 0;
    for (let i = 0; i < variances.length - 4; i++) {
        const diff1 = Math.abs(variances[i] - variances[i+2]);
        const diff2 = Math.abs(variances[i+1] - variances[i+3]);
        if (diff1 < 5 && diff2 < 5) periodicityScore++;
    }
    const periodicityRatio = periodicityScore / (variances.length - 4);

    // Color channel correlation (AI images often have unnatural RGB relationships)
    let rVariance = 0, gVariance = 0, bVariance = 0;
    for (let i = 0; i < data.length; i += 4) {
        rVariance += data[i] * data[i];
        gVariance += data[i+1] * data[i+1];
        bVariance += data[i+2] * data[i+2];
    }
    const channelRatio = Math.max(rVariance, gVariance, bVariance) / Math.min(rVariance, gVariance, bVariance + 1);

    // ==================== WORLD-CLASS SCORING LOGIC ====================
    let score = 50;

    // Factor 1: Average variance (camera sensors have predictable noise ranges)
    // Real photos: 100-600, Screenshots: 10-100, AI: <50 or >700
    if (avgVariance < 20) {
        score += 40; // Extremely smooth = GAN or over-processed AI
    } else if (avgVariance < 50) {
        // Could be screenshot OR AI - check other factors
        score += 15;
    } else if (avgVariance >= 100 && avgVariance <= 600) {
        score -= 25; // Strong indicator of real photo with natural noise
    } else if (avgVariance > 700) {
        score += 30; // Over-sharpened or artificial noise added
    }

    // Factor 2: Variance consistency (GANs produce unnaturally uniform noise)
    // Real photos have varied noise across regions, AI is too consistent
    if (varianceConsistency < 5) {
        score += 25; // Suspiciously uniform = GAN signature
    } else if (varianceConsistency < 15) {
        score += 12;
    } else if (varianceConsistency > 80) {
        score -= 15; // Natural variation indicates real photo
    }

    // Factor 3: Periodicity (neural network grid artifacts)
    // GANs often create repeating patterns from convolutional layers
    if (periodicityRatio > 0.35) {
        score += 20; // Strong GAN fingerprint
    } else if (periodicityRatio > 0.25) {
        score += 12;
    } else if (periodicityRatio < 0.1) {
        score -= 10; // Low periodicity = likely real
    }

    // Factor 4: Channel correlation (RGB relationships)
    // Real photos have natural correlations, AI can be too perfect or too chaotic
    if (channelRatio > 3.0) {
        score += 18; // One channel dominates = AI error
    } else if (channelRatio > 2.5) {
        score += 10;
    } else if (channelRatio < 1.05) {
        score += 12; // Too perfectly balanced = synthetic
    } else if (channelRatio >= 1.1 && channelRatio <= 2.0) {
        score -= 10; // Natural correlation range
    }

    // Factor 5: Combined heuristic (multi-signal agreement)
    // When multiple factors agree, boost confidence
    let aiIndicators = 0;
    let realIndicators = 0;

    if (avgVariance < 50 || avgVariance > 700) aiIndicators++;
    if (avgVariance >= 100 && avgVariance <= 600) realIndicators++;

    if (varianceConsistency < 15) aiIndicators++;
    if (varianceConsistency > 80) realIndicators++;

    if (periodicityRatio > 0.25) aiIndicators++;
    if (periodicityRatio < 0.1) realIndicators++;

    if (channelRatio > 2.5 || channelRatio < 1.05) aiIndicators++;
    if (channelRatio >= 1.1 && channelRatio <= 2.0) realIndicators++;

    // Strong agreement boosts confidence
    if (aiIndicators >= 3) score += 15;
    if (realIndicators >= 3) score -= 20;

    return clamp(score, 10, 95);
}

function analyzeCompressionArtifacts(img) {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const size = Math.min(img.width, img.height, 256);
    canvas.width = size; canvas.height = size;
    ctx.drawImage(img, 0, 0, size, size);
    const data = ctx.getImageData(0, 0, size, size).data;

    // ==================== ADVANCED DCT & COMPRESSION ANALYSIS ====================
    // Detect 8x8 DCT block boundaries (JPEG), 16x16 (AI upscaling), 4x4 (modern codecs)
    const blockSizes = [4, 8, 16];
    const blockScores = [];

    for (const blockSize of blockSizes) {
        let blockEdges = 0, smoothBlocks = 0, total = 0;

        for (let y = blockSize; y < size - blockSize; y += blockSize) {
            for (let x = blockSize; x < size - blockSize; x += blockSize) {
                const i = (y * size + x) * 4;
                const left = ((y * size) + (x - 1)) * 4;
                const up = (((y - 1) * size) + x) * 4;

                const diffLeft = Math.abs(data[i] - data[left]) +
                               Math.abs(data[i+1] - data[left+1]) +
                               Math.abs(data[i+2] - data[left+2]);
                const diffUp = Math.abs(data[i] - data[up]) +
                              Math.abs(data[i+1] - data[up+1]) +
                              Math.abs(data[i+2] - data[up+2]);

                if (diffLeft > 20 || diffUp > 20) blockEdges++;

                // Check for over-smooth blocks (AI generation signature)
                let blockVariance = 0, blockCount = 0;
                for (let dy = 0; dy < blockSize && y + dy < size; dy++) {
                    for (let dx = 0; dx < blockSize && x + dx < size; dx++) {
                        const idx = ((y + dy) * size + (x + dx)) * 4;
                        const gray = (data[idx] + data[idx+1] + data[idx+2]) / 3;
                        blockVariance += gray * gray;
                        blockCount++;
                    }
                }
                blockVariance /= blockCount;
                if (blockVariance < 100) smoothBlocks++; // Unnaturally smooth

                total++;
            }
        }

        const blockRatio = blockEdges / total;
        const smoothRatio = smoothBlocks / total;
        blockScores.push({ size: blockSize, edgeRatio: blockRatio, smoothRatio });
    }

    // Bilinear/Bicubic interpolation detection (AI upscaling signature)
    let interpolationArtifacts = 0;
    for (let y = 2; y < size - 2; y += 4) {
        for (let x = 2; x < size - 2; x += 4) {
            const center = (y * size + x) * 4;
            const neighbors = [
                ((y-1) * size + x) * 4,
                ((y+1) * size + x) * 4,
                (y * size + (x-1)) * 4,
                (y * size + (x+1)) * 4
            ];

            // Check if center pixel is average of neighbors (interpolation)
            let avgR = 0, avgG = 0, avgB = 0;
            for (const n of neighbors) {
                avgR += data[n];
                avgG += data[n+1];
                avgB += data[n+2];
            }
            avgR /= 4; avgG /= 4; avgB /= 4;

            const centerDiff = Math.abs(data[center] - avgR) +
                             Math.abs(data[center+1] - avgG) +
                             Math.abs(data[center+2] - avgB);

            if (centerDiff < 5) interpolationArtifacts++; // Too perfect interpolation
        }
    }
    const interpolationRatio = interpolationArtifacts / ((size / 4) * (size / 4));

    // ==================== ADVANCED SCORING - SCREENSHOT VS AI VS REAL ====================
    let score = 50;

    const jpeg8x8 = blockScores.find(b => b.size === 8).edgeRatio;
    const block4x4 = blockScores.find(b => b.size === 4).edgeRatio;
    const ai16x16 = blockScores.find(b => b.size === 16).edgeRatio;
    const smoothRatio8x8 = blockScores.find(b => b.size === 8).smoothRatio;

    // Factor 1: Block pattern analysis
    // Real photos: Strong 8x8 JPEG blocks
    // Screenshots: Very low block edges (PNG/lossless compression)
    // AI: 16x16 patterns from neural upscaling

    if (jpeg8x8 > 0.35) {
        score -= 20; // Strong JPEG artifacts = likely real photo
    } else if (jpeg8x8 < 0.1 && block4x4 < 0.1 && ai16x16 < 0.1) {
        // Very few block artifacts = screenshot or PNG
        score -= 15; // Likely screenshot (REAL)
    }

    if (ai16x16 > jpeg8x8 * 1.8) {
        score += 30; // AI upscaling dominant
    } else if (ai16x16 > jpeg8x8 * 1.2) {
        score += 18;
    }

    // Factor 2: Over-smooth blocks (GAN/diffusion signature)
    // Real photos and screenshots have detail, AI is often too smooth
    if (smoothRatio8x8 > 0.6) {
        score += 25; // Extremely smooth = GAN
    } else if (smoothRatio8x8 > 0.45) {
        score += 15;
    } else if (smoothRatio8x8 > 0.3) {
        score += 8;
    } else if (smoothRatio8x8 < 0.15) {
        score -= 12; // Lots of detail = likely real
    }

    // Factor 3: Interpolation artifacts (AI upscaling signature)
    if (interpolationRatio > 0.45) {
        score += 25; // Strong AI upscaling
    } else if (interpolationRatio > 0.30) {
        score += 15;
    } else if (interpolationRatio > 0.20) {
        score += 8;
    } else if (interpolationRatio < 0.1) {
        score -= 10; // Natural image (real or screenshot)
    }

    // Factor 4: PNG/Screenshot detection
    // Screenshots typically have very uniform blocks and low compression
    if (jpeg8x8 < 0.05 && smoothRatio8x8 < 0.2) {
        score -= 20; // Likely screenshot - REAL
    }

    // Factor 5: Multi-signal agreement
    let aiSignals = 0;
    let realSignals = 0;

    if (ai16x16 > jpeg8x8 * 1.5) aiSignals++;
    if (smoothRatio8x8 > 0.45) aiSignals++;
    if (interpolationRatio > 0.30) aiSignals++;

    if (jpeg8x8 > 0.35) realSignals++;
    if (smoothRatio8x8 < 0.2) realSignals++;
    if (interpolationRatio < 0.1) realSignals++;

    if (aiSignals >= 2) score += 12;
    if (realSignals >= 2) score -= 15;

    return clamp(score, 10, 95);
}

function analyzeColorDistribution(img) {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const size = Math.min(img.width, img.height, 256);
    canvas.width = size; canvas.height = size;
    ctx.drawImage(img, 0, 0, size, size);
    const data = ctx.getImageData(0, 0, size, size).data;
    
    // Build color histogram
    const histR = new Array(256).fill(0);
    const histG = new Array(256).fill(0);
    const histB = new Array(256).fill(0);
    
    for (let i = 0; i < data.length; i += 4) {
        histR[data[i]]++;
        histG[data[i+1]]++;
        histB[data[i+2]]++;
    }
    
    // Count peaks (local maxima) - AI tends to have fewer, smoother peaks
    function countPeaks(hist) {
        let peaks = 0;
        for (let i = 3; i < 253; i++) {
            if (hist[i] > hist[i-1] && hist[i] > hist[i+1] &&
                hist[i] > hist[i-2] && hist[i] > hist[i+2] &&
                hist[i] > hist[i-3] && hist[i] > hist[i+3]) {
                peaks++;
            }
        }
        return peaks;
    }
    
    const totalPeaks = countPeaks(histR) + countPeaks(histG) + countPeaks(histB);
    
    // Calculate histogram smoothness
    let smoothness = 0;
    for (let c of [histR, histG, histB]) {
        for (let i = 1; i < 255; i++) {
            smoothness += Math.abs(c[i] - (c[i-1] + c[i+1]) / 2);
        }
    }
    smoothness /= (size * size * 3);
    
    // AI images often have smoother histograms with fewer peaks
    let score = 50;
    if (totalPeaks < 10) score += 20;
    else if (totalPeaks < 20) score += 10;
    else if (totalPeaks > 40) score -= 15;
    
    if (smoothness < 0.5) score += 15;
    else if (smoothness < 1) score += 5;
    else if (smoothness > 3) score -= 10;
    
    return clamp(score, 20, 85);
}

function analyzeEdgeCoherence(img) {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const size = Math.min(img.width, img.height, 128);
    canvas.width = size; canvas.height = size;
    ctx.drawImage(img, 0, 0, size, size);
    const data = ctx.getImageData(0, 0, size, size).data;
    
    // Simple Sobel edge detection
    let edgeStrength = 0, edgeCount = 0;
    
    for (let y = 1; y < size - 1; y++) {
        for (let x = 1; x < size - 1; x++) {
            const idx = (y * size + x) * 4;
            const gray = (data[idx] + data[idx+1] + data[idx+2]) / 3;
            
            // Get neighbors
            const grayL = (data[idx-4] + data[idx-3] + data[idx-2]) / 3;
            const grayR = (data[idx+4] + data[idx+5] + data[idx+6]) / 3;
            const grayU = (data[idx-size*4] + data[idx-size*4+1] + data[idx-size*4+2]) / 3;
            const grayD = (data[idx+size*4] + data[idx+size*4+1] + data[idx+size*4+2]) / 3;
            
            const gx = grayR - grayL;
            const gy = grayD - grayU;
            const magnitude = Math.sqrt(gx*gx + gy*gy);
            
            if (magnitude > 20) {
                edgeStrength += magnitude;
                edgeCount++;
            }
        }
    }
    
    const avgEdge = edgeCount > 0 ? edgeStrength / edgeCount : 0;
    const edgeDensity = edgeCount / (size * size);
    
    // AI images often have unnaturally sharp or smooth edges
    let score = 50;
    
    if (avgEdge > 80) score += 15; // Overly sharp
    else if (avgEdge < 25) score += 20; // Too smooth
    
    if (edgeDensity < 0.05) score += 15; // Very few edges
    else if (edgeDensity > 0.4) score += 10; // Too many edges
    
    return clamp(score, 25, 80);
}

function analyzeFrequencyDomain(img) {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const size = 64; // Small for speed
    canvas.width = size; canvas.height = size;
    ctx.drawImage(img, 0, 0, size, size);
    const data = ctx.getImageData(0, 0, size, size).data;
    
    // Simple frequency analysis via gradient magnitudes at different scales
    let lowFreq = 0, highFreq = 0;
    
    // Low frequency: large-scale changes
    for (let y = 0; y < size - 8; y += 8) {
        for (let x = 0; x < size - 8; x += 8) {
            const i1 = (y * size + x) * 4;
            const i2 = ((y + 8) * size + (x + 8)) * 4;
            lowFreq += Math.abs(data[i1] - data[i2]);
        }
    }
    
    // High frequency: pixel-level changes
    for (let y = 0; y < size - 1; y++) {
        for (let x = 0; x < size - 1; x++) {
            const i1 = (y * size + x) * 4;
            const i2 = (y * size + x + 1) * 4;
            highFreq += Math.abs(data[i1] - data[i2]);
        }
    }
    
    const ratio = lowFreq / (highFreq + 1);
    
    // AI images often have unusual frequency ratios
    if (ratio < 0.02) return 70; // Too much high freq (noise)
    if (ratio < 0.05) return 55;
    if (ratio > 0.5) return 65; // Too little high freq (smooth)
    if (ratio > 0.3) return 55;
    return 40;
}

function analyzeModelOutput(results) {
    // Analyze the confidence distribution from the model
    // AI images often produce different confidence patterns
    
    if (!results || results.length === 0) return 50;
    
    const topScore = results[0].score;
    const secondScore = results.length > 1 ? results[1].score : 0;
    const gap = topScore - secondScore;
    
    // Very high confidence or very uncertain both can indicate AI
    let score = 50;
    
    if (topScore > 0.9) score += 15; // Overconfident
    else if (topScore < 0.3) score += 20; // Very uncertain (unfamiliar)
    
    if (gap > 0.7) score += 10; // One dominant class
    else if (gap < 0.1) score += 15; // Confusion between classes
    
    // Check for common AI-generated content patterns
    const labels = results.map(r => r.label.toLowerCase());
    const aiIndicators = ['digital', 'graphic', 'render', 'art', 'illustration', 'cartoon'];
    const realIndicators = ['photo', 'camera', 'outdoor', 'indoor', 'person', 'animal'];
    
    for (const label of labels.slice(0, 3)) {
        if (aiIndicators.some(ind => label.includes(ind))) score += 10;
        if (realIndicators.some(ind => label.includes(ind))) score -= 5;
    }
    
    return clamp(score, 25, 85);
}

async function analyzeMultipleCrops(img) {
    const regions = [
        { x: 0.1, y: 0.1, w: 0.35, h: 0.35 },   // Top-left
        { x: 0.55, y: 0.1, w: 0.35, h: 0.35 },  // Top-right
        { x: 0.1, y: 0.55, w: 0.35, h: 0.35 },  // Bottom-left
        { x: 0.55, y: 0.55, w: 0.35, h: 0.35 }, // Bottom-right
        { x: 0.25, y: 0.25, w: 0.5, h: 0.5 }    // Center
    ];
    
    const scores = [];
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    for (const region of regions) {
        const sx = img.width * region.x;
        const sy = img.height * region.y;
        const sw = img.width * region.w;
        const sh = img.height * region.h;
        
        canvas.width = 64; canvas.height = 64;
        ctx.drawImage(img, sx, sy, sw, sh, 0, 0, 64, 64);
        
        const data = ctx.getImageData(0, 0, 64, 64).data;
        
        // Quick variance check for each crop
        let sum = 0, sumSq = 0;
        for (let i = 0; i < data.length; i += 4) {
            const gray = (data[i] + data[i+1] + data[i+2]) / 3;
            sum += gray; sumSq += gray * gray;
        }
        const n = data.length / 4;
        const mean = sum / n;
        const variance = (sumSq / n) - (mean * mean);
        
        // Low variance in multiple regions suggests AI
        if (variance < 500) scores.push(70);
        else if (variance < 1500) scores.push(55);
        else scores.push(40);
        
        await sleep(10);
    }
    
    // Return average with consistency boost
    const avg = scores.reduce((a, b) => a + b, 0) / scores.length;
    const allHigh = scores.every(s => s > 55);
    const allLow = scores.every(s => s < 50);
    
    if (allHigh) return Math.min(85, avg * 1.1);
    if (allLow) return Math.max(25, avg * 0.9);
    return avg;
}

// ==================== METADATA & EXIF ANALYSIS ====================
async function analyzeEXIFData(file) {
    // Check for EXIF data that indicates real camera vs AI generation
    if (!file) return 50;

    try {
        const arrayBuffer = await file.arrayBuffer();
        const view = new DataView(arrayBuffer);

        // Check for JPEG marker (FF D8)
        if (view.getUint8(0) !== 0xFF || view.getUint8(1) !== 0xD8) {
            return 55; // Not JPEG, slightly suspicious
        }

        // Look for EXIF marker (APP1)
        let hasEXIF = false;
        let hasCameraModel = false;
        let hasSoftware = false;

        for (let offset = 2; offset < view.byteLength - 4; offset++) {
            if (view.getUint8(offset) === 0xFF && view.getUint8(offset + 1) === 0xE1) {
                hasEXIF = true;

                // Check for common EXIF strings
                const chunk = arrayBuffer.slice(offset, offset + 500);
                const text = String.fromCharCode(...new Uint8Array(chunk));

                if (text.includes('Canon') || text.includes('Nikon') || text.includes('Sony') ||
                    text.includes('iPhone') || text.includes('Samsung') || text.includes('Pixel')) {
                    hasCameraModel = true;
                }

                if (text.includes('Adobe') || text.includes('Photoshop') || text.includes('GIMP') ||
                    text.includes('Midjourney') || text.includes('DALL') || text.includes('Stable Diffusion')) {
                    hasSoftware = true;
                }
                break;
            }
        }

        // ==================== IMPROVED EXIF SCORING ====================
        // Real camera photos: EXIF + camera model, no AI software
        // Screenshots: No EXIF (perfectly normal for screenshots!)
        // AI images: No EXIF OR suspicious software tags

        if (hasEXIF && hasCameraModel && !hasSoftware) {
            return 15; // Strong indicator of real camera photo
        }

        if (hasSoftware) {
            return 85; // AI generation or editing software detected
        }

        if (!hasEXIF) {
            // No EXIF could mean:
            // 1. Screenshot (REAL and common!)
            // 2. Stripped metadata (privacy)
            // 3. AI generated
            // Don't penalize heavily - let other signals decide
            return 50; // Neutral - check other factors
        }

        return 45; // Has EXIF but no camera model (edited photo?)

    } catch (e) {
        console.error('[EXIF] Analysis failed:', e);
        return 50;
    }
}

async function analyzeMetadata(file) {
    // ==================== ENHANCED METADATA ANALYSIS ====================
    if (!file) return 50;

    let score = 50;

    // File size vs dimensions ratio
    const fileSizeKB = file.size / 1024;
    const img = new Image();
    await new Promise((res) => { img.onload = res; img.src = currentDataUrl; });

    const pixels = img.width * img.height;
    const bytesPerPixel = file.size / pixels;

    // Compression ratio analysis
    // Real photos (JPEG): 0.1-1.0 bytes/pixel
    // Screenshots (PNG): 0.5-3.0 bytes/pixel
    // AI (optimized export): <0.08 or >4.0 bytes/pixel
    if (bytesPerPixel < 0.08) {
        score += 18; // Over-compressed = likely AI export
    } else if (bytesPerPixel >= 0.1 && bytesPerPixel <= 1.0) {
        score -= 15; // Normal JPEG = likely real photo
    } else if (bytesPerPixel >= 0.5 && bytesPerPixel <= 3.0) {
        score -= 18; // PNG range = likely screenshot (REAL)
    } else if (bytesPerPixel > 4.0) {
        score += 10; // Unusual compression
    }

    // Filename pattern analysis
    const name = file.name.toLowerCase();

    // AI generation patterns
    const aiPatterns = ['dall', 'midjourney', 'stable', 'diffusion', 'generated', 'ai_', 'synthetic', 'fake', 'output', 'gan', 'openai', 'replicate'];

    // Real image patterns (including screenshots!)
    const realPatterns = ['img_', 'dsc_', 'photo', 'pxl_', 'screenshot', 'screen shot', 'capture', 'snap', 'camera', 'pic_'];

    let aiPatternMatch = false;
    let realPatternMatch = false;

    for (const pattern of aiPatterns) {
        if (name.includes(pattern)) {
            score += 25; // Strong AI indicator
            aiPatternMatch = true;
        }
    }

    for (const pattern of realPatterns) {
        if (name.includes(pattern)) {
            score -= 15; // Strong real/screenshot indicator
            realPatternMatch = true;
        }
    }

    // File extension check
    const ext = name.split('.').pop();
    if (ext === 'png') {
        score -= 10; // PNG often used for screenshots (REAL)
    } else if (ext === 'jpg' || ext === 'jpeg') {
        score -= 5; // JPEG common for both real and AI
    } else if (ext === 'webp') {
        score += 8; // WebP sometimes used by AI generators
    }

    // Dimension analysis
    // AI generators love certain sizes: 512x512, 1024x1024, 768x768
    const w = img.width;
    const h = img.height;

    if ((w === 512 && h === 512) || (w === 1024 && h === 1024) ||
        (w === 768 && h === 768) || (w === 2048 && h === 2048)) {
        score += 20; // Common AI generation sizes
    }

    // Screenshots often have exact desktop resolutions
    const commonScreenSizes = [
        [1920, 1080], [2560, 1440], [3840, 2160], // Desktop
        [1366, 768], [1280, 720], [1440, 900], // Laptop
        [1170, 2532], [1284, 2778], [1125, 2436] // Mobile
    ];

    for (const [sw, sh] of commonScreenSizes) {
        if ((w === sw && h === sh) || (w === sh && h === sw)) {
            score -= 20; // Common screenshot size = REAL
            break;
        }
    }

    // File age check
    if (file.lastModified) {
        const now = Date.now();
        const age = now - file.lastModified;

        // Very recent files might be just-generated AI
        // But could also be fresh screenshot or photo
        // Don't weight this heavily
        if (age < 60000) {
            score += 3; // Slight suspicion only
        }
    }

    return clamp(score, 15, 85);
}

function updateProgress(percent, status) {
    $('progressBar').style.width = percent + '%';
    $('progressStatus').textContent = status;
}

window.cancelScan = () => { 
    analysisAborted = true; 
    $('progressCard').classList.add('hidden'); 
    toast('Scan cancelled'); 
};

// ==================== RESULTS DISPLAY ====================
function displayResults(result, mode) {
    $('progressCard').classList.add('hidden'); 
    $('resultCard').classList.remove('hidden');
    
    const { aiScore, isAI, confidence, breakdown } = result;
    
    // Determine label and icon
    let label, iconClass, icon;
    if (aiScore >= 75) { 
        label = 'Likely AI Generated'; iconClass = 'fake'; icon = '';
    } else if (aiScore >= 60) { 
        label = 'Probably AI'; iconClass = 'fake'; icon = '';
    } else if (aiScore >= 45) { 
        label = 'Uncertain'; iconClass = 'uncertain'; icon = '';
    } else if (aiScore >= 30) { 
        label = 'Probably Real'; iconClass = 'real'; icon = '';
    } else { 
        label = 'Likely Real'; iconClass = 'real'; icon = '';
    }
    
    $('resultLabel').textContent = label;
    $('resultSublabel').textContent = `${mode === 'quick' ? 'Quick' : mode === 'forensics' ? 'Forensics' : 'Deep'} Scan`;
    $('resultIcon').className = 'result-icon ' + iconClass;
    $('resultIcon').textContent = icon;
    
    $('confidenceBadge').className = 'confidence-badge confidence-' + confidence;
    $('confidenceText').textContent = confidence.charAt(0).toUpperCase() + confidence.slice(1) + ' Confidence';
    
    $('scoreFill').style.width = aiScore + '%';
    $('scoreFill').className = 'score-fill ' + iconClass;
    $('scoreValue').textContent = `AI Probability: ${aiScore}%`;
    
    // Glow effect
    const glowColor = isAI ? 'rgba(255,71,87,.3)' : aiScore >= 45 ? 'rgba(255,165,2,.3)' : 'rgba(46,213,115,.3)';
    $('resultGlow').style.background = `radial-gradient(circle, ${glowColor} 0%, transparent 70%)`;
    
    // Generate explainers
    const explainers = generateExplainers(result);
    $('explainersContent').innerHTML = explainers;
    $('explainersContent').classList.add('show');
    $('explainersToggle').textContent = '';
    
    // Reset feedback buttons
    document.querySelectorAll('.feedback-btn').forEach(b => b.classList.remove('selected'));
    
    currentResult = result;
}

function generateExplainers(result) {
    const { moduleExplanations, aiScore, mode, confidence } = result;
    let html = '';

    // If we have the new comprehensive module explanations
    if (moduleExplanations && moduleExplanations.length > 0) {
        // First show triggered modules (strong signals)
        const triggered = moduleExplanations.filter(m => m.triggered);
        const notTriggered = moduleExplanations.filter(m => !m.triggered);

        if (triggered.length > 0) {
            html += `<div class="explainer-section">
                <div class="explainer-section-title"> Key Detection Signals (${triggered.length} modules triggered)</div>
            `;

            triggered.forEach(module => {
                const isAIIndicator = module.confidence > 55;
                const strength = module.confidence > 70 ? 'Strong' : module.confidence > 60 ? 'Moderate' : module.confidence < 30 ? 'Strong' : module.confidence < 40 ? 'Moderate' : 'Weak';
                const direction = module.confidence > 55 ? 'AI' : 'Real';

                html += `
                    <div class="module-card ${isAIIndicator ? 'ai-indicator' : 'real-indicator'}">
                        <div class="module-header">
                            <span class="module-icon">${module.icon}</span>
                            <span class="module-name">${module.name}</span>
                            <span class="module-confidence" style="color: ${isAIIndicator ? '#ff4757' : '#2ed573'}">${strength} ${direction}</span>
                        </div>
                        <div class="module-reason">${module.reason}</div>
                        <div class="module-technical">
                            <span class="tech-label">Technical:</span> ${module.technical}
                        </div>
                        <div class="module-meter">
                            <div class="module-meter-fill" style="width: ${module.confidence}%; background: ${isAIIndicator ? 'linear-gradient(90deg, #ff6b81, #ff4757)' : 'linear-gradient(90deg, #7bed9f, #2ed573)'}"></div>
                        </div>
                        <div class="module-score">${module.confidence}% confidence</div>
                    </div>
                `;
            });

            html += `</div>`;
        }

        // Show all other modules in collapsed section
        if (notTriggered.length > 0) {
            html += `
                <div class="explainer-section" style="margin-top: 12px;">
                    <div class="explainer-section-toggle" onclick="toggleAllModules()" style="cursor:pointer;display:flex;justify-content:space-between;align-items:center;padding:8px;background:var(--card);border-radius:8px;">
                        <span class="explainer-section-title" style="margin:0"> All Detection Modules (${notTriggered.length} more)</span>
                        <span id="allModulesToggle"></span>
                    </div>
                    <div id="allModulesContent" class="all-modules-content" style="display:none;margin-top:8px;">
            `;

            notTriggered.forEach(module => {
                const isAIIndicator = module.confidence > 55;

                html += `
                    <div class="module-card-compact">
                        <div class="module-compact-header">
                            <span class="module-icon">${module.icon}</span>
                            <span class="module-name">${module.name}</span>
                            <span class="module-compact-score" style="color: ${module.confidence > 55 ? '#ff6b81' : module.confidence < 45 ? '#7bed9f' : '#a4b0be'}">${module.confidence}%</span>
                        </div>
                        <div class="module-compact-meter">
                            <div class="module-compact-meter-fill" style="width: ${module.confidence}%; background: ${module.confidence > 55 ? '#ff6b81' : module.confidence < 45 ? '#7bed9f' : '#a4b0be'}"></div>
                        </div>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            `;
        }

        // Summary statistics
        const avgConfidence = Math.round(moduleExplanations.reduce((sum, m) => sum + m.confidence, 0) / moduleExplanations.length);
        const aiVotes = moduleExplanations.filter(m => m.confidence > 55).length;
        const realVotes = moduleExplanations.filter(m => m.confidence < 45).length;

        html += `
            <div class="detection-summary">
                <div class="summary-stat">
                    <span class="summary-label">Module Agreement:</span>
                    <span class="summary-value">${aiVotes} vote AI, ${realVotes} vote Real</span>
                </div>
                <div class="summary-stat">
                    <span class="summary-label">Average Confidence:</span>
                    <span class="summary-value">${avgConfidence}%</span>
                </div>
            </div>
        `;

    } else {
        // Fallback to old explainer format for backward compatibility
        const { breakdown } = result;

        if (breakdown.noise > 65 || breakdown.noise < 35) {
            html += `<div class="explainer-item"><span class="explainer-icon"></span><span class="explainer-text">${breakdown.noise > 65 ? 'Noise patterns appear unnaturally uniform - common in AI images' : 'Natural camera sensor noise detected'}</span></div>`;
        }
        if (breakdown.compression > 60) {
            html += `<div class="explainer-item"><span class="explainer-icon"></span><span class="explainer-text">Periodic compression artifacts detected - may indicate AI upscaling</span></div>`;
        }
        if (breakdown.color > 60 || breakdown.color < 35) {
            html += `<div class="explainer-item"><span class="explainer-icon"></span><span class="explainer-text">${breakdown.color > 60 ? 'Color distribution appears mathematically smooth' : 'Natural color variation consistent with real photography'}</span></div>`;
        }
        if (breakdown.edges > 60) {
            html += `<div class="explainer-item"><span class="explainer-icon"></span><span class="explainer-text">Edge coherence patterns suggest synthetic generation</span></div>`;
        }
    }

    // Add suggestion for low confidence quick scans
    if (mode === 'quick' && confidence === 'low' && !user) {
        html += `<div class="explainer-item" style="border-top:1px dashed var(--border);padding-top:8px;margin-top:12px">
            <span class="explainer-icon"></span>
            <span class="explainer-text">Sign in for Deep Scan with 90%+ accuracy and detailed module breakdown</span>
        </div>`;
    }

    // Fallback if still no content
    if (!html) {
        html = `<div class="explainer-item"><span class="explainer-icon"></span><span class="explainer-text">Analysis based on multiple image characteristics</span></div>`;
    }

    return html;
}

window.toggleExplainers = () => {
    $('explainersContent').classList.toggle('show');
    $('explainersToggle').textContent = $('explainersContent').classList.contains('show') ? '' : '';
};

window.toggleAllModules = () => {
    const content = $('allModulesContent');
    const toggle = $('allModulesToggle');
    if (content && toggle) {
        if (content.style.display === 'none') {
            content.style.display = 'block';
            toggle.textContent = '';
        } else {
            content.style.display = 'none';
            toggle.textContent = '';
        }
    }
};

// ==================== FEEDBACK ====================
window.submitFeedback = function(type) {
    document.querySelectorAll('.feedback-btn').forEach(b => b.classList.remove('selected'));
    event.target.closest('.feedback-btn').classList.add('selected');

    // ==================== SELF-LEARNING INTEGRATION ====================
    // Update adaptive weights based on user feedback
    if (currentResult && currentResult._rawSignals) {
        const wasCorrect = type === 'correct';
        const userSaidAI = currentResult.isAI; // The prediction we made

        // Update weights to improve future predictions
        updateWeightsFromFeedback(currentResult._rawSignals, wasCorrect, userSaidAI);

        console.log(`[LEARN] Feedback processed: ${type}. System is improving!`);
    }

    const feedback = {
        scanId: Date.now().toString(),
        user_id: user?.id || 'guest',
        type,
        aiScore: currentResult?.aiScore,
        mode: currentResult?.mode,
        confidence: currentResult?.confidence,
        version: DETECTOR_VERSION,
        timestamp: new Date().toISOString(),
        // Include signals for analytics
        signals: currentResult?._rawSignals || null
    };

    // Store locally
    const log = JSON.parse(localStorage.getItem('feedback_log') || '[]');
    log.push(feedback);
    if (log.length > 200) log.shift();
    localStorage.setItem('feedback_log', JSON.stringify(log));

    // Sync to Supabase
    if (!useLocalFallback && supabase && user) {
        supabase.from('feedback').insert({
            user_id: user.id,
            feedback_type: type,
            ai_score: currentResult?.aiScore,
            scan_mode: currentResult?.mode,
            confidence: currentResult?.confidence,
            detector_version: DETECTOR_VERSION
        }).catch(() => {});
    }

    // Enhanced feedback messages showing learning progress
    const accuracy = adaptiveWeights.totalFeedback > 0 ?
        ((adaptiveWeights.correctPredictions / adaptiveWeights.totalFeedback) * 100).toFixed(0) : 0;

    const messages = {
        correct: ` Perfect! AI improving... (${accuracy}% accuracy)`,
        incorrect: ` Learning from this! (${accuracy}% accuracy)`,
        unsure: ` Noted! Thanks for helping us improve.`
    };

    toast(messages[type] || messages.unsure);
};

// ==================== SHARE & NEW SCAN ====================
window.shareResult = async function() {
    if (!currentResult) return;
    
    const text = `AuthenticaDetector: ${$('resultLabel').textContent}\nAI Probability: ${currentResult.aiScore}%\nConfidence: ${currentResult.confidence}\n\nTry it: ${location.origin}`;
    
    if (navigator.share) {
        try { 
            await navigator.share({ title: 'AuthenticaDetector Result', text }); 
        } catch (e) { 
            if (e.name !== 'AbortError') copyToClipboard(text); 
        }
    } else {
        copyToClipboard(text);
    }
};

function copyToClipboard(text) {
    navigator.clipboard.writeText(text)
        .then(() => toast(' Copied to clipboard!'))
        .catch(() => toast('Could not copy'));
}

window.newScan = () => {
    currentFile = null; currentDataUrl = null; currentResult = null;
    $('dropzonePreview').classList.add('hidden'); 
    $('dropzoneContent').classList.remove('hidden');
    $('dropzone').classList.remove('has-file'); 
    $('resultCard').classList.add('hidden'); 
    $('progressCard').classList.add('hidden');
    $('quickBtn').disabled = true; 
    $('deepBtn').disabled = true; 
    $('fileInput').value = '';
};

// ==================== ADVANCED SETTINGS ====================
window.toggleAdvanced = () => { 
    $('advancedContent').classList.toggle('show'); 
    $('advancedToggle').textContent = $('advancedContent').classList.contains('show') ? '' : '';
};
window.updateForensics = () => { 
    forensicsMode = $('forensicsToggle').checked; 
};

// ==================== HISTORY ====================
async function saveToHistory(result, mode) {
    if (!user) return;
    
    const entry = {
        id: Date.now().toString(),
        resultLabel: $('resultLabel').textContent,
        confidence: result.confidence,
        aiScore: result.aiScore,
        isAI: result.isAI,
        mode: mode,
        fileName: currentFile?.name,
        version: DETECTOR_VERSION,
        createdAt: new Date().toISOString()
    };
    
    // Save to Supabase
    if (!useLocalFallback && supabase) {
        try {
            await supabase.from('scans').insert({
                user_id: user.id,
                media_type: 'image',
                scan_mode: mode,
                result_label: entry.resultLabel,
                confidence: entry.confidence,
                ai_score: entry.aiScore,
                is_ai: entry.isAI,
                file_name: entry.fileName,
                detector_version: DETECTOR_VERSION
            });
        } catch (e) { console.error('[History] Save failed:', e); }
    }
    
    // Always save locally as backup
    const h = JSON.parse(localStorage.getItem(`history_${user.id}`) || '[]');
    h.unshift(entry);
    if (h.length > 100) h.pop();
    localStorage.setItem(`history_${user.id}`, JSON.stringify(h));
}

async function loadHistory() {
    if (!user) {
        $('historyContent').innerHTML = '<div class="history-empty"><div style="font-size:40px;margin-bottom:8px"></div><p>Sign in to see your history</p></div>';
        return;
    }
    
    let history = [];
    
    if (!useLocalFallback && supabase) {
        try {
            const { data } = await supabase.from('scans')
                .select('*')
                .eq('user_id', user.id)
                .order('created_at', { ascending: false })
                .limit(50);
            if (data) {
                history = data.map(d => ({
                    id: d.id,
                    resultLabel: d.result_label,
                    aiScore: d.ai_score,
                    isAI: d.is_ai,
                    mode: d.scan_mode,
                    createdAt: d.created_at
                }));
            }
        } catch (e) {}
    }
    
    // Merge with local
    const local = JSON.parse(localStorage.getItem(`history_${user.id}`) || '[]');
    if (local.length > history.length) history = local;
    
    if (history.length === 0) {
        $('historyContent').innerHTML = '<div class="history-empty"><div style="font-size:40px;margin-bottom:8px"></div><p>No scans yet. Start scanning!</p></div>';
        return;
    }
    
    let html = '';
    for (const item of history) {
        const date = new Date(item.createdAt).toLocaleDateString();
        const scoreClass = item.isAI ? 'fake' : 'real';
        html += `
            <div class="history-item">
                <div class="history-thumb"></div>
                <div class="history-info">
                    <div class="history-result">${item.resultLabel}</div>
                    <div class="history-meta">${item.mode}  ${date}</div>
                </div>
                <div class="history-score ${scoreClass}">${item.aiScore}%</div>
            </div>
        `;
    }
    $('historyContent').innerHTML = html;
}

window.openHistory = () => { loadHistory(); showView('historyView'); };

// ==================== LEADERBOARD ====================
async function loadLeaderboard() {
    let lb = [];
    
    if (!useLocalFallback && supabase) {
        try {
            const { data } = await supabase.from('leaderboard').select('*').limit(100);
            if (data) lb = data;
        } catch (e) {}
    }
    
    // Demo/fallback data if no backend
    if (lb.length === 0) {
        const localUsers = JSON.parse(localStorage.getItem('local_users') || '{}');
        lb = Object.entries(localUsers).map(([email, u], i) => {
            const stats = JSON.parse(localStorage.getItem(`stats_local_${email}`) || localStorage.getItem(`stats_${email}`) || '{}');
            return {
                id: email,
                display_name: u.name || email.split('@')[0],
                avatar_url: u.avatar,
                total_scans: stats.total || 0,
                ai_found: stats.ai || 0,
                points: stats.points || (stats.total || 0) * 2
            };
        }).filter(u => u.points > 0)
          .sort((a, b) => b.points - a.points);
        
        // Add current user if logged in
        if (user) {
            const myStats = JSON.parse(localStorage.getItem(`stats_${user.id}`) || '{}');
            const existing = lb.find(u => u.id === user.id || u.id === user.email);
            if (!existing && myStats.total > 0) {
                lb.push({
                    id: user.id,
                    display_name: user.name,
                    avatar_url: user.avatar,
                    total_scans: myStats.total || 0,
                    ai_found: myStats.ai || 0,
                    points: myStats.points || 0
                });
                lb.sort((a, b) => b.points - a.points);
            }
        }
    }
    
    renderLeaderboard(lb);
}

function renderLeaderboard(data) {
    if (data.length === 0) {
        $('podium').innerHTML = '';
        $('leaderboardContent').innerHTML = '<div class="history-empty"><div style="font-size:40px;margin-bottom:8px"></div><p>No rankings yet. Be the first!</p></div>';
        return;
    }
    
    // Render podium (top 3)
    const top3 = data.slice(0, 3);
    const podiumOrder = [1, 0, 2]; // Display order: 2nd, 1st, 3rd
    const positions = ['second', 'first', 'third'];
    
    let podiumHtml = '';
    for (let i = 0; i < 3; i++) {
        const displayIdx = podiumOrder[i];
        const entry = top3[displayIdx];
        if (!entry) continue;
        
        const rank = displayIdx + 1;
        const tier = getTier(rank);
        const initial = entry.display_name ? entry.display_name[0].toUpperCase() : '?';
        const avatar = entry.avatar_url ? `<img src="${entry.avatar_url}">` : initial;
        const crown = rank === 1 ? '<div class="podium-crown"></div>' : '';
        
        podiumHtml += `
            <div class="podium-item ${positions[i]}" onclick="viewPublicProfile('${entry.id}')">
                <div class="podium-avatar">${crown}${avatar}</div>
                <div class="podium-name">${entry.display_name}</div>
                <div class="podium-points">${entry.points} pts</div>
                <span class="podium-tier ${tier.class}">${tier.name}</span>
            </div>
        `;
    }
    $('podium').innerHTML = podiumHtml;
    
    // Render rest of leaderboard
    let listHtml = '';
    for (let i = 3; i < data.length; i++) {
        const entry = data[i];
        const rank = i + 1;
        const tier = getTier(rank);
        const initial = entry.display_name ? entry.display_name[0].toUpperCase() : '?';
        const avatar = entry.avatar_url ? `<img src="${entry.avatar_url}">` : initial;
        
        listHtml += `
            <div class="lb-item" onclick="viewPublicProfile('${entry.id}')">
                <div class="lb-rank ${rank <= 10 ? 'top10' : 'normal'}">${rank}</div>
                <div class="lb-avatar">${avatar}</div>
                <div class="lb-info">
                    <div class="lb-name">${entry.display_name}</div>
                    <div class="lb-stats">${entry.total_scans} scans  ${entry.ai_found} AI found</div>
                </div>
                <div class="lb-points">${entry.points}</div>
                ${tier ? `<span class="lb-tier podium-tier ${tier.class}">${tier.name}</span>` : ''}
            </div>
        `;
    }
    $('leaderboardContent').innerHTML = listHtml;
}

window.openLeaderboard = () => { loadLeaderboard(); showView('leaderboardView'); };

// ==================== PUBLIC PROFILE ====================
window.viewPublicProfile = async function(userId) {
    let profile = null;
    
    if (!useLocalFallback && supabase) {
        try {
            const { data: p } = await supabase.from('profiles')
                .select('id,display_name,avatar_url,created_at')
                .eq('id', userId).single();
            const { data: s } = await supabase.from('user_stats')
                .select('total_scans,ai_found,points')
                .eq('user_id', userId).single();
            const { data: b } = await supabase.from('user_badges')
                .select('badge_id')
                .eq('user_id', userId);
            
            if (p) {
                profile = {
                    ...p,
                    total_scans: s?.total_scans || 0,
                    ai_found: s?.ai_found || 0,
                    points: s?.points || 0,
                    badges: b?.map(x => x.badge_id) || []
                };
            }
        } catch (e) {}
    }
    
    // Fallback to local
    if (!profile) {
        const localUsers = JSON.parse(localStorage.getItem('local_users') || '{}');
        const u = localUsers[userId] || (user?.id === userId ? user : null);
        if (u) {
            const stats = JSON.parse(localStorage.getItem(`stats_${userId}`) || '{}');
            const badges = JSON.parse(localStorage.getItem(`badges_${userId}`) || '[]');
            profile = {
                id: userId,
                display_name: u.name || userId.split('@')[0],
                avatar_url: u.avatar,
                created_at: new Date(u.created || Date.now()).toISOString(),
                total_scans: stats.total || 0,
                ai_found: stats.ai || 0,
                points: stats.points || 0,
                badges
            };
        }
    }
    
    if (!profile) { toast('Could not load profile'); return; }
    
    const days = Math.floor((Date.now() - new Date(profile.created_at)) / 86400000) || 1;
    const initial = profile.display_name[0].toUpperCase();
    const avatar = profile.avatar_url ? `<img src="${profile.avatar_url}" style="width:100%;height:100%;object-fit:cover">` : initial;
    
    // Earned badges only (PRIVACY)
    let badgesHtml = '';
    if (profile.badges?.length > 0) {
        badgesHtml = '<div style="margin-top:12px"><div style="font-size:12px;font-weight:700;margin-bottom:8px"> Badges Earned</div><div class="badges-grid" style="justify-content:center">';
        for (const bid of profile.badges.slice(0, 6)) {
            const b = BADGES[bid];
            if (b) badgesHtml += `<div class="badge"><div class="badge-icon ${b.rarity}">${b.icon}</div><div class="badge-name">${b.name}</div></div>`;
        }
        badgesHtml += '</div></div>';
    }
    
    $('publicProfileContent').innerHTML = `
        <div style="text-align:center">
            <div style="width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,var(--primary),#00ff88);margin:0 auto 12px;display:flex;align-items:center;justify-content:center;font-size:32px;font-weight:800;color:#000;overflow:hidden">${avatar}</div>
            <div style="font-size:20px;font-weight:800;margin-bottom:2px">${profile.display_name}</div>
            <div style="font-size:11px;color:var(--text3);margin-bottom:12px">Member for ${days} day${days !== 1 ? 's' : ''}</div>
            <div class="stats-grid" style="grid-template-columns:1fr 1fr 1fr">
                <div class="stat-card"><div class="stat-value">${profile.total_scans}</div><div class="stat-label">Scans</div></div>
                <div class="stat-card"><div class="stat-value">${profile.ai_found}</div><div class="stat-label">AI Found</div></div>
                <div class="stat-card"><div class="stat-value">${profile.points}</div><div class="stat-label">Points</div></div>
            </div>
            ${badgesHtml}
        </div>
    `;
    $('publicProfileModal').classList.add('show');
};

window.closePublicProfile = () => $('publicProfileModal').classList.remove('show');

// ==================== STATS & BADGES ====================
async function updateUserStatsAfterScan(result, mode) {
    if (!user) return;

    const key = `stats_${user.id}`;
    const stats = JSON.parse(localStorage.getItem(key) || '{"total":0,"ai":0,"deep":0,"quick":0,"forensics":0,"streak":0,"maxStreak":0,"points":0,"lastScanDate":"","dailyScans":0,"consecutiveDays":0}');

    // ==================== ENHANCED REWARDS SYSTEM ====================
    const today = new Date().toDateString();
    const lastScanDate = stats.lastScanDate || '';
    const yesterday = new Date(Date.now() - 86400000).toDateString();

    // Daily login bonus
    if (lastScanDate !== today) {
        if (lastScanDate === yesterday) {
            stats.consecutiveDays = (stats.consecutiveDays || 0) + 1;
            const dailyBonus = Math.min(stats.consecutiveDays * 10, 100); // Max 100 bonus
            stats.points += dailyBonus;
            toast(` Daily Login Bonus: +${dailyBonus} points! (${stats.consecutiveDays} day streak)`);
        } else {
            stats.consecutiveDays = 1; // Reset streak
        }
        stats.dailyScans = 0; // Reset daily counter
    }

    stats.lastScanDate = today;
    stats.dailyScans = (stats.dailyScans || 0) + 1;
    stats.total++;
    scanCount = stats.total;

    // Base points calculation with multipliers
    let basePoints = 0;
    let multiplier = 1.0;
    let bonusReasons = [];

    // Mode-specific base points
    if (mode === 'quick') {
        stats.quick = (stats.quick || 0) + 1;
        basePoints = 1;
    } else if (mode === 'forensics' || (mode === 'deep' && forensicsMode)) {
        stats.forensics = (stats.forensics || 0) + 1;
        basePoints = 5;
        multiplier += 0.2; // 20% bonus for forensics
        bonusReasons.push('Forensics Mode');
    } else {
        stats.deep = (stats.deep || 0) + 1;
        basePoints = 3;
    }

    // AI detection bonus
    if (result.isAI) {
        stats.ai++;
        stats.streak++;
        stats.maxStreak = Math.max(stats.maxStreak, stats.streak);
        basePoints += 5; // AI found bonus

        // Streak multiplier (up to 2x at 10 streak)
        if (stats.streak >= 3) {
            const streakBonus = Math.min(stats.streak * 0.1, 1.0);
            multiplier += streakBonus;
            bonusReasons.push(`${stats.streak}x Streak `);
        }
    } else {
        stats.streak = 0;
    }

    // Daily scan combo bonus
    if (stats.dailyScans >= 5) {
        multiplier += 0.1; // 10% bonus after 5 scans today
        bonusReasons.push('Daily Active');
    }
    if (stats.dailyScans >= 10) {
        multiplier += 0.2; // Additional 20% after 10 scans
        bonusReasons.push('Power User ');
    }

    // Weekend bonus (Saturday/Sunday)
    const dayOfWeek = new Date().getDay();
    if (dayOfWeek === 0 || dayOfWeek === 6) {
        multiplier += 0.15; // 15% weekend bonus
        bonusReasons.push('Weekend Warrior ');
    }

    // Consecutive days bonus
    if (stats.consecutiveDays >= 7) {
        multiplier += 0.3; // 30% bonus for week streak
        bonusReasons.push('Week Streak ');
    }

    // Calculate final points
    const earnedPoints = Math.round(basePoints * multiplier);
    stats.points += earnedPoints;

    // Show bonus notification if multiplier applied
    if (bonusReasons.length > 0 && multiplier > 1.0) {
        const multiplierText = `${(multiplier * 100).toFixed(0)}%`;
        toast(` +${earnedPoints} points (${multiplierText} multiplier: ${bonusReasons.join(', ')})`, 4000);
    }
    
    localStorage.setItem(key, JSON.stringify(stats));
    
    // Update UI
    $('statScans').textContent = stats.total;
    $('statFound').textContent = stats.ai;
    $('statPoints').textContent = stats.points;
    
    // Check badges
    checkBadges(stats);
    
    // Sync to Supabase
    if (!useLocalFallback && supabase) {
        try {
            await supabase.from('user_stats').upsert({
                user_id: user.id,
                total_scans: stats.total,
                ai_found: stats.ai,
                deep_scans: stats.deep,
                quick_scans: stats.quick,
                forensics_scans: stats.forensics,
                current_streak: stats.streak,
                max_streak: stats.maxStreak,
                points: stats.points
            });
        } catch (e) {}
    }
}

function checkBadges(stats) {
    if (!user) return;
    
    const key = `badges_${user.id}`;
    const earned = JSON.parse(localStorage.getItem(key) || '[]');
    const newBadges = [];
    
    for (const [id, badge] of Object.entries(BADGES)) {
        if (earned.includes(id)) continue;
        
        let met = false;
        switch (badge.type) {
            case 'total': met = stats.total >= badge.req; break;
            case 'ai': met = stats.ai >= badge.req; break;
            case 'deep': met = (stats.deep || 0) >= badge.req; break;
            case 'quick': met = (stats.quick || 0) >= badge.req; break;
            case 'forensics': met = (stats.forensics || 0) >= badge.req; break;
            case 'streak': met = stats.maxStreak >= badge.req; break;
        }
        
        if (met) {
            newBadges.push(id);
            earned.push(id);
        }
    }
    
    if (newBadges.length > 0) {
        localStorage.setItem(key, JSON.stringify(earned));
        
        for (const id of newBadges) {
            const badge = BADGES[id];
            toast(` Badge Earned: ${badge.name}!`);
        }
        
        // Sync to Supabase
        if (!useLocalFallback && supabase) {
            for (const bid of newBadges) {
                supabase.from('user_badges').insert({ user_id: user.id, badge_id: bid }).catch(() => {});
            }
        }
    }
}

function renderBadgesPreview() {
    if (!user) {
        $('badgesPreview').innerHTML = '<div style="font-size:10px;color:var(--text3);padding:12px;text-align:center">Sign in to earn badges</div>';
        return;
    }
    
    const earned = JSON.parse(localStorage.getItem(`badges_${user.id}`) || '[]');
    const allBadges = Object.values(BADGES);
    const earnedBadges = allBadges.filter(b => earned.includes(b.id));
    const lockedBadges = allBadges.filter(b => !earned.includes(b.id));
    
    const display = [...earnedBadges.slice(0, 4), ...lockedBadges.slice(0, 4 - earnedBadges.length)];
    
    let html = '';
    for (const b of display) {
        const isEarned = earned.includes(b.id);
        html += `
            <div class="badge">
                <div class="badge-icon ${isEarned ? b.rarity : 'locked'}">${isEarned ? b.icon : ''}</div>
                <div class="badge-name">${isEarned ? b.name : '???'}</div>
            </div>
        `;
    }
    $('badgesPreview').innerHTML = html;
}

window.openAllBadges = () => { renderAllBadges(); showView('allBadgesView'); };

function renderAllBadges() {
    const earned = user ? JSON.parse(localStorage.getItem(`badges_${user.id}`) || '[]') : [];
    
    const groups = { common: [], rare: [], epic: [], legendary: [] };
    for (const b of Object.values(BADGES)) {
        groups[b.rarity].push({ ...b, earned: earned.includes(b.id) });
    }
    
    const rarityNames = { common: 'Common', rare: 'Rare', epic: 'Epic', legendary: 'Legendary' };
    const rarityColors = { common: '#718096', rare: '#3182ce', epic: '#805ad5', legendary: '#d69e2e' };
    
    let html = '';
    for (const [rarity, badges] of Object.entries(groups)) {
        if (badges.length === 0) continue;
        
        html += `<div style="margin-bottom:16px">
            <h3 style="font-size:12px;color:${rarityColors[rarity]};margin-bottom:8px;text-transform:uppercase">${rarityNames[rarity]}</h3>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">`;
        
        for (const b of badges) {
            html += `
                <div style="background:var(--surface);border-radius:10px;padding:12px;text-align:center">
                    <div class="badge-icon ${b.earned ? b.rarity : 'locked'}" style="margin:0 auto 4px">${b.earned ? b.icon : ''}</div>
                    <div style="font-size:10px;font-weight:600;margin-bottom:2px">${b.earned ? b.name : '???'}</div>
                    <div style="font-size:8px;color:var(--text3)">${b.earned ? b.desc : 'Locked'}</div>
                </div>
            `;
        }
        html += '</div></div>';
    }
    
    $('allBadgesContent').innerHTML = html;
}

// ==================== PROFILE ====================
window.openProfile = () => { 
    loadUserStats(); 
    renderBadgesPreview(); 
    showView('profileView'); 
};

window.changeProfilePic = () => { 
    if (!user) { toast('Sign in first'); return; } 
    $('profilePicInput').click(); 
};

window.handleProfilePic = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    if (!file.type.startsWith('image/')) { toast('Select an image'); return; }
    if (file.size > 2 * 1024 * 1024) { toast('Max 2MB'); return; }
    
    const reader = new FileReader();
    reader.onload = async (e) => {
        user.avatar = e.target.result;
        saveUser();
        updateUserUI();
        
        if (!useLocalFallback && supabase) {
            try {
                await supabase.from('profiles').update({ avatar_url: user.avatar }).eq('id', user.id);
            } catch (e) {}
        }
        
        toast('Profile picture updated!');
    };
    reader.readAsDataURL(file);
};

// ==================== HELP ====================
window.openHelp = () => showView('helpView');
window.toggleHelp = (header) => {
    const content = header.nextElementSibling;
    const toggle = header.querySelector('.help-toggle');
    content.classList.toggle('show');
    toggle.textContent = content.classList.contains('show') ? '' : '';
};

// ==================== SHARE TARGET ====================
async function handleShareTarget() {
    const params = new URLSearchParams(location.search);
    if (params.get('share') === '1' && 'serviceWorker' in navigator && navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({ type: 'GET_SHARED_FILE' });
    }
}

if ('serviceWorker' in navigator) {
    navigator.serviceWorker.addEventListener('message', e => {
        if (e.data.type === 'SHARED_FILE') {
            const { file, name, mimeType } = e.data;
            const blob = new Blob([file], { type: mimeType });
            const f = new File([blob], name, { type: mimeType });
            processFile(f);
            toast(' Image received!');
            history.replaceState({}, '', '/');
            
            // Auto-analyze if user is logged in
            setTimeout(() => {
                if (user && currentFile) {
                    startScan('deep');
                } else if (currentFile) {
                    startScan('quick');
                }
            }, 500);
        }
    });
}

// ==================== INIT ====================
async function init() {
    console.log(`[AuthenticaDetector] v${APP_VERSION} starting...`);

    initSupabase();
    loadAdaptiveWeights(); // Load self-learning AI weights
    initLogos();
    initFacts();
    checkInstallState();

    await loadUser();
    renderBadgesPreview();
    updateGating();
    updateStatusBar();
    
    // Register service worker
    if ('serviceWorker' in navigator) {
        try {
            await navigator.serviceWorker.register('/sw.js');
            console.log('[SW] Registered');
        } catch (e) {
            console.log('[SW] Registration failed:', e);
        }
    }
    
    // Handle share target
    handleShareTarget();
    
    // Auth state listener
    if (!useLocalFallback && supabase) {
        supabase.auth.onAuthStateChange((event, session) => {
            console.log('[Auth] State change:', event);
            if (event === 'SIGNED_IN' && session?.user) {
                user = {
                    id: session.user.id,
                    email: session.user.email,
                    name: session.user.user_metadata?.display_name || session.user.email.split('@')[0]
                };
                saveUser();
                updateUserUI();
                loadUserStats();
            } else if (event === 'SIGNED_OUT') {
                user = null;
                saveUser();
                updateUserUI();
            }
        });
    }
    
    console.log(`[AuthenticaDetector] Ready! Installed: ${isInstalled}, User: ${user?.email || 'guest'}`);

    // Initialize game mechanics
    initGameMechanics();
}

// ==================== GAME MECHANICS ====================

// Shop Items Database
const SHOP_ITEMS = [
    // Power-ups
    { id: 'accuracy_boost', name: ' Accuracy Boost', desc: '+10% detection accuracy for 24h', price: 150, category: 'powerups', duration: 86400000 },
    { id: 'double_points', name: ' Double Points', desc: '2x points for next 10 scans', price: 100, category: 'powerups', uses: 10 },
    { id: 'auto_forensics', name: ' Auto Forensics', desc: 'Automatic forensics mode for 24h', price: 200, category: 'powerups', duration: 86400000 },
    { id: 'streak_shield', name: ' Streak Shield', desc: 'Protects your streak for 1 day', price: 50, category: 'powerups', uses: 1 },
    { id: 'instant_scan', name: ' Instant Scan', desc: 'Skip loading time (x5 uses)', price: 80, category: 'powerups', uses: 5 },

    // Cosmetics
    { id: 'rainbow_theme', name: ' Rainbow Theme', desc: 'Colorful animated background', price: 300, category: 'cosmetics', permanent: true },
    { id: 'gold_badge', name: ' Gold Badge Frame', desc: 'Golden border for your badges', price: 250, category: 'cosmetics', permanent: true },
    { id: 'custom_avatar', name: ' Custom Avatar', desc: 'Upload any profile picture', price: 200, category: 'cosmetics', permanent: true },
    { id: 'particle_effects', name: ' Particle Effects', desc: 'Sparkles on successful scans', price: 150, category: 'cosmetics', permanent: true },

    // Boosters
    { id: 'quest_doubler', name: ' Quest Doubler', desc: 'Double quest rewards for 24h', price: 180, category: 'boosters', duration: 86400000 },
    { id: 'badge_hunter', name: ' Badge Hunter', desc: '+50% progress to badges for 24h', price: 220, category: 'boosters', duration: 86400000 },
    { id: 'exp_boost', name: ' EXP Boost', desc: '3x experience for 12 hours', price: 120, category: 'boosters', duration: 43200000 },
];

// Daily Quests Templates
const QUEST_TEMPLATES = {
    daily: [
        { id: 'daily_scan_5', title: 'Daily Scanner', desc: 'Complete 5 scans', type: 'scans', target: 5, reward: 50 },
        { id: 'daily_ai_3', title: 'AI Hunter', desc: 'Find 3 AI images', type: 'ai_found', target: 3, reward: 75 },
        { id: 'daily_deep_2', title: 'Deep Diver', desc: 'Use Deep Scan 2 times', type: 'deep_scans', target: 2, reward: 60 },
        { id: 'daily_forensics', title: 'Forensic Expert', desc: 'Complete 1 Forensics scan', type: 'forensics_scans', target: 1, reward: 100 },
        { id: 'daily_feedback', title: 'Helpful', desc: 'Submit 3 feedback', type: 'feedback', target: 3, reward: 40 },
    ],
    weekly: [
        { id: 'weekly_scan_50', title: 'Scan Master', desc: 'Complete 50 scans this week', type: 'scans', target: 50, reward: 500 },
        { id: 'weekly_ai_20', title: 'AI Nemesis', desc: 'Find 20 AI images', type: 'ai_found', target: 20, reward: 600 },
        { id: 'weekly_streak_7', title: 'Dedicated', desc: 'Maintain 7-day streak', type: 'streak', target: 7, reward: 800 },
        { id: 'weekly_leaderboard', title: 'Competitive', desc: 'Reach top 50 on leaderboard', type: 'rank', target: 50, reward: 1000 },
    ]
};

// Game State
let gameState = {
    inventory: [],
    activeItems: [],
    dailyQuests: [],
    weeklyQuests: [],
    questsLastReset: null,
    totalEarnings: 0
};

function initGameMechanics() {
    loadGameState();
    checkQuestReset();
    updateQuestTimer();
    setInterval(updateQuestTimer, 1000);
}

function loadGameState() {
    const saved = localStorage.getItem('gameState');
    if (saved) {
        try {
            gameState = { ...gameState, ...JSON.parse(saved) };
        } catch (e) {
            console.error('[Game] Load error:', e);
        }
    }
}

function saveGameState() {
    localStorage.setItem('gameState', JSON.stringify(gameState));
}

function checkQuestReset() {
    const now = Date.now();
    const lastReset = gameState.questsLastReset || 0;
    const daysSinceReset = (now - lastReset) / (1000 * 60 * 60 * 24);

    if (daysSinceReset >= 1) {
        // Reset daily quests
        generateDailyQuests();
        gameState.questsLastReset = now;
        saveGameState();
    }

    if (!gameState.weeklyQuests.length) {
        generateWeeklyQuests();
    }
}

function generateDailyQuests() {
    // Randomly select 3 daily quests
    const selected = [];
    const available = [...QUEST_TEMPLATES.daily];

    for (let i = 0; i < 3; i++) {
        if (available.length === 0) break;
        const index = Math.floor(Math.random() * available.length);
        selected.push({ ...available[index], progress: 0, completed: false });
        available.splice(index, 1);
    }

    gameState.dailyQuests = selected;
    saveGameState();
}

function generateWeeklyQuests() {
    gameState.weeklyQuests = QUEST_TEMPLATES.weekly.map(q => ({ ...q, progress: 0, completed: false }));
    saveGameState();
}

function updateQuestTimer() {
    const now = new Date();
    const tomorrow = new Date(now);
    tomorrow.setDate(tomorrow.getDate() + 1);
    tomorrow.setHours(0, 0, 0, 0);

    const diff = tomorrow - now;
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diff % (1000 * 60)) / 1000);

    const timer = $('questTimer');
    if (timer) {
        timer.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }
}

function updateQuestProgress(type, amount = 1) {
    let anyCompleted = false;

    // Update daily quests
    gameState.dailyQuests.forEach(quest => {
        if (!quest.completed && quest.type === type) {
            quest.progress = Math.min(quest.progress + amount, quest.target);
            if (quest.progress >= quest.target && !quest.completed) {
                quest.completed = true;
                anyCompleted = true;
                awardQuestReward(quest.reward);
                toast(` Quest Complete! +${quest.reward} points`);
            }
        }
    });

    // Update weekly quests
    gameState.weeklyQuests.forEach(quest => {
        if (!quest.completed && quest.type === type) {
            quest.progress = Math.min(quest.progress + amount, quest.target);
            if (quest.progress >= quest.target && !quest.completed) {
                quest.completed = true;
                anyCompleted = true;
                awardQuestReward(quest.reward);
                toast(` Weekly Quest Complete! +${quest.reward} points`);
            }
        }
    });

    if (anyCompleted) {
        updateQuestBadge();
    }

    saveGameState();
}

function awardQuestReward(points) {
    // Add points to user stats
    if (user && !useLocalFallback) {
        // Update Supabase
        supabase.from('user_stats').update({
            points: (user.stats?.points || 0) + points
        }).eq('user_id', user.id).then(() => loadUserStats());
    }

    gameState.totalEarnings += points;
    saveGameState();
}

function updateQuestBadge() {
    const incomplete = [
        ...gameState.dailyQuests.filter(q => !q.completed),
        ...gameState.weeklyQuests.filter(q => !q.completed)
    ].length;

    const badge = $('questBadge');
    if (badge) {
        if (incomplete > 0) {
            badge.textContent = incomplete;
            badge.style.display = 'block';
        } else {
            badge.style.display = 'none';
        }
    }
}

// Shop Functions
window.openShop = function() {
    loadShop();
    showView('shopView');
};

function loadShop() {
    renderShopItems();
    renderInventory();
    updateShopPoints();
}

function renderShopItems() {
    const container = $('shopItems');
    if (!container) return;

    container.innerHTML = SHOP_ITEMS.map(item => {
        const owned = gameState.inventory.some(i => i.id === item.id);
        return `
            <div class="shop-item ${owned ? 'owned' : ''}" onclick="purchaseItem('${item.id}')">
                ${owned ? '<div class="shop-item-owned">OWNED</div>' : ''}
                <div class="shop-item-icon">${item.name.split(' ')[0]}</div>
                <div class="shop-item-name">${item.name.substring(item.name.indexOf(' ') + 1)}</div>
                <div class="shop-item-desc">${item.desc}</div>
                <div class="shop-item-price">
                    <span></span>
                    <span>${item.price}</span>
                </div>
            </div>
        `;
    }).join('');
}

function renderInventory() {
    const container = $('inventoryItems');
    if (!container) return;

    if (gameState.inventory.length === 0) {
        container.innerHTML = '<div class="inventory-empty">No items yet! Purchase from shop above.</div>';
        return;
    }

    container.innerHTML = gameState.inventory.map(item => {
        const active = gameState.activeItems.some(a => a.id === item.id);
        return `
            <div class="inventory-item ${active ? 'active' : ''}" onclick="useItem('${item.id}')">
                ${item.quantity > 1 ? `<div class="inventory-item-count">${item.quantity}</div>` : ''}
                <div class="inventory-item-icon">${item.icon}</div>
                <div class="inventory-item-name">${item.name}</div>
            </div>
        `;
    }).join('');
}

function updateShopPoints() {
    const pointsEl = $('shopPoints');
    if (pointsEl) {
        const points = user?.stats?.points || 0;
        pointsEl.textContent = `${points} pts`;
    }
}

window.filterShop = function(category) {
    // Update active button
    document.querySelectorAll('.shop-cat-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');

    // Filter items
    const items = document.querySelectorAll('.shop-item');
    items.forEach(item => {
        if (category === 'all') {
            item.style.display = 'block';
        } else {
            const itemData = SHOP_ITEMS.find(i => item.onclick.toString().includes(i.id));
            item.style.display = itemData && itemData.category === category ? 'block' : 'none';
        }
    });
};

window.purchaseItem = function(itemId) {
    if (!user) {
        toast(' Please log in to purchase items');
        return;
    }

    const item = SHOP_ITEMS.find(i => i.id === itemId);
    if (!item) return;

    const userPoints = user.stats?.points || 0;

    if (userPoints < item.price) {
        toast(' Not enough points!');
        return;
    }

    // Check if already owned (for permanent items)
    if (item.permanent && gameState.inventory.some(i => i.id === itemId)) {
        toast('You already own this item!');
        return;
    }

    // Deduct points
    const newPoints = userPoints - item.price;

    if (!useLocalFallback && supabase) {
        supabase.from('user_stats').update({
            points: newPoints
        }).eq('user_id', user.id).then(() => {
            loadUserStats();
            addToInventory(item);
            toast(` Purchased ${item.name}!`);
            renderShopItems();
            renderInventory();
            updateShopPoints();
        });
    } else {
        addToInventory(item);
        toast(` Purchased ${item.name}!`);
        renderShopItems();
        renderInventory();
    }
};

function addToInventory(item) {
    const existing = gameState.inventory.find(i => i.id === item.id);

    if (existing) {
        existing.quantity = (existing.quantity || 1) + 1;
    } else {
        gameState.inventory.push({
            id: item.id,
            name: item.name,
            icon: item.name.split(' ')[0],
            quantity: item.uses || 1,
            permanent: item.permanent,
            duration: item.duration
        });
    }

    saveGameState();
}

window.useItem = function(itemId) {
    const inventoryItem = gameState.inventory.find(i => i.id === itemId);
    if (!inventoryItem) return;

    const shopItem = SHOP_ITEMS.find(i => i.id === itemId);
    if (!shopItem) return;

    // Check if already active
    if (gameState.activeItems.some(a => a.id === itemId)) {
        toast('This item is already active!');
        return;
    }

    // Activate item
    if (shopItem.duration) {
        gameState.activeItems.push({
            id: itemId,
            expiresAt: Date.now() + shopItem.duration
        });
        toast(` Activated ${shopItem.name}!`);
    } else if (shopItem.uses) {
        inventoryItem.quantity--;
        if (inventoryItem.quantity <= 0) {
            gameState.inventory = gameState.inventory.filter(i => i.id !== itemId);
        }
        toast(` Used ${shopItem.name}!`);
    }

    saveGameState();
    renderInventory();
    applyItemEffects();
};

function applyItemEffects() {
    // Check for expired items
    gameState.activeItems = gameState.activeItems.filter(item => item.expiresAt > Date.now());

    // Apply active item effects
    // These will be checked during scanning
    saveGameState();
}

function hasActiveItem(itemId) {
    return gameState.activeItems.some(a => a.id === itemId);
}

// Quests Functions
window.openQuests = function() {
    loadQuests();
    showView('questsView');
};

function loadQuests() {
    renderQuests();
    updateQuestStreak();
}

// Tank Shooter Game Functions
window.openTankShooter = function() {
    console.log('[TankShooter] Opening Tank Shooter game...');
    showView('tankShooterView');
    document.getElementById('tankShooterStart').style.display = 'flex';
    document.getElementById('truthCannonGame').style.display = 'none';
};

window.closeTankShooter = function() {
    console.log('[TankShooter] Closing Tank Shooter game...');
    if (typeof tankGame !== 'undefined' && tankGame.running) {
        tankGame.running = false;
    }
    document.getElementById('truthCannonGame').style.display = 'none';
    document.getElementById('tankShooterStart').style.display = 'flex';
    document.getElementById('mobileControls').style.display = 'none';
    showView('homeView');
};

function renderQuests() {
    renderQuestList('dailyQuests', gameState.dailyQuests);
    renderQuestList('weeklyQuests', gameState.weeklyQuests);
}

function renderQuestList(containerId, quests) {
    const container = $(containerId);
    if (!container) return;

    if (quests.length === 0) {
        container.innerHTML = '<div class="inventory-empty">No quests available</div>';
        return;
    }

    container.innerHTML = quests.map(quest => {
        const progress = Math.min(quest.progress, quest.target);
        const percent = (progress / quest.target) * 100;

        return `
            <div class="quest-card ${quest.completed ? 'completed' : ''}">
                ${quest.completed ? '<div class="quest-complete-badge"></div>' : ''}
                <div class="quest-card-header">
                    <div class="quest-title">${quest.title}</div>
                    <div class="quest-reward">+${quest.reward} pts</div>
                </div>
                <div class="quest-desc">${quest.desc}</div>
                <div class="quest-progress">
                    <div class="quest-progress-bar" style="width: ${percent}%"></div>
                </div>
                <div class="quest-progress-text">${progress} / ${quest.target}</div>
            </div>
        `;
    }).join('');
}

function updateQuestStreak() {
    const streakCount = user?.stats?.current_streak || 0;
    const bonus = Math.min(streakCount * 5, 50); // Max 50% bonus

    const countEl = $('questStreakCount');
    const bonusEl = $('streakBonusPercent');

    if (countEl) countEl.textContent = `${streakCount} days`;
    if (bonusEl) bonusEl.textContent = bonus;
}

// Hook into existing scan completion
const originalHandleScanComplete = window.handleScanComplete || function() {};
window.handleScanComplete = function(...args) {
    originalHandleScanComplete.apply(this, args);

    // Update quest progress
    if (currentResult) {
        updateQuestProgress('scans');

        if (currentResult.isAI) {
            updateQuestProgress('ai_found');
        }

        if (forensicsMode) {
            updateQuestProgress('forensics_scans');
        } else if (user) {
            updateQuestProgress('deep_scans');
        } else {
            // quick scan (no quest for it though)
        }
    }

    // Apply active item effects
    if (hasActiveItem('double_points')) {
        // Double points already applied
    }

    applyItemEffects();
};

init();

// ==================== ANIMATION UTILITIES ====================
// Comprehensive animation helper functions for delightful micro-interactions

const AnimationUtils = {
    // ==================== PAGE TRANSITIONS ====================

    // Fade in view with animation
    fadeInView: function(viewElement) {
        if (!viewElement) return;
        viewElement.style.opacity = '0';
        viewElement.style.transform = 'translateY(20px)';

        // Trigger reflow
        void viewElement.offsetHeight;

        viewElement.style.transition = 'opacity 300ms ease-out, transform 300ms ease-out';
        viewElement.style.opacity = '1';
        viewElement.style.transform = 'translateY(0)';
    },

    // Fade out view
    fadeOutView: function(viewElement) {
        if (!viewElement) return;
        viewElement.style.transition = 'opacity 300ms ease-out, transform 300ms ease-out';
        viewElement.style.opacity = '0';
        viewElement.style.transform = 'translateY(20px)';
    },

    // ==================== LOADING SKELETONS ====================

    // Create skeleton loader
    createSkeleton: function(width = '100%', height = '16px') {
        const skeleton = document.createElement('div');
        skeleton.className = 'skeleton skeleton-text';
        skeleton.style.width = width;
        skeleton.style.height = height;
        return skeleton;
    },

    // Create skeleton bar (progress-like)
    createSkeletonBar: function(width = '100%', height = '12px') {
        const skeleton = document.createElement('div');
        skeleton.className = 'skeleton skeleton-bar';
        skeleton.style.width = width;
        skeleton.style.height = height;
        return skeleton;
    },

    // ==================== BUTTON INTERACTIONS ====================

    // Add loading state to button
    setButtonLoading: function(button, isLoading = true) {
        if (!button) return;

        if (isLoading) {
            button.disabled = true;
            button.dataset.originalText = button.innerHTML;
            button.innerHTML = '<span class="btn-spinner"></span> Loading...';
            button.classList.add('btn-loading');
        } else {
            button.disabled = false;
            button.innerHTML = button.dataset.originalText || 'Done';
            button.classList.remove('btn-loading');
        }
    },

    // Show success state on button
    setButtonSuccess: function(button, message = 'Success!') {
        if (!button) return;

        button.disabled = true;
        button.classList.add('btn-success');
        button.innerHTML = ' ' + message;
        button.style.backgroundColor = 'var(--success)';

        setTimeout(() => {
            button.classList.remove('btn-success');
            button.disabled = false;
            button.style.backgroundColor = '';
        }, 2000);
    },

    // Show error state on button
    setButtonError: function(button, message = 'Error!') {
        if (!button) return;

        button.classList.add('btn-error');
        button.innerHTML = ' ' + message;
        button.style.backgroundColor = 'var(--danger)';

        setTimeout(() => {
            button.classList.remove('btn-error');
            button.style.backgroundColor = '';
        }, 2500);
    },

    // ==================== SCAN PROGRESS ====================

    // Create animated progress bar
    createProgressBar: function(container) {
        if (!container) return null;
        const bar = document.createElement('div');
        bar.className = 'progress-bar';
        bar.style.width = '0%';
        container.appendChild(bar);
        return bar;
    },

    // Update progress with animation
    updateProgress: function(progressElement, percentage) {
        if (!progressElement) return;
        progressElement.style.width = percentage + '%';
    },

    // Add pulsing scan indicator
    addScanIndicator: function(container) {
        if (!container) return null;
        const indicator = document.createElement('div');
        indicator.className = 'scan-indicator';
        indicator.innerHTML = '';
        indicator.style.fontSize = '24px';
        indicator.style.display = 'inline-block';
        container.appendChild(indicator);
        return indicator;
    },

    // Animate checkmark for completed module
    animateCheckmark: function(element) {
        if (!element) return;
        element.classList.add('module-checkmark');
        element.innerHTML = '';
    },

    // Reveal score with count-up animation
    revealScore: function(scoreElement, finalScore) {
        if (!scoreElement) return;

        scoreElement.classList.add('score-reveal');

        let currentScore = 0;
        const increment = finalScore / 20; // Divide into 20 steps
        const interval = 600 / 20; // Total animation is 600ms

        const counter = setInterval(() => {
            currentScore += increment;
            if (currentScore >= finalScore) {
                currentScore = finalScore;
                clearInterval(counter);
            }
            scoreElement.textContent = Math.round(currentScore) + '%';
        }, interval);
    },

    // ==================== LIST/CARD ANIMATIONS ====================

    // Add cascade effect to cards
    cascadeCards: function(cardElements) {
        if (!cardElements || cardElements.length === 0) return;

        cardElements.forEach((card, index) => {
            card.classList.add('card-cascade');
            card.style.setProperty('--card-index', index);
        });
    },

    // Add lift effect to card on hover
    addCardLift: function(card) {
        if (!card) return;
        card.classList.add('card-lift');
    },

    // Smooth expand animation
    expandElement: function(element) {
        if (!element) return;
        element.classList.remove('collapse-exit');
        element.classList.add('collapse-enter');
        element.style.display = 'block';
    },

    // Smooth collapse animation
    collapseElement: function(element) {
        if (!element) return;
        element.classList.remove('collapse-enter');
        element.classList.add('collapse-exit');

        setTimeout(() => {
            element.style.display = 'none';
        }, 300);
    },

    // Remove item with animation
    removeItemAnimated: function(element, callback) {
        if (!element) return;
        element.classList.add('item-remove');

        setTimeout(() => {
            element.remove();
            if (callback) callback();
        }, 300);
    },

    // ==================== CELEBRATORY MOMENTS ====================

    // Create confetti burst
    createConfetti: function(count = 30, originX = 0.5, originY = 0.5) {
        const colors = ['var(--primary)', 'var(--secondary)', 'var(--warning)', 'var(--success)'];

        for (let i = 0; i < count; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';

            const angle = (Math.PI * 2 * i) / count;
            const velocity = 3 + Math.random() * 4;
            const tx = Math.cos(angle) * velocity * 100;
            const ty = Math.sin(angle) * velocity * 100 - 100;

            confetti.style.setProperty('--tx', tx + 'px');
            confetti.style.setProperty('--ty', ty + 'px');
            confetti.style.left = (originX * 100) + '%';
            confetti.style.top = (originY * 100) + '%';
            confetti.style.background = colors[i % colors.length];

            document.body.appendChild(confetti);

            setTimeout(() => confetti.remove(), 800);
        }
    },

    // Badge unlock animation
    animateBadgeUnlock: function(badgeElement) {
        if (!badgeElement) return;
        badgeElement.classList.add('badge-unlock');

        // Create confetti on unlock
        const rect = badgeElement.getBoundingClientRect();
        this.createConfetti(20, rect.left / window.innerWidth, rect.top / window.innerHeight);
    },

    // Level up animation
    animateLevelUp: function(container) {
        if (!container) return;
        const element = document.createElement('div');
        element.className = 'level-up';
        element.style.fontSize = '32px';
        element.innerHTML = ' Level Up!';
        element.style.textAlign = 'center';
        element.style.color = 'var(--primary)';
        container.appendChild(element);

        setTimeout(() => element.remove(), 600);
    },

    // Success burst effect
    createSuccessBurst: function(element) {
        if (!element) return;
        const burst = document.createElement('div');
        burst.className = 'success-burst';
        burst.innerHTML = '';
        burst.style.position = 'absolute';
        burst.style.fontSize = '32px';
        burst.style.color = 'var(--success)';
        burst.style.top = '50%';
        burst.style.left = '50%';
        burst.style.transform = 'translate(-50%, -50%)';
        element.appendChild(burst);

        setTimeout(() => burst.remove(), 500);
    },

    // Leaderboard rank up glow
    animateRankUp: function(element) {
        if (!element) return;
        element.classList.add('rank-up');
        setTimeout(() => element.classList.remove('rank-up'), 800);
    },

    // ==================== SUBTLE DETAILS ====================

    // Show tooltip with animation
    showTooltip: function(text, element = null) {
        let tooltip = document.querySelector('.tooltip');
        if (!tooltip) {
            tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.style.position = 'fixed';
            tooltip.style.backgroundColor = 'var(--surface)';
            tooltip.style.color = 'var(--text)';
            tooltip.style.padding = '8px 12px';
            tooltip.style.borderRadius = '6px';
            tooltip.style.fontSize = '12px';
            tooltip.style.zIndex = '9999';
            tooltip.style.pointerEvents = 'none';
            document.body.appendChild(tooltip);
        }

        tooltip.textContent = text;
        tooltip.classList.add('show');

        if (element) {
            const rect = element.getBoundingClientRect();
            tooltip.style.left = (rect.left + rect.width / 2 - tooltip.offsetWidth / 2) + 'px';
            tooltip.style.top = (rect.top - 40) + 'px';
        }

        return tooltip;
    },

    // Hide tooltip
    hideTooltip: function() {
        const tooltip = document.querySelector('.tooltip.show');
        if (tooltip) {
            tooltip.classList.remove('show');
        }
    },

    // Icon bounce effect
    bounceIcon: function(element) {
        if (!element) return;
        element.classList.add('icon-hover');
        setTimeout(() => element.classList.remove('icon-hover'), 400);
    },

    // Float animation for icons
    addFloatingIcon: function(element) {
        if (!element) return;
        element.classList.add('float');
    },

    // Create notification
    showNotification: function(message, duration = 3000, type = 'info') {
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.style.position = 'fixed';
        notification.style.top = 'var(--safe-top, 0)';
        notification.style.right = '0';
        notification.style.margin = '10px';
        notification.style.padding = '12px 16px';
        notification.style.borderRadius = '8px';
        notification.style.zIndex = '10000';
        notification.style.maxWidth = '300px';

        // Set type styling
        const styles = {
            success: { background: 'var(--success)', color: 'white' },
            error: { background: 'var(--danger)', color: 'white' },
            warning: { background: 'var(--warning)', color: 'black' },
            info: { background: 'var(--secondary)', color: 'white' }
        };

        const style = styles[type] || styles.info;
        Object.assign(notification.style, style);

        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.classList.add('exit');
            setTimeout(() => notification.remove(), 300);
        }, duration);

        return notification;
    },

    // ==================== SPINNER HELPERS ====================

    // Create spinner element
    createSpinner: function(size = 'md') {
        const spinner = document.createElement('div');
        if (size === 'sm') {
            spinner.className = 'spinner spinner-sm';
        } else if (size === 'lg') {
            spinner.className = 'spinner spinner-lg';
        } else {
            spinner.className = 'spinner';
        }
        return spinner;
    },

    // ==================== UTILITY ANIMATIONS ====================

    // Add float animation
    addFloat: function(element) {
        if (!element) return;
        element.classList.add('float');
    },

    // Add heartbeat effect
    addHeartbeat: function(element) {
        if (!element) return;
        element.classList.add('heartbeat');
        setTimeout(() => element.classList.remove('heartbeat'), 600);
    },

    // Text reveal animation
    revealText: function(element, text) {
        if (!element) return;
        element.classList.add('text-reveal');
        element.textContent = text;
    },

    // Pop in animation
    popIn: function(element) {
        if (!element) return;
        element.classList.add('pop-in');
    },

    // Apply smooth transitions
    smoothTransition: function(element) {
        if (!element) return;
        element.classList.add('smooth-transition');
    }
};

// ==================== ANIMATION HELPER FUNCTION ====================

// Universal helper to trigger animations on elements
function animate(element, animationName, duration = 300) {
    if (!element) return Promise.resolve();

    return new Promise((resolve) => {
        element.style.animation = `${animationName} ${duration}ms ease-out forwards`;

        setTimeout(() => {
            element.style.animation = '';
            resolve();
        }, duration);
    });
}

// Delay utility for chaining animations
function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// Chain multiple animations
async function animateSequence(elements, animationName, duration = 300, staggerDelay = 100) {
    for (let i = 0; i < elements.length; i++) {
        animate(elements[i], animationName, duration);
        await delay(staggerDelay);
    }
}

// ==================== AUTO-INITIALIZE ANIMATIONS ====================

// Initialize button animations on page load
document.addEventListener('DOMContentLoaded', function() {
    // Add smooth transitions to all interactive elements
    const interactiveElements = document.querySelectorAll('button, a, input, select');
    interactiveElements.forEach(el => {
        AnimationUtils.smoothTransition(el);
    });

    // Add card lift to existing cards
    const cards = document.querySelectorAll('.shop-item, .quest-card, .inventory-item');
    cards.forEach(card => {
        AnimationUtils.addCardLift(card);
    });
});

// Extend showView to include animations with debouncing to prevent navigation loops
if (typeof showView !== 'undefined') {
    const originalShowView = showView;
    let isNavigating = false;
    let navigationTimeout = null;

    window.showView = function(id) {
        // Prevent rapid navigation causing loops
        if (isNavigating) {
            console.log('[Navigation] Debouncing navigation to', id);
            return;
        }

        isNavigating = true;

        // Clear any pending navigation timeout
        if (navigationTimeout) {
            clearTimeout(navigationTimeout);
        }

        // Execute navigation
        originalShowView(id);
        const element = document.getElementById(id);
        if (element) {
            AnimationUtils.fadeInView(element);
        }

        // Reset navigation lock after animation completes
        navigationTimeout = setTimeout(() => {
            isNavigating = false;
        }, 300); // Match animation duration
    };
}

// Export AnimationUtils globally
window.AnimationUtils = AnimationUtils;
window.animate = animate;
window.delay = delay;
window.animateSequence = animateSequence;

</script>
</body>
</html>
